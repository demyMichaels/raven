<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Graph State Management - Interactive Learning Platform</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .node:hover {
            filter: brightness(1.2);
        }
        .link {
            fill: none;
            stroke-opacity: 0.6;
            transition: all 0.3s ease;
        }
        .link:hover {
            stroke-opacity: 1;
            stroke-width: 3px !important;
        }
        .link-label {
            font-size: 10px;
            fill: #666;
            pointer-events: none;
        }
        .dark .link-label {
            fill: #999;
        }
        .node-label {
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            text-anchor: middle;
        }
        .tooltip {
            position: absolute;
            padding: 12px;
            background: white;
            border: 2px solid #5D5CDE;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 300px;
            z-index: 1000;
        }
        .dark .tooltip {
            background: #1f2937;
            color: #e5e7eb;
        }
        .vector-point {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .vector-point:hover {
            transform: scale(1.5);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .legend-line {
            width: 30px;
            height: 3px;
        }
        .legend-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        .highlight-node {
            animation: pulse-ring 1.5s ease-out infinite;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #5D5CDE;
            color: white;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-primary to-purple-600 text-white py-6 px-4 shadow-lg">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-3xl font-bold mb-2">Portfolio Graph State Management</h1>
                <p class="text-purple-100">Interactive Learning Platform for Investment Managers</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex flex-wrap gap-2 py-4">
                    <button class="tab-button active px-6 py-2 rounded-lg font-semibold text-base" data-tab="graph">
                        Portfolio Graph
                    </button>
                    <button class="tab-button px-6 py-2 rounded-lg font-semibold text-base hover:bg-gray-200 dark:hover:bg-gray-700" data-tab="relationships">
                        Relationships
                    </button>
                    <button class="tab-button px-6 py-2 rounded-lg font-semibold text-base hover:bg-gray-200 dark:hover:bg-gray-700" data-tab="vectors">
                        Vector Similarity
                    </button>
                    <button class="tab-button px-6 py-2 rounded-lg font-semibold text-base hover:bg-gray-200 dark:hover:bg-gray-700" data-tab="cloning">
                        Cloning & Backtesting
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 py-8">

            <!-- Tab 1: Portfolio Graph -->
            <div id="graph-tab" class="tab-content">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-3">Portfolio as a Graph Structure</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        Traditional portfolio systems treat assets as flat lists. This graph-based approach reveals the complex interconnections:
                        chronological acquisition order (blue arrows), hedging relationships (green), sector correlations (orange), and more.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Controls -->
                    <div class="lg:col-span-1 bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                        <h3 class="font-bold mb-4 text-lg">Controls</h3>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold mb-2">Show Relationships</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="w-4 h-4 relationship-filter" data-type="chronological" checked>
                                    <span class="text-sm">Chronological (Next)</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="w-4 h-4 relationship-filter" data-type="hedging" checked>
                                    <span class="text-sm">Hedging</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="w-4 h-4 relationship-filter" data-type="sector" checked>
                                    <span class="text-sm">Sector Correlation</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="w-4 h-4 relationship-filter" data-type="rebalance" checked>
                                    <span class="text-sm">Rebalancing Trigger</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="w-4 h-4 relationship-filter" data-type="tax" checked>
                                    <span class="text-sm">Tax Lot Chain</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="w-4 h-4 relationship-filter" data-type="margin" checked>
                                    <span class="text-sm">Margin Relationship</span>
                                </label>
                            </div>
                        </div>

                        <button id="resetGraph" class="w-full bg-primary hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg mt-4">
                            Reset View
                        </button>

                        <button id="addAsset" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mt-2">
                            Add Random Asset
                        </button>
                    </div>

                    <!-- Graph Visualization -->
                    <div class="lg:col-span-3">
                        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                            <svg id="portfolioGraph" width="100%" height="600" class="border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900"></svg>
                        </div>

                        <!-- Legend -->
                        <div class="mt-4 bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                            <h4 class="font-bold mb-3">Legend</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div>
                                    <div class="text-sm font-semibold mb-2">Asset Types</div>
                                    <div class="legend-item">
                                        <div class="legend-circle" style="background-color: #3B82F6;"></div>
                                        <span class="text-sm">Stock</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-circle" style="background-color: #10B981;"></div>
                                        <span class="text-sm">Bond</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-circle" style="background-color: #F59E0B;"></div>
                                        <span class="text-sm">Option</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-circle" style="background-color: #8B5CF6;"></div>
                                        <span class="text-sm">Real Estate</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-circle" style="background-color: #EC4899;"></div>
                                        <span class="text-sm">Crypto</span>
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="text-sm font-semibold mb-2">Relationship Types</div>
                                    <div class="grid grid-cols-2 gap-x-4">
                                        <div class="legend-item">
                                            <div class="legend-line" style="background-color: #60A5FA;"></div>
                                            <span class="text-sm">Chronological</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-line" style="background-color: #34D399;"></div>
                                            <span class="text-sm">Hedging</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-line" style="background-color: #FB923C;"></div>
                                            <span class="text-sm">Sector Correlation</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-line" style="background-color: #A78BFA;"></div>
                                            <span class="text-sm">Rebalancing</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-line" style="background-color: #FBBF24;"></div>
                                            <span class="text-sm">Tax Lot Chain</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-line" style="background-color: #F472B6;"></div>
                                            <span class="text-sm">Margin</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Relationships Deep Dive -->
            <div id="relationships-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-3">Understanding Portfolio Relationships</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        Explore each type of relationship and its implications for portfolio management.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-800 dark:to-gray-700 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-blue-400"></span>
                            Chronological (Next Pointers)
                        </h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-3">
                            Maintains acquisition order for FIFO/LIFO tax lot accounting and tracks cost basis history.
                        </p>
                        <div class="bg-white dark:bg-gray-800 rounded p-4 text-sm font-mono">
                            AAPL (Jan 2023) → MSFT (Mar 2023) → AAPL (Jun 2023)
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                            <strong>Use Case:</strong> When selling AAPL shares, determine which lot to sell first for optimal tax treatment.
                        </p>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-gray-800 dark:to-gray-700 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-green-400"></span>
                            Hedging Relationships
                        </h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-3">
                            Links assets with their protective instruments (puts, calls, inverse positions).
                        </p>
                        <div class="bg-white dark:bg-gray-800 rounded p-4 text-sm font-mono">
                            TSLA (100 shares) ↔ TSLA Put $200 (1 contract)
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                            <strong>Use Case:</strong> Calculate true portfolio delta and understand downside protection coverage.
                        </p>
                    </div>

                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 dark:from-gray-800 dark:to-gray-700 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-orange-400"></span>
                            Sector Correlations
                        </h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-3">
                            Clusters assets that move together based on sector, industry, or factor exposure.
                        </p>
                        <div class="bg-white dark:bg-gray-800 rounded p-4 text-sm font-mono">
                            AAPL ↔ MSFT ↔ GOOGL (Tech sector, correlation > 0.7)
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                            <strong>Use Case:</strong> Identify concentration risk and ensure proper diversification across uncorrelated clusters.
                        </p>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-gray-800 dark:to-gray-700 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-purple-400"></span>
                            Rebalancing Triggers
                        </h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-3">
                            Conditional relationships: "If asset A drops X%, increase position in asset B."
                        </p>
                        <div class="bg-white dark:bg-gray-800 rounded p-4 text-sm font-mono">
                            IF BND drops > 5% THEN buy 10% more BND
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                            <strong>Use Case:</strong> Automated tactical asset allocation based on predefined rules and mean reversion strategies.
                        </p>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-gray-800 dark:to-gray-700 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-yellow-400"></span>
                            Tax Lot Chains
                        </h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-3">
                            Multiple purchases of the same security form a linked chain for sophisticated tax management.
                        </p>
                        <div class="bg-white dark:bg-gray-800 rounded p-4 text-sm font-mono">
                            AAPL_Lot1 ($120, 100sh) → AAPL_Lot2 ($150, 50sh) → AAPL_Lot3 ($145, 75sh)
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                            <strong>Use Case:</strong> Tax loss harvesting - sell specific lots to minimize tax liability or harvest losses.
                        </p>
                    </div>

                    <div class="bg-gradient-to-br from-pink-50 to-pink-100 dark:from-gray-800 dark:to-gray-700 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-3 flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-pink-400"></span>
                            Margin Relationships
                        </h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-3">
                            Tracks which assets secure which leveraged positions and borrowing capacity.
                        </p>
                        <div class="bg-white dark:bg-gray-800 rounded p-4 text-sm font-mono">
                            [AAPL + MSFT] → secures → Margin Loan ($50k)
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                            <strong>Use Case:</strong> Monitor margin requirements and prevent margin calls by understanding collateral dependencies.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Vector Similarity -->
            <div id="vectors-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-3">Vector Embeddings & Portfolio Similarity</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        Each portfolio is embedded as a high-dimensional vector capturing: risk profile, sector exposure,
                        return patterns, volatility fingerprint, and correlation structure. Similar portfolios cluster together.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg">2D Projection (t-SNE)</h3>
                                <div class="flex gap-2">
                                    <button id="runClustering" class="bg-primary hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                                        Run Clustering
                                    </button>
                                    <button id="findSimilar" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                                        Find Similar
                                    </button>
                                </div>
                            </div>
                            <svg id="vectorSpace" width="100%" height="500" class="border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900"></svg>
                        </div>

                        <div class="bg-blue-50 dark:bg-gray-800 rounded-lg p-4">
                            <h4 class="font-bold mb-2">How Vector Embeddings Work</h4>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                <li><strong>Feature Extraction:</strong> Calculate metrics for each portfolio (Sharpe ratio, max drawdown, sector weights, beta, etc.)</li>
                                <li><strong>Embedding:</strong> Transform features into a dense vector (e.g., 128 dimensions) using neural networks or autoencoders</li>
                                <li><strong>Similarity Search:</strong> Use cosine similarity or Euclidean distance to find nearest neighbors</li>
                                <li><strong>Clustering:</strong> Group similar portfolios to discover successful strategies and risk patterns</li>
                            </ol>
                        </div>
                    </div>

                    <div>
                        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mb-4">
                            <h3 class="font-bold mb-3">Your Portfolio</h3>
                            <div id="currentPortfolioMetrics" class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Sharpe Ratio:</span>
                                    <span class="font-semibold" id="sharpe">1.45</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Max Drawdown:</span>
                                    <span class="font-semibold" id="drawdown">-18.2%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Volatility:</span>
                                    <span class="font-semibold" id="volatility">14.5%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Tech Exposure:</span>
                                    <span class="font-semibold" id="techExp">35%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Beta:</span>
                                    <span class="font-semibold" id="beta">1.12</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 dark:bg-gray-800 rounded-lg p-4">
                            <h3 class="font-bold mb-3">Similar Portfolios</h3>
                            <div id="similarPortfolios" class="space-y-3">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Click "Find Similar" to discover portfolios with similar characteristics.</p>
                            </div>
                        </div>

                        <div class="bg-purple-50 dark:bg-gray-800 rounded-lg p-4 mt-4">
                            <h3 class="font-bold mb-3">Query Examples</h3>
                            <div class="space-y-2 text-sm">
                                <button class="w-full text-left p-2 bg-white dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 query-example" data-query="bear">
                                    Outperformers in bear markets
                                </button>
                                <button class="w-full text-left p-2 bg-white dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 query-example" data-query="low-vol">
                                    Low volatility, high Sharpe
                                </button>
                                <button class="w-full text-left p-2 bg-white dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 query-example" data-query="diversified">
                                    Well-diversified portfolios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Cloning & Backtesting -->
            <div id="cloning-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-3">Portfolio Cloning & Backtesting</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        Clone entire portfolio graphs to preserve exact asset relationships. Test alternative strategies
                        on historical data by cloning past states and simulating different decisions.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4">Original Portfolio State</h3>
                        <svg id="originalPortfolio" width="100%" height="400" class="border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900 mb-4"></svg>
                        <div class="flex gap-2">
                            <button id="clonePortfolio" class="flex-1 bg-primary hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg">
                                Clone Portfolio →
                            </button>
                            <button id="modifyClone" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg" disabled>
                                Modify Clone
                            </button>
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4">Cloned Portfolio (Editable)</h3>
                        <svg id="clonedPortfolio" width="100%" height="400" class="border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900 mb-4"></svg>
                        <div id="cloneStatus" class="text-sm text-gray-600 dark:text-gray-400 text-center py-8">
                            No clone yet. Click "Clone Portfolio" to create a deep copy.
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-700 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">Backtesting Scenarios</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4">
                            <h4 class="font-bold mb-2">Scenario A: Original</h4>
                            <div class="text-sm space-y-1 mb-3">
                                <div>Initial Value: $1,000,000</div>
                                <div>Time Period: 2020-2024</div>
                                <div class="font-bold text-green-600">Final Value: $1,420,000</div>
                                <div class="text-gray-600 dark:text-gray-400">CAGR: 9.2%</div>
                            </div>
                            <div class="h-24 bg-gray-100 dark:bg-gray-700 rounded">
                                <canvas id="chartOriginal" class="w-full h-full"></canvas>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4">
                            <h4 class="font-bold mb-2">Scenario B: More Hedging</h4>
                            <div class="text-sm space-y-1 mb-3">
                                <div>Initial Value: $1,000,000</div>
                                <div>Time Period: 2020-2024</div>
                                <div class="font-bold text-green-600">Final Value: $1,385,000</div>
                                <div class="text-gray-600 dark:text-gray-400">CAGR: 8.5%</div>
                            </div>
                            <div class="h-24 bg-gray-100 dark:bg-gray-700 rounded">
                                <canvas id="chartHedged" class="w-full h-full"></canvas>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4">
                            <h4 class="font-bold mb-2">Scenario C: Different Rebalancing</h4>
                            <div class="text-sm space-y-1 mb-3">
                                <div>Initial Value: $1,000,000</div>
                                <div>Time Period: 2020-2024</div>
                                <div class="font-bold text-green-600">Final Value: $1,512,000</div>
                                <div class="text-gray-600 dark:text-gray-400">CAGR: 10.9%</div>
                            </div>
                            <div class="h-24 bg-gray-100 dark:bg-gray-700 rounded">
                                <canvas id="chartRebalanced" class="w-full h-full"></canvas>
                            </div>
                        </div>
                    </div>
                    <button id="runBacktest" class="w-full bg-primary hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg">
                        Run Comparative Backtest
                    </button>
                </div>

                <div class="bg-yellow-50 dark:bg-gray-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-3">Why Graph Cloning Matters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <h4 class="font-semibold mb-2 text-primary">✓ Preserves Relationships</h4>
                            <p class="text-gray-700 dark:text-gray-300">All hedges, correlations, and dependencies remain intact in the clone, ensuring realistic simulations.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2 text-primary">✓ Time-Travel Testing</h4>
                            <p class="text-gray-700 dark:text-gray-300">Clone historical states and test "what if" scenarios without affecting your current portfolio.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2 text-primary">✓ Strategy Comparison</h4>
                            <p class="text-gray-700 dark:text-gray-300">Run multiple clones with different parameters in parallel to find optimal allocation strategies.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2 text-primary">✓ Risk Analysis</h4>
                            <p class="text-gray-700 dark:text-gray-300">Simulate stress scenarios (2008 crisis, COVID crash) on cloned portfolios to measure resilience.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Tab navigation
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                tabButtons.forEach(btn => btn.classList.remove('active', 'bg-primary', 'text-white'));
                tabButtons.forEach(btn => btn.classList.add('hover:bg-gray-200', 'dark:hover:bg-gray-700'));
                button.classList.add('active', 'bg-primary', 'text-white');
                button.classList.remove('hover:bg-gray-200', 'dark:hover:bg-gray-700');

                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${targetTab}-tab`).classList.remove('hidden');
            });
        });

        // Portfolio Graph Data
        const assetTypes = {
            stock: { color: '#3B82F6', examples: ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'NVDA', 'AMZN'] },
            bond: { color: '#10B981', examples: ['BND', 'AGG', 'TLT', 'GOVT'] },
            option: { color: '#F59E0B', examples: ['AAPL Put $170', 'TSLA Call $250', 'SPY Put $420'] },
            realestate: { color: '#8B5CF6', examples: ['VNQ', 'REIT-A', 'Property-1'] },
            crypto: { color: '#EC4899', examples: ['BTC', 'ETH', 'SOL'] }
        };

        const relationshipTypes = {
            chronological: { color: '#60A5FA', label: 'Next' },
            hedging: { color: '#34D399', label: 'Hedge' },
            sector: { color: '#FB923C', label: 'Sector' },
            rebalance: { color: '#A78BFA', label: 'Rebalance' },
            tax: { color: '#FBBF24', label: 'Tax Lot' },
            margin: { color: '#F472B6', label: 'Margin' }
        };

        let portfolioData = {
            nodes: [
                { id: 'AAPL', type: 'stock', value: 45000, shares: 250 },
                { id: 'MSFT', type: 'stock', value: 38000, shares: 100 },
                { id: 'GOOGL', type: 'stock', value: 32000, shares: 230 },
                { id: 'BND', type: 'bond', value: 50000, shares: 600 },
                { id: 'AAPL Put $170', type: 'option', value: 2500, contracts: 5 },
                { id: 'VNQ', type: 'realestate', value: 25000, shares: 280 },
                { id: 'BTC', type: 'crypto', value: 15000, amount: 0.25 },
                { id: 'TSLA', type: 'stock', value: 28000, shares: 110 },
            ],
            links: [
                { source: 'AAPL', target: 'MSFT', type: 'chronological' },
                { source: 'MSFT', target: 'GOOGL', type: 'chronological' },
                { source: 'GOOGL', target: 'BND', type: 'chronological' },
                { source: 'AAPL', target: 'AAPL Put $170', type: 'hedging' },
                { source: 'AAPL', target: 'MSFT', type: 'sector' },
                { source: 'MSFT', target: 'GOOGL', type: 'sector' },
                { source: 'BND', target: 'BND', type: 'rebalance', label: 'Buy if drops >5%' },
                { source: 'AAPL', target: 'TSLA', type: 'tax' },
                { source: 'MSFT', target: 'VNQ', type: 'margin' },
            ]
        };

        // Main graph visualization
        const svg = d3.select('#portfolioGraph');
        const width = svg.node().getBoundingClientRect().width;
        const height = 600;

        let simulation = d3.forceSimulation(portfolioData.nodes)
            .force('link', d3.forceLink(portfolioData.links).id(d => d.id).distance(150))
            .force('charge', d3.forceManyBody().strength(-500))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(50));

        let linkGroup = svg.append('g').attr('class', 'links');
        let nodeGroup = svg.append('g').attr('class', 'nodes');

        function updateGraph() {
            const activeRelationships = new Set();
            document.querySelectorAll('.relationship-filter:checked').forEach(cb => {
                activeRelationships.add(cb.dataset.type);
            });

            const visibleLinks = portfolioData.links.filter(l => activeRelationships.has(l.type));

            // Update links
            const link = linkGroup.selectAll('line')
                .data(visibleLinks, d => `${d.source.id || d.source}-${d.target.id || d.target}-${d.type}`);

            link.exit().remove();

            link.enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke', d => relationshipTypes[d.type].color)
                .attr('stroke-width', 2)
                .merge(link)
                .on('mouseover', function(event, d) {
                    const tooltip = d3.select('#tooltip');
                    tooltip.style('opacity', 1)
                        .html(`
                            <strong>${relationshipTypes[d.type].label}</strong><br>
                            ${d.source.id || d.source} → ${d.target.id || d.target}
                            ${d.label ? '<br>' + d.label : ''}
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select('#tooltip').style('opacity', 0);
                });

            // Update nodes
            const node = nodeGroup.selectAll('g')
                .data(portfolioData.nodes, d => d.id);

            node.exit().remove();

            const nodeEnter = node.enter()
                .append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            nodeEnter.append('circle')
                .attr('r', d => Math.sqrt(d.value) / 15 + 20)
                .attr('fill', d => assetTypes[d.type].color)
                .attr('stroke', '#fff')
                .attr('stroke-width', 3);

            nodeEnter.append('text')
                .attr('class', 'node-label')
                .attr('dy', 4)
                .text(d => d.id)
                .attr('fill', '#fff');

            nodeEnter.merge(node)
                .on('mouseover', function(event, d) {
                    const tooltip = d3.select('#tooltip');
                    let details = `<strong>${d.id}</strong><br>Type: ${d.type}<br>Value: $${d.value.toLocaleString()}`;
                    if (d.shares) details += `<br>Shares: ${d.shares}`;
                    if (d.contracts) details += `<br>Contracts: ${d.contracts}`;
                    if (d.amount) details += `<br>Amount: ${d.amount}`;

                    tooltip.style('opacity', 1)
                        .html(details)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select('#tooltip').style('opacity', 0);
                });

            simulation.nodes(portfolioData.nodes);
            simulation.force('link').links(visibleLinks);
            simulation.alpha(0.3).restart();
        }

        simulation.on('tick', () => {
            linkGroup.selectAll('line')
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            nodeGroup.selectAll('g')
                .attr('transform', d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Event listeners
        document.querySelectorAll('.relationship-filter').forEach(cb => {
            cb.addEventListener('change', updateGraph);
        });

        document.getElementById('resetGraph').addEventListener('click', () => {
            portfolioData.nodes.forEach(n => {
                n.fx = null;
                n.fy = null;
            });
            simulation.alpha(1).restart();
        });

        document.getElementById('addAsset').addEventListener('click', () => {
            const types = Object.keys(assetTypes);
            const randomType = types[Math.floor(Math.random() * types.length)];
            const examples = assetTypes[randomType].examples;
            const randomAsset = examples[Math.floor(Math.random() * examples.length)];
            const newId = `${randomAsset}-${Date.now()}`;

            const newNode = {
                id: newId,
                type: randomType,
                value: Math.random() * 50000 + 10000,
                shares: Math.floor(Math.random() * 500 + 50)
            };

            portfolioData.nodes.push(newNode);

            // Add a random link
            if (portfolioData.nodes.length > 1) {
                const randomSource = portfolioData.nodes[Math.floor(Math.random() * (portfolioData.nodes.length - 1))];
                const linkTypes = Object.keys(relationshipTypes);
                const randomLinkType = linkTypes[Math.floor(Math.random() * linkTypes.length)];

                portfolioData.links.push({
                    source: randomSource.id,
                    target: newId,
                    type: randomLinkType
                });
            }

            updateGraph();
        });

        // Vector Space Visualization
        const vectorSvg = d3.select('#vectorSpace');
        const vectorWidth = vectorSvg.node().getBoundingClientRect().width;
        const vectorHeight = 500;

        // Generate sample portfolios with metrics
        const samplePortfolios = [];
        const portfolioTypes = [
            { name: 'Aggressive Growth', sharpe: [1.2, 1.8], drawdown: [-25, -35], volatility: [18, 25], tech: [40, 60], beta: [1.2, 1.5] },
            { name: 'Balanced', sharpe: [1.0, 1.5], drawdown: [-15, -22], volatility: [10, 16], tech: [20, 35], beta: [0.8, 1.1] },
            { name: 'Conservative', sharpe: [0.8, 1.2], drawdown: [-8, -15], volatility: [6, 12], tech: [10, 25], beta: [0.5, 0.8] },
            { name: 'Bear Market Winners', sharpe: [1.5, 2.2], drawdown: [-5, -12], volatility: [8, 14], tech: [15, 30], beta: [0.3, 0.6] },
        ];

        for (let i = 0; i < 50; i++) {
            const type = portfolioTypes[Math.floor(Math.random() * portfolioTypes.length)];
            samplePortfolios.push({
                id: `Portfolio-${i + 1}`,
                type: type.name,
                sharpe: Math.random() * (type.sharpe[1] - type.sharpe[0]) + type.sharpe[0],
                drawdown: Math.random() * (type.drawdown[1] - type.drawdown[0]) + type.drawdown[0],
                volatility: Math.random() * (type.volatility[1] - type.volatility[0]) + type.volatility[0],
                techExposure: Math.random() * (type.tech[1] - type.tech[0]) + type.tech[0],
                beta: Math.random() * (type.beta[1] - type.beta[0]) + type.beta[0],
                // 2D projection (simulated t-SNE)
                x: 0,
                y: 0
            });
        }

        // Add current portfolio
        const currentPortfolio = {
            id: 'Your Portfolio',
            type: 'Current',
            sharpe: 1.45,
            drawdown: -18.2,
            volatility: 14.5,
            techExposure: 35,
            beta: 1.12,
            x: 0,
            y: 0,
            isCurrent: true
        };
        samplePortfolios.push(currentPortfolio);

        // Simulate t-SNE projection (simplified)
        samplePortfolios.forEach((p, i) => {
            // Map metrics to 2D space
            p.x = (p.sharpe * 50 + p.techExposure * 3 - p.volatility * 5) * 2;
            p.y = (p.drawdown + p.beta * 20 - p.volatility * 2) * 2;
        });

        // Center and scale
        const xExtent = d3.extent(samplePortfolios, d => d.x);
        const yExtent = d3.extent(samplePortfolios, d => d.y);
        const xScale = d3.scaleLinear().domain(xExtent).range([50, vectorWidth - 50]);
        const yScale = d3.scaleLinear().domain(yExtent).range([vectorHeight - 50, 50]);

        const typeColors = {
            'Aggressive Growth': '#EF4444',
            'Balanced': '#3B82F6',
            'Conservative': '#10B981',
            'Bear Market Winners': '#8B5CF6',
            'Current': '#F59E0B'
        };

        function renderVectorSpace() {
            vectorSvg.selectAll('*').remove();

            const g = vectorSvg.append('g');

            // Draw axes
            g.append('line')
                .attr('x1', 50).attr('y1', vectorHeight / 2)
                .attr('x2', vectorWidth - 50).attr('y2', vectorHeight / 2)
                .attr('stroke', '#ccc').attr('stroke-width', 1);

            g.append('line')
                .attr('x1', vectorWidth / 2).attr('y1', 50)
                .attr('x2', vectorWidth / 2).attr('y2', vectorHeight - 50)
                .attr('stroke', '#ccc').attr('stroke-width', 1);

            g.append('text')
                .attr('x', vectorWidth - 40).attr('y', vectorHeight / 2 - 10)
                .attr('class', 'text-xs fill-gray-600 dark:fill-gray-400')
                .text('Risk →');

            g.append('text')
                .attr('x', vectorWidth / 2 + 10).attr('y', 40)
                .attr('class', 'text-xs fill-gray-600 dark:fill-gray-400')
                .text('↑ Return');

            // Draw portfolio points
            const points = g.selectAll('circle')
                .data(samplePortfolios)
                .enter()
                .append('circle')
                .attr('class', 'vector-point')
                .attr('cx', d => xScale(d.x))
                .attr('cy', d => yScale(d.y))
                .attr('r', d => d.isCurrent ? 10 : 6)
                .attr('fill', d => typeColors[d.type])
                .attr('stroke', d => d.isCurrent ? '#000' : 'none')
                .attr('stroke-width', d => d.isCurrent ? 3 : 0)
                .attr('opacity', d => d.isCurrent ? 1 : 0.7)
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('r', d.isCurrent ? 12 : 8);
                    const tooltip = d3.select('#tooltip');
                    tooltip.style('opacity', 1)
                        .html(`
                            <strong>${d.id}</strong><br>
                            Type: ${d.type}<br>
                            Sharpe: ${d.sharpe.toFixed(2)}<br>
                            Max DD: ${d.drawdown.toFixed(1)}%<br>
                            Volatility: ${d.volatility.toFixed(1)}%<br>
                            Tech Exposure: ${d.techExposure.toFixed(0)}%<br>
                            Beta: ${d.beta.toFixed(2)}
                        `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).attr('r', d.isCurrent ? 10 : 6);
                    d3.select('#tooltip').style('opacity', 0);
                });

            // Add current portfolio label
            g.append('text')
                .attr('x', xScale(currentPortfolio.x))
                .attr('y', yScale(currentPortfolio.y) - 15)
                .attr('class', 'text-xs font-bold fill-orange-600')
                .attr('text-anchor', 'middle')
                .text('YOU');
        }

        renderVectorSpace();

        // Find similar portfolios
        document.getElementById('findSimilar').addEventListener('click', () => {
            // Calculate Euclidean distance
            samplePortfolios.forEach(p => {
                if (!p.isCurrent) {
                    p.distance = Math.sqrt(
                        Math.pow(p.sharpe - currentPortfolio.sharpe, 2) +
                        Math.pow(p.drawdown - currentPortfolio.drawdown, 2) / 100 +
                        Math.pow(p.volatility - currentPortfolio.volatility, 2) / 100 +
                        Math.pow(p.techExposure - currentPortfolio.techExposure, 2) / 100 +
                        Math.pow(p.beta - currentPortfolio.beta, 2)
                    );
                }
            });

            const similar = samplePortfolios
                .filter(p => !p.isCurrent)
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5);

            const html = similar.map((p, i) => `
                <div class="p-3 bg-white dark:bg-gray-700 rounded-lg border-2" style="border-color: ${typeColors[p.type]}">
                    <div class="font-bold text-sm mb-1">#${i + 1}: ${p.id}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400">
                        Similarity: ${(100 - p.distance * 20).toFixed(1)}%<br>
                        Sharpe: ${p.sharpe.toFixed(2)} | Vol: ${p.volatility.toFixed(1)}%
                    </div>
                </div>
            `).join('');

            document.getElementById('similarPortfolios').innerHTML = html;

            // Highlight on graph
            vectorSvg.selectAll('circle')
                .transition()
                .duration(500)
                .attr('opacity', d => {
                    if (d.isCurrent) return 1;
                    return similar.includes(d) ? 1 : 0.2;
                })
                .attr('r', d => {
                    if (d.isCurrent) return 10;
                    return similar.includes(d) ? 8 : 6;
                });
        });

        // Clustering
        document.getElementById('runClustering').addEventListener('click', () => {
            renderVectorSpace();

            // Draw cluster boundaries (circles)
            const clusters = [
                { type: 'Aggressive Growth', center: null, radius: 80 },
                { type: 'Balanced', center: null, radius: 70 },
                { type: 'Conservative', center: null, radius: 60 },
                { type: 'Bear Market Winners', center: null, radius: 65 },
            ];

            clusters.forEach(cluster => {
                const clusterPoints = samplePortfolios.filter(p => p.type === cluster.type);
                const centerX = d3.mean(clusterPoints, d => xScale(d.x));
                const centerY = d3.mean(clusterPoints, d => yScale(d.y));

                vectorSvg.append('circle')
                    .attr('cx', centerX)
                    .attr('cy', centerY)
                    .attr('r', 0)
                    .attr('fill', typeColors[cluster.type])
                    .attr('opacity', 0.1)
                    .attr('stroke', typeColors[cluster.type])
                    .attr('stroke-width', 2)
                    .attr('stroke-dasharray', '5,5')
                    .transition()
                    .duration(1000)
                    .attr('r', cluster.radius);

                vectorSvg.append('text')
                    .attr('x', centerX)
                    .attr('y', centerY)
                    .attr('class', 'text-sm font-bold')
                    .attr('text-anchor', 'middle')
                    .attr('opacity', 0)
                    .attr('fill', typeColors[cluster.type])
                    .text(cluster.type)
                    .transition()
                    .duration(1000)
                    .attr('opacity', 0.6);
            });
        });

        // Query examples
        document.querySelectorAll('.query-example').forEach(btn => {
            btn.addEventListener('click', function() {
                const query = this.dataset.query;
                let filtered = [];

                if (query === 'bear') {
                    filtered = samplePortfolios.filter(p => p.type === 'Bear Market Winners');
                } else if (query === 'low-vol') {
                    filtered = samplePortfolios.filter(p => p.volatility < 12 && p.sharpe > 1.3);
                } else if (query === 'diversified') {
                    filtered = samplePortfolios.filter(p => p.techExposure < 30 && p.beta < 0.9);
                }

                vectorSvg.selectAll('circle')
                    .transition()
                    .duration(500)
                    .attr('opacity', d => filtered.includes(d) ? 1 : 0.2)
                    .attr('r', d => {
                        if (d.isCurrent) return 10;
                        return filtered.includes(d) ? 8 : 6;
                    });

                const html = filtered.slice(0, 5).map((p, i) => `
                    <div class="p-3 bg-white dark:bg-gray-700 rounded-lg border-2" style="border-color: ${typeColors[p.type]}">
                        <div class="font-bold text-sm mb-1">${p.id}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">
                            Sharpe: ${p.sharpe.toFixed(2)} | Vol: ${p.volatility.toFixed(1)}%
                        </div>
                    </div>
                `).join('');

                document.getElementById('similarPortfolios').innerHTML = html || '<p class="text-sm text-gray-600 dark:text-gray-400">No matches found.</p>';
            });
        });

        // Cloning & Backtesting
        const originalSvg = d3.select('#originalPortfolio');
        const clonedSvg = d3.select('#clonedPortfolio');
        const cloneWidth = originalSvg.node().getBoundingClientRect().width;
        const cloneHeight = 400;

        let clonedData = null;

        function renderMiniGraph(svg, data, isClone = false) {
            svg.selectAll('*').remove();

            const miniSim = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(cloneWidth / 2, cloneHeight / 2))
                .force('collision', d3.forceCollide().radius(30));

            const linkG = svg.append('g');
            const nodeG = svg.append('g');

            const links = linkG.selectAll('line')
                .data(data.links)
                .enter()
                .append('line')
                .attr('stroke', d => relationshipTypes[d.type].color)
                .attr('stroke-width', 2)
                .attr('opacity', 0.6);

            const nodes = nodeG.selectAll('g')
                .data(data.nodes)
                .enter()
                .append('g');

            nodes.append('circle')
                .attr('r', d => Math.sqrt(d.value) / 20 + 15)
                .attr('fill', d => assetTypes[d.type].color)
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);

            nodes.append('text')
                .attr('class', 'text-xs font-semibold fill-white')
                .attr('text-anchor', 'middle')
                .attr('dy', 3)
                .text(d => d.id.length > 8 ? d.id.substring(0, 7) + '...' : d.id);

            miniSim.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                nodes.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            if (isClone) {
                nodes.style('cursor', 'pointer')
                    .on('click', function(event, d) {
                        d3.select(this).select('circle')
                            .transition()
                            .duration(200)
                            .attr('r', Math.sqrt(d.value) / 20 + 20)
                            .transition()
                            .duration(200)
                            .attr('r', Math.sqrt(d.value) / 20 + 15);
                    });
            }
        }

        // Render original portfolio
        renderMiniGraph(originalSvg, {
            nodes: portfolioData.nodes.slice(0, 5).map(n => ({ ...n })),
            links: portfolioData.links.slice(0, 4).map(l => ({ ...l }))
        });

        document.getElementById('clonePortfolio').addEventListener('click', () => {
            // Deep clone
            clonedData = {
                nodes: JSON.parse(JSON.stringify(portfolioData.nodes.slice(0, 5))),
                links: JSON.parse(JSON.stringify(portfolioData.links.slice(0, 4)))
            };

            renderMiniGraph(clonedSvg, clonedData, true);
            document.getElementById('cloneStatus').innerHTML = '<div class="text-green-600 dark:text-green-400 font-semibold">✓ Portfolio cloned successfully! Click nodes to interact.</div>';
            document.getElementById('modifyClone').disabled = false;
            document.getElementById('modifyClone').classList.remove('opacity-50');
        });

        document.getElementById('modifyClone').addEventListener('click', () => {
            if (clonedData) {
                // Add a new hedging relationship
                const newOption = {
                    id: 'New Hedge',
                    type: 'option',
                    value: 3000,
                    contracts: 3
                };
                clonedData.nodes.push(newOption);
                clonedData.links.push({
                    source: clonedData.nodes[0].id,
                    target: 'New Hedge',
                    type: 'hedging'
                });

                renderMiniGraph(clonedSvg, clonedData, true);
                document.getElementById('cloneStatus').innerHTML = '<div class="text-blue-600 dark:text-blue-400 font-semibold">✓ Modified: Added new hedging position!</div>';
            }
        });

        // Backtest charts (simple line charts using canvas)
        function drawSimpleChart(canvasId, values, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2;
            const height = canvas.height = canvas.offsetHeight * 2;

            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();

            const xStep = width / (values.length - 1);
            const yMin = Math.min(...values);
            const yMax = Math.max(...values);
            const yRange = yMax - yMin;

            values.forEach((val, i) => {
                const x = i * xStep;
                const y = height - ((val - yMin) / yRange) * height;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();
        }

        // Generate sample backtest data
        function generateBacktestData(volatility, trend) {
            const data = [1000000];
            for (let i = 1; i < 50; i++) {
                const change = (Math.random() - 0.5) * volatility + trend;
                data.push(data[i - 1] * (1 + change / 100));
            }
            return data;
        }

        const chartDataOriginal = generateBacktestData(2, 0.8);
        const chartDataHedged = generateBacktestData(1.5, 0.7);
        const chartDataRebalanced = generateBacktestData(2.2, 1.0);

        drawSimpleChart('chartOriginal', chartDataOriginal, '#10B981');
        drawSimpleChart('chartHedged', chartDataHedged, '#3B82F6');
        drawSimpleChart('chartRebalanced', chartDataRebalanced, '#8B5CF6');

        document.getElementById('runBacktest').addEventListener('click', function() {
            this.innerHTML = '<span class="animate-pulse">Running backtest...</span>';
            setTimeout(() => {
                this.innerHTML = '✓ Backtest Complete - Scenario C performed best!';
                this.classList.add('bg-green-600');
                this.classList.remove('bg-primary');
            }, 2000);
        });

        // Initialize
        updateGraph();
    </script>
</body>
</html>