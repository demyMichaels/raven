<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow - Smart Study Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4A49B8',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .gantt-bar {
            transition: all 0.3s ease;
        }
        .gantt-bar:hover {
            transform: scaleY(1.1);
            filter: brightness(1.1);
        }
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1s linear;
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 min-h-screen transition-colors">

<!-- Navigation -->
<nav class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center space-x-3">
                <i class="fas fa-graduation-cap text-2xl text-primary"></i>
                <span class="text-xl font-bold">StudyFlow</span>
            </div>
            <div class="flex items-center space-x-6">
                <button onclick="navigateTo('study')" class="nav-link text-base hover:text-primary transition-colors">
                    <i class="fas fa-book mr-2"></i>Study
                </button>
                <button onclick="navigateTo('schedule')" class="nav-link text-base hover:text-primary transition-colors">
                    <i class="fas fa-calendar mr-2"></i>Schedule
                </button>
                <button onclick="navigateTo('analytics')" class="nav-link text-base hover:text-primary transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>Analytics
                </button>
                <button onclick="navigateTo('settings')" class="nav-link text-base hover:text-primary transition-colors">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content Container -->
<div id="app-content" class="animate-fade-in"></div>


<script>
// ======================
// State Management
// ======================
const AppState = {
    currentPage: 'study',
    studyData: null,
    activeSession: null,

    init() {
        // Load data from localStorage
        const saved = localStorage.getItem('studyFlowData');
        if (saved) {
            this.studyData = JSON.parse(saved);
        } else {
            // Initialize with sample data
            this.studyData = this.getDefaultData();
            this.save();
        }
    },

    save() {
        localStorage.setItem('studyFlowData', JSON.stringify(this.studyData));
    },

    getDefaultData() {
        const today = new Date();
        const examDate = new Date(today);
        examDate.setDate(examDate.getDate() + 90); // 90 days from now

        return {
            examDate: examDate.toISOString(),
            subjects: [
                {
                    id: 1,
                    name: 'Mathematics',
                    color: '#3B82F6',
                    progress: 68,
                    topics: [
                        { id: 1, name: 'Calculus', completed: true, confidence: 3, hoursSpent: 8, hoursPlanned: 8 },
                        { id: 2, name: 'Linear Algebra', completed: true, confidence: 2, hoursSpent: 6, hoursPlanned: 6 },
                        { id: 3, name: 'Statistics', completed: false, confidence: 0, hoursSpent: 0, hoursPlanned: 10 },
                        { id: 4, name: 'Probability', completed: false, confidence: 0, hoursSpent: 0, hoursPlanned: 8 }
                    ]
                },
                {
                    id: 2,
                    name: 'Physics',
                    color: '#10B981',
                    progress: 45,
                    topics: [
                        { id: 1, name: 'Mechanics', completed: true, confidence: 3, hoursSpent: 12, hoursPlanned: 12 },
                        { id: 2, name: 'Thermodynamics', completed: false, confidence: 1, hoursSpent: 4, hoursPlanned: 10 },
                        { id: 3, name: 'Electromagnetism', completed: false, confidence: 0, hoursSpent: 0, hoursPlanned: 14 }
                    ]
                },
                {
                    id: 3,
                    name: 'Chemistry',
                    color: '#F59E0B',
                    progress: 72,
                    topics: [
                        { id: 1, name: 'Organic Chemistry', completed: true, confidence: 3, hoursSpent: 15, hoursPlanned: 15 },
                        { id: 2, name: 'Inorganic Chemistry', completed: true, confidence: 2, hoursSpent: 10, hoursPlanned: 10 },
                        { id: 3, name: 'Physical Chemistry', completed: false, confidence: 1, hoursSpent: 5, hoursPlanned: 12 }
                    ]
                },
                {
                    id: 4,
                    name: 'Biology',
                    color: '#EF4444',
                    progress: 55,
                    topics: [
                        { id: 1, name: 'Cell Biology', completed: true, confidence: 3, hoursSpent: 8, hoursPlanned: 8 },
                        { id: 2, name: 'Genetics', completed: false, confidence: 2, hoursSpent: 6, hoursPlanned: 10 },
                        { id: 3, name: 'Ecology', completed: false, confidence: 0, hoursSpent: 0, hoursPlanned: 8 }
                    ]
                }
            ],
            schedule: this.generateSchedule(),
            streak: 7,
            studySessions: [],
            settings: {
                intensity: 'medium',
                hoursPerDay: 4,
                studyDays: [1, 2, 3, 4, 5, 6], // Mon-Sat
                revisionBuffer: 20
            }
        };
    },

    generateSchedule() {
        const schedule = [];
        const today = new Date();

        for (let i = 0; i < 30; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() + i);

            if (date.getDay() === 0) continue; // Skip Sundays

            const daySchedule = {
                date: date.toISOString(),
                sessions: []
            };

            // Add 2-3 study sessions per day
            const sessionCount = Math.floor(Math.random() * 2) + 2;
            const subjects = this.getDefaultData().subjects;

            for (let j = 0; j < sessionCount; j++) {
                const subject = subjects[Math.floor(Math.random() * subjects.length)];
                const topic = subject.topics[Math.floor(Math.random() * subject.topics.length)];

                daySchedule.sessions.push({
                    subject: subject.name,
                    topic: topic.name,
                    duration: Math.floor(Math.random() * 60) + 30, // 30-90 mins
                    completed: i < 0 ? Math.random() > 0.3 : false
                });
            }

            schedule.push(daySchedule);
        }

        return schedule;
    },

    getOverallProgress() {
        if (!this.studyData || !this.studyData.subjects) return 0;
        const avg = this.studyData.subjects.reduce((sum, s) => sum + s.progress, 0) / this.studyData.subjects.length;
        return Math.round(avg);
    },

    getDaysUntilExam() {
        const exam = new Date(this.studyData.examDate);
        const today = new Date();
        const diff = exam - today;
        return Math.ceil(diff / (1000 * 60 * 60 * 24));
    },

    getTodaysSchedule() {
        const today = new Date().toISOString().split('T')[0];
        const todaySchedule = this.studyData.schedule.find(s => s.date.startsWith(today));
        return todaySchedule ? todaySchedule.sessions : [];
    }
};

// ======================
// Page Renderers
// ======================

// PAGE 1: Study Overview Dashboard
function renderStudyDashboard() {
    const progress = AppState.getOverallProgress();
    const daysUntil = AppState.getDaysUntilExam();
    const todaysSessions = AppState.getTodaysSchedule();

    const motivationalQuotes = [
        "Success is the sum of small efforts repeated day in and day out.",
        "The expert in anything was once a beginner.",
        "Study while others are sleeping; work while others are loafing.",
        "Your future is created by what you do today, not tomorrow."
    ];
    const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];

    return `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header Section -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">Today's Study Session</h1>
                <p class="text-gray-600 dark:text-gray-400">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                <p class="text-primary italic mt-3">"${quote}"</p>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gradient-to-br from-primary to-primary-dark text-white rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Day Streak</p>
                            <p class="text-4xl font-bold mt-2">${AppState.studyData.streak}</p>
                        </div>
                        <i class="fas fa-fire text-5xl opacity-20"></i>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Days Until Exam</p>
                            <p class="text-4xl font-bold mt-2">${daysUntil}</p>
                        </div>
                        <i class="fas fa-calendar-check text-5xl opacity-20"></i>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90">Overall Progress</p>
                            <p class="text-4xl font-bold mt-2">${progress}%</p>
                        </div>
                        <i class="fas fa-chart-line text-5xl opacity-20"></i>
                    </div>
                </div>
            </div>

            <!-- Main Cards Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Today's Plan Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-list-check text-primary mr-2"></i>
                        Today's Plan
                    </h2>
                    <div class="space-y-3 mb-6">
                        ${todaysSessions.length > 0 ? todaysSessions.map(session => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                <div>
                                    <p class="font-semibold">${session.subject} - ${session.topic}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${session.duration} minutes</p>
                                </div>
                                ${session.completed ?
                                    '<i class="fas fa-check-circle text-green-500 text-xl"></i>' :
                                    '<i class="far fa-circle text-gray-400 text-xl"></i>'
                                }
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-8">No study sessions scheduled for today. Take a break! üéâ</p>'}
                    </div>
                    ${todaysSessions.length > 0 ? `
                        <button onclick="navigateTo('pre-session')" class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-4 rounded-xl transition-colors text-lg">
                            <i class="fas fa-play mr-2"></i>Start Studying
                        </button>
                        <button onclick="navigateTo('calendar')" class="w-full mt-3 text-primary hover:underline text-base">
                            See Full Week ‚Üí
                        </button>
                    ` : ''}
                </div>

                <!-- Progress Overview Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-pie text-primary mr-2"></i>
                        Progress Overview
                    </h2>

                    <!-- Circular Progress -->
                    <div class="flex justify-center mb-6">
                        <div class="relative w-40 h-40">
                            <svg class="transform -rotate-90 w-40 h-40">
                                <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent" class="text-gray-200 dark:text-gray-700"/>
                                <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="12" fill="transparent"
                                    class="text-primary"
                                    style="stroke-dasharray: 439.6; stroke-dashoffset: ${439.6 * (1 - progress / 100)}"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-3xl font-bold">${progress}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Subject Progress Bars -->
                    <div class="space-y-3 mb-4">
                        ${AppState.studyData.subjects.map(subject => `
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>${subject.name}</span>
                                    <span class="font-semibold">${subject.progress}%</span>
                                </div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all" style="width: ${subject.progress}%; background-color: ${subject.color}"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button onclick="navigateTo('analytics')" class="w-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold py-3 rounded-xl transition-colors">
                        View Detailed Analytics
                    </button>
                </div>

                <!-- Upcoming Deadlines Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-clock text-primary mr-2"></i>
                        Upcoming Deadlines
                    </h2>
                    <div class="space-y-4">
                        <div class="flex items-start space-x-3 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border-l-4 border-red-500">
                            <i class="fas fa-exclamation-circle text-red-500 mt-1"></i>
                            <div>
                                <p class="font-semibold text-red-700 dark:text-red-400">Chemistry Mock Exam</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">In 3 days</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-500">
                            <i class="fas fa-flag text-yellow-500 mt-1"></i>
                            <div>
                                <p class="font-semibold text-yellow-700 dark:text-yellow-400">Week 8 Milestone</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Complete 75% of syllabus</p>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500">
                            <i class="fas fa-book text-blue-500 mt-1"></i>
                            <div>
                                <p class="font-semibold text-blue-700 dark:text-blue-400">Physics Revision</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Start in 1 week</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt text-primary mr-2"></i>
                        Quick Actions
                    </h2>
                    <div class="space-y-3">
                        <button onclick="navigateTo('reschedule')" class="w-full flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <span class="flex items-center">
                                <i class="fas fa-calendar-alt text-orange-500 mr-3 text-xl"></i>
                                <span class="font-semibold">Reschedule Plan</span>
                            </span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="showCustomSessionModal()" class="w-full flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <span class="flex items-center">
                                <i class="fas fa-plus-circle text-green-500 mr-3 text-xl"></i>
                                <span class="font-semibold">Add Custom Session</span>
                            </span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="navigateTo('practice-test')" class="w-full flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <span class="flex items-center">
                                <i class="fas fa-pen-to-square text-blue-500 mr-3 text-xl"></i>
                                <span class="font-semibold">Take Practice Test</span>
                            </span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>

                        <button onclick="navigateTo('settings')" class="w-full flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <span class="flex items-center">
                                <i class="fas fa-sliders text-purple-500 mr-3 text-xl"></i>
                                <span class="font-semibold">Adjust Study Settings</span>
                            </span>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// PAGE 2: Calendar View
function renderCalendarView() {
    const schedule = AppState.studyData.schedule.slice(0, 7); // Next 7 days

    return `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Weekly Schedule</h1>
                <div class="flex space-x-3">
                    <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
                        Week
                    </button>
                    <button onclick="navigateTo('gantt')" class="px-4 py-2 bg-gray-200 dark:bg-gray-800 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                        Gantt View
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                ${schedule.map(day => {
                    const date = new Date(day.date);
                    const isToday = date.toDateString() === new Date().toDateString();
                    const completedCount = day.sessions.filter(s => s.completed).length;
                    const totalCount = day.sessions.length;

                    return `
                        <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border ${isToday ? 'border-primary' : 'border-gray-200 dark:border-gray-800'}">
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">${date.toLocaleDateString('en-US', { weekday: 'short' })}</p>
                                <p class="text-2xl font-bold">${date.getDate()}</p>
                                ${isToday ? '<span class="text-xs bg-primary text-white px-2 py-1 rounded-full">Today</span>' : ''}
                                <p class="text-sm mt-2 text-gray-600 dark:text-gray-400">${completedCount}/${totalCount} completed</p>
                            </div>

                            <div class="space-y-2">
                                ${day.sessions.map(session => `
                                    <div class="p-3 rounded-lg border-l-4 ${session.completed ? 'bg-green-50 dark:bg-green-900/20 border-green-500' : 'bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-700'}">
                                        <p class="font-semibold text-sm">${session.subject}</p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">${session.topic}</p>
                                        <p class="text-xs mt-1">${session.duration} min</p>
                                    </div>
                                `).join('')}
                            </div>

                            ${!isToday ? '' : `
                                <button onclick="navigateTo('pre-session')" class="w-full mt-4 bg-primary text-white py-2 rounded-lg hover:bg-primary-dark transition-colors text-sm">
                                    Start Session
                                </button>
                            `}
                        </div>
                    `;
                }).join('')}
            </div>

            <div class="mt-8 text-center">
                <button onclick="navigateTo('study')" class="text-primary hover:underline">
                    ‚Üê Back to Dashboard
                </button>
            </div>
        </div>
    `;
}

// PAGE 3: Gantt Chart View
function renderGanttView() {
    const subjects = AppState.studyData.subjects;
    const today = new Date();
    const examDate = new Date(AppState.studyData.examDate);
    const totalDays = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));

    return `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Gantt Chart View</h1>
                <button onclick="navigateTo('calendar')" class="px-4 py-2 bg-gray-200 dark:bg-gray-800 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-calendar mr-2"></i>Calendar View
                </button>
            </div>

            <!-- Legend -->
            <div class="mb-6 flex flex-wrap gap-4 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-green-500 rounded"></div>
                    <span class="text-sm">Completed</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                    <span class="text-sm">In Progress</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-blue-500 rounded"></div>
                    <span class="text-sm">Planned</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-4 h-4 bg-red-500 rounded"></div>
                    <span class="text-sm">Behind Schedule</span>
                </div>
            </div>

            <!-- Gantt Chart -->
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800 overflow-x-auto">
                <div style="min-width: 800px;">
                    <!-- Timeline Header -->
                    <div class="flex mb-4">
                        <div class="w-48 font-semibold">Subject</div>
                        <div class="flex-1 flex justify-between text-xs text-gray-600 dark:text-gray-400">
                            <span>Today</span>
                            <span>Week 4</span>
                            <span>Week 8</span>
                            <span>Exam Day</span>
                        </div>
                    </div>

                    <!-- Subject Rows -->
                    ${subjects.map(subject => {
                        const completedTopics = subject.topics.filter(t => t.completed).length;
                        const totalTopics = subject.topics.length;
                        const progressPercent = (completedTopics / totalTopics) * 100;

                        let barColor = subject.color;
                        if (progressPercent === 100) barColor = '#10B981'; // green
                        else if (progressPercent > 0) barColor = '#F59E0B'; // yellow
                        else if (progressPercent < 50) barColor = '#EF4444'; // red if behind

                        return `
                            <div class="mb-4">
                                <div class="flex items-center">
                                    <div class="w-48">
                                        <p class="font-semibold">${subject.name}</p>
                                        <p class="text-xs text-gray-600 dark:text-gray-400">${subject.progress}% complete</p>
                                    </div>
                                    <div class="flex-1 relative h-12">
                                        <div class="absolute inset-0 bg-gray-100 dark:bg-gray-800 rounded-lg"></div>
                                        <div class="absolute left-0 top-0 h-full gantt-bar rounded-lg flex items-center px-3 cursor-pointer"
                                             style="width: ${subject.progress}%; background-color: ${barColor}"
                                             title="${subject.name}: ${subject.progress}%">
                                            <span class="text-white text-sm font-semibold">${subject.progress}%</span>
                                        </div>
                                        <!-- Today line -->
                                        <div class="absolute top-0 bottom-0 w-0.5 bg-red-500" style="left: ${(totalDays > 0 ? ((totalDays - Math.ceil((examDate - today) / (1000 * 60 * 60 * 24))) / totalDays * 100) : 0)}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <!-- Zoom Controls -->
            <div class="mt-6 flex justify-center space-x-4">
                <button class="px-4 py-2 bg-gray-200 dark:bg-gray-800 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-search-minus mr-2"></i>Subject Level
                </button>
                <button class="px-4 py-2 bg-gray-200 dark:bg-gray-800 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-search-plus mr-2"></i>Topic Level
                </button>
            </div>

            <div class="mt-8 text-center">
                <button onclick="navigateTo('study')" class="text-primary hover:underline">
                    ‚Üê Back to Dashboard
                </button>
            </div>
        </div>
    `;
}

// PAGE 4: Subject Detail
function renderSubjectDetail(subjectId = 1) {
    const subject = AppState.studyData.subjects.find(s => s.id === subjectId);
    if (!subject) return renderStudyDashboard();

    const totalHoursSpent = subject.topics.reduce((sum, t) => sum + t.hoursSpent, 0);
    const totalHoursPlanned = subject.topics.reduce((sum, t) => sum + t.hoursPlanned, 0);
    const weakTopics = subject.topics.filter(t => t.confidence < 2 && !t.completed);

    return `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <button onclick="navigateTo('study')" class="mb-6 text-primary hover:underline">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </button>

            <div class="mb-8">
                <h1 class="text-3xl font-bold mb-2">${subject.name}</h1>
                <div class="flex items-center space-x-4">
                    <div class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Progress: </span>
                        <span class="font-bold" style="color: ${subject.color}">${subject.progress}%</span>
                    </div>
                    <div class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Time: </span>
                        <span class="font-bold">${totalHoursSpent}h / ${totalHoursPlanned}h</span>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all" style="width: ${subject.progress}%; background-color: ${subject.color}"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Topics List -->
                <div class="lg:col-span-2 bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800">
                    <h2 class="text-xl font-bold mb-4">Topics</h2>
                    <div class="space-y-3">
                        ${subject.topics.map(topic => {
                            const confidenceColors = ['text-gray-400', 'text-red-500', 'text-yellow-500', 'text-green-500'];
                            const confidenceLabels = ['Not Started', 'Shaky', 'Getting There', 'Confident'];

                            return `
                                <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-3">
                                            <input type="checkbox" ${topic.completed ? 'checked' : ''}
                                                   class="w-5 h-5 rounded border-gray-300"
                                                   onchange="toggleTopicCompletion(${subject.id}, ${topic.id})">
                                            <span class="font-semibold ${topic.completed ? 'line-through text-gray-500' : ''}">${topic.name}</span>
                                        </div>
                                        <span class="${confidenceColors[topic.confidence]} text-sm font-semibold">
                                            ${confidenceLabels[topic.confidence]}
                                        </span>
                                    </div>
                                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 ml-8">
                                        <span><i class="fas fa-clock mr-1"></i>${topic.hoursSpent}h / ${topic.hoursPlanned}h</span>
                                        <div class="flex space-x-1">
                                            ${[1,2,3].map(level => `
                                                <i class="fas fa-star ${topic.confidence >= level ? confidenceColors[topic.confidence] : 'text-gray-300 dark:text-gray-700'}"
                                                   onclick="setTopicConfidence(${subject.id}, ${topic.id}, ${level})"></i>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- Stats & Actions -->
                <div class="space-y-6">
                    <!-- Time Analytics -->
                    <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800">
                        <h3 class="font-bold mb-4">Time Analytics</h3>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Time Spent</span>
                                    <span class="font-semibold">${totalHoursSpent}h</span>
                                </div>
                                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 rounded-full" style="width: ${(totalHoursSpent/totalHoursPlanned)*100}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Remaining</span>
                                    <span class="font-semibold">${totalHoursPlanned - totalHoursSpent}h</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weak Areas -->
                    ${weakTopics.length > 0 ? `
                        <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-red-200 dark:border-red-900">
                            <h3 class="font-bold mb-4 text-red-600 dark:text-red-400">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Weak Areas
                            </h3>
                            <div class="space-y-2 mb-4">
                                ${weakTopics.map(t => `
                                    <div class="text-sm p-2 bg-red-50 dark:bg-red-900/20 rounded">
                                        ${t.name}
                                    </div>
                                `).join('')}
                            </div>
                            <button class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg transition-colors text-sm">
                                Focus on Weak Topics
                            </button>
                        </div>
                    ` : ''}

                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-lg border border-gray-200 dark:border-gray-800">
                        <h3 class="font-bold mb-4">Quick Actions</h3>
                        <div class="space-y-2">
                            <button onclick="navigateTo('pre-session')" class="w-full bg-primary hover:bg-primary-dark text-white py-2 rounded-lg transition-colors text-sm">
                                <i class="fas fa-play mr-2"></i>Start Study Session
                            </button>
                            <button class="w-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 py-2 rounded-lg transition-colors text-sm">
                                <i class="fas fa-calendar mr-2"></i>Schedule Review
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// PAGE 5: Pre-Session Setup
function renderPreSession() {
    const todaysSessions = AppState.getTodaysSchedule();
    const nextSession = todaysSessions.find(s => !s.completed) || todaysSessions[0] || {
        subject: 'Mathematics',
        topic: 'Calculus',
        duration: 45
    };

    return `
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <button onclick="navigateTo('study')" class="mb-6 text-primary hover:underline">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </button>

            <div class="bg-white dark:bg-gray-900 rounded-2xl p-8 shadow-lg border border-gray-200 dark:border-gray-800">
                <h1 class="text-3xl font-bold mb-2 text-center">Ready to Study?</h1>
                <p class="text-center text-gray-600 dark:text-gray-400 mb-8">Let's make this session count!</p>

                <!-- Session Info -->
                <div class="mb-8 p-6 bg-gradient-to-br from-primary/10 to-primary/5 rounded-xl border border-primary/20">
                    <h2 class="text-2xl font-bold mb-2">${nextSession.subject}</h2>
                    <p class="text-xl text-gray-700 dark:text-gray-300 mb-4">${nextSession.topic}</p>
                    <div class="flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-400">
                        <span><i class="fas fa-clock mr-2"></i>Estimated: ${nextSession.duration} minutes</span>
                        <span><i class="fas fa-calendar mr-2"></i>${new Date().toLocaleDateString()}</span>
                    </div>
                </div>

                <!-- Learning Objectives -->
                <div class="mb-8">
                    <h3 class="font-bold mb-3">Learning Objectives</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
                            <span>Understand core concepts and principles</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
                            <span>Practice problem-solving techniques</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
                            <span>Review and reinforce previous knowledge</span>
                        </li>
                    </ul>
                </div>

                <!-- Quick Links -->
                <div class="mb-8">
                    <h3 class="font-bold mb-3">Quick Links</h3>
                    <div class="flex flex-wrap gap-3">
                        <button class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-sm">
                            <i class="fas fa-file-pdf mr-2"></i>Study Notes
                        </button>
                        <button class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-sm">
                            <i class="fas fa-video mr-2"></i>Video Lectures
                        </button>
                        <button class="px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-sm">
                            <i class="fas fa-book mr-2"></i>Textbook Chapter
                        </button>
                    </div>
                </div>

                <!-- Timer Options -->
                <div class="mb-8">
                    <h3 class="font-bold mb-3">Timer Mode</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="startSession('pomodoro')" class="p-4 bg-gray-50 dark:bg-gray-800 hover:bg-primary/10 dark:hover:bg-primary/20 border-2 border-transparent hover:border-primary rounded-lg transition-all">
                            <i class="fas fa-clock text-2xl text-primary mb-2"></i>
                            <p class="font-semibold">Pomodoro</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">25 min + 5 min break</p>
                        </button>
                        <button onclick="startSession('custom')" class="p-4 bg-gray-50 dark:bg-gray-800 hover:bg-primary/10 dark:hover:bg-primary/20 border-2 border-transparent hover:border-primary rounded-lg transition-all">
                            <i class="fas fa-sliders text-2xl text-primary mb-2"></i>
                            <p class="font-semibold">Custom Timer</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Set your own time</p>
                        </button>
                        <button onclick="startSession('none')" class="p-4 bg-gray-50 dark:bg-gray-800 hover:bg-primary/10 dark:hover:bg-primary/20 border-2 border-transparent hover:border-primary rounded-lg transition-all">
                            <i class="fas fa-infinity text-2xl text-primary mb-2"></i>
                            <p class="font-semibold">No Timer</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Study at your pace</p>
                        </button>
                    </div>
                </div>

                <!-- Start Button -->
                <button onclick="startSession('pomodoro')" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl transition-colors text-xl">
                    <i class="fas fa-play mr-2"></i>Start Session
                </button>
            </div>
        </div>
    `;
}

// PAGE 6: Active Study Session
function renderActiveSession() {
    const session = AppState.activeSession || {
        topic: 'Calculus',
        subject: 'Mathematics',
        duration: 25 * 60, // 25 minutes in seconds
        elapsed: 0,
        mode: 'pomodoro'
    };

    return `
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div class="text-center">
                <h2 class="text-2xl font-bold mb-2">${session.subject}</h2>
                <p class="text-xl text-gray-600 dark:text-gray-400 mb-12">${session.topic}</p>

                <!-- Timer Display -->
                <div class="mb-12">
                    <svg class="mx-auto" width="300" height="300">
                        <circle cx="150" cy="150" r="140" fill="none" stroke="currentColor" stroke-width="8" class="text-gray-200 dark:text-gray-700"/>
                        <circle id="timer-progress" cx="150" cy="150" r="140" fill="none" stroke="currentColor" stroke-width="8"
                                class="text-primary timer-circle" transform="rotate(-90 150 150)"/>
                        <text x="150" y="150" text-anchor="middle" dy=".3em" class="text-6xl font-bold fill-current" id="timer-display">
                            25:00
                        </text>
                    </svg>
                </div>

                <!-- Controls -->
                <div class="flex justify-center space-x-4 mb-12">
                    <button id="pause-btn" onclick="toggleTimer()" class="w-16 h-16 bg-primary hover:bg-primary-dark text-white rounded-full transition-colors flex items-center justify-center">
                        <i class="fas fa-pause text-2xl"></i>
                    </button>
                    <button onclick="showConfirmEndSession()" class="w-16 h-16 bg-red-500 hover:bg-red-600 text-white rounded-full transition-colors flex items-center justify-center">
                        <i class="fas fa-stop text-2xl"></i>
                    </button>
                </div>

                <!-- Quick Note -->
                <button onclick="showQuickNoteModal()" class="px-6 py-3 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="fas fa-sticky-note mr-2"></i>Quick Note
                </button>

                <!-- Session Stats -->
                <div class="mt-12 grid grid-cols-3 gap-6 max-w-md mx-auto">
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Sessions Today</p>
                        <p class="text-2xl font-bold">3</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Focus Time</p>
                        <p class="text-2xl font-bold">2.5h</p>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Streak</p>
                        <p class="text-2xl font-bold">${AppState.studyData.streak}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// PAGE 7: Session Completion
function renderSessionReview() {
    return `
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-8 shadow-lg border border-gray-200 dark:border-gray-800">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check text-4xl text-green-500"></i>
                    </div>
                    <h1 class="text-3xl font-bold mb-2">Great Work!</h1>
                    <p class="text-gray-600 dark:text-gray-400">You've completed your study session</p>
                </div>

                <!-- Session Summary -->
                <div class="mb-8 p-6 bg-gray-50 dark:bg-gray-800 rounded-xl">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Time Planned</p>
                            <p class="text-2xl font-bold">45 min</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">Actual Time</p>
                            <p class="text-2xl font-bold">42 min</p>
                        </div>
                    </div>
                </div>

                <!-- Feedback Form -->
                <form onsubmit="completeSession(event)" class="space-y-6">
                    <!-- Mood Rating -->
                    <div>
                        <label class="block font-bold mb-3">How did it go?</label>
                        <div class="flex justify-center space-x-6">
                            <button type="button" onclick="selectMood(1)" class="mood-btn text-5xl hover:scale-110 transition-transform" data-mood="1">üòä</button>
                            <button type="button" onclick="selectMood(2)" class="mood-btn text-5xl hover:scale-110 transition-transform" data-mood="2">üòê</button>
                            <button type="button" onclick="selectMood(3)" class="mood-btn text-5xl hover:scale-110 transition-transform" data-mood="3">üòû</button>
                        </div>
                        <input type="hidden" id="mood-input" required>
                    </div>

                    <!-- Confidence Meter -->
                    <div>
                        <label class="block font-bold mb-3">Confidence Level</label>
                        <div class="grid grid-cols-3 gap-4">
                            <button type="button" onclick="selectConfidence(1)" class="confidence-btn p-4 border-2 border-gray-300 dark:border-gray-700 rounded-lg hover:border-red-500 transition-colors">
                                <p class="font-semibold text-red-500">Shaky</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Need more practice</p>
                            </button>
                            <button type="button" onclick="selectConfidence(2)" class="confidence-btn p-4 border-2 border-gray-300 dark:border-gray-700 rounded-lg hover:border-yellow-500 transition-colors">
                                <p class="font-semibold text-yellow-500">Getting There</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Making progress</p>
                            </button>
                            <button type="button" onclick="selectConfidence(3)" class="confidence-btn p-4 border-2 border-gray-300 dark:border-gray-700 rounded-lg hover:border-green-500 transition-colors">
                                <p class="font-semibold text-green-500">Confident</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Got it down!</p>
                            </button>
                        </div>
                        <input type="hidden" id="confidence-input" required>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block font-bold mb-3">Key Takeaways (Optional)</label>
                        <textarea id="session-notes" rows="4"
                                  class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                  placeholder="What did you learn? Any insights or questions?"></textarea>
                    </div>

                    <!-- Schedule Review -->
                    <div class="flex items-center space-x-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <input type="checkbox" id="schedule-review" class="w-5 h-5 rounded border-gray-300">
                        <label for="schedule-review" class="text-sm">
                            <span class="font-semibold">Schedule a review session</span>
                            <span class="text-gray-600 dark:text-gray-400"> (Recommended for spaced repetition)</span>
                        </label>
                    </div>

                    <!-- Submit -->
                    <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl transition-colors">
                        Complete & Continue
                    </button>
                </form>
            </div>
        </div>
    `;
}

// PAGE 8: Reschedule Wizard
function renderRescheduleWizard(step = 1) {
    const steps = ['Reason', 'Duration', 'Strategy', 'Preview', 'Confirm'];

    let content = '';

    if (step === 1) {
        content = `
            <h2 class="text-2xl font-bold mb-6">What happened?</h2>
            <div class="space-y-3">
                <button onclick="rescheduleStep(2, 'missed')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg mb-1">Missed Sessions</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">I couldn't complete my planned study sessions</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </button>
                <button onclick="rescheduleStep(2, 'behind')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg mb-1">Fell Behind</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">My progress is slower than planned</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </button>
                <button onclick="rescheduleStep(2, 'moretime')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg mb-1">Need More Time on Topic</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">A specific topic needs more attention</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </button>
                <button onclick="rescheduleStep(2, 'event')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-bold text-lg mb-1">Unexpected Event</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Life happened, need to adjust schedule</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </button>
            </div>
        `;
    } else if (step === 2) {
        content = `
            <h2 class="text-2xl font-bold mb-6">How much time was affected?</h2>
            <div class="space-y-3">
                <button onclick="rescheduleStep(3, 'today')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <p class="font-bold text-lg">Just Today</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">One day adjustment needed</p>
                </button>
                <button onclick="rescheduleStep(3, 'fewdays')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <p class="font-bold text-lg">Last Few Days</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">2-3 days behind schedule</p>
                </button>
                <button onclick="rescheduleStep(3, 'week')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <p class="font-bold text-lg">This Entire Week</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Significant catch-up needed</p>
                </button>
            </div>
        `;
    } else if (step === 3) {
        content = `
            <h2 class="text-2xl font-bold mb-4">Recommended Strategy</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Based on your situation, here are some options:</p>
            <div class="space-y-3">
                <button onclick="rescheduleStep(4, 'slow')" class="w-full p-6 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-xl text-left transition-colors border-2 border-blue-200 dark:border-blue-900">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-star text-blue-500 mr-2"></i>
                        <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">Recommended</span>
                    </div>
                    <p class="font-bold text-lg mb-1">Catch Up Slowly</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Add 30 minutes per day to gradually catch up</p>
                    <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">Impact: Extends timeline by 3 days</p>
                </button>
                <button onclick="rescheduleStep(4, 'power')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <p class="font-bold text-lg mb-1">Power Weekend</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Dedicate this weekend to catch up</p>
                    <p class="text-xs text-gray-500 mt-2">Impact: 6-8 hours of focused study</p>
                </button>
                <button onclick="rescheduleStep(4, 'triage')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <p class="font-bold text-lg mb-1">Triage Mode</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Drop low-priority topics to stay on track</p>
                    <p class="text-xs text-orange-600 dark:text-orange-400 mt-2">Warning: Some topics will be skipped</p>
                </button>
                <button onclick="rescheduleStep(4, 'custom')" class="w-full p-6 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl text-left transition-colors border-2 border-transparent hover:border-primary">
                    <p class="font-bold text-lg mb-1">Custom Reshuffle</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Manually adjust your schedule</p>
                </button>
            </div>
        `;
    } else if (step === 4) {
        content = `
            <h2 class="text-2xl font-bold mb-6">Preview Changes</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="p-6 bg-gray-50 dark:bg-gray-800 rounded-xl">
                    <h3 class="font-bold mb-4 text-gray-600 dark:text-gray-400">Current Schedule</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Daily Study Time:</span>
                            <span class="font-bold">4 hours</span>
                        </div>
                        <div class="flex justify-between">
                            <span>End Date:</span>
                            <span class="font-bold">${new Date(AppState.studyData.examDate).toLocaleDateString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Topics Remaining:</span>
                            <span class="font-bold">12</span>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-green-50 dark:bg-green-900/20 rounded-xl border-2 border-green-500">
                    <h3 class="font-bold mb-4 text-green-700 dark:text-green-400">New Schedule</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Daily Study Time:</span>
                            <span class="font-bold">4.5 hours</span>
                        </div>
                        <div class="flex justify-between">
                            <span>End Date:</span>
                            <span class="font-bold">${new Date(new Date(AppState.studyData.examDate).getTime() + 3*24*60*60*1000).toLocaleDateString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Topics Remaining:</span>
                            <span class="font-bold">12</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-blue-50 dark:bg-blue-900/20 rounded-xl mb-8">
                <h3 class="font-bold mb-3"><i class="fas fa-info-circle text-blue-500 mr-2"></i>Impact Summary</h3>
                <ul class="space-y-2 text-sm">
                    <li>‚úì All topics will still be covered</li>
                    <li>‚úì Moderate pace - sustainable long-term</li>
                    <li>‚úì Maintains revision buffer of 20%</li>
                    <li>‚ö†Ô∏è Timeline extended by 3 days</li>
                </ul>
            </div>

            <div class="flex space-x-4">
                <button onclick="rescheduleStep(3)" class="flex-1 px-6 py-3 bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button onclick="rescheduleStep(5)" class="flex-1 px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
                    Continue<i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        `;
    } else if (step === 5) {
        content = `
            <div class="text-center">
                <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-check text-4xl text-green-500"></i>
                </div>
                <h2 class="text-2xl font-bold mb-4">Schedule Updated!</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-8">Your study plan has been adjusted successfully.</p>

                <div class="p-6 bg-gray-50 dark:bg-gray-800 rounded-xl mb-8">
                    <h3 class="font-bold mb-4">What's Next?</h3>
                    <ul class="text-left space-y-2 text-sm">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>New schedule synced to your calendar</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>Study time increased to 4.5 hours per day</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 mr-2 mt-1"></i>
                            <span>All topics redistributed evenly</span>
                        </li>
                    </ul>
                </div>

                <button onclick="navigateTo('study')" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl transition-colors">
                    Back to Dashboard
                </button>
            </div>
        `;
    }

    return `
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <button onclick="navigateTo('study')" class="mb-6 text-primary hover:underline">
                <i class="fas fa-arrow-left mr-2"></i>Cancel
            </button>

            <!-- Progress Steps -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    ${steps.map((s, i) => `
                        <div class="flex-1 ${i < steps.length - 1 ? 'relative' : ''}">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center ${step > i + 1 ? 'bg-green-500 text-white' : step === i + 1 ? 'bg-primary text-white' : 'bg-gray-300 dark:bg-gray-700 text-gray-600 dark:text-gray-400'}">
                                    ${step > i + 1 ? '<i class="fas fa-check"></i>' : i + 1}
                                </div>
                                <span class="ml-2 text-xs hidden sm:inline">${s}</span>
                            </div>
                            ${i < steps.length - 1 ? '<div class="absolute top-5 left-10 right-0 h-0.5 bg-gray-300 dark:bg-gray-700 -z-10"></div>' : ''}
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Content -->
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-8 shadow-lg border border-gray-200 dark:border-gray-800">
                ${content}
            </div>
        </div>
    `;
}

// PAGE 9: Settings
function renderSettings() {
    const settings = AppState.studyData.settings;

    return `
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold mb-8">Study Settings</h1>

            <div class="bg-white dark:bg-gray-900 rounded-2xl p-8 shadow-lg border border-gray-200 dark:border-gray-800">
                <!-- Study Intensity -->
                <div class="mb-8">
                    <label class="block font-bold mb-4">Study Intensity</label>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <button onclick="setIntensity('light')" class="p-4 border-2 ${settings.intensity === 'light' ? 'border-primary bg-primary/10' : 'border-gray-300 dark:border-gray-700'} rounded-lg transition-colors">
                            <p class="font-semibold">Light</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">2-3 hrs/day</p>
                        </button>
                        <button onclick="setIntensity('medium')" class="p-4 border-2 ${settings.intensity === 'medium' ? 'border-primary bg-primary/10' : 'border-gray-300 dark:border-gray-700'} rounded-lg transition-colors">
                            <p class="font-semibold">Medium</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">4-5 hrs/day</p>
                        </button>
                        <button onclick="setIntensity('intense')" class="p-4 border-2 ${settings.intensity === 'intense' ? 'border-primary bg-primary/10' : 'border-gray-300 dark:border-gray-700'} rounded-lg transition-colors">
                            <p class="font-semibold">Intense</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">6-8 hrs/day</p>
                        </button>
                    </div>
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <p class="text-sm"><strong>Impact:</strong> Estimated completion: ${new Date(AppState.studyData.examDate).toLocaleDateString()}</p>
                    </div>
                </div>

                <!-- Hours per Day -->
                <div class="mb-8">
                    <label class="block font-bold mb-3">Hours per Study Day</label>
                    <input type="range" min="1" max="10" step="0.5" value="${settings.hoursPerDay}"
                           oninput="updateHoursPerDay(this.value)"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mt-2">
                        <span>1h</span>
                        <span id="hours-display" class="font-bold text-primary">${settings.hoursPerDay}h</span>
                        <span>10h</span>
                    </div>
                </div>

                <!-- Study Days -->
                <div class="mb-8">
                    <label class="block font-bold mb-3">Study Days</label>
                    <div class="grid grid-cols-7 gap-2">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => `
                            <button onclick="toggleStudyDay(${i})"
                                    class="p-3 border-2 ${settings.studyDays.includes(i) ? 'border-primary bg-primary text-white' : 'border-gray-300 dark:border-gray-700'} rounded-lg transition-colors text-sm font-semibold">
                                ${day}
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Subject Weightings -->
                <div class="mb-8">
                    <label class="block font-bold mb-4">Subject Priority</label>
                    <div class="space-y-4">
                        ${AppState.studyData.subjects.map(subject => `
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span>${subject.name}</span>
                                    <span class="font-semibold" style="color: ${subject.color}">Medium Priority</span>
                                </div>
                                <input type="range" min="1" max="3" step="1" value="2"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                                <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mt-1">
                                    <span>Low</span>
                                    <span>Medium</span>
                                    <span>High</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Revision Buffer -->
                <div class="mb-8">
                    <label class="block font-bold mb-3">Revision Buffer</label>
                    <input type="range" min="0" max="50" step="5" value="${settings.revisionBuffer}"
                           oninput="updateRevisionBuffer(this.value)"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mt-2">
                        <span>No buffer</span>
                        <span id="buffer-display" class="font-bold text-primary">${settings.revisionBuffer}%</span>
                        <span>50% buffer</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Time reserved for review and practice</p>
                </div>

                <!-- Apply Changes -->
                <button onclick="applySettings()" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl transition-colors">
                    Apply Changes
                </button>
            </div>
        </div>
    `;
}

    return `
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold mb-8">Contact Us</h1>
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-8 shadow-lg border border-gray-200 dark:border-gray-800">
                <p class="text-gray-600 dark:text-gray-400 mb-8">Have questions, feedback, or need support? We'd love to hear from you!</p>

                <form onsubmit="submitContact(event)" class="space-y-6">
                    <div>
                        <label class="block font-semibold mb-2">Name</label>
                        <input type="text" required
                               class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <div>
                        <label class="block font-semibold mb-2">Email</label>
                        <input type="email" required
                               class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <div>
                        <label class="block font-semibold mb-2">Subject</label>
                        <select class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option>General Inquiry</option>
                            <option>Technical Support</option>
                            <option>Feature Request</option>
                            <option>Bug Report</option>
                            <option>Account Issue</option>
                            <option>Billing Question</option>
                        </select>
                    </div>

                    <div>
                        <label class="block font-semibold mb-2">Message</label>
                        <textarea rows="6" required
                                  class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                  placeholder="Tell us more about your question or feedback..."></textarea>
                    </div>

                    <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Send Message
                    </button>
                </form>

                <div class="mt-12 pt-8 border-t border-gray-300 dark:border-gray-700">
                    <h3 class="font-bold mb-4">Other Ways to Reach Us</h3>
                    <div class="space-y-3">
                        <p><i class="fas fa-envelope text-primary mr-3"></i>support@studyflow.com</p>
                        <p><i class="fas fa-comments text-primary mr-3"></i>Live Chat (Mon-Fri, 9am-5pm)</p>
                        <p><i class="fab fa-twitter text-primary mr-3"></i>@StudyFlowApp</p>
                    </div>
                </div>
            </div>
        </div>
    `;

// Analytics placeholder
function renderAnalytics() {
    return `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold mb-8">Analytics & Insights</h1>
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-12 shadow-lg border border-gray-200 dark:border-gray-800 text-center">
                <i class="fas fa-chart-bar text-6xl text-gray-300 dark:text-gray-700 mb-4"></i>
                <p class="text-xl text-gray-600 dark:text-gray-400">Detailed analytics coming soon!</p>
                <button onclick="navigateTo('study')" class="mt-6 text-primary hover:underline">
                    ‚Üê Back to Dashboard
                </button>
            </div>
        </div>
    `;
}

// Practice test placeholder
function renderPracticeTest() {
    return `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold mb-8">Practice Tests</h1>
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-12 shadow-lg border border-gray-200 dark:border-gray-800 text-center">
                <i class="fas fa-pen-to-square text-6xl text-gray-300 dark:text-gray-700 mb-4"></i>
                <p class="text-xl text-gray-600 dark:text-gray-400">Practice tests coming soon!</p>
                <button onclick="navigateTo('study')" class="mt-6 text-primary hover:underline">
                    ‚Üê Back to Dashboard
                </button>
            </div>
        </div>
    `;
}

// ======================
// Navigation & State
// ======================
function navigateTo(page) {
    AppState.currentPage = page;
    render();
}

function render() {
    const contentDiv = document.getElementById('app-content');

    let html = '';
    switch(AppState.currentPage) {
        case 'study':
            html = renderStudyDashboard();
            break;
        case 'calendar':
            html = renderCalendarView();
            break;
        case 'gantt':
            html = renderGanttView();
            break;
        case 'schedule':
            html = renderCalendarView();
            break;
        case 'subject':
            html = renderSubjectDetail();
            break;
        case 'pre-session':
            html = renderPreSession();
            break;
        case 'active-session':
            html = renderActiveSession();
            startTimer();
            break;
        case 'session-review':
            html = renderSessionReview();
            break;
        case 'reschedule':
            html = renderRescheduleWizard();
            break;
        case 'settings':
            html = renderSettings();
            break;
        case 'analytics':
            html = renderAnalytics();
            break;
        case 'practice-test':
            html = renderPracticeTest();
            break;
        case 'terms':
            html = renderTermsOfService();
            break;
        case 'privacy':
            html = renderPrivacyPolicy();
            break;
        case 'copyright':
            html = renderCopyright();
            break;
        case 'contact':
            html = renderContact();
            break;
        default:
            html = renderStudyDashboard();
    }

    contentDiv.innerHTML = html;
    window.scrollTo(0, 0);
}

// ======================
// Interactive Functions
// ======================

let timerInterval = null;
let timerSeconds = 0;
let timerDuration = 25 * 60;
let timerPaused = false;

function startSession(mode) {
    AppState.activeSession = {
        mode: mode,
        startTime: new Date(),
        topic: AppState.getTodaysSchedule()[0]?.topic || 'Study Session',
        subject: AppState.getTodaysSchedule()[0]?.subject || 'General'
    };

    if (mode === 'pomodoro') {
        timerDuration = 25 * 60;
    } else if (mode === 'custom') {
        timerDuration = 45 * 60; // Default 45 mins
    } else {
        timerDuration = 0; // No timer
    }

    navigateTo('active-session');
}

function startTimer() {
    timerSeconds = timerDuration;
    updateTimerDisplay();

    if (timerDuration > 0) {
        timerInterval = setInterval(() => {
            if (!timerPaused && timerSeconds > 0) {
                timerSeconds--;
                updateTimerDisplay();
                updateTimerCircle();

                if (timerSeconds === 0) {
                    clearInterval(timerInterval);
                    showSessionComplete();
                }
            }
        }, 1000);
    }
}

function updateTimerDisplay() {
    const display = document.getElementById('timer-display');
    if (!display) return;

    const mins = Math.floor(timerSeconds / 60);
    const secs = timerSeconds % 60;
    display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

function updateTimerCircle() {
    const circle = document.getElementById('timer-progress');
    if (!circle) return;

    const percent = timerSeconds / timerDuration;
    const offset = 283 * (1 - percent);
    circle.style.strokeDashoffset = offset;
}

function toggleTimer() {
    timerPaused = !timerPaused;
    const btn = document.getElementById('pause-btn');
    if (btn) {
        btn.innerHTML = timerPaused ? '<i class="fas fa-play text-2xl"></i>' : '<i class="fas fa-pause text-2xl"></i>';
    }
}

function showConfirmEndSession() {
    showCustomConfirm(
        'End Session Early?',
        'Are you sure you want to end this study session? Your progress will still be saved.',
        () => {
            clearInterval(timerInterval);
            navigateTo('session-review');
        }
    );
}

function showSessionComplete() {
    // Show completion notification
    showNotification('Session Complete! üéâ', 'Great work! Time to review your session.');
    navigateTo('session-review');
}

// Session Review Functions
let selectedMood = null;
let selectedConfidence = null;

function selectMood(mood) {
    selectedMood = mood;
    document.getElementById('mood-input').value = mood;

    // Visual feedback
    document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.style.opacity = btn.dataset.mood == mood ? '1' : '0.4';
    });
}

function selectConfidence(level) {
    selectedConfidence = level;
    document.getElementById('confidence-input').value = level;

    // Visual feedback
    document.querySelectorAll('.confidence-btn').forEach(btn => {
        btn.classList.remove('border-red-500', 'border-yellow-500', 'border-green-500');
    });

    const colors = ['', 'border-red-500', 'border-yellow-500', 'border-green-500'];
    event.target.closest('.confidence-btn').classList.add(colors[level]);
}

function completeSession(event) {
    event.preventDefault();

    if (!selectedMood || !selectedConfidence) {
        showNotification('Please complete all fields', 'Select your mood and confidence level', 'error');
        return;
    }

    const notes = document.getElementById('session-notes').value;
    const scheduleReview = document.getElementById('schedule-review').checked;

    // Save session data
    AppState.studyData.studySessions.push({
        date: new Date().toISOString(),
        topic: AppState.activeSession.topic,
        subject: AppState.activeSession.subject,
        duration: Math.floor((new Date() - AppState.activeSession.startTime) / 1000 / 60),
        mood: selectedMood,
        confidence: selectedConfidence,
        notes: notes,
        scheduleReview: scheduleReview
    });

    AppState.studyData.streak++;
    AppState.save();

    showNotification('Session Saved! üéØ', 'Keep up the great work!');
    navigateTo('study');
}

// Reschedule Functions
let rescheduleData = {};

function rescheduleStep(step, data) {
    if (data) {
        rescheduleData[`step${step-1}`] = data;
    }
    navigateTo('reschedule-' + step);
    AppState.currentPage = 'reschedule';
    document.getElementById('app-content').innerHTML = renderRescheduleWizard(step);
}

// Settings Functions
function setIntensity(level) {
    AppState.studyData.settings.intensity = level;
    const hours = { light: 3, medium: 4.5, intense: 7 };
    AppState.studyData.settings.hoursPerDay = hours[level];
    render();
}

function updateHoursPerDay(value) {
    AppState.studyData.settings.hoursPerDay = parseFloat(value);
    document.getElementById('hours-display').textContent = value + 'h';
}

function toggleStudyDay(day) {
    const days = AppState.studyData.settings.studyDays;
    const index = days.indexOf(day);

    if (index > -1) {
        days.splice(index, 1);
    } else {
        days.push(day);
    }

    render();
}

function updateRevisionBuffer(value) {
    AppState.studyData.settings.revisionBuffer = parseInt(value);
    document.getElementById('buffer-display').textContent = value + '%';
}

function applySettings() {
    AppState.save();
    showNotification('Settings Saved!', 'Your study plan has been updated');
    navigateTo('study');
}

// Subject detail functions
function toggleTopicCompletion(subjectId, topicId) {
    const subject = AppState.studyData.subjects.find(s => s.id === subjectId);
    const topic = subject.topics.find(t => t.id === topicId);
    topic.completed = !topic.completed;

    // Recalculate progress
    const completedTopics = subject.topics.filter(t => t.completed).length;
    subject.progress = Math.round((completedTopics / subject.topics.length) * 100);

    AppState.save();
    render();
}

function setTopicConfidence(subjectId, topicId, level) {
    const subject = AppState.studyData.subjects.find(s => s.id === subjectId);
    const topic = subject.topics.find(t => t.id === topicId);
    topic.confidence = level;

    AppState.save();
    render();
}

// Modal Functions
function showCustomConfirm(title, message, onConfirm) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl animate-fade-in">
            <h3 class="text-xl font-bold mb-3">${title}</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">${message}</p>
            <div class="flex space-x-3">
                <button onclick="this.closest('.fixed').remove()"
                        class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors">
                    Cancel
                </button>
                <button onclick="this.closest('.fixed').remove(); (${onConfirm.toString()})()"
                        class="flex-1 px-4 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showQuickNoteModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl animate-fade-in">
            <h3 class="text-xl font-bold mb-4">Quick Note</h3>
            <textarea id="quick-note-text" rows="6"
                      class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent mb-4"
                      placeholder="Jot down a quick thought..."></textarea>
            <div class="flex space-x-3">
                <button onclick="this.closest('.fixed').remove()"
                        class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors">
                    Cancel
                </button>
                <button onclick="saveQuickNote(); this.closest('.fixed').remove()"
                        class="flex-1 px-4 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
                    Save Note
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('quick-note-text').focus();
}

function saveQuickNote() {
    const text = document.getElementById('quick-note-text')?.value;
    if (text) {
        // Save note (in real app would save to backend)
        showNotification('Note Saved', 'Your quick note has been saved');
    }
}

function showCustomSessionModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl animate-fade-in">
            <h3 class="text-xl font-bold mb-4">Add Custom Study Session</h3>
            <form onsubmit="saveCustomSession(event)" class="space-y-4">
                <div>
                    <label class="block font-semibold mb-2 text-sm">Subject</label>
                    <select class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                        ${AppState.studyData.subjects.map(s => `<option>${s.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">Topic</label>
                    <input type="text" required
                           class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">Duration (minutes)</label>
                    <input type="number" min="5" max="300" value="45" required
                           class="w-full px-4 py-3 text-base bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                </div>
                <div class="flex space-x-3 pt-2">
                    <button type="button" onclick="this.closest('.fixed').remove()"
                            class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                            class="flex-1 px-4 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
                        Add Session
                    </button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function saveCustomSession(event) {
    event.preventDefault();
    showNotification('Session Added!', 'Your custom study session has been added to the schedule');
    event.target.closest('.fixed').remove();
}

function showNotification(title, message, type = 'success') {
    const notification = document.createElement('div');
    const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
    const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };

    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-fade-in max-w-sm`;
    notification.innerHTML = `
        <div class="flex items-start space-x-3">
            <i class="fas ${icons[type]} text-xl mt-1"></i>
            <div>
                <p class="font-bold">${title}</p>
                <p class="text-sm opacity-90">${message}</p>
            </div>
        </div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        notification.style.transition = 'all 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function submitContact(event) {
    event.preventDefault();
    showNotification('Message Sent!', 'We\'ll get back to you soon');
    event.target.reset();
}

// ======================
// Dark Mode
// ======================
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
    if (event.matches) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
});

// ======================
// Initialize App
// ======================
AppState.init();
render();

</script>
</body>
</html>
