<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Database AI Tutor - Interactive Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .vector-dot {
            transition: all 0.3s ease;
        }
        .vector-dot:hover {
            transform: scale(1.3);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .markdown-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content p {
            margin-bottom: 0.75rem;
        }
        .markdown-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .markdown-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
        }
        .dark .markdown-content code {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
    <!-- Header -->
    <header class="gradient-bg text-white py-8 shadow-lg">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl font-bold mb-2">üß† Vector Database AI Tutor</h1>
            <p class="text-lg opacity-90">Learn how vector databases power intelligent AI assistants</p>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex overflow-x-auto space-x-1 py-2">
                <button onclick="showSection('learn')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-base">üìö Learn</button>
                <button onclick="showSection('visualize')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-base">üé® Visualize</button>
                <button onclick="showSection('knowledge')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-base">üìñ Knowledge Base</button>
                <button onclick="showSection('tutor')" class="nav-btn px-4 py-2 rounded-lg whitespace-nowrap text-base">ü§ñ AI Tutor</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Learn Section -->
        <section id="learn-section" class="section-content">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold mb-6 text-primary">What are Vector Databases?</h2>

                <div class="space-y-6">
                    <div class="border-l-4 border-primary pl-4">
                        <h3 class="text-xl font-semibold mb-2">Traditional vs. Vector Databases</h3>
                        <p class="text-gray-700 dark:text-gray-300">Traditional databases store exact data (names, numbers, dates). Vector databases store <strong>semantic meanings</strong> as high-dimensional vectors, enabling similarity-based search.</p>
                    </div>

                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                        <h3 class="text-xl font-semibold mb-3">üîë Key Concepts</h3>
                        <ul class="space-y-2 text-gray-700 dark:text-gray-300">
                            <li><strong>Embeddings:</strong> Text/images/audio converted to numerical vectors (arrays of numbers)</li>
                            <li><strong>Semantic Search:</strong> Find content by <em>meaning</em>, not just keywords</li>
                            <li><strong>Similarity Metrics:</strong> Cosine similarity, Euclidean distance to measure closeness</li>
                            <li><strong>RAG (Retrieval-Augmented Generation):</strong> AI retrieves relevant context before generating answers</li>
                        </ul>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-2">üìù Example: Traditional Search</h3>
                            <p class="text-sm text-gray-700 dark:text-gray-300">Query: "dog"<br>Finds: Documents containing exact word "dog"<br>Misses: "puppy", "canine", "pet"</p>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4">
                            <h3 class="text-lg font-semibold mb-2">üîç Example: Vector Search</h3>
                            <p class="text-sm text-gray-700 dark:text-gray-300">Query: "dog"<br>Finds: Documents about dogs, puppies, canines, pets<br>Understands semantic similarity!</p>
                        </div>
                    </div>

                    <div class="border-l-4 border-purple-500 pl-4">
                        <h3 class="text-xl font-semibold mb-2">How AI Tutors Use Vector Databases</h3>
                        <ol class="list-decimal list-inside space-y-2 text-gray-700 dark:text-gray-300">
                            <li><strong>Store Knowledge:</strong> Course materials, textbooks, Q&As stored as vectors</li>
                            <li><strong>Student Asks Question:</strong> Convert question to vector embedding</li>
                            <li><strong>Find Relevant Info:</strong> Search vector DB for most similar content</li>
                            <li><strong>Generate Answer:</strong> AI uses retrieved context to provide accurate, grounded response</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-3">üöÄ Real-World Applications</h3>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-3xl mb-2">üéì</div>
                        <h4 class="font-semibold mb-1">Education</h4>
                        <p class="text-sm opacity-90">Personalized tutors, study assistants, course recommendations</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-3xl mb-2">üí¨</div>
                        <h4 class="font-semibold mb-1">Customer Support</h4>
                        <p class="text-sm opacity-90">Smart chatbots that find relevant help articles</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-3xl mb-2">üî¨</div>
                        <h4 class="font-semibold mb-1">Research</h4>
                        <p class="text-sm opacity-90">Semantic literature search, document analysis</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Visualize Section -->
        <section id="visualize-section" class="section-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold mb-6 text-primary">Visualize Vector Similarity</h2>

                <div class="mb-6">
                    <label class="block text-lg font-semibold mb-3">Add a document to the vector space:</label>
                    <div class="flex gap-2">
                        <input type="text" id="doc-input" placeholder="e.g., 'Python is a programming language'" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        <button onclick="addDocument()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition whitespace-nowrap text-base">Add</button>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-lg font-semibold mb-3">Search query:</label>
                    <div class="flex gap-2">
                        <input type="text" id="query-input" placeholder="e.g., 'coding language'" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                        <button onclick="searchVectors()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition whitespace-nowrap text-base">Search</button>
                    </div>
                </div>

                <!-- Vector Space Visualization -->
                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6 relative" style="height: 400px;">
                    <h3 class="text-lg font-semibold mb-2">2D Vector Space (Simplified)</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Real embeddings use 100s-1000s of dimensions. This is a 2D projection for visualization.</p>
                    <svg id="vector-canvas" width="100%" height="320" class="bg-white dark:bg-gray-800 rounded">
                        <!-- Grid -->
                        <line x1="50%" y1="0" x2="50%" y2="100%" stroke="#ccc" stroke-width="1" stroke-dasharray="5,5"/>
                        <line x1="0" y1="50%" x2="100%" y2="50%" stroke="#ccc" stroke-width="1" stroke-dasharray="5,5"/>
                    </svg>
                </div>

                <!-- Search Results -->
                <div id="search-results" class="hidden">
                    <h3 class="text-xl font-semibold mb-3">Search Results (by similarity):</h3>
                    <div id="results-list" class="space-y-2"></div>
                </div>
            </div>
        </section>

        <!-- Knowledge Base Section -->
        <section id="knowledge-section" class="section-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold mb-6 text-primary">Build Your Knowledge Base</h2>

                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6">
                    <p class="text-gray-700 dark:text-gray-300">Add educational content that the AI tutor can reference. This simulates how vector databases store and retrieve information.</p>
                </div>

                <div class="mb-6">
                    <label class="block text-lg font-semibold mb-2">Add Knowledge Article:</label>
                    <input type="text" id="kb-title" placeholder="Title (e.g., 'What is Machine Learning?')" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 mb-3 text-base">
                    <textarea id="kb-content" placeholder="Content (detailed explanation...)" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 h-32 text-base"></textarea>
                    <button onclick="addKnowledge()" class="mt-3 bg-primary text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition text-base">Add to Knowledge Base</button>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-3">Current Knowledge Base (<span id="kb-count">0</span> articles):</h3>
                    <div id="kb-list" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- AI Tutor Section -->
        <section id="tutor-section" class="section-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-3xl font-bold mb-6 text-primary">ü§ñ AI Tutor with RAG</h2>

                <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-lg mb-2">How it works:</h3>
                    <ol class="list-decimal list-inside space-y-1 text-sm text-gray-700 dark:text-gray-300">
                        <li>You ask a question</li>
                        <li>System searches knowledge base for relevant context (simulated vector search)</li>
                        <li>Retrieved context is sent to AI along with your question</li>
                        <li>AI generates informed answer based on the knowledge base</li>
                    </ol>
                </div>

                <!-- RAG Visualization -->
                <div id="rag-visualization" class="mb-6 hidden">
                    <div class="border-2 border-primary rounded-lg p-4 bg-purple-50 dark:bg-purple-900/20">
                        <h3 class="font-semibold mb-3 flex items-center">
                            <span class="pulse-animation inline-block w-3 h-3 bg-primary rounded-full mr-2"></span>
                            RAG Process in Action
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div id="rag-step-1" class="flex items-start opacity-50">
                                <span class="mr-2">1Ô∏è‚É£</span>
                                <span>Question received: <span class="font-mono text-xs" id="rag-query"></span></span>
                            </div>
                            <div id="rag-step-2" class="flex items-start opacity-50">
                                <span class="mr-2">2Ô∏è‚É£</span>
                                <span>Searching knowledge base for relevant context...</span>
                            </div>
                            <div id="rag-step-3" class="flex items-start opacity-50">
                                <span class="mr-2">3Ô∏è‚É£</span>
                                <span>Retrieved <span id="rag-context-count">0</span> relevant articles</span>
                            </div>
                            <div id="rag-step-4" class="flex items-start opacity-50">
                                <span class="mr-2">4Ô∏è‚É£</span>
                                <span>Sending to AI with context...</span>
                            </div>
                            <div id="rag-step-5" class="flex items-start opacity-50">
                                <span class="mr-2">5Ô∏è‚É£</span>
                                <span>Generating answer...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Retrieved Context Display -->
                <div id="retrieved-context" class="mb-6 hidden">
                    <h3 class="font-semibold mb-2">üìö Retrieved Context from Knowledge Base:</h3>
                    <div id="context-list" class="space-y-2"></div>
                </div>

                <!-- Chat Interface -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg">
                    <div id="chat-messages" class="h-96 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900/50"></div>
                    <div class="border-t border-gray-300 dark:border-gray-600 p-4 bg-white dark:bg-gray-800">
                        <div class="flex gap-2">
                            <input type="text" id="tutor-input" placeholder="Ask a question... (e.g., 'What is machine learning?')" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base">
                            <button onclick="askTutor()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition whitespace-nowrap text-base">Ask</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Dark mode handling
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Section navigation
        function showSection(section) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            });
            event.target.classList.add('bg-primary', 'text-white');
            event.target.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
        }

        // Initialize with learn section
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.nav-btn').click();
            initializeDefaultKnowledge();
        });

        // Simple vector database simulation
        let vectorDB = [];
        let knowledgeBase = [];

        // Simplified text to vector conversion (using character statistics)
        function textToVector(text) {
            text = text.toLowerCase();
            const features = {
                length: text.length / 100,
                spaces: (text.match(/ /g) || []).length / 20,
                vowels: (text.match(/[aeiou]/g) || []).length / text.length,
                consonants: (text.match(/[bcdfghjklmnpqrstvwxyz]/g) || []).length / text.length,
                numbers: (text.match(/[0-9]/g) || []).length / text.length,
                techWords: (text.match(/python|code|programming|computer|algorithm|data|machine|learning|ai/g) || []).length / 10,
                scienceWords: (text.match(/physics|chemistry|biology|science|experiment|theory/g) || []).length / 10,
                mathWords: (text.match(/math|equation|calculate|number|algebra|geometry/g) || []).length / 10
            };

            // Add some randomness for better 2D visualization
            return [
                features.techWords * 10 + features.mathWords * 5 + Math.random() * 2,
                features.scienceWords * 10 + features.length + Math.random() * 2
            ];
        }

        function cosineSimilarity(vec1, vec2) {
            const dotProduct = vec1.reduce((sum, val, i) => sum + val * vec2[i], 0);
            const mag1 = Math.sqrt(vec1.reduce((sum, val) => sum + val * val, 0));
            const mag2 = Math.sqrt(vec2.reduce((sum, val) => sum + val * val, 0));
            return dotProduct / (mag1 * mag2);
        }

        function addDocument() {
            const input = document.getElementById('doc-input');
            const text = input.value.trim();
            if (!text) return;

            const vector = textToVector(text);
            vectorDB.push({ text, vector });
            input.value = '';

            renderVectorSpace();
        }

        function searchVectors() {
            const input = document.getElementById('query-input');
            const query = input.value.trim();
            if (!query || vectorDB.length === 0) return;

            const queryVector = textToVector(query);

            const results = vectorDB.map(doc => ({
                ...doc,
                similarity: cosineSimilarity(queryVector, doc.vector)
            })).sort((a, b) => b.similarity - a.similarity);

            renderVectorSpace(queryVector, query);
            displayResults(results, query);
        }

        function renderVectorSpace(queryVector = null, queryText = null) {
            const svg = document.getElementById('vector-canvas');
            const width = svg.clientWidth;
            const height = 320;

            // Clear existing dots
            const existingDots = svg.querySelectorAll('.vector-dot, .query-dot, .vector-label');
            existingDots.forEach(el => el.remove());

            // Find max values for scaling
            let maxX = 10, maxY = 10;
            vectorDB.forEach(doc => {
                maxX = Math.max(maxX, doc.vector[0]);
                maxY = Math.max(maxY, doc.vector[1]);
            });
            if (queryVector) {
                maxX = Math.max(maxX, queryVector[0]);
                maxY = Math.max(maxY, queryVector[1]);
            }

            // Scale and plot documents
            vectorDB.forEach((doc, idx) => {
                const x = (doc.vector[0] / maxX) * (width - 100) + 50;
                const y = height - ((doc.vector[1] / maxY) * (height - 100) + 50);

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', 6);
                circle.setAttribute('fill', '#5D5CDE');
                circle.classList.add('vector-dot');
                circle.setAttribute('title', doc.text);
                svg.appendChild(circle);

                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x + 10);
                label.setAttribute('y', y + 5);
                label.setAttribute('class', 'vector-label text-xs fill-gray-600 dark:fill-gray-400');
                label.textContent = doc.text.substring(0, 20) + '...';
                svg.appendChild(label);
            });

            // Plot query if exists
            if (queryVector) {
                const x = (queryVector[0] / maxX) * (width - 100) + 50;
                const y = height - ((queryVector[1] / maxY) * (height - 100) + 50);

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', 8);
                circle.setAttribute('fill', '#10B981');
                circle.classList.add('query-dot');
                svg.appendChild(circle);

                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x + 12);
                label.setAttribute('y', y + 5);
                label.setAttribute('class', 'vector-label text-xs fill-green-600 dark:fill-green-400 font-bold');
                label.textContent = 'üîç ' + queryText;
                svg.appendChild(label);
            }
        }

        function displayResults(results, query) {
            const resultsDiv = document.getElementById('search-results');
            const listDiv = document.getElementById('results-list');

            resultsDiv.classList.remove('hidden');
            listDiv.innerHTML = results.map((result, idx) => `
                <div class="bg-white dark:bg-gray-700 rounded-lg p-3 border-l-4 ${idx === 0 ? 'border-green-500' : 'border-gray-300 dark:border-gray-600'}">
                    <div class="flex justify-between items-start">
                        <p class="font-medium">${result.text}</p>
                        <span class="ml-2 px-2 py-1 bg-gray-100 dark:bg-gray-600 rounded text-sm whitespace-nowrap">
                            ${(result.similarity * 100).toFixed(1)}% match
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Knowledge Base Management
        function initializeDefaultKnowledge() {
            const defaultKB = [
                {
                    title: "What is Machine Learning?",
                    content: "Machine learning is a subset of artificial intelligence that enables computers to learn and improve from experience without being explicitly programmed. It uses algorithms to identify patterns in data and make predictions or decisions. Common types include supervised learning, unsupervised learning, and reinforcement learning."
                },
                {
                    title: "Vector Databases Explained",
                    content: "Vector databases are specialized databases designed to store and query high-dimensional vectors (embeddings). Unlike traditional databases that search for exact matches, vector databases find similar items based on semantic meaning. They use techniques like cosine similarity and approximate nearest neighbor search to quickly find relevant information."
                },
                {
                    title: "What is RAG (Retrieval-Augmented Generation)?",
                    content: "RAG is a technique that enhances AI responses by first retrieving relevant information from a knowledge base before generating an answer. This helps AI provide more accurate, factual, and contextually relevant responses. The process involves: 1) Converting the query to a vector, 2) Searching the vector database for similar content, 3) Passing retrieved context to the AI, 4) Generating an informed response."
                },
                {
                    title: "Neural Networks Basics",
                    content: "Neural networks are computing systems inspired by biological neural networks. They consist of layers of interconnected nodes (neurons) that process information. Each connection has a weight that adjusts during training. Neural networks excel at pattern recognition, classification, and prediction tasks. Deep learning uses neural networks with many layers."
                }
            ];

            defaultKB.forEach(item => {
                knowledgeBase.push(item);
            });
            updateKBDisplay();
        }

        function addKnowledge() {
            const title = document.getElementById('kb-title').value.trim();
            const content = document.getElementById('kb-content').value.trim();

            if (!title || !content) {
                showCustomAlert('Please fill in both title and content');
                return;
            }

            knowledgeBase.push({ title, content });
            document.getElementById('kb-title').value = '';
            document.getElementById('kb-content').value = '';

            updateKBDisplay();
        }

        function updateKBDisplay() {
            const listDiv = document.getElementById('kb-list');
            document.getElementById('kb-count').textContent = knowledgeBase.length;

            listDiv.innerHTML = knowledgeBase.map((item, idx) => `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                    <h4 class="font-semibold text-lg mb-2">${item.title}</h4>
                    <p class="text-sm text-gray-700 dark:text-gray-300">${item.content.substring(0, 150)}${item.content.length > 150 ? '...' : ''}</p>
                </div>
            `).join('');
        }

        // AI Tutor with RAG
        let conversationHistory = [];

        window.Poe = window.Poe || {};

        window.Poe.registerHandler = window.Poe.registerHandler || function() {};

        window.Poe.registerHandler('tutor-handler', (result, context) => {
            const msg = result.responses[0];
            const messageDiv = document.getElementById(`msg-${context.messageId}`);

            if (!messageDiv) return;

            if (msg.status === 'error') {
                messageDiv.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
                        <p class="text-red-700 dark:text-red-300">Error: ${msg.statusText || 'Failed to get response'}</p>
                    </div>
                `;
                hideRAGSteps();
            } else if (msg.status === 'incomplete') {
                const content = marked.parse(msg.content || '');
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold">AI</div>
                        <div class="flex-1 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                            <div class="markdown-content prose dark:prose-invert max-w-none">${content}</div>
                            <div class="mt-2 flex items-center text-sm text-gray-500">
                                <span class="pulse-animation inline-block w-2 h-2 bg-primary rounded-full mr-2"></span>
                                Generating...
                            </div>
                        </div>
                    </div>
                `;
                updateRAGStep(5, true);
            } else if (msg.status === 'complete') {
                const content = marked.parse(msg.content);
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3 fade-in">
                        <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold">AI</div>
                        <div class="flex-1 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                            <div class="markdown-content prose dark:prose-invert max-w-none">${content}</div>
                        </div>
                    </div>
                `;
                hideRAGSteps();
            }
        });

        async function askTutor() {
            const input = document.getElementById('tutor-input');
            const question = input.value.trim();

            if (!question) return;

            input.value = '';

            // Display user message
            const chatDiv = document.getElementById('chat-messages');
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'flex items-start space-x-3 justify-end fade-in';
            userMsgDiv.innerHTML = `
                <div class="bg-gray-200 dark:bg-gray-700 rounded-lg p-4 max-w-[80%]">
                    <p>${question}</p>
                </div>
                <div class="flex-shrink-0 w-8 h-8 bg-gray-500 rounded-full flex items-center justify-center text-white font-bold">U</div>
            `;
            chatDiv.appendChild(userMsgDiv);

            // Show RAG process
            showRAGProcess(question);

            // Simulate vector search on knowledge base
            await new Promise(resolve => setTimeout(resolve, 500));
            updateRAGStep(1, true);
            updateRAGStep(2, true);

            const relevantContext = findRelevantContext(question);

            await new Promise(resolve => setTimeout(resolve, 500));
            updateRAGStep(3, true);
            displayRetrievedContext(relevantContext);

            // Prepare context for AI
            const contextText = relevantContext.map(item =>
                `Title: ${item.title}\nContent: ${item.content}`
            ).join('\n\n');

            const prompt = `You are an AI tutor. Use the following knowledge base context to answer the student's question accurately and helpfully.

KNOWLEDGE BASE CONTEXT:
${contextText}

STUDENT QUESTION: ${question}

Provide a clear, educational answer based on the context above. If the context doesn't contain relevant information, say so and provide general guidance.`;

            // Create AI response placeholder
            const messageId = Date.now();
            const aiMsgDiv = document.createElement('div');
            aiMsgDiv.id = `msg-${messageId}`;
            aiMsgDiv.className = 'fade-in';
            aiMsgDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-bold">AI</div>
                    <div class="flex-1 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                        <div class="flex items-center text-sm text-gray-500">
                            <span class="pulse-animation inline-block w-2 h-2 bg-primary rounded-full mr-2"></span>
                            Waiting for response...
                        </div>
                    </div>
                </div>
            `;
            chatDiv.appendChild(aiMsgDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;

            updateRAGStep(4, true);

            try {
                await window.Poe.sendUserMessage(`@Claude-Sonnet-4.5 ${prompt}`, {
                    handler: 'tutor-handler',
                    stream: true,
                    openChat: false,
                    handlerContext: { messageId }
                });
            } catch (err) {
                aiMsgDiv.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
                        <p class="text-red-700 dark:text-red-300">Error: ${err.message}</p>
                    </div>
                `;
                hideRAGSteps();
            }
        }

        function findRelevantContext(query) {
            if (knowledgeBase.length === 0) return [];

            const queryVector = textToVector(query);

            const scored = knowledgeBase.map(item => {
                const itemVector = textToVector(item.title + ' ' + item.content);
                const similarity = cosineSimilarity(queryVector, itemVector);
                return { ...item, similarity };
            });

            scored.sort((a, b) => b.similarity - a.similarity);

            return scored.slice(0, 2);
        }

        function showRAGProcess(query) {
            const vizDiv = document.getElementById('rag-visualization');
            vizDiv.classList.remove('hidden');
            document.getElementById('rag-query').textContent = query;

            // Reset all steps
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`rag-step-${i}`).classList.add('opacity-50');
                document.getElementById(`rag-step-${i}`).classList.remove('opacity-100', 'font-semibold');
            }
        }

        function updateRAGStep(step, active) {
            const stepDiv = document.getElementById(`rag-step-${step}`);
            if (active) {
                stepDiv.classList.remove('opacity-50');
                stepDiv.classList.add('opacity-100', 'font-semibold');
            }
        }

        function hideRAGSteps() {
            setTimeout(() => {
                document.getElementById('rag-visualization').classList.add('hidden');
                document.getElementById('retrieved-context').classList.add('hidden');
            }, 2000);
        }

        function displayRetrievedContext(context) {
            const contextDiv = document.getElementById('retrieved-context');
            const listDiv = document.getElementById('context-list');

            document.getElementById('rag-context-count').textContent = context.length;

            contextDiv.classList.remove('hidden');
            listDiv.innerHTML = context.map(item => `
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
                    <h4 class="font-semibold text-sm mb-1">${item.title}</h4>
                    <p class="text-xs text-gray-700 dark:text-gray-300">${item.content.substring(0, 100)}...</p>
                    <span class="text-xs text-gray-500">Similarity: ${(item.similarity * 100).toFixed(1)}%</span>
                </div>
            `).join('');
        }

        // Custom alert function
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-primary text-white hover:bg-purple-700 rounded">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Enter key support
        document.getElementById('doc-input')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') addDocument();
        });
        document.getElementById('query-input')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') searchVectors();
        });
        document.getElementById('tutor-input')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') askTutor();
        });
    </script>
</body>
</html>

