
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Keep all existing head content] -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=1.0, user-scalable=no">
    <title>Raven Dashboard</title>
    
    <!-- [Keep all existing styles and scripts] -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- [Keep all existing Tailwind config and styles] -->
    <script>
        tailwind.config = {
            // [Keep existing config]
        }
    </script>
    
    <style>
        /* [Keep all existing styles] */
    </style>
</head>

<body class="bg-neutral-50 dark:bg-neutral-900 font-sans transition-colors duration-200">

<!-- [Keep all existing HTML structure] -->

<script>
/* ============================================
   ENHANCED AUTHENTICATION SYSTEM
   Integrates examtutor.xyz auth with dashboard
   ============================================ */

// ============================================
// 1. AUTHENTICATION BRIDGE SYSTEM
// ============================================

class AuthenticationBridge {
    constructor() {
        this.authToken = null;
        this.userData = null;
        this.sessionTimeout = 24 * 60 * 60 * 1000; // 24 hours
        this.examtutorAuthURL = 'https://examtutor.xyz'; // Auth gateway
        this.init();
    }

    init() {
        // Check for existing session
        this.restoreSession();
        
        // Listen for messages from examtutor.xyz (if using iframe/popup)
        window.addEventListener('message', (e) => this.handleAuthMessage(e));
        
        // Check session validity on page load
        this.validateSession();
    }

    /**
     * Handle authentication from examtutor.xyz
     */
    handleAuthMessage(event) {
        // Verify origin for security
        if (event.origin !== this.examtutorAuthURL) return;

        const { type, data } = event.data;

        if (type === 'AUTH_SUCCESS') {
            this.setSession(data);
            this.onAuthSuccess(data);
        } else if (type === 'AUTH_FAILED') {
            this.onAuthFailed(data);
        }
    }

    /**
     * Set authenticated session
     */
    setSession(authData) {
        const sessionData = {
            token: authData.token || this.generateToken(),
            user: {
                id: authData.id,
                name: authData.name,
                email: authData.email,
                institute: authData.institute,
                course: authData.course,
                targetScore: authData.targetScore,
                jambSubjects: authData.jambSubjects || [],
                hasPaid: authData.hasPaid || false,
                subscriptionPlan: authData.subscriptionPlan || null,
                subscriptionDate: authData.subscriptionDate || null,
            },
            timestamp: Date.now(),
            expiresAt: Date.now() + this.sessionTimeout
        };

        // Store in localStorage
        localStorage.setItem('ravenAuthSession', JSON.stringify(sessionData));
        localStorage.setItem('currentUserEmail', authData.email);
        
        this.authToken = sessionData.token;
        this.userData = sessionData.user;

        return sessionData;
    }

    /**
     * Restore session from localStorage
     */
    restoreSession() {
        try {
            const sessionData = localStorage.getItem('ravenAuthSession');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                
                // Check if session is still valid
                if (session.expiresAt > Date.now()) {
                    this.authToken = session.token;
                    this.userData = session.user;
                    return true;
                } else {
                    // Session expired
                    this.clearSession();
                    return false;
                }
            }
        } catch (error) {
            console.error('Error restoring session:', error);
        }
        return false;
    }

    /**
     * Validate current session
     */
    validateSession() {
        if (!this.authToken || !this.userData) {
            // No valid session - redirect to login
            this.redirectToLogin();
            return false;
        }

        // Session is valid
        return true;
    }

    /**
     * Redirect to examtutor.xyz login
     */
    redirectToLogin() {
        // Store the intended destination
        localStorage.setItem('ravenRedirectAfterAuth', window.location.href);
        
        // Redirect to examtutor.xyz with callback
        const callbackURL = encodeURIComponent(window.location.origin + '/dashboard');
        window.location.href = `${this.examtutorAuthURL}?redirect=${callbackURL}&app=raven-dashboard`;
    }

    /**
     * Handle successful authentication
     */
    onAuthSuccess(userData) {
        console.log('âœ… Authentication successful:', userData.name);
        
        // Update UI
        updateUserDisplay(userData);
        
        // Load dashboard
        renderDashboard();
        showSection(dashboardSection);
        
        // Show success message
        showMaterialToast(`Welcome back, ${userData.name}! ðŸŽ“`, 'success');
    }

    /**
     * Handle authentication failure
     */
    onAuthFailed(error) {
        console.error('âŒ Authentication failed:', error);
        showMaterialToast('Authentication failed. Please try again.', 'error');
        this.redirectToLogin();
    }

    /**
     * Generate secure token
     */
    generateToken() {
        return 'token_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }

    /**
     * Clear session
     */
    clearSession() {
        localStorage.removeItem('ravenAuthSession');
        localStorage.removeItem('currentUserEmail');
        this.authToken = null;
        this.userData = null;
    }

    /**
     * Get current user
     */
    getCurrentUser() {
        return this.userData;
    }

    /**
     * Check if user is authenticated
     */
    isAuthenticated() {
        return this.authToken && this.userData && this.userData.email;
    }

    /**
     * Logout user
     */
    logout() {
        this.clearSession();
        showMaterialToast('Logged out successfully', 'info');
        this.redirectToLogin();
    }
}

// ============================================
// 2. INITIALIZE AUTHENTICATION BRIDGE
// ============================================

const authBridge = new AuthenticationBridge();

// ============================================
// 3. MODIFY EXISTING CODE TO USE AUTH BRIDGE
// ============================================

// Global variables
let allUsers = JSON.parse(localStorage.getItem('raven_users')) || [];
let currentUser = null;

// Analytics data global variable
let analyticsData = {
    quizResults: [],
    topicProgress: {},
    subjectProgress: {},
    timeSpent: {}
};

let examMode = 'jamb';

// DOM Elements
const landingSection = document.getElementById('landingSection');
const loginSection = document.getElementById('loginSection');
const registerSection = document.getElementById('registerSection');
const paymentSection = document.getElementById('paymentSection');
const dashboardSection = document.getElementById('dashboardSection');
const analyticsSection = document.getElementById('analyticsSection');
const mainHeader = document.getElementById('mainHeader');
const fabButton = document.getElementById('fabButton');
const logoutBtn = document.getElementById('logoutBtn');

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
    initializeSubjectSelection();
    loadAnalyticsData();
    
    // NEW: Check authentication first
    if (authBridge.isAuthenticated()) {
        // User is authenticated via examtutor.xyz
        currentUser = authBridge.getCurrentUser();
        updateStudyStreak(currentUser);
        updateUserDisplay(currentUser);
        renderDashboard();
        showSection(dashboardSection);
    } else {
        // No valid session - show landing page
        showSection(landingSection);
    }
    
    setupAnalyticsListeners();
});

// ============================================
// 4. ENHANCED LOGOUT FUNCTION
// ============================================

function logout() {
    authBridge.logout();
    currentUser = null;
    logoutBtn.classList.add('hidden');
    showSection(landingSection);
}

// ============================================
// 5. HANDLE REDIRECT FROM examtutor.xyz
// ============================================

// Check if returning from examtutor.xyz with auth data
window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const authToken = urlParams.get('token');
    const userData = urlParams.get('user');

    if (authToken && userData) {
        try {
            const decodedUser = JSON.parse(atob(userData));
            authBridge.setSession({
                token: authToken,
                ...decodedUser
            });
            
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Reload to show dashboard
            location.reload();
        } catch (error) {
            console.error('Error processing auth redirect:', error);
        }
    }
});

// ============================================
// 6. KEEP ALL EXISTING FUNCTIONS
// ============================================

// [Keep all existing functions like:]
// - loadAnalyticsData()
// - saveAnalyticsData()
// - renderDashboard()
// - renderProgress()
// - renderAnalytics()
// - updateUserDisplay()
// - etc.

// ============================================
// 7. ENHANCED LOGIN FORM (Optional - for manual login)
// ============================================

document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    // Option 1: Redirect to examtutor.xyz login
    const loginURL = `${authBridge.examtutorAuthURL}/login?email=${encodeURIComponent(email)}&redirect=${encodeURIComponent(window.location.href)}`;
    window.location.href = loginURL;

    // Option 2: Or use local authentication (fallback)
    // const user = allUsers.find(u => u.email === email && u.password === password);
    // if (user) {
    //     authBridge.setSession(user);
    //     authBridge.onAuthSuccess(user);
    // }
});

// ============================================
// 8. ENHANCED REGISTER FORM
// ============================================

document.getElementById('registerForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const institute = document.getElementById('registerInstitute').value;
    const course = document.getElementById('registerCourse').value;
    const targetScore = document.getElementById('registerTargetScore').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;

    if (password !== confirmPassword) {
        showMaterialToast('Passwords do not match!', 'error');
        return;
    }

    const selectedSubjects = getSelectedSubjects();
    if (selectedSubjects.length !== 4) {
        showMaterialToast('Please select exactly 3 additional subjects', 'error');
        return;
    }

    // Redirect to examtutor.xyz registration with data
    const registrationData = {
        name, email, institute, course, targetScore, 
        jambSubjects: selectedSubjects, password
    };
    
    const encodedData = btoa(JSON.stringify(registrationData));
    const registerURL = `${authBridge.examtutorAuthURL}/register?data=${encodedData}&redirect=${encodeURIComponent(window.location.href)}`;
    window.location.href = registerURL;
});

// ============================================
// 9. PAYMENT HANDLER (Enhanced)
// ============================================

function handlePayment(plan) {
    if (!authBridge.isAuthenticated()) {
        showMaterialToast('Please log in first', 'error');
        authBridge.redirectToLogin();
        return;
    }

    showMaterialToast('Opening payment gateway...', 'info');

    // Redirect to examtutor.xyz payment page
    const paymentURL = `${authBridge.examtutorAuthURL}/payment?plan=${plan}&token=${authBridge.authToken}&redirect=${encodeURIComponent(window.location.href)}`;
    window.location.href = paymentURL;
}

// ============================================
// [KEEP ALL REMAINING EXISTING FUNCTIONS]
// ============================================

// All your existing functions remain unchanged:
// - initializeSubjectSelection()
// - updateSubjectSelection()
// - getSelectedSubjects()
// - loadAnalyticsData()
// - saveAnalyticsData()
// - validateAnalyticsData()
// - saveQuizResult()
// - getTopicProgress()
// - getProgressBarColor()
// - getStatusClass()
// - capitalizeWords()
// - toggleExamMode()
// - setupAnalyticsListeners()
// - showAnalyticsFromMobile()
// - showAnalyticsSection()
// - renderAnalytics()
// - renderAnalyticsCharts()
// - renderAnalyticsHeatmap()
// - renderAnalyticsRecommendations()
// - showSection()
// - updateStudyStreak()
// - renderDashboard()
// - renderProgress()
// - renderDashboardProgressChart()
// - updateUserDisplay()
// - openSettingsModal()
// - closeSettingsModal()
// - Settings form handler
// - Dark mode detection
// - toggleMobileMenu()
// - startQuickPractice()
// - showMaterialToast()
// - createToastContainer()
// - showTopicDetail()
// - closeTopicDetail()
// - renderTopicTimeTrend()

</script>

</body>
</html>