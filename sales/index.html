<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Coach Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
        }

        .loading-content {
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* App Container */
        .app-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            min-height: 600px;
        }

        /* Scenarios Panel */
        .scenarios-panel {
            flex: 1;
            min-width: 300px;
            padding: 30px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
        }

        .scenarios-panel h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .scenarios-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .scenario-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            border-color: #4361ee;
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.15);
        }

        .scenario-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .scenario-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .scenario-info h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .scenario-info p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .scenario-desc {
            color: #475569;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .scenario-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            background: #f1f5f9;
            color: #475569;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .difficulty-easy {
            background: #d1fae5;
            color: #065f46;
        }

        .difficulty-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .difficulty-hard {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Chat Panel */
        .chat-panel {
            flex: 2;
            min-width: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #f8fafc;
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: #e2e8f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #475569;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #cbd5e1;
        }

        .persona-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .persona-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .persona-details h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .persona-details p {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Messages */
        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 500px;
        }

        .message {
            max-width: 70%;
            padding: 15px;
            border-radius: 18px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            align-self: flex-end;
            background: #4361ee;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-ai {
            align-self: flex-start;
            background: white;
            color: #334155;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            display: block;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        /* Input Area */
        .input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            max-height: 120px;
            transition: all 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .send-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 12px;
            width: 60px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
        }

        .send-btn:hover:not(:disabled) {
            background: #3a56d4;
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        /* Analysis Panel */
        .analysis-panel {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            margin: 20px 30px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .analysis-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .analysis-header h4 {
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-badge {
            background: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .score-good {
            background: #d1fae5;
            color: #065f46;
        }

        .score-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .score-poor {
            background: #fee2e2;
            color: #991b1b;
        }

        .analysis-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .emotion-badge {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-left: 10px;
        }

        .feedback {
            color: #475569;
            font-style: italic;
            line-height: 1.5;
        }

        .suggestion {
            background: #e6f3ff;
            padding: 15px;
            border-radius: 8px;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
            margin-top: 10px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 15px;
            align-self: flex-start;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #94a3b8;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Coach Panel */
        .coach-panel {
            flex: 1;
            min-width: 300px;
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            display: none;
        }

        .coach-header {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
        }

        .coach-header h3 {
            color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .coach-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8fafc;
        }

        .coach-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }

        .coach-message-received {
            align-self: flex-start;
            background: white;
            border: 1px solid #e2e8f0;
        }

        .coach-message-sent {
            align-self: flex-end;
            background: #4361ee;
            color: white;
        }

        .coach-input {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .coach-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
        }

        .coach-input button {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            cursor: pointer;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-card h3 {
            font-size: 2rem;
            color: #4361ee;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 0.9rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .scenarios-panel {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .coach-panel {
                border-left: none;
                border-top: 1px solid #e2e8f0;
            }
            
            .message {
                max-width: 85%;
            }
        }

        /* Error Message */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>Sales Coach Simulator</h2>
            <p id="loadingText">Loading AI models...</p>
            <div id="errorMessage" class="error-message"></div>
            <button id="retryButton" onclick="initializeApp()" style="
                display: none;
                margin-top: 20px;
                padding: 10px 20px;
                background: white;
                color: #667eea;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
            ">Retry</button>
        </div>
    </div>

    <!-- Main App -->
    <div class="container">
        <div class="app-container">
            <!-- Header -->
            <div class="header">
                <h1>üéØ Sales Coach Simulator</h1>
                <p>Practice sales conversations with AI personas. Get real-time coaching feedback.</p>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Scenarios Panel -->
                <div id="scenariosPanel" class="scenarios-panel">
                    <h2>Select a Scenario</h2>
                    <div class="scenarios-grid" id="scenariosContainer">
                        <!-- Scenarios will load here -->
                    </div>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <h3>3</h3>
                            <p>Practice Scenarios</p>
                        </div>
                        <div class="stat-card">
                            <h3>AI</h3>
                            <p>Live Coaching</p>
                        </div>
                        <div class="stat-card">
                            <h3>üíØ</h3>
                            <p>Real-time Feedback</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Panel -->
                <div id="chatPanel" class="chat-panel" style="display: none;">
                    <div class="chat-header">
                        <button class="back-btn" onclick="showScenarios()">‚Üê</button>
                        <div class="persona-info">
                            <div class="persona-avatar" id="personaAvatar">üë§</div>
                            <div class="persona-details">
                                <h3 id="personaName">Emma Richardson</h3>
                                <p id="personaRole">CFO ‚Ä¢ Medium Difficulty</p>
                            </div>
                        </div>
                        <button onclick="toggleCoachPanel()" style="
                            background: #4361ee;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                        ">üéì AI Coach</button>
                    </div>

                    <!-- Messages -->
                    <div class="messages-container" id="messagesContainer">
                        <!-- Messages appear here -->
                    </div>

                    <!-- Analysis Panel -->
                    <div class="analysis-panel" id="analysisPanel">
                        <div class="analysis-header">
                            <h4>üìä Coach Analysis</h4>
                            <div class="score-badge" id="scoreBadge">Score: 0/100</div>
                        </div>
                        <div class="analysis-content">
                            <div>
                                <strong>Detected Emotion:</strong>
                                <span class="emotion-badge" id="detectedEmotion">Neutral</span>
                            </div>
                            <p class="feedback" id="feedbackText">No feedback yet.</p>
                            <div class="suggestion" id="suggestionText">
                                üí° Tip: Keep the conversation going and address their main concerns.
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="input-area">
                        <div class="input-wrapper">
                            <textarea 
                                id="messageInput" 
                                placeholder="Type your sales pitch here..."
                                rows="2"
                                oninput="autoResize(this)"
                                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                            ></textarea>
                            <button 
                                id="sendButton" 
                                class="send-btn" 
                                onclick="sendMessage()"
                                disabled
                            >‚û§</button>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="insertTemplate('question')" style="
                                background: #f1f5f9;
                                border: 1px solid #e2e8f0;
                                padding: 8px 16px;
                                border-radius: 20px;
                                font-size: 0.9rem;
                                cursor: pointer;
                                color: #475569;
                            ">üí≠ Ask a question</button>
                            <button onclick="insertTemplate('value')" style="
                                background: #f1f5f9;
                                border: 1px solid #e2e8f0;
                                padding: 8px 16px;
                                border-radius: 20px;
                                font-size: 0.9rem;
                                cursor: pointer;
                                color: #475569;
                            ">üí∞ Show value</button>
                            <button onclick="insertTemplate('objection')" style="
                                background: #f1f5f9;
                                border: 1px solid #e2e8f0;
                                padding: 8px 16px;
                                border-radius: 20px;
                                font-size: 0.9rem;
                                cursor: pointer;
                                color: #475569;
                            ">üõ°Ô∏è Handle objection</button>
                        </div>
                    </div>
                </div>

                <!-- Coach Panel -->
                <div id="coachPanel" class="coach-panel">
                    <div class="coach-header">
                        <h3>üß† AI Sales Coach</h3>
                        <p style="color: #64748b; margin-top: 5px;">Live coaching assistant</p>
                    </div>
                    <div class="coach-messages" id="coachMessages">
                        <div class="coach-message coach-message-received">
                            Hello! I'm your AI Sales Coach. I'll help you practice and improve your sales skills. Ask me anything!
                        </div>
                    </div>
                    <div class="coach-input">
                        <input 
                            type="text" 
                            id="coachInput" 
                            placeholder="Ask your coach..."
                            onkeypress="if(event.key === 'Enter') askCoach()"
                        >
                        <button onclick="askCoach()">Ask</button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Sales Coach Simulator ‚Ä¢ Powered by Google Gemini AI ‚Ä¢ Practice API Key</p>
                <p style="font-size: 0.8rem; margin-top: 5px; color: #94a3b8;">
                    Note: Using practice API key. For production, use your own key.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Your API Key
        const API_KEY = "AIzaSyBKXdjfql_vFda8CMDDYjC5Kr32wd-hZHQ";

        // Global variables
        let geminiAI = null;
        let chatSession = null;
        let coachSession = null;
        let currentScenario = null;

        // Scenarios data
        const scenarios = [
            {
                id: 'emma',
                name: 'Emma Richardson',
                role: 'CFO',
                difficulty: 'Medium',
                avatarColor: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                description: 'CFO who needs clear ROI within 12 months. Budget-conscious and data-driven.',
                emotionalTriggers: ['Budget concerns', 'ROI skepticism', 'Risk aversion'],
                systemInstruction: `You are Emma Richardson, CFO of TechGrowth Inc. You're skeptical about new software purchases unless they show clear ROI within 12 months. You're polite but direct. You value data over promises. Your company is currently using outdated CRM software but you're worried about implementation costs and training time.`,
                initialGreeting: "I'm listening to your pitch, but I need to be clear upfront - unless you can show me a clear ROI within 12 months and minimal disruption to our current workflow, this won't be an easy sell. What makes your solution worth our investment?"
            },
            {
                id: 'david',
                name: 'David Chen',
                role: 'IT Director',
                difficulty: 'Hard',
                avatarColor: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                description: 'IT Director overwhelmed with tech solutions. Hates sales jargon and wants practical solutions.',
                emotionalTriggers: ['Jargon aversion', 'Time constraints', 'Integration fears'],
                systemInstruction: `You are David Chen, IT Director at RetailCorp. You're tired of salespeople using buzzwords. You want concrete facts, integration capabilities with existing systems, and minimal maintenance. You're currently dealing with 5 different vendors and it's a nightmare. Be blunt but not rude.`,
                initialGreeting: "Let's skip the sales talk. I've heard it all before. Tell me exactly how this integrates with our existing Azure infrastructure and what the maintenance overhead is. We can't afford another system that needs constant babysitting."
            },
            {
                id: 'sarah',
                name: 'Sarah Johnson',
                role: 'Marketing Manager',
                difficulty: 'Easy',
                avatarColor: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                description: 'Marketing Manager excited about new tech but needs help with team adoption.',
                emotionalTriggers: ['Team adoption', 'Learning curve', 'Feature relevance'],
                systemInstruction: `You are Sarah Johnson, Marketing Manager at a growing e-commerce brand. You're excited about tools that can help your team but worried about adoption. Your team is resistant to change. You need something intuitive that clearly benefits daily workflows.`,
                initialGreeting: "This looks interesting! My team is always looking for ways to work smarter. But they're a bit resistant to new tools. How would this actually fit into our daily workflow? I need something that won't require weeks of training."
            }
        ];

        // Initialize the app
        async function initializeApp() {
            try {
                updateLoadingText('Loading AI SDK...');
                
                // Load Google AI SDK
                await loadGeminiSDK();
                
                updateLoadingText('Initializing AI models...');
                
                // Initialize Gemini AI
                if (window.google && google.ai && google.ai.generativeAI) {
                    geminiAI = new google.ai.generativeAI(API_KEY);
                } else if (window.GoogleGenerativeAI) {
                    geminiAI = new GoogleGenerativeAI(API_KEY);
                } else {
                    throw new Error('Google AI SDK not loaded properly');
                }
                
                updateLoadingText('Testing API connection...');
                
                // Test the API
                const model = geminiAI.getGenerativeModel({ model: 'gemini-pro' });
                await model.generateContent('test');
                
                // Initialize coach
                await initializeCoach();
                
                // Load scenarios
                renderScenarios();
                
                // Show app
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.querySelector('.app-container').style.display = 'block';
                    addCoachMessage('Ready to practice! Select a scenario to begin.', 'received');
                }, 500);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError(`Failed to initialize: ${error.message}`);
            }
        }

        // Load Gemini SDK
        function loadGeminiSDK() {
            return new Promise((resolve, reject) => {
                // Check if already loaded
                if (window.google || window.GoogleGenerativeAI) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@google/generative-ai';
                script.onload = () => {
                    // Wait for SDK to initialize
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        if (window.google || window.GoogleGenerativeAI) {
                            clearInterval(checkInterval);
                            resolve();
                        } else if (attempts > 20) {
                            clearInterval(checkInterval);
                            reject(new Error('SDK failed to initialize'));
                        }
                        attempts++;
                    }, 100);
                };
                script.onerror = () => {
                    reject(new Error('Failed to load Google AI SDK'));
                };
                document.head.appendChild(script);
            });
        }

        // Initialize AI Coach
        async function initializeCoach() {
            try {
                const model = geminiAI.getGenerativeModel({ 
                    model: 'gemini-pro',
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 300,
                    }
                });
                
                coachSession = model.startChat({
                    history: [
                        {
                            role: "user",
                            parts: [{ text: "You are an expert sales coach with 20 years experience. Give short, actionable advice. Be supportive but honest." }],
                        },
                        {
                            role: "model",
                            parts: [{ text: "I'll help you practice sales conversations. Ask me for strategies, feedback, or tips." }],
                        }
                    ]
                });
            } catch (error) {
                console.warn('Coach init failed:', error);
            }
        }

        // Render scenarios
        function renderScenarios() {
            const container = document.getElementById('scenariosContainer');
            container.innerHTML = '';
            
            scenarios.forEach(scenario => {
                const card = document.createElement('div');
                card.className = 'scenario-card';
                card.innerHTML = `
                    <div class="scenario-header">
                        <div class="scenario-avatar" style="background: ${scenario.avatarColor}">
                            üë§
                        </div>
                        <div class="scenario-info">
                            <h3>${scenario.name}</h3>
                            <p>${scenario.role} ‚Ä¢ <span class="difficulty-${scenario.difficulty.toLowerCase()}">${scenario.difficulty}</span></p>
                        </div>
                    </div>
                    <p class="scenario-desc">${scenario.description}</p>
                    <div class="scenario-tags">
                        ${scenario.emotionalTriggers.map(trigger => 
                            `<span class="tag">${trigger}</span>`
                        ).join('')}
                    </div>
                `;
                
                card.onclick = () => startScenario(scenario);
                container.appendChild(card);
            });
        }

        // Start a scenario
        async function startScenario(scenario) {
            currentScenario = scenario;
            
            // Update UI
            document.getElementById('scenariosPanel').style.display = 'none';
            document.getElementById('chatPanel').style.display = 'flex';
            document.getElementById('coachPanel').style.display = 'none';
            
            // Update persona info
            document.getElementById('personaName').textContent = scenario.name;
            document.getElementById('personaRole').textContent = `${scenario.role} ‚Ä¢ ${scenario.difficulty} Difficulty`;
            document.getElementById('personaAvatar').style.background = scenario.avatarColor;
            
            // Clear chat
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('analysisPanel').style.display = 'none';
            
            // Add initial message
            addMessage(scenario.initialGreeting, 'ai');
            
            // Initialize chat session
            try {
                const model = geminiAI.getGenerativeModel({ 
                    model: 'gemini-pro',
                    generationConfig: {
                        temperature: 0.8,
                        maxOutputTokens: 300,
                    }
                });
                
                chatSession = model.startChat({
                    history: [
                        {
                            role: "user",
                            parts: [{ text: scenario.systemInstruction }],
                        },
                        {
                            role: "model",
                            parts: [{ text: scenario.initialGreeting }],
                        }
                    ]
                });
                
                // Update coach
                addCoachMessage(`You're now practicing with ${scenario.name}, the ${scenario.role}. ${scenario.description}`, 'received');
                
            } catch (error) {
                console.error('Chat init failed:', error);
                addMessage('Error starting conversation. Please try again.', 'ai');
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !chatSession) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            autoResize(input);
            document.getElementById('sendButton').disabled = true;
            
            // Show typing indicator
            const typing = document.createElement('div');
            typing.className = 'typing-indicator';
            typing.innerHTML = `
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            `;
            document.getElementById('messagesContainer').appendChild(typing);
            
            try {
                // Get response
                const result = await chatSession.sendMessage(message);
                const response = result.response;
                const text = response.text();
                
                // Remove typing indicator
                typing.remove();
                
                // Add AI response
                addMessage(text, 'ai');
                
                // Analyze conversation
                analyzeConversation(message, text);
                
            } catch (error) {
                console.error('Error:', error);
                typing.remove();
                addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                document.getElementById('sendButton').disabled = false;
            }
        }

        // Add message to chat
        function addMessage(text, sender) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            
            const time = new Date().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <p>${escapeHtml(text)}</p>
                <span class="message-time">${time}</span>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Analyze conversation
        async function analyzeConversation(userMsg, aiMsg) {
            if (!currentScenario || !geminiAI) return;
            
            const prompt = `
                Analyze this sales conversation:
                
                Scenario: ${currentScenario.description}
                Salesperson: "${userMsg}"
                Customer: "${aiMsg}"
                
                Provide analysis in this exact format:
                Score: [0-100]
                Emotion: [detected emotion]
                Feedback: [one sentence]
                Suggestion: [one tip]
            `;
            
            try {
                const model = geminiAI.getGenerativeModel({ model: 'gemini-pro' });
                const result = await model.generateContent(prompt);
                const response = result.response;
                const text = response.text();
                
                // Parse response
                const scoreMatch = text.match(/Score:\s*(\d+)/);
                const emotionMatch = text.match(/Emotion:\s*([^\n]+)/);
                const feedbackMatch = text.match(/Feedback:\s*([^\n]+)/);
                const suggestionMatch = text.match(/Suggestion:\s*([^\n]+)/);
                
                // Update UI
                const container = document.getElementById('analysisPanel');
                const scoreBadge = document.getElementById('scoreBadge');
                const detectedEmotion = document.getElementById('detectedEmotion');
                const feedbackText = document.getElementById('feedbackText');
                const suggestionText = document.getElementById('suggestionText');
                
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[1]);
                    scoreBadge.textContent = `Score: ${score}/100`;
                    
                    // Update score color
                    if (score >= 80) {
                        scoreBadge.className = 'score-badge score-good';
                    } else if (score >= 60) {
                        scoreBadge.className = 'score-badge score-medium';
                    } else {
                        scoreBadge.className = 'score-badge score-poor';
                    }
                }
                
                if (emotionMatch) detectedEmotion.textContent = emotionMatch[1].trim();
                if (feedbackMatch) feedbackText.textContent = feedbackMatch[1].trim();
                if (suggestionMatch) suggestionText.textContent = `üí° ${suggestionMatch[1].trim()}`;
                
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
                
                // Get coach feedback
                getCoachFeedback(userMsg, aiMsg);
                
            } catch (error) {
                console.error('Analysis failed:', error);
            }
        }

        // Get coach feedback
        async function getCoachFeedback(userMsg, aiMsg) {
            if (!coachSession) return;
            
            const prompt = `Brief feedback for this exchange with ${currentScenario.name}:\n\nUser: "${userMsg}"\nCustomer: "${aiMsg}"\n\nGive one tip for improvement.`;
            
            try {
                const result = await coachSession.sendMessage(prompt);
                const response = result.response;
                const text = response.text();
                
                addCoachMessage(text, 'received');
            } catch (error) {
                console.error('Coach feedback failed:', error);
            }
        }

        // Ask coach
        async function askCoach() {
            const input = document.getElementById('coachInput');
            const question = input.value.trim();
            
            if (!question || !coachSession) return;
            
            // Add user question
            addCoachMessage(question, 'sent');
            input.value = '';
            
            try {
                const result = await coachSession.sendMessage(question);
                const response = result.response;
                const text = response.text();
                
                addCoachMessage(text, 'received');
            } catch (error) {
                console.error('Coach error:', error);
                addCoachMessage('Sorry, I encountered an error. Please try again.', 'received');
            }
        }

        // Add coach message
        function addCoachMessage(text, type) {
            const container = document.getElementById('coachMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `coach-message coach-message-${type}`;
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // UI Functions
        function toggleCoachPanel() {
            const panel = document.getElementById('coachPanel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'flex';
                if (currentScenario) {
                    addCoachMessage(`I'm here to help you with ${currentScenario.name}. What do you need help with?`, 'received');
                }
            }
        }

        function showScenarios() {
            document.getElementById('chatPanel').style.display = 'none';
            document.getElementById('coachPanel').style.display = 'none';
            document.getElementById('scenariosPanel').style.display = 'block';
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            document.getElementById('sendButton').disabled = !textarea.value.trim();
        }

        function insertTemplate(type) {
            const templates = {
                question: "That's a great point. Can you tell me more about your current process?",
                value: "Based on what you've shared, our solution could save you approximately 15 hours per week by...",
                objection: "I understand your concern about [objection]. Many of our clients felt the same way initially, but they found that..."
            };
            
            const input = document.getElementById('messageInput');
            if (templates[type]) {
                input.value = templates[type];
                autoResize(input);
                document.getElementById('sendButton').disabled = false;
            }
        }

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('retryButton').style.display = 'inline-block';
        }

        // Start the app
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>