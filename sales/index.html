<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Coach Simulator</title>
    <style>
        /* ====== RESET & BASE ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        /* ====== LOADING SCREEN ====== */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
        }

        .loading-content {
            max-width: 400px;
            padding: 40px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ====== APP CONTAINER ====== */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: none;
        }

        /* ====== HEADER ====== */
        .header {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* ====== MAIN LAYOUT ====== */
        .main-layout {
            display: flex;
            flex-wrap: wrap;
            min-height: 700px;
        }

        /* ====== SIDEBAR ====== */
        .sidebar {
            flex: 1;
            min-width: 300px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding: 30px;
        }

        .scenarios-container {
            margin-top: 20px;
        }

        .scenario-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e2e8f0;
        }

        .scenario-card:hover {
            border-color: #4361ee;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.1);
        }

        .scenario-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .scenario-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .scenario-info h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .scenario-desc {
            color: #64748b;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .scenario-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            background: #f1f5f9;
            color: #475569;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .tag.difficulty-easy { background: #d1fae5; color: #065f46; }
        .tag.difficulty-medium { background: #fef3c7; color: #92400e; }
        .tag.difficulty-hard { background: #fee2e2; color: #991b1b; }

        /* ====== CHAT AREA ====== */
        .chat-area {
            flex: 2;
            min-width: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: #f1f5f9;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }

        .persona-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .persona-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .persona-details h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .persona-details p {
            color: #64748b;
            font-size: 0.9rem;
        }

        /* ====== MESSAGES ====== */
        .messages-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 500px;
        }

        .message {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            background: #4361ee;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            align-self: flex-start;
            background: white;
            color: #334155;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            display: block;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 8px;
            text-align: right;
        }

        /* ====== INPUT AREA ====== */
        .input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
        }

        textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            max-height: 120px;
            transition: all 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .send-btn {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 12px;
            width: 60px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            background: #3a56d4;
        }

        .send-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        /* ====== ANALYSIS PANEL ====== */
        .analysis-panel {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            margin: 0 30px 20px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .analysis-header h4 {
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .score-good { background: #d1fae5; color: #065f46; }
        .score-medium { background: #fef3c7; color: #92400e; }
        .score-poor { background: #fee2e2; color: #991b1b; }

        .analysis-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .emotion-badge {
            background: #e0f2fe;
            color: #0369a1;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-left: 10px;
        }

        .feedback {
            color: #475569;
            font-style: italic;
            line-height: 1.5;
        }

        .suggestion {
            background: #e6f3ff;
            padding: 15px;
            border-radius: 8px;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
            margin-top: 10px;
        }

        /* ====== COACH PANEL ====== */
        .coach-panel {
            flex: 1;
            min-width: 300px;
            background: white;
            border-left: 1px solid #e2e8f0;
            display: none;
            flex-direction: column;
        }

        .coach-header {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .coach-header h3 {
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .coach-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .coach-message {
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
        }

        .coach-message.user {
            align-self: flex-end;
            background: #4361ee;
            color: white;
        }

        .coach-message.ai {
            align-self: flex-start;
            background: white;
            border: 1px solid #e2e8f0;
        }

        .coach-input {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .coach-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .coach-input button {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            cursor: pointer;
            font-size: 1rem;
        }

        /* ====== TYPING INDICATOR ====== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 15px;
            align-self: flex-start;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #94a3b8;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* ====== QUICK ACTIONS ====== */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            color: #475569;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: #e2e8f0;
        }

        /* ====== RESPONSIVE ====== */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .coach-panel {
                border-left: none;
                border-top: 1px solid #e2e8f0;
            }
            
            .message {
                max-width: 85%;
            }
            
            body {
                padding: 10px;
            }
        }

        /* ====== ERROR MESSAGE ====== */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        /* ====== STATUS INDICATOR ====== */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #d1fae5;
            color: #065f46;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ====== QUICK TIPS ====== */
        .quick-tips {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tip-btn {
            background: #f0f9ff;
            color: #0369a1;
            border: 1px solid #bae6fd;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tip-btn:hover {
            background: #e0f2fe;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>üöÄ Sales Coach Simulator</h2>
            <p id="loadingText">Initializing application...</p>
            <div id="errorMessage" class="error-message"></div>
            <div style="margin-top: 30px; text-align: left; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                <h4 style="margin-bottom: 10px;">‚ú® Features:</h4>
                <p>‚úÖ AI-powered sales practice</p>
                <p>‚úÖ Real-time coaching feedback</p>
                <p>‚úÖ No SDK required</p>
                <p>‚úÖ Works in all browsers</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>üéØ Sales Coach Simulator</h1>
            <p>Practice sales conversations with AI personas. Get instant feedback.</p>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>Connected to Gemini AI</span>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar (Scenarios) -->
            <div id="sidebar" class="sidebar">
                <h2>üë• Practice Scenarios</h2>
                <p style="color: #64748b; margin: 10px 0 20px;">Select a customer persona to practice with:</p>
                
                <div class="scenarios-container" id="scenariosContainer">
                    <!-- Scenarios will load here -->
                </div>

                <div class="quick-tips">
                    <button class="tip-btn" onclick="toggleCoachPanel()">üß† Ask AI Coach</button>
                    <button class="tip-btn" onclick="showHelp()">‚ùì How to Practice</button>
                </div>
            </div>

            <!-- Chat Area -->
            <div id="chatArea" class="chat-area" style="display: none;">
                <!-- Chat Header -->
                <div class="chat-header">
                    <button class="back-btn" onclick="showScenarios()">‚Üê</button>
                    <div class="persona-info">
                        <div class="persona-avatar" id="personaAvatar">üë§</div>
                        <div class="persona-details">
                            <h3 id="personaName">Emma Richardson</h3>
                            <p id="personaRole">CFO ‚Ä¢ Medium Difficulty</p>
                        </div>
                    </div>
                    <button onclick="toggleCoachPanel()" style="
                        background: #4361ee;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                    ">üß† AI Coach</button>
                </div>

                <!-- Messages -->
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages appear here -->
                </div>

                <!-- Analysis Panel -->
                <div class="analysis-panel" id="analysisPanel">
                    <div class="analysis-header">
                        <h4>üìä Coach Analysis</h4>
                        <div id="scoreBadge" class="score-badge score-medium">Score: 0/100</div>
                    </div>
                    <div class="analysis-content">
                        <div>
                            <strong>Detected Emotion:</strong>
                            <span id="detectedEmotion" class="emotion-badge">Neutral</span>
                        </div>
                        <p class="feedback" id="feedbackText">Start the conversation to get feedback.</p>
                        <div class="suggestion" id="suggestionText">
                            üí° Tip: Listen carefully to their concerns and address them directly.
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="Type your sales pitch here... (Press Shift+Enter for new line)"
                            rows="2"
                            oninput="autoResize(this)"
                            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                        ></textarea>
                        <button 
                            id="sendButton" 
                            class="send-btn" 
                            onclick="sendMessage()"
                            disabled
                        >‚û§</button>
                    </div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="insertTemplate('question')">üí≠ Ask a question</button>
                        <button class="quick-btn" onclick="insertTemplate('value')">üí∞ Show value</button>
                        <button class="quick-btn" onclick="insertTemplate('objection')">üõ°Ô∏è Handle objection</button>
                        <button class="quick-btn" onclick="insertTemplate('closing')">ü§ù Try to close</button>
                    </div>
                </div>
            </div>

            <!-- Coach Panel -->
            <div id="coachPanel" class="coach-panel">
                <div class="coach-header">
                    <h3>üß† AI Sales Coach</h3>
                    <p style="color: #64748b; margin-top: 5px;">Get real-time feedback and advice</p>
                </div>
                <div class="coach-messages" id="coachMessages">
                    <div class="coach-message ai">
                        Hi! I'm your AI Sales Coach. I'll help you improve your sales skills. 
                        Ask me for strategies, feedback, or tips on handling objections!
                    </div>
                </div>
                <div class="coach-input">
                    <input 
                        type="text" 
                        id="coachInput" 
                        placeholder="Ask your coach anything..."
                        onkeypress="if(event.key === 'Enter') askCoach()"
                    >
                    <button onclick="askCoach()">Ask</button>
                </div>
                <div style="padding: 15px; border-top: 1px solid #e2e8f0;">
                    <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 10px;">Quick questions:</p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="quickCoachQuestion('strategy')" style="
                            background: #f0f9ff;
                            color: #0369a1;
                            border: 1px solid #bae6fd;
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-size: 0.85rem;
                            cursor: pointer;
                        ">Best strategy?</button>
                        <button onclick="quickCoachQuestion('objection')" style="
                            background: #f0f9ff;
                            color: #0369a1;
                            border: 1px solid #bae6fd;
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-size: 0.85rem;
                            cursor: pointer;
                        ">Handle objection?</button>
                        <button onclick="quickCoachQuestion('question')" style="
                            background: #f0f9ff;
                            color: #0369a1;
                            border: 1px solid #bae6fd;
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-size: 0.85rem;
                            cursor: pointer;
                        ">What to ask?</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div style="background: #f8fafc; padding: 20px; text-align: center; color: #64748b; border-top: 1px solid #e2e8f0;">
            <p>Sales Coach Simulator ‚Ä¢ Powered by Google Gemini AI ‚Ä¢ Using REST API</p>
            <p style="font-size: 0.85rem; margin-top: 5px; color: #94a3b8;">
                API calls are made directly to Google's servers. Your key stays in your browser.
            </p>
        </div>
    </div>

    <script>
        // ===================== CONFIGURATION =====================
        const API_KEY = "AIzaSyBKXdjfql_vFda8CMDDYjC5Kr32wd-hZHQ";
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent";

        // ===================== STATE VARIABLES =====================
        let currentScenario = null;
        let conversationHistory = [];
        let coachHistory = [];

        // ===================== SCENARIOS DATA =====================
        const scenarios = [
            {
                id: 'emma',
                name: 'Emma Richardson',
                role: 'CFO',
                difficulty: 'Medium',
                avatarColor: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                description: 'CFO who needs clear ROI within 12 months. Budget-conscious and data-driven.',
                tags: ['Budget', 'ROI', 'Data-driven'],
                personality: `You are Emma Richardson, CFO of TechGrowth Inc. You're skeptical about new software purchases unless they show clear ROI within 12 months. You're polite but direct. You value data over promises. Your company is currently using outdated CRM software but you're worried about implementation costs and training time.`,
                initialMessage: "I'm listening to your pitch, but I need to be clear upfront - unless you can show me a clear ROI within 12 months and minimal disruption to our current workflow, this won't be an easy sell. What makes your solution worth our investment?"
            },
            {
                id: 'david',
                name: 'David Chen',
                role: 'IT Director',
                difficulty: 'Hard',
                avatarColor: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                description: 'IT Director overwhelmed with tech solutions. Hates sales jargon and wants practical solutions.',
                tags: ['Technical', 'No-nonsense', 'Integration'],
                personality: `You are David Chen, IT Director at RetailCorp. You're tired of salespeople using buzzwords. You want concrete facts, integration capabilities with existing systems, and minimal maintenance. You're currently dealing with 5 different vendors and it's a nightmare. Be blunt but not rude.`,
                initialMessage: "Let's skip the sales talk. I've heard it all before. Tell me exactly how this integrates with our existing Azure infrastructure and what the maintenance overhead is. We can't afford another system that needs constant babysitting."
            },
            {
                id: 'sarah',
                name: 'Sarah Johnson',
                role: 'Marketing Manager',
                difficulty: 'Easy',
                avatarColor: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                description: 'Marketing Manager excited about new tech but needs help with team adoption.',
                tags: ['Team-oriented', 'Adoption-focused', 'User-friendly'],
                personality: `You are Sarah Johnson, Marketing Manager at a growing e-commerce brand. You're excited about tools that can help your team but worried about adoption. Your team is resistant to change. You need something intuitive that clearly benefits daily workflows.`,
                initialMessage: "This looks interesting! My team is always looking for ways to work smarter. But they're a bit resistant to new tools. How would this actually fit into our daily workflow? I need something that won't require weeks of training."
            }
        ];

        // ===================== INITIALIZATION =====================
        async function initializeApp() {
            try {
                updateLoadingText('Checking API configuration...');
                
                // Test the API with a simple request
                const testResult = await callGeminiAPI("Hello", []);
                if (!testResult) {
                    throw new Error("API test failed. Check your internet connection and API key.");
                }
                
                updateLoadingText('Loading scenarios...');
                
                // Initialize coach
                coachHistory.push({
                    role: "user",
                    parts: [{ text: "You are an expert sales coach with 20 years of experience. Give short, actionable advice for sales conversations. Be supportive but honest. Keep responses under 100 words." }]
                });
                
                coachHistory.push({
                    role: "model",
                    parts: [{ text: "I'm your AI Sales Coach! I'll help you practice sales conversations and give you actionable feedback. Ask me for strategies, tips, or analysis of your conversations." }]
                });
                
                // Load scenarios
                renderScenarios();
                
                // Show app
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.querySelector('.app-container').style.display = 'block';
                    updateLoadingText('Ready!');
                }, 1000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError(`Failed to initialize: ${error.message}`);
            }
        }

        // ===================== CORE API FUNCTION =====================
        async function callGeminiAPI(message, history, systemInstruction = "") {
            try {
                const url = `${API_URL}?key=${API_KEY}`;
                
                // Prepare the content array
                const contents = [];
                
                // Add system instruction if provided
                if (systemInstruction) {
                    contents.push({
                        role: "user",
                        parts: [{ text: systemInstruction }]
                    });
                    contents.push({
                        role: "model", 
                        parts: [{ text: "Understood. I will roleplay as specified." }]
                    });
                }
                
                // Add conversation history
                history.forEach(msg => {
                    contents.push({
                        role: msg.role === "user" ? "user" : "model",
                        parts: [{ text: msg.content }]
                    });
                });
                
                // Add current message
                contents.push({
                    role: "user",
                    parts: [{ text: message }]
                });
                
                const requestBody = {
                    contents: contents,
                    generationConfig: {
                        temperature: 0.8,
                        maxOutputTokens: 500,
                    }
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error("Invalid API response");
                }
                
                return data.candidates[0].content.parts[0].text;
                
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // ===================== RENDER SCENARIOS =====================
        function renderScenarios() {
            const container = document.getElementById('scenariosContainer');
            container.innerHTML = '';
            
            scenarios.forEach(scenario => {
                const card = document.createElement('div');
                card.className = 'scenario-card';
                card.innerHTML = `
                    <div class="scenario-header">
                        <div class="scenario-avatar" style="background: ${scenario.avatarColor}">
                            üë§
                        </div>
                        <div>
                            <h3>${scenario.name}</h3>
                            <p style="color: #64748b; font-size: 0.9rem;">${scenario.role} ‚Ä¢ 
                                <span class="tag difficulty-${scenario.difficulty.toLowerCase()}">
                                    ${scenario.difficulty}
                                </span>
                            </p>
                        </div>
                    </div>
                    <p class="scenario-desc">${scenario.description}</p>
                    <div class="scenario-tags">
                        ${scenario.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                `;
                
                card.onclick = () => startScenario(scenario);
                container.appendChild(card);
            });
        }

        // ===================== START SCENARIO =====================
        async function startScenario(scenario) {
            currentScenario = scenario;
            conversationHistory = [];
            
            // Update UI
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('chatArea').style.display = 'flex';
            document.getElementById('coachPanel').style.display = 'none';
            
            // Update persona info
            document.getElementById('personaName').textContent = scenario.name;
            document.getElementById('personaRole').textContent = `${scenario.role} ‚Ä¢ ${scenario.difficulty} Difficulty`;
            document.getElementById('personaAvatar').style.background = scenario.avatarColor;
            
            // Clear chat
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('analysisPanel').style.display = 'none';
            
            // Add initial message
            addMessage(scenario.initialMessage, 'ai');
            
            // Add to history
            conversationHistory.push({
                role: "ai",
                content: scenario.initialMessage
            });
            
            // Add coach welcome
            addCoachMessage(`You're now practicing with ${scenario.name}, the ${scenario.role}. ${scenario.description}`, 'ai');
        }

        // ===================== SEND MESSAGE =====================
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentScenario) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            autoResize(input);
            document.getElementById('sendButton').disabled = true;
            
            // Add to history
            conversationHistory.push({
                role: "user",
                content: message
            });
            
            // Show typing indicator
            const typing = document.createElement('div');
            typing.className = 'typing-indicator';
            typing.innerHTML = `
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            `;
            document.getElementById('messagesContainer').appendChild(typing);
            
            try {
                // Get AI response
                const response = await callGeminiAPI(message, conversationHistory.slice(0, -1), currentScenario.personality);
                
                // Remove typing indicator
                typing.remove();
                
                // Add AI response
                addMessage(response, 'ai');
                
                // Add to history
                conversationHistory.push({
                    role: "ai",
                    content: response
                });
                
                // Analyze conversation
                await analyzeConversation(message, response);
                
                // Get coach feedback
                await getCoachFeedback(message, response);
                
            } catch (error) {
                console.error('Error:', error);
                typing.remove();
                addMessage("I'm having trouble responding right now. Please try again.", 'ai');
                document.getElementById('sendButton').disabled = false;
            }
        }

        // ===================== ANALYZE CONVERSATION =====================
        async function analyzeConversation(userMsg, aiMsg) {
            if (!currentScenario) return;
            
            const prompt = `Analyze this sales conversation:

Scenario: ${currentScenario.description}
Salesperson: "${userMsg}"
Customer: "${aiMsg}"

Provide analysis in this exact format:
Score: [0-100]
Emotion: [detected emotion]
Feedback: [one sentence]
Suggestion: [one specific tip]`;
            
            try {
                const analysisText = await callGeminiAPI(prompt, []);
                
                // Parse response
                const scoreMatch = analysisText.match(/Score:\s*(\d+)/);
                const emotionMatch = analysisText.match(/Emotion:\s*([^\n]+)/);
                const feedbackMatch = analysisText.match(/Feedback:\s*([^\n]+)/);
                const suggestionMatch = analysisText.match(/Suggestion:\s*([^\n]+)/);
                
                // Update UI
                const container = document.getElementById('analysisPanel');
                const scoreBadge = document.getElementById('scoreBadge');
                const detectedEmotion = document.getElementById('detectedEmotion');
                const feedbackText = document.getElementById('feedbackText');
                const suggestionText = document.getElementById('suggestionText');
                
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[1]);
                    scoreBadge.textContent = `Score: ${score}/100`;
                    
                    // Update score color
                    scoreBadge.className = 'score-badge ';
                    if (score >= 80) scoreBadge.classList.add('score-good');
                    else if (score >= 60) scoreBadge.classList.add('score-medium');
                    else scoreBadge.classList.add('score-poor');
                }
                
                if (emotionMatch) detectedEmotion.textContent = emotionMatch[1].trim();
                if (feedbackMatch) feedbackText.textContent = feedbackMatch[1].trim();
                if (suggestionMatch) suggestionText.innerHTML = `üí° ${suggestionMatch[1].trim()}`;
                
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Analysis failed:', error);
            }
        }

        // ===================== COACH FUNCTIONS =====================
        async function askCoach() {
            const input = document.getElementById('coachInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Add user question
            addCoachMessage(question, 'user');
            input.value = '';
            
            // Add to history
            coachHistory.push({
                role: "user",
                parts: [{ text: question }]
            });
            
            try {
                // Get coach response
                const response = await callGeminiAPI(question, coachHistory.slice(-10));
                
                // Add to history
                coachHistory.push({
                    role: "model",
                    parts: [{ text: response }]
                });
                
                // Show response
                addCoachMessage(response, 'ai');
                
            } catch (error) {
                console.error('Coach error:', error);
                addCoachMessage("I'm having trouble responding. Please try again.", 'ai');
            }
        }

        async function getCoachFeedback(userMsg, aiMsg) {
            const prompt = `Brief feedback for this exchange with ${currentScenario.name}:

Salesperson: "${userMsg}"
Customer: "${aiMsg}"

Give one practical tip for improvement in 1-2 sentences.`;
            
            try {
                const feedback = await callGeminiAPI(prompt, []);
                addCoachMessage(feedback, 'ai');
            } catch (error) {
                console.error('Coach feedback failed:', error);
            }
        }

        function quickCoachQuestion(type) {
            const questions = {
                strategy: "What's the best strategy for dealing with this customer?",
                objection: "How should I handle their main objection?",
                question: "What question should I ask next to move the conversation forward?"
            };
            
            if (questions[type]) {
                document.getElementById('coachInput').value = questions[type];
                askCoach();
            }
        }

        // ===================== UI FUNCTIONS =====================
        function addMessage(text, sender) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const time = new Date().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <p>${escapeHtml(text)}</p>
                <span class="message-time">${time}</span>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addCoachMessage(text, sender) {
            const container = document.getElementById('coachMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `coach-message ${sender}`;
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function toggleCoachPanel() {
            const panel = document.getElementById('coachPanel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        function showScenarios() {
            document.getElementById('chatArea').style.display = 'none';
            document.getElementById('coachPanel').style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            document.getElementById('sendButton').disabled = !textarea.value.trim();
        }

        function insertTemplate(type) {
            const templates = {
                question: "That's a great point. Can you tell me more about your current process and what you're hoping to achieve?",
                value: "Based on what you've shared, I believe our solution could help you achieve [benefit] by [specific way]. Many of our clients have seen [result].",
                objection: "I understand your concern about [objection]. Let me address that directly...",
                closing: "Based on our conversation, it sounds like this could be a good fit. Would you be open to scheduling a follow-up call with our technical team?"
            };
            
            const input = document.getElementById('messageInput');
            if (templates[type]) {
                input.value = templates[type];
                autoResize(input);
                document.getElementById('sendButton').disabled = false;
            }
        }

        function showHelp() {
            alert(`üéØ HOW TO PRACTICE:

1. Select a scenario (customer persona)
2. Type your sales pitch in the chat
3. Get real-time feedback from the AI Coach
4. Use quick templates for common responses
5. Ask the AI Coach for specific advice

üí° TIPS:
- Listen to the customer's concerns
- Address objections directly
- Show value, not just features
- Ask open-ended questions
- Practice different approaches`);
        }

        // ===================== UTILITY FUNCTIONS =====================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        // ===================== INITIALIZE APP =====================
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>