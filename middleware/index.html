<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raven Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Paystack SDK -->
    <script src="https://js.paystack.co/v2/inline.js"></script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8LYQ579PW8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8LYQ579PW8');
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: "#0F2C59",
                            50: "#f0f3f8",
                            100: "#d6e1ee",
                            500: "#0F2C59",
                            600: "#0a2549",
                            700: "#081e39",
                        },
                        accent: {
                            DEFAULT: "#009F9D",
                            50: "#e6f7f7",
                            100: "#b3ebea",
                            500: "#009F9D",
                            600: "#008280",
                            700: "#006663",
                        },
                        neutral: {
                            25: "#FEFEFE",
                            50: "#F8F9FA",
                            100: "#F1F3F4",
                            200: "#E8EAED",
                            300: "#DADCE0",
                            400: "#BDC1C6",
                            500: "#9AA0A6",
                            600: "#80868B",
                            700: "#5F6368",
                            800: "#2D3748",
                            900: "#1F2937",
                        },
                        premium: {
                            DEFAULT: "#F59E0B",
                            50: "#fffbeb",
                            100: "#fef3c7",
                            500: "#F59E0B",
                            600: "#D97706",
                            700: "#B45309",
                        },
                        success: "#22c55e",
                        warning: "#f59e0b",
                        error: "#ef4444",
                    },
                    boxShadow: {
                        'material-1': '0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24)',
                        'material-2': '0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23)',
                        'material-3': '0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23)',
                        'material-4': '0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22)',
                    },
                    fontFamily: {
                        'sans': ['Roboto', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        .material-card {
            transition: box-shadow 0.28s cubic-bezier(0.4, 0.0, 0.2, 1), transform 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .material-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .material-button {
            transition: all 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .material-button:active {
            transform: scale(0.98);
        }
        .dark .material-card {
            background-color: #1F2937;
            border-color: #374151;
        }
        .dark .material-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .headline-3 { font-size: 1.75rem; font-weight: 700; line-height: 1.2; letter-spacing: -0.5px; }
        .headline-4 { font-size: 1.25rem; font-weight: 600; line-height: 1.235; letter-spacing: 0.25px; }
        .headline-5 { font-size: 1.125rem; font-weight: 600; line-height: 1.334; }
        .headline-6 { font-size: 1rem; font-weight: 500; line-height: 1.6; letter-spacing: 0.15px; }
        .subtitle-1 { font-size: 0.875rem; font-weight: 400; line-height: 1.75; letter-spacing: 0.15px; }
        .body-1 { font-size: 0.875rem; font-weight: 400; line-height: 1.5; letter-spacing: 0.5px; }
        .button-text { font-size: 0.75rem; font-weight: 500; line-height: 1.75; letter-spacing: 1.25px; text-transform: uppercase; }
        .caption { font-size: 0.6875rem; font-weight: 400; line-height: 1.66; letter-spacing: 0.4px; }

        @media (min-width: 640px) {
            .headline-3 { font-size: 2.25rem; }
            .headline-4 { font-size: 1.5rem; }
            .headline-5 { font-size: 1.25rem; }
        }
        @media (min-width: 1024px) {
            .headline-3 { font-size: 3rem; }
            .headline-4 { font-size: 2.125rem; }
            .headline-5 { font-size: 1.75rem; }
        }

        .hero-section {
            background: linear-gradient(135deg, rgba(15, 44, 89, 0.02) 0%, rgba(0, 159, 157, 0.02) 100%);
        }
        .dark .hero-section {
            background: linear-gradient(135deg, rgba(15, 44, 89, 0.1) 0%, rgba(0, 159, 157, 0.05) 100%);
        }

        .option-btn {
            border: 2px solid transparent;
            transition: all 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .option-btn:hover {
            border-color: rgba(15, 44, 89, 0.3);
            transform: translateY(-1px);
        }
        .option-btn.selected {
            border-color: #d7e422;
            background-color: rgba(34, 197, 94, 0.1);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }
        .option-btn.correct {
            border-color: #22c55e;
            background-color: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        .option-btn.incorrect {
            border-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        .dark .option-btn.selected {
            border-color: #71c522;
            background-color: rgba(34, 197, 94, 0.15);
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.4), 0 0 0 3px rgba(34, 197, 94, 0.25);
        }

        .progress-bar {
            height: 6px;
            background-color: rgba(34, 197, 94, 0.2);
            border-radius: 6px;
            overflow: hidden;
        }
        .dark .progress-bar {
            background-color: rgba(34, 197, 94, 0.3);
        }
        .progress-fill {
            background-color: #22c55e;
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .spinner {
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }

        .subject-card {
            position: relative;
            overflow: hidden;
        }
        .subject-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--card-color-start), var(--card-color-end));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .subject-card:hover::before {
            transform: scaleX(1);
        }

        .premium-badge-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 40;
            animation: slideInUp 0.3s ease;
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .timer-low {
            animation: timerPulse 0.5s ease-in-out infinite;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .img-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .dark .img-loading {
            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            body { overflow-y: auto !important; min-height: auto; }
            #quizInterface { min-height: auto !important; padding-bottom: 60px; }
            #quizInterface > div { padding-top: 8px !important; padding-bottom: 8px !important; }
            #quizInterface .material-card { padding: 12px !important; margin-bottom: 8px !important; }
            #questionOptions { gap: 6px !important; }
            #questionOptions .option-btn { padding: 8px 12px !important; font-size: 0.8rem !important; }
        }
    </style>
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 font-sans transition-colors duration-200">

<main class="min-h-screen">
    <!-- Subject Selection -->
    <div id="subjectSelection" class="mb-6">
        <!-- Hero Section -->
        <div class="hero-section border-b border-neutral-200 dark:border-neutral-800">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
                <!-- Header with Premium Button -->
                <div class="flex items-center justify-between mb-6">
                    <a href="/middleware/index.html" class="inline-flex items-center space-x-2 text-neutral-600 dark:text-neutral-400 hover:text-primary dark:hover:text-accent transition-colors group">
                        <span class="material-icons text-xl">arrow_back</span>
                        <span class="text-sm font-medium">Back to Home</span>
                    </a>
                    <button id="headerPremiumBtn" class="inline-flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-premium-500 to-premium-600 text-white rounded-xl font-medium shadow-material-1 hover:shadow-material-2 transition-all">
                        <span class="material-icons text-lg">workspace_premium</span>
                        <span class="text-sm">Unlock All</span>
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h1 class="headline-4 text-neutral-900 dark:text-white mb-2">JAMB SERIES REMIX</h1>
                        <p class="text-base text-neutral-600 dark:text-neutral-400">Master JAMB past questions topic by topic with our extensive question bank.</p>
                        <!-- Free topics notice -->
                        <div class="mt-3 inline-flex items-center space-x-2 px-3 py-1.5 bg-success/10 border border-success/20 rounded-full">
                            <span class="material-icons text-success text-sm">card_giftcard</span>
                            <span class="text-xs font-medium text-success">First 3 topics of each subject are FREE!</span>
                        </div>
                    </div>
                    <!-- Mode Selector -->
                    <div class="hidden sm:flex items-center gap-2">
                        <span class="text-xs text-neutral-500 dark:text-neutral-400 mr-1">Mode:</span>
                        <div id="modeSelectorButtons" class="flex items-center gap-1 bg-neutral-100 dark:bg-neutral-800 rounded-xl p-1"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Mode Selector -->
        <div class="sm:hidden max-w-5xl mx-auto px-4 pt-4">
            <div class="bg-white dark:bg-neutral-800 rounded-xl border border-neutral-200 dark:border-neutral-700 p-3">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-1.5">
                        <span class="text-xs font-medium text-neutral-600 dark:text-neutral-400">Select Mode</span>
                        <button id="modeInfoBtn" class="w-5 h-5 rounded-full bg-neutral-200 dark:bg-neutral-700 flex items-center justify-center text-neutral-500 dark:text-neutral-400">
                            <span class="material-icons text-xs">help</span>
                        </button>
                    </div>
                    <span id="mobileSelectedModeName" class="text-xs font-semibold text-accent"></span>
                </div>
                <p id="mobileSelectedModeDesc" class="text-[11px] text-neutral-500 dark:text-neutral-400 mb-2"></p>
                <div id="mobileModeSelector" class="grid grid-cols-4 gap-1.5"></div>

                <!-- Mode Info Panel -->
                <div id="modeInfoPanel" class="hidden mt-3 pt-3 border-t border-neutral-200 dark:border-neutral-700">
                    <p class="text-xs font-medium text-neutral-700 dark:text-neutral-300 mb-2">What each mode means:</p>
                    <div class="space-y-2">
                        <div class="flex items-start gap-2 p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20">
                            <span class="material-icons text-blue-500 text-base mt-0.5">all_inclusive</span>
                            <div>
                                <p class="text-xs font-semibold text-blue-700 dark:text-blue-300">Untimed</p>
                                <p class="text-[11px] text-blue-600 dark:text-blue-400">No time limit. Learn at your own pace.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-2 p-2 rounded-lg bg-orange-50 dark:bg-orange-900/20">
                            <span class="material-icons text-orange-500 text-base mt-0.5">schedule</span>
                            <div>
                                <p class="text-xs font-semibold text-orange-700 dark:text-orange-300">JAMB Exam</p>
                                <p class="text-[11px] text-orange-600 dark:text-orange-400">40 seconds per question.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-2 p-2 rounded-lg bg-red-50 dark:bg-red-900/20">
                            <span class="material-icons text-red-500 text-base mt-0.5">flash_on</span>
                            <div>
                                <p class="text-xs font-semibold text-red-700 dark:text-red-300">Speed Test</p>
                                <p class="text-[11px] text-red-600 dark:text-red-400">20 seconds per question.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-2 p-2 rounded-lg bg-purple-50 dark:bg-purple-900/20">
                            <span class="material-icons text-purple-500 text-base mt-0.5">bolt</span>
                            <div>
                                <p class="text-xs font-semibold text-purple-700 dark:text-purple-300">Lightning</p>
                                <p class="text-[11px] text-purple-600 dark:text-purple-400">10 seconds per question.</p>
                            </div>
                        </div>
                    </div>
                    <button id="closeModeInfoBtn" class="w-full mt-3 py-2 text-xs font-medium text-white bg-accent hover:bg-accent-600 rounded-lg transition-colors">Got it!</button>
                </div>
            </div>
        </div>

        <!-- Subject Grid -->
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
            <h2 class="headline-5 text-neutral-800 dark:text-white mb-6 sm:mb-8">Choose Your Subject</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-5" id="subjectGrid"></div>
        </div>
    </div>

    <!-- Topic Selection -->
    <div id="topicSelection" class="hidden">
        <div class="bg-gradient-to-b from-white to-neutral-50 dark:from-neutral-900 dark:to-neutral-900 border-b border-neutral-200 dark:border-neutral-800">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
                <button id="backToSubjects" class="inline-flex items-center space-x-2 text-neutral-600 dark:text-neutral-400 hover:text-primary dark:hover:text-accent transition-colors mb-6 group">
                    <span class="material-icons text-xl">arrow_back</span>
                    <span class="text-sm font-medium">Back to Subjects</span>
                </button>

                <div class="flex items-center space-x-4 mb-4">
                    <div class="w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-br from-primary to-accent rounded-2xl flex items-center justify-center shadow-material-2">
                        <span class="material-icons text-white text-2xl sm:text-3xl">menu_book</span>
                    </div>
                    <div>
                        <h2 class="headline-4 text-neutral-900 dark:text-white" id="selectedSubjectTitle"></h2>
                        <p class="text-neutral-600 dark:text-neutral-400">Select a topic to begin</p>
                    </div>
                </div>
                <!-- Free topics badge -->
                <div class="inline-flex items-center space-x-2 px-3 py-1.5 bg-success/10 border border-success/20 rounded-full">
                    <span class="material-icons text-success text-sm">card_giftcard</span>
                    <span class="text-xs font-medium text-success">First 3 topics are FREE!</span>
                </div>
            </div>
        </div>

        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5" id="topicGrid"></div>
        </div>
    </div>

    <!-- Quiz Interface -->
    <div id="quizInterface" class="hidden min-h-screen bg-neutral-50 dark:bg-neutral-900">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
            <!-- Quiz Header -->
            <div class="flex items-center justify-between mb-6">
                <button id="backToTopics" class="inline-flex items-center space-x-2 text-neutral-600 dark:text-neutral-400 hover:text-primary dark:hover:text-accent transition-colors">
                    <span class="material-icons">arrow_back</span>
                    <span class="text-sm font-medium hidden sm:inline">Back</span>
                </button>
                <div class="flex items-center space-x-4">
                    <div id="timerDisplay" class="hidden items-center space-x-2 px-3 py-1.5 rounded-full border-2" style="border-color: var(--timer-color, #22c55e)">
                        <span class="material-icons text-sm" style="color: var(--timer-color, #22c55e)">timer</span>
                        <span class="text-sm font-bold" style="color: var(--timer-color, #22c55e)" id="timerText">00</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="material-icons text-accent text-lg">quiz</span>
                        <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">
                            <span id="currentQuestion">1</span> / <span id="totalQuestions">0</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar mb-8">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>

            <!-- Question Card -->
            <div class="material-card bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-2xl p-6 sm:p-8 shadow-material-2 mb-6">
                <div class="flex items-center justify-between mb-5">
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-primary-50 dark:bg-accent/20 text-primary dark:text-accent border border-transparent dark:border-accent/30 text-xs font-medium" id="questionMeta"></span>
                    <span id="quizModeBadge" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold text-white shadow-material-1">
                        <span class="material-icons text-sm mr-1" id="quizModeIcon"></span>
                        <span id="quizModeName"></span>
                    </span>
                </div>
                <h3 class="text-lg sm:text-xl font-medium mb-6 sm:mb-8 text-neutral-900 dark:text-white leading-relaxed" id="questionText"></h3>
                <div id="questionImageContainer" class="mb-6 hidden"></div>
                <div id="questionOptions" class="space-y-3"></div>

                <!-- Explanation Box -->
                <div id="explanationBox" class="mt-6 hidden overflow-hidden rounded-2xl border-2 border-accent-200 dark:border-accent-700 bg-white dark:bg-neutral-800 shadow-material-2">
                    <div class="bg-gradient-to-r from-accent to-accent-600 px-5 py-3">
                        <div class="flex items-center space-x-3">
                            <span class="material-icons text-white text-xl">psychology</span>
                            <h4 class="font-semibold text-white text-base">Step-by-Step Solution</h4>
                        </div>
                    </div>
                    <div class="px-5 py-5">
                        <div id="explanationContent" class="space-y-4"></div>
                        <div id="explanationImageContainer" class="mt-4 hidden"></div>
                        <div id="explanationVideoContainer" class="mt-4 hidden"></div>
                    </div>
                    <div id="keyTakeaway" class="hidden mx-5 mb-5 p-4 bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-400 rounded-r-lg">
                        <div class="flex items-start space-x-3">
                            <span class="material-icons text-amber-500 text-lg flex-shrink-0">tips_and_updates</span>
                            <div>
                                <span class="text-xs text-amber-700 dark:text-amber-400 font-medium uppercase tracking-wide">Key Takeaway</span>
                                <p class="text-amber-800 dark:text-amber-200 text-sm mt-1" id="keyTakeawayText"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div id="quizNavigation" class="flex flex-col gap-3">
                <div class="flex justify-end space-x-3">
                    <button id="prevBtn" class="material-button flex-1 sm:flex-initial bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-neutral-700 dark:text-neutral-300 px-6 py-3 rounded-xl font-medium shadow-material-1 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <button id="nextBtn" class="material-button flex-1 sm:flex-initial bg-primary hover:bg-primary-600 text-white px-6 py-3 rounded-xl font-medium shadow-material-1 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                </div>
                <button id="explainBtn" class="material-button bg-accent hover:bg-accent-600 text-white px-6 py-3 rounded-xl font-medium flex items-center justify-center space-x-2 shadow-material-1 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto sm:self-start" disabled>
                    <span class="material-icons">psychology</span>
                    <span>Explain Answer</span>
                </button>
            </div>

            <!-- Quiz Results -->
            <div id="quizResults" class="hidden">
                <div class="material-card bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-2xl p-8 sm:p-12 text-center shadow-material-3 mb-6">
                    <div class="inline-block mb-8">
                        <div class="w-20 h-20 bg-accent rounded-3xl flex items-center justify-center shadow-material-2">
                            <span class="material-icons text-white text-3xl">emoji_events</span>
                        </div>
                    </div>
                    <h3 class="headline-4 text-neutral-900 dark:text-white mb-6">Quiz Complete!</h3>
                    <div class="mb-8">
                        <div class="text-6xl sm:text-7xl font-bold text-primary dark:text-accent mb-3" id="finalScore">0%</div>
                        <div class="text-lg text-neutral-600 dark:text-neutral-400" id="scoreDetails">0 out of 0 correct</div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button id="retakeBtn" class="material-button bg-primary hover:bg-primary-600 text-white px-8 py-3 rounded-xl font-medium shadow-material-2">Retake Quiz</button>
                        <button id="reviewWrongBtn" class="material-button bg-error hover:bg-red-600 text-white px-8 py-3 rounded-xl font-medium shadow-material-2 flex items-center justify-center space-x-2">
                            <span class="material-icons">rate_review</span>
                            <span>Review Wrong Answers</span>
                        </button>
                        <button id="backToTopicsFromResults" class="material-button bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-neutral-700 dark:text-neutral-300 px-8 py-3 rounded-xl font-medium shadow-material-1">Choose Another Topic</button>
                    </div>
                </div>

                <!-- Wrong Answers Review Section -->
                <div id="wrongAnswersSection" class="hidden space-y-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="headline-5 text-neutral-900 dark:text-white flex items-center space-x-2">
                            <span class="material-icons text-error">error_outline</span>
                            <span>Questions to Review</span>
                        </h4>
                        <button id="hideWrongAnswersBtn" class="text-sm text-neutral-500 dark:text-neutral-400 hover:text-primary dark:hover:text-accent flex items-center space-x-1">
                            <span class="material-icons text-sm">visibility_off</span>
                            <span>Hide</span>
                        </button>
                    </div>
                    <div id="wrongAnswersList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Premium Floating Badge -->
<div id="premiumBadge" class="premium-badge-floating hidden">
    <div class="flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-premium-500 to-premium-600 text-white rounded-full shadow-material-2">
        <span class="material-icons text-lg">workspace_premium</span>
        <span class="text-sm font-medium">Premium Active</span>
    </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
    <div class="material-card bg-white dark:bg-neutral-800 rounded-2xl shadow-material-4 max-w-md w-full overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-premium-500 to-premium-600 px-6 py-5 text-center">
            <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-3">
                <span class="material-icons text-white text-3xl">workspace_premium</span>
            </div>
            <h3 class="text-xl font-bold text-white">Unlock All Topics</h3>
            <p class="text-white/80 text-sm mt-1">Get unlimited access to every topic</p>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Price -->
            <div class="text-center mb-6">
                <div class="text-4xl font-bold text-premium-600 dark:text-premium-500">‚Ç¶3,000</div>
                <div class="text-sm text-neutral-500 dark:text-neutral-400 mt-1">One-time payment ‚Ä¢ Lifetime access</div>
            </div>

            <!-- Features -->
            <div class="space-y-3 mb-6">
                <div class="flex items-center space-x-3 p-3 bg-success/5 rounded-xl">
                    <span class="material-icons text-success">check_circle</span>
                    <span class="text-sm text-neutral-700 dark:text-neutral-300">Access all topics in all 7 subjects</span>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-success/5 rounded-xl">
                    <span class="material-icons text-success">check_circle</span>
                    <span class="text-sm text-neutral-700 dark:text-neutral-300">1000+ practice questions</span>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-success/5 rounded-xl">
                    <span class="material-icons text-success">check_circle</span>
                    <span class="text-sm text-neutral-700 dark:text-neutral-300">Detailed explanations for every question</span>
                </div>
                <div class="flex items-center space-x-3 p-3 bg-success/5 rounded-xl">
                    <span class="material-icons text-success">check_circle</span>
                    <span class="text-sm text-neutral-700 dark:text-neutral-300">All quiz modes (Timed, Speed, Lightning)</span>
                </div>
            </div>

            <!-- Email Input -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">Email Address</label>
                <input type="email" id="paymentEmail" placeholder="your@email.com" class="w-full px-4 py-3 border-2 border-neutral-200 dark:border-neutral-700 rounded-xl bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-white focus:border-premium-500 focus:outline-none transition-colors" style="font-size: 16px;">
                <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">Receipt will be sent to this email</p>
            </div>

            <!-- Buttons -->
            <div class="flex flex-col gap-3">
                <button id="payWithPaystackBtn" class="material-button w-full bg-gradient-to-r from-premium-500 to-premium-600 hover:from-premium-600 hover:to-premium-700 text-white px-6 py-4 rounded-xl font-semibold shadow-material-2 flex items-center justify-center space-x-2">
                    <span class="material-icons">lock_open</span>
                    <span>Pay ‚Ç¶3,000 with Paystack</span>
                </button>
                <button id="closePaymentModal" class="text-neutral-500 dark:text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200 text-sm py-2 transition-colors">Maybe Later</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="material-card bg-white dark:bg-neutral-800 p-6 rounded-2xl shadow-material-4 max-w-sm w-full mx-4">
        <div class="flex items-center justify-center space-x-3">
            <div class="spinner border-primary dark:border-accent"></div>
            <span class="text-neutral-800 dark:text-white">Loading questions...</span>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden p-4" onclick="closeImageModal()">
    <button class="absolute top-4 right-4 text-white hover:text-neutral-300 transition-colors" onclick="closeImageModal()">
        <span class="material-icons text-3xl">close</span>
    </button>
    <img id="modalImage" src="" alt="Enlarged image" class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
</div>

<!-- Submit Confirmation Modal -->
<div id="submitConfirmModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
    <div class="material-card bg-white dark:bg-neutral-800 rounded-2xl shadow-material-4 max-w-md w-full overflow-hidden">
        <div class="bg-gradient-to-r from-primary to-primary-600 px-6 py-4">
            <div class="flex items-center space-x-3">
                <span class="material-icons text-white text-2xl">help_outline</span>
                <h3 class="text-lg font-semibold text-white">Submit Quiz?</h3>
            </div>
        </div>
        <div class="p-6">
            <p class="text-neutral-700 dark:text-neutral-300 mb-2">Are you sure you want to submit your answers?</p>
            <p class="text-sm text-neutral-500 dark:text-neutral-400 mb-6" id="submitModalStats"></p>
            <div class="bg-accent-50 dark:bg-accent-900/20 border border-accent-200 dark:border-accent-700 rounded-xl p-4 mb-6">
                <p class="text-sm text-accent-800 dark:text-accent-200 font-medium mb-2">‚å®Ô∏è JAMB Keyboard Shortcuts:</p>
                <div class="flex space-x-4 text-sm">
                    <div class="flex items-center space-x-2">
                        <kbd class="px-2 py-1 bg-green-500 text-white rounded font-bold text-xs">Y</kbd>
                        <span class="text-accent-700 dark:text-accent-300">Yes, Submit</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <kbd class="px-2 py-1 bg-neutral-500 text-white rounded font-bold text-xs">R</kbd>
                        <span class="text-accent-700 dark:text-accent-300">Return</span>
                    </div>
                </div>
            </div>
            <div class="flex space-x-3">
                <button id="confirmSubmitBtn" class="flex-1 material-button bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-medium shadow-material-1 flex items-center justify-center space-x-2">
                    <kbd class="px-1.5 py-0.5 bg-green-600 rounded text-xs">Y</kbd>
                    <span>Yes, Submit</span>
                </button>
                <button id="cancelSubmitBtn" class="flex-1 material-button bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-neutral-700 dark:text-neutral-300 px-6 py-3 rounded-xl font-medium shadow-material-1 flex items-center justify-center space-x-2">
                    <kbd class="px-1.5 py-0.5 bg-neutral-300 dark:bg-neutral-600 rounded text-xs">R</kbd>
                    <span>Return</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 hidden">
    <div class="flex items-center space-x-3 px-5 py-3 bg-neutral-800 dark:bg-neutral-700 text-white rounded-xl shadow-material-3">
        <span class="material-icons text-success" id="toastIcon">check_circle</span>
        <span id="toastText">Success!</span>
    </div>
</div>

<!-- Keyboard Help Panel -->
<div id="keyboardHelpPanel" class="fixed bottom-4 right-4 z-40 hidden">
    <div class="material-card bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-2xl shadow-material-3 p-4 max-w-xs">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-2">
                <span class="material-icons text-accent text-lg">keyboard</span>
                <span class="font-semibold text-neutral-900 dark:text-white text-sm">JAMB Keyboard Mode</span>
            </div>
            <button id="closeKeyboardHelp" class="text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-200">
                <span class="material-icons text-lg">close</span>
            </button>
        </div>
        <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="flex items-center space-x-2"><kbd class="px-2 py-1 bg-primary text-white rounded font-bold">A</kbd><span class="text-neutral-600 dark:text-neutral-400">Option A</span></div>
            <div class="flex items-center space-x-2"><kbd class="px-2 py-1 bg-primary text-white rounded font-bold">B</kbd><span class="text-neutral-600 dark:text-neutral-400">Option B</span></div>
            <div class="flex items-center space-x-2"><kbd class="px-2 py-1 bg-primary text-white rounded font-bold">C</kbd><span class="text-neutral-600 dark:text-neutral-400">Option C</span></div>
            <div class="flex items-center space-x-2"><kbd class="px-2 py-1 bg-primary text-white rounded font-bold">D</kbd><span class="text-neutral-600 dark:text-neutral-400">Option D</span></div>
            <div class="flex items-center space-x-2"><kbd class="px-2 py-1 bg-neutral-500 text-white rounded font-bold">P</kbd><span class="text-neutral-600 dark:text-neutral-400">Previous</span></div>
            <div class="flex items-center space-x-2"><kbd class="px-2 py-1 bg-neutral-500 text-white rounded font-bold">N</kbd><span class="text-neutral-600 dark:text-neutral-400">Next</span></div>
        </div>
    </div>
</div>

<button id="keyboardHelpToggle" class="fixed bottom-4 right-4 z-30 hidden w-12 h-12 bg-accent hover:bg-accent-600 text-white rounded-full shadow-material-2 flex items-center justify-center transition-all duration-200">
    <span class="material-icons">keyboard</span>
</button>

<script>
// ============================================
// DARK MODE SUPPORT
// ============================================
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
    document.documentElement.classList.toggle('dark', event.matches);
});

// ============================================
// PAYSTACK CONFIGURATION
// ============================================
const PAYSTACK_KEY = 'pk_live_2f5034a8e5d68f4201b5ed04c2c05dc2e24af8fb';
const PREMIUM_PRICE = 3000; // ‚Ç¶3,000
const popup = new PaystackPop();

function generateReference() {
    return 'RAVEN_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// ============================================
// ACCESS CONTROL MIDDLEWARE
// ============================================
const AccessMiddleware = {
    FREE_TOPIC_COUNT: 3,
    isPremium: false,

    canAccessTopic(topicIndex) {
        return this.isPremium || topicIndex < this.FREE_TOPIC_COUNT;
    },

    unlockPremium() {
        this.isPremium = true;
        document.getElementById('premiumBadge').classList.remove('hidden');
        document.getElementById('headerPremiumBtn').classList.add('hidden');
        this.refreshUI();
        showToast('All topics unlocked! üéâ', 'success');
    },

    refreshUI() {
        if (currentSubject) {
            renderTopics(subjects[currentSubject.id].topics);
        }
        renderSubjects();
    }
};

// ============================================
// PAYMENT FUNCTIONS
// ============================================
function showPaymentModal() {
    document.getElementById('paymentModal').classList.remove('hidden');
    document.getElementById('paymentEmail').focus();
}

function hidePaymentModal() {
    document.getElementById('paymentModal').classList.add('hidden');
}

function initiatePayment() {
    const email = document.getElementById('paymentEmail').value.trim();

    if (!email || !email.includes('@')) {
        showToast('Please enter a valid email address', 'error');
        return;
    }

    const payBtn = document.getElementById('payWithPaystackBtn');
    payBtn.innerHTML = '<div class="spinner border-white"></div><span class="ml-2">Processing...</span>';
    payBtn.disabled = true;

    popup.newTransaction({
        key: PAYSTACK_KEY,
        email: email,
        amount: PREMIUM_PRICE * 100, // Amount in kobo
        currency: 'NGN',
        reference: generateReference(),
        metadata: {
            custom_fields: [
                { display_name: 'Product', variable_name: 'product', value: 'Raven Quiz Premium' },
                { display_name: 'Type', variable_name: 'type', value: 'one_time_access' }
            ]
        },
        onLoad: (response) => {
            payBtn.innerHTML = '<span class="material-icons">lock_open</span><span>Pay ‚Ç¶3,000 with Paystack</span>';
            payBtn.disabled = false;
        },
        onSuccess: (transaction) => {
            hidePaymentModal();
            AccessMiddleware.unlockPremium();
            showToast('Payment successful! All topics are now unlocked.', 'success');
        },
        onCancel: () => {
            payBtn.innerHTML = '<span class="material-icons">lock_open</span><span>Pay ‚Ç¶3,000 with Paystack</span>';
            payBtn.disabled = false;
            showToast('Payment cancelled', 'info');
        },
        onError: (error) => {
            payBtn.innerHTML = '<span class="material-icons">lock_open</span><span>Pay ‚Ç¶3,000 with Paystack</span>';
            payBtn.disabled = false;
            showToast('Payment failed. Please try again.', 'error');
        }
    });
}

// ============================================
// TOAST NOTIFICATION
// ============================================
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');
    const toastIcon = document.getElementById('toastIcon');

    toastText.textContent = message;

    if (type === 'success') {
        toastIcon.textContent = 'check_circle';
        toastIcon.className = 'material-icons text-success';
    } else if (type === 'error') {
        toastIcon.textContent = 'error';
        toastIcon.className = 'material-icons text-error';
    } else {
        toastIcon.textContent = 'info';
        toastIcon.className = 'material-icons text-accent';
    }

    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

// ============================================
// APP STATE
// ============================================
let currentView = 'subjects';
let subjects = {};
let currentSubject = null;
let currentTopic = null;
let currentQuestions = [];
let currentQuestionIndex = 0;
let userAnswers = [];
let quizStartTime = null;
let currentMode = 'practice';
let timerInterval = null;
let timeRemaining = 0;

const PRACTICE_MODES = {
    practice: { name: 'Untimed', shortName: 'Untimed', time: null, description: 'No time pressure', icon: 'all_inclusive', color: 'from-blue-500 to-blue-600' },
    jamb: { name: 'JAMB Exam', shortName: 'JAMB', time: 40, description: '40 sec/question', icon: 'schedule', color: 'from-orange-500 to-orange-600' },
    hard: { name: 'Speed Test', shortName: 'Speed', time: 20, description: '20 sec/question', icon: 'flash_on', color: 'from-red-500 to-red-600' },
    zen: { name: 'Lightning', shortName: 'Lightning', time: 10, description: '10 sec/question', icon: 'bolt', color: 'from-purple-500 to-purple-600' }
};

let analyticsData = { quizResults: [], topicProgress: {}, subjectProgress: {}, timeSpent: {} };

const availableSubjects = [
    { id: 'mathematics', name: 'Mathematics', icon: 'calculate', file: 'data/mathematics.json' },
    { id: 'physics', name: 'Physics', icon: 'science', file: 'data/physics.json' },
    { id: 'chemistry', name: 'Chemistry', icon: 'science', file: 'data/chemistry.json' },
    { id: 'biology', name: 'Biology', icon: 'biotech', file: 'data/biology.json' },
    { id: 'english', name: 'English', icon: 'translate', file: 'data/english.json' },
    { id: 'crs', name: 'CRS', icon: 'church', file: 'data/crs.json' },
    { id: 'government', name: 'Government', icon: 'account_balance', file: 'data/government.json' },
];

const subjectSelection = document.getElementById('subjectSelection');
const topicSelection = document.getElementById('topicSelection');
const quizInterface = document.getElementById('quizInterface');
const loadingModal = document.getElementById('loadingModal');

// ============================================
// UTILITY FUNCTIONS
// ============================================
function getTopicIcon(topicName, category) {
    const name = topicName.toLowerCase();
    if (name.includes('algebra')) return 'functions';
    if (name.includes('geometry')) return 'crop_free';
    if (name.includes('trigonometry')) return 'change_history';
    if (name.includes('calculus')) return 'show_chart';
    if (name.includes('statistic')) return 'bar_chart';
    if (name.includes('number')) return 'pin';
    return 'quiz';
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function sanitizeHTML(html) {
    if (!html) return '';
    const allowedTags = ['sub', 'sup', 'strong', 'em', 'b', 'i', 'u', 'br', 'span'];
    const temp = document.createElement('div');
    temp.innerHTML = html;

    function cleanNode(node) {
        Array.from(node.childNodes).forEach(child => {
            if (child.nodeType === Node.ELEMENT_NODE) {
                const tagName = child.tagName.toLowerCase();
                if (allowedTags.includes(tagName)) {
                    Array.from(child.attributes).forEach(attr => {
                        if (attr.name !== 'class') child.removeAttribute(attr.name);
                    });
                    cleanNode(child);
                } else {
                    node.replaceChild(document.createTextNode(child.textContent), child);
                }
            }
        });
    }
    cleanNode(temp);
    return temp.innerHTML;
}

function getProgressBarColor(score) {
    if (score >= 80) return 'linear-gradient(90deg, #10B981, #059669)';
    if (score >= 60) return 'linear-gradient(90deg, #3B82F6, #1D4ED8)';
    if (score >= 40) return 'linear-gradient(90deg, #F59E0B, #D97706)';
    return 'linear-gradient(90deg, #EF4444, #DC2626)';
}

// ============================================
// ANALYTICS
// ============================================
function saveAnalyticsData() {
    try {
        localStorage.setItem('ravenAnalytics', JSON.stringify(analyticsData));
    } catch (e) { }
}

function loadAnalyticsData() {
    try {
        const saved = localStorage.getItem('ravenAnalytics');
        if (saved) analyticsData = JSON.parse(saved);
    } catch (e) {
        analyticsData = { quizResults: [], topicProgress: {}, subjectProgress: {}, timeSpent: {} };
    }
}

function saveQuizResult(score) {
    const result = {
        id: Date.now(),
        subject: currentSubject.id,
        subjectName: currentSubject.name,
        topic: currentTopic.name,
        score: score.percentage,
        correct: score.correct,
        total: score.total,
        timeSpent: score.timeSpent,
        date: new Date().toISOString(),
        mode: currentMode,
        modeName: PRACTICE_MODES[currentMode].name
    };

    analyticsData.quizResults.push(result);

    const topicKey = `${currentSubject.id}_${currentTopic.name}`;
    if (!analyticsData.topicProgress[topicKey]) {
        analyticsData.topicProgress[topicKey] = { bestScore: 0, attempts: 0, averageScore: 0, totalScore: 0, averageTime: 0, totalTime: 0 };
    }
    const tp = analyticsData.topicProgress[topicKey];
    tp.attempts++;
    tp.totalScore += score.percentage;
    tp.averageScore = Math.round(tp.totalScore / tp.attempts);
    tp.bestScore = Math.max(tp.bestScore, score.percentage);
    tp.totalTime += score.timeSpent;
    tp.averageTime = tp.totalTime / tp.attempts;

    if (!analyticsData.subjectProgress[currentSubject.id]) {
        analyticsData.subjectProgress[currentSubject.id] = { bestScore: 0, attempts: 0, averageScore: 0, totalScore: 0 };
    }
    const sp = analyticsData.subjectProgress[currentSubject.id];
    sp.attempts++;
    sp.totalScore += score.percentage;
    sp.averageScore = Math.round(sp.totalScore / sp.attempts);
    sp.bestScore = Math.max(sp.bestScore, score.percentage);

    saveAnalyticsData();
    renderSubjects();
    if (subjects[currentSubject.id]) renderTopics(subjects[currentSubject.id].topics);
}

function getTopicProgress(subjectId, topicName) {
    const key = `${subjectId}_${topicName}`;
    return analyticsData.topicProgress[key] || { bestScore: 0, attempts: 0, averageScore: 0, averageTime: 0 };
}

// ============================================
// INITIALIZATION
// ============================================
async function init() {
    loadAnalyticsData();
    renderModeSelectors();
    renderSubjects();
    setupEventListeners();
}

// ============================================
// MODE SELECTORS
// ============================================
function renderModeSelectors() {
    const desktopContainer = document.getElementById('modeSelectorButtons');
    const mobileContainer = document.getElementById('mobileModeSelector');
    const mobileModeName = document.getElementById('mobileSelectedModeName');
    const mobileDescription = document.getElementById('mobileSelectedModeDesc');

    desktopContainer.innerHTML = '';
    Object.entries(PRACTICE_MODES).forEach(([key, mode]) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'relative group';

        const btn = document.createElement('button');
        btn.className = `mode-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all duration-200 ${
            currentMode === key
                ? 'bg-gradient-to-r ' + mode.color + ' text-white shadow-material-1'
                : 'text-neutral-600 dark:text-neutral-400 hover:bg-neutral-200 dark:hover:bg-neutral-700'
        }`;
        btn.innerHTML = `<span class="material-icons text-sm align-middle mr-1">${mode.icon}</span>${mode.shortName}`;
        btn.addEventListener('click', () => setGlobalMode(key));

        const tooltip = document.createElement('div');
        tooltip.className = 'absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-neutral-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50';
        tooltip.innerHTML = `<div class="font-semibold">${mode.name}</div><div class="text-neutral-300">${mode.description}</div>`;

        wrapper.appendChild(btn);
        wrapper.appendChild(tooltip);
        desktopContainer.appendChild(wrapper);
    });

    mobileContainer.innerHTML = '';
    Object.entries(PRACTICE_MODES).forEach(([key, mode]) => {
        const btn = document.createElement('button');
        btn.className = `flex flex-col items-center justify-center p-2 rounded-lg transition-all ${
            currentMode === key
                ? 'bg-gradient-to-br ' + mode.color + ' text-white shadow-material-1'
                : 'bg-neutral-100 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-400'
        }`;
        btn.innerHTML = `<span class="material-icons text-lg">${mode.icon}</span><span class="text-[10px] mt-0.5 font-medium">${mode.shortName}</span>`;
        btn.addEventListener('click', () => setGlobalMode(key));
        mobileContainer.appendChild(btn);
    });

    mobileModeName.textContent = PRACTICE_MODES[currentMode].name;
    if (mobileDescription) mobileDescription.textContent = PRACTICE_MODES[currentMode].description;
}

function setGlobalMode(modeKey) {
    currentMode = modeKey;
    renderModeSelectors();
}

// ============================================
// RENDER SUBJECTS
// ============================================
function renderSubjects() {
    const subjectGrid = document.getElementById('subjectGrid');
    subjectGrid.innerHTML = '';

    const subjectColors = {
        'mathematics': { start: '#3b82f6', end: '#2563eb' },
        'physics': { start: '#f97316', end: '#ea580c' },
        'chemistry': { start: '#a855f7', end: '#9333ea' },
        'biology': { start: '#22c55e', end: '#16a34a' },
        'english': { start: '#14b8a6', end: '#0d9488' },
        'crs': { start: '#f43f5e', end: '#e11d48' },
        'government': { start: '#0ea5e9', end: '#0284c7' },
    };

    availableSubjects.forEach((subject) => {
        const colors = subjectColors[subject.id] || { start: '#0F2C59', end: '#009F9D' };
        const subjectProgress = analyticsData.subjectProgress[subject.id];

        const card = document.createElement('div');
        card.className = 'subject-card material-card material-button w-full bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-2xl p-5 sm:p-6 hover:shadow-material-3 cursor-pointer transition-all duration-300';
        card.style.setProperty('--card-color-start', colors.start);
        card.style.setProperty('--card-color-end', colors.end);

        const progressHTML = subjectProgress
            ? `<div class="flex items-center justify-between text-xs text-neutral-600 dark:text-neutral-400 mb-1">
                <span>Progress</span><span class="font-medium">${Math.round(subjectProgress.averageScore)}%</span>
            </div>
            <div class="w-full bg-neutral-200 dark:bg-neutral-700 rounded-full h-1.5">
                <div class="h-1.5 rounded-full transition-all duration-500" style="width: ${subjectProgress.averageScore}%; background: linear-gradient(90deg, ${colors.start}, ${colors.end})"></div>
            </div>`
            : `<div class="text-xs text-neutral-500 italic">Not started</div>`;

        card.innerHTML = `
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0 w-14 h-14 rounded-2xl flex items-center justify-center shadow-material-1" style="background: linear-gradient(135deg, ${colors.start}, ${colors.end})">
                    <span class="material-icons text-white text-2xl">${subject.icon}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-neutral-900 dark:text-white mb-1">${subject.name}</h3>
                    <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-3">${subjectProgress ? `${subjectProgress.attempts} session` : 'Start practicing'}</div>
                    ${progressHTML}
                </div>
                <span class="material-icons text-neutral-400 dark:text-neutral-600 text-xl">arrow_forward_ios</span>
            </div>`;

        card.addEventListener('click', () => selectSubject(subject));
        subjectGrid.appendChild(card);
    });
}

// ============================================
// SELECT SUBJECT
// ============================================
async function selectSubject(subject) {
    showLoading();
    try {
        const response = await fetch(subject.file);
        if (!response.ok) throw new Error(`Failed to load ${subject.name}`);
        const data = await response.json();
        subjects[subject.id] = data;
        currentSubject = subject;
        renderTopics(data.topics);
        showTopicSelection();
    } catch (error) {
        showError(`Error loading ${subject.name}: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// ============================================
// RENDER TOPICS WITH ACCESS CONTROL
// ============================================
function renderTopics(topics) {
    const topicGrid = document.getElementById('topicGrid');
    const selectedSubjectTitle = document.getElementById('selectedSubjectTitle');

    selectedSubjectTitle.textContent = currentSubject.name;
    topicGrid.innerHTML = '';

    const colorSchemes = [
        { primary: '#3b82f6', secondary: '#2563eb' },
        { primary: '#f97316', secondary: '#ea580c' },
        { primary: '#22c55e', secondary: '#16a34a' },
        { primary: '#ef4444', secondary: '#dc2626' },
        { primary: '#a855f7', secondary: '#9333ea' },
        { primary: '#f59e0b', secondary: '#d97706' },
        { primary: '#14b8a6', secondary: '#0d9488' },
        { primary: '#ec4899', secondary: '#db2777' },
    ];

    const categories = {};
    Object.entries(topics).forEach(([topicId, topic]) => {
        if (!categories[topic.category]) categories[topic.category] = [];
        categories[topic.category].push({ id: topicId, ...topic });
    });

    const categoryNames = Object.keys(categories);
    const categoryColors = {};
    categoryNames.forEach((cat, idx) => { categoryColors[cat] = colorSchemes[idx % colorSchemes.length]; });

    let globalTopicIndex = 0;

    Object.entries(categories).forEach(([category, categoryTopics]) => {
        const colors = categoryColors[category];

        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'col-span-full mt-6 mb-4 first:mt-0';
        categoryDiv.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="w-1 h-6 rounded-full" style="background: linear-gradient(180deg, ${colors.primary}, ${colors.secondary})"></div>
                <h3 class="text-lg font-semibold text-neutral-800 dark:text-white">${category}</h3>
                <div class="flex-1 h-px bg-neutral-200 dark:bg-neutral-700"></div>
            </div>`;
        topicGrid.appendChild(categoryDiv);

        categoryTopics.forEach((topic) => {
            const questionCount = topic.questions ? topic.questions.length : 0;
            const progressData = getTopicProgress(currentSubject.id, topic.name);
            const topicIcon = getTopicIcon(topic.name, topic.category);

            const isLocked = !AccessMiddleware.canAccessTopic(globalTopicIndex);
            const topicIndex = globalTopicIndex;
            globalTopicIndex++;

            const topicCard = document.createElement('div');
            topicCard.className = `material-card material-button w-full bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-2xl p-5 sm:p-6 transition-all duration-300 relative ${
                questionCount > 0 ? 'cursor-pointer hover:shadow-material-3' : 'opacity-60 cursor-not-allowed'
            } ${isLocked ? 'topic-card-locked' : ''}`;

            // Status badge
            let statusBadge = '';
            if (isLocked) {
                statusBadge = `
                    <div class="flex items-center space-x-1.5 px-3 py-1 rounded-full bg-premium-50 dark:bg-premium-900/20 border border-premium-200 dark:border-premium-700">
                        <span class="material-icons text-premium-500 text-sm">lock</span>
                        <span class="text-xs font-medium text-premium-600 dark:text-premium-400">Premium</span>
                    </div>`;
            } else if (progressData.attempts > 0) {
                statusBadge = `
                    <div class="flex items-center space-x-1.5 px-3 py-1 rounded-full bg-accent-50 dark:bg-accent-900/20">
                        <span class="material-icons text-accent text-sm">check_circle</span>
                        <span class="text-xs font-medium text-accent">${Math.round(progressData.averageScore)}%</span>
                    </div>`;
            } else {
                statusBadge = `
                    <div class="flex items-center space-x-1.5 px-3 py-1 rounded-full bg-success/10 dark:bg-success/20">
                        <span class="material-icons text-success text-sm">play_arrow</span>
                        <span class="text-xs font-medium text-success">Free</span>
                    </div>`;
            }

            topicCard.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-12 h-12 sm:w-14 sm:h-14 rounded-xl flex items-center justify-center shadow-material-1 transition-all duration-300" style="background: linear-gradient(135deg, ${colors.primary}, ${colors.secondary})">
                        <span class="material-icons text-white text-lg sm:text-xl">${topicIcon}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-semibold text-neutral-900 dark:text-white mb-1 line-clamp-2">${topic.name}</h4>
                        <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-3">${questionCount} practice questions</div>
                        ${progressData.attempts > 0 ? `
                            <div class="space-y-2">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-neutral-500 dark:text-neutral-400">Your Progress</span>
                                    <span class="font-medium" style="color: ${colors.primary}">${Math.round(progressData.averageScore)}%</span>
                                </div>
                                <div class="w-full bg-neutral-200 dark:bg-neutral-700 rounded-full h-1.5">
                                    <div class="h-1.5 rounded-full transition-all duration-500" style="width: ${progressData.averageScore}%; background: ${getProgressBarColor(progressData.averageScore)}"></div>
                                </div>
                                <div class="flex justify-between text-xs text-neutral-400 dark:text-neutral-500">
                                    <span>Best: ${Math.round(progressData.bestScore)}%</span>
                                    <span>${progressData.attempts} ${progressData.attempts === 1 ? 'attempt' : 'attempts'}</span>
                                </div>
                            </div>
                        ` : `<div class="text-xs text-neutral-400 dark:text-neutral-500 italic">Not attempted yet</div>`}
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        ${statusBadge}
                        ${questionCount > 0 ? '<span class="material-icons text-neutral-400 dark:text-neutral-600">arrow_forward_ios</span>' : ''}
                    </div>
                </div>`;

            if (questionCount > 0) {
                topicCard.addEventListener('click', () => {
                    if (isLocked) {
                        showPaymentModal();
                    } else {
                        startQuiz(topic);
                    }
                });
            }

            topicGrid.appendChild(topicCard);
        });
    });
}

// ============================================
// START QUIZ
// ============================================
function startQuiz(topic) {
    if (!topic.questions || topic.questions.length === 0) {
        showError('No questions available for this topic');
        return;
    }

    currentTopic = topic;
    currentQuestions = shuffleArray([...currentTopic.questions]);
    currentQuestionIndex = 0;
    userAnswers = [];
    quizStartTime = Date.now();
    renderQuestion();
    showQuizInterface();
}

// ============================================
// RENDER QUESTION
// ============================================
function renderQuestion() {
    const question = currentQuestions[currentQuestionIndex];
    if (!question) return;

    stopTimer();

    document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
    document.getElementById('totalQuestions').textContent = currentQuestions.length;
    document.getElementById('questionMeta').textContent = `${currentTopic.name}`;
    document.getElementById('questionText').innerHTML = sanitizeHTML(question.question);

    const imageContainer = document.getElementById('questionImageContainer');
    imageContainer.innerHTML = '';
    if (question.image) {
        const imgWrapper = createImageElement(
            question.image,
            'Question image',
            'w-full h-auto max-h-64 object-contain rounded-lg',
            () => openImageModal(question.image)
        );
        imgWrapper.className = 'rounded-xl overflow-hidden border border-neutral-200 dark:border-neutral-700 bg-neutral-100 dark:bg-neutral-900';
        imageContainer.appendChild(imgWrapper);
        const hint = document.createElement('p');
        hint.className = 'text-xs text-neutral-500 dark:text-neutral-400 mt-1 text-center';
        hint.textContent = 'Tap image to enlarge';
        imageContainer.appendChild(hint);
        imageContainer.classList.remove('hidden');
    } else {
        imageContainer.classList.add('hidden');
    }

    const mode = PRACTICE_MODES[currentMode];
    const modeBadge = document.getElementById('quizModeBadge');
    const modeIcon = document.getElementById('quizModeIcon');
    const modeName = document.getElementById('quizModeName');

    const colorMap = {
        'from-blue-500 to-blue-600': 'linear-gradient(135deg, #3b82f6, #2563eb)',
        'from-orange-500 to-orange-600': 'linear-gradient(135deg, #f97316, #ea580c)',
        'from-red-500 to-red-600': 'linear-gradient(135deg, #ef4444, #dc2626)',
        'from-purple-500 to-purple-600': 'linear-gradient(135deg, #a855f7, #9333ea)'
    };

    modeBadge.style.background = colorMap[mode.color] || 'linear-gradient(135deg, #3b82f6, #2563eb)';
    modeIcon.textContent = mode.icon;
    modeName.textContent = mode.shortName;

    const progress = ((currentQuestionIndex) / currentQuestions.length) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;

    const optionsContainer = document.getElementById('questionOptions');
    optionsContainer.innerHTML = '';
    optionsContainer.className = 'space-y-3';

    question.options.forEach((option, index) => {
        const optionBtn = document.createElement('div');
        optionBtn.className = 'option-btn material-button p-4 sm:p-5 rounded-xl border-2 border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 text-neutral-800 dark:text-white cursor-pointer touch-target';
        optionBtn.innerHTML = `
            <div class="flex items-center space-x-3 sm:space-x-4">
                <span class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-primary to-accent text-white flex items-center justify-center font-medium text-sm">${String.fromCharCode(65 + index)}</span>
                <span class="flex-1 text-sm sm:text-base">${sanitizeHTML(option)}</span>
            </div>`;

        const isSelected = userAnswers[currentQuestionIndex] === index;
        if (isSelected) {
            optionBtn.classList.add('selected');
        }

        optionBtn.addEventListener('click', () => selectOption(index));
        optionsContainer.appendChild(optionBtn);
    });

    updateNavigationButtons();
    document.getElementById('explanationBox').classList.add('hidden');

    startTimer();
}

// ============================================
// TIMER FUNCTIONS
// ============================================
function startTimer() {
    const mode = PRACTICE_MODES[currentMode];
    const timerDisplay = document.getElementById('timerDisplay');
    const timerText = document.getElementById('timerText');

    if (!mode || !mode.time) {
        timerDisplay.classList.add('hidden');
        timerDisplay.classList.remove('flex');
        return;
    }

    timerDisplay.classList.remove('hidden');
    timerDisplay.classList.add('flex');
    timeRemaining = mode.time;
    updateTimerDisplay();

    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) {
            stopTimer();
            autoAdvanceQuestion();
        }
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function updateTimerDisplay() {
    const timerText = document.getElementById('timerText');
    const timerDisplay = document.getElementById('timerDisplay');
    timerText.textContent = String(timeRemaining).padStart(2, '0');

    let color;
    const mode = PRACTICE_MODES[currentMode];
    if (!mode) return;

    const percentRemaining = (timeRemaining / mode.time) * 100;
    if (percentRemaining > 50) {
        color = '#22c55e';
        timerDisplay.classList.remove('timer-low');
    } else if (percentRemaining > 25) {
        color = '#f59e0b';
        timerDisplay.classList.remove('timer-low');
    } else {
        color = '#ef4444';
        timerDisplay.classList.add('timer-low');
    }

    timerDisplay.style.setProperty('--timer-color', color);
}

function autoAdvanceQuestion() {
    if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        finishQuiz();
    }
}

// ============================================
// SELECT OPTION
// ============================================
function selectOption(optionIndex) {
    userAnswers[currentQuestionIndex] = optionIndex;
    const options = document.querySelectorAll('.option-btn');
    options.forEach((option, index) => {
        option.classList.remove('selected');
        if (index === optionIndex) {
            option.classList.add('selected');
        }
    });
    updateNavigationButtons();
}

// ============================================
// UPDATE NAVIGATION BUTTONS
// ============================================
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const explainBtn = document.getElementById('explainBtn');

    prevBtn.disabled = currentQuestionIndex === 0;
    nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined;

    if (currentMode === 'practice') {
        explainBtn.classList.remove('hidden');
        explainBtn.disabled = userAnswers[currentQuestionIndex] === undefined;
    } else {
        explainBtn.classList.add('hidden');
    }

    if (currentQuestionIndex === currentQuestions.length - 1) {
        nextBtn.textContent = 'Finish Quiz';
    } else {
        nextBtn.textContent = 'Next';
    }
}

// ============================================
// NAVIGATION
// ============================================
function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
    }
}

function nextQuestion() {
    if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        finishQuiz();
    }
}

// ============================================
// EXPLANATION
// ============================================
function parseExplanation(text) {
    const result = { steps: [], keyTakeaway: null };

    const takeawayPatterns = [
        /(?:key\stakeaway|remember|note|tip|important)[:\s]+(.+?)(?=\n\n|$)/i,
        /(?:therefore|hence|thus)[,:\s]+(.+?)(?=\n\n|$)/i
    ];

    let remainingText = text;
    for (const pattern of takeawayPatterns) {
        const match = remainingText.match(pattern);
        if (match) {
            result.keyTakeaway = match[1].trim();
            remainingText = remainingText.replace(match[0], '').trim();
            break;
        }
    }

    const numberedMatch = remainingText.match(/(?:^|\n)\s*(?:step\s*)?(\d+)[.):\s-]+/gi);
    if (numberedMatch && numberedMatch.length >= 2) {
        const parts = remainingText.split(/(?:^|\n)\s*(?:step\s*)?\d+[.):\s-]+/i).filter(p => p.trim());
        parts.forEach((part, index) => {
            const cleanText = part.trim();
            if (cleanText) {
                result.steps.push({ number: index + 1, text: cleanText });
            }
        });
    } else {
        const sentences = remainingText
            .split(/(?:\.\s+|\n+)/)
            .map(s => s.trim())
            .filter(s => s.length > 10);

        if (sentences.length > 1) {
            sentences.forEach((sentence, index) => {
                const text = sentence.endsWith('.') ? sentence : sentence + '.';
                result.steps.push({ number: index + 1, text: text });
            });
        } else {
            result.steps.push({ number: 1, text: remainingText.trim() });
        }
    }

    return result;
}

function renderExplanationContent(parsedExplanation, question) {
    const container = document.getElementById('explanationContent');
    const explanationImageContainer = document.getElementById('explanationImageContainer');
    const explanationVideoContainer = document.getElementById('explanationVideoContainer');

    container.innerHTML = '';
    explanationImageContainer.innerHTML = '';
    explanationVideoContainer.innerHTML = '';

    parsedExplanation.steps.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.className = 'flex items-start space-x-4';

        const numberBadge = document.createElement('div');
        numberBadge.className = 'flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-accent to-accent-600 text-white flex items-center justify-center font-bold text-sm shadow-material-1';
        numberBadge.textContent = step.number;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'flex-1 pt-1';
        const textP = document.createElement('p');
        textP.className = 'text-sm text-neutral-700 dark:text-neutral-300 leading-relaxed';
        textP.innerHTML = sanitizeHTML(step.text);
        contentDiv.appendChild(textP);

        stepDiv.appendChild(numberBadge);
        stepDiv.appendChild(contentDiv);
        container.appendChild(stepDiv);
    });

    if (question && question.explanationImage) {
        const imgWrapper = document.createElement('div');
        imgWrapper.className = 'rounded-xl overflow-hidden border border-accent-200 dark:border-accent-700 bg-neutral-100 dark:bg-neutral-900';
        const imgElement = createImageElement(
            question.explanationImage,
            'Explanation diagram',
            'w-full h-auto max-h-64 object-contain',
            () => openImageModal(question.explanationImage)
        );
        imgWrapper.appendChild(imgElement);
        const hint = document.createElement('p');
        hint.className = 'text-xs text-neutral-500 dark:text-neutral-400 mt-1 text-center';
        hint.textContent = 'Tap image to enlarge';
        explanationImageContainer.appendChild(imgWrapper);
        explanationImageContainer.appendChild(hint);
        explanationImageContainer.classList.remove('hidden');
    } else {
        explanationImageContainer.classList.add('hidden');
    }

    if (question && question.explanationVideo) {
        const videoEmbed = createVideoEmbed(question.explanationVideo);
        explanationVideoContainer.appendChild(videoEmbed);
        explanationVideoContainer.classList.remove('hidden');
    } else {
        explanationVideoContainer.classList.add('hidden');
    }

    const keyTakeawayDiv = document.getElementById('keyTakeaway');
    const keyTakeawayText = document.getElementById('keyTakeawayText');
    if (parsedExplanation.keyTakeaway) {
        keyTakeawayText.innerHTML = sanitizeHTML(parsedExplanation.keyTakeaway);
        keyTakeawayDiv.classList.remove('hidden');
    } else {
        keyTakeawayDiv.classList.add('hidden');
    }
}

function showExplanation() {
    const question = currentQuestions[currentQuestionIndex];
    const explanationBox = document.getElementById('explanationBox');
    const correctIndex = question.answer.charCodeAt(0) - 97;

    if (question.explanation || question.explanationImage || question.explanationVideo) {
        const parsed = question.explanation ? parseExplanation(question.explanation) : { steps: [], keyTakeaway: null };
        if (parsed.steps.length === 0 && (question.explanationImage || question.explanationVideo)) {
            parsed.steps.push({ number: 1, text: 'See the solution below.' });
        }

        renderExplanationContent(parsed, question);
        explanationBox.classList.remove('hidden');

        const options = document.querySelectorAll('.option-btn');
        const userIndex = userAnswers[currentQuestionIndex];
        options.forEach((option, index) => {
            option.classList.remove('selected');
            if (index === correctIndex) {
                option.classList.add('correct');
            } else if (index === userIndex && index !== correctIndex) {
                option.classList.add('incorrect');
            }
        });

        setTimeout(() => {
            explanationBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }
}

// ============================================
// IMAGE AND VIDEO HELPERS
// ============================================
function createImageElement(src, alt, className, onClick) {
    const container = document.createElement('div');
    container.className = 'relative';
    const img = document.createElement('img');
    img.alt = alt;
    img.className = className + ' img-loading';
    img.style.minHeight = '80px';

    const loadingPlaceholder = document.createElement('div');
    loadingPlaceholder.className = 'absolute inset-0 flex items-center justify-center bg-neutral-100 dark:bg-neutral-800 rounded-lg';
    loadingPlaceholder.innerHTML = '<span class="material-icons text-neutral-400 animate-pulse">image</span>';
    container.appendChild(loadingPlaceholder);

    img.onload = function() {
        img.classList.remove('img-loading');
        loadingPlaceholder.remove();
    };

    img.onerror = function() {
        img.classList.add('hidden');
        loadingPlaceholder.innerHTML = `
            <div class="img-error w-full h-full flex flex-col items-center justify-center p-4 text-center">
                <span class="material-icons text-2xl mb-1">broken_image</span>
                <span class="text-xs">Image failed to load</span>
            </div>`;
    };

    if (onClick) {
        img.classList.add('cursor-pointer', 'hover:opacity-90', 'transition-opacity');
        img.onclick = onClick;
    }

    img.src = src;
    container.appendChild(img);
    return container;
}

function getYouTubeVideoId(url) {
    if (!url) return null;
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([^&\n?#]+)/,
        /^([a-zA-Z0-9_-]{11})$/
    ];
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
    }
    return null;
}

function createVideoEmbed(videoUrl) {
    const container = document.createElement('div');
    container.className = 'mt-4';
    const youtubeId = getYouTubeVideoId(videoUrl);

    if (youtubeId) {
        container.innerHTML = `
            <div class="flex items-center space-x-2 mb-3">
                <span class="material-icons text-red-500">play_circle</span>
                <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Video Explanation</span>
            </div>
            <div class="video-container border border-neutral-200 dark:border-neutral-700 shadow-material-1">
                <iframe src="https://www.youtube.com/embed/${youtubeId}?rel=0" title="Video Explanation" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>`;
    } else {
        container.innerHTML = `
            <div class="flex items-center space-x-2 mb-3">
                <span class="material-icons text-red-500">play_circle</span>
                <span class="text-sm font-medium text-neutral-700 dark:text-neutral-300">Video Explanation</span>
            </div>
            <a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-3 p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors">
                <div class="w-12 h-12 rounded-full bg-red-500 flex items-center justify-center shadow-material-1">
                    <span class="material-icons text-white">play_arrow</span>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-red-700 dark:text-red-300">Watch Video Explanation</p>
                    <p class="text-xs text-red-600 dark:text-red-400">Opens in new tab</p>
                </div>
                <span class="material-icons text-red-500">open_in_new</span>
            </a>`;
    }

    return container;
}

function openImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    modalImage.src = imageSrc;
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

// ============================================
// FINISH QUIZ
// ============================================
function finishQuiz() {
    stopTimer();
    const score = calculateScore();
    saveQuizResult(score);
    showQuizResults(score);
}

function calculateScore() {
    let correct = 0;
    currentQuestions.forEach((question, index) => {
        const correctIndex = question.answer.charCodeAt(0) - 97;
        if (userAnswers[index] === correctIndex) {
            correct++;
        }
    });
    return {
        correct,
        total: currentQuestions.length,
        percentage: (correct / currentQuestions.length) * 100,
        timeSpent: Date.now() - quizStartTime
    };
}

function showQuizResults(score) {
    document.getElementById('finalScore').textContent = `${Math.round(score.percentage)}%`;
    document.getElementById('scoreDetails').textContent = `${score.correct} out of ${score.total} correct`;
    document.getElementById('quizResults').classList.remove('hidden');
    document.querySelector('#quizInterface .material-card').classList.add('hidden');

    const navigationContainer = document.getElementById('quizNavigation');
    if (navigationContainer) {
        navigationContainer.classList.add('hidden');
    }

    document.getElementById('wrongAnswersSection').classList.add('hidden');

    const wrongCount = score.total - score.correct;
    const reviewBtn = document.getElementById('reviewWrongBtn');
    if (wrongCount === 0) {
        reviewBtn.classList.add('hidden');
    } else {
        reviewBtn.classList.remove('hidden');
        reviewBtn.querySelector('span:last-child').textContent = `Review ${wrongCount} Wrong Answer${wrongCount > 1 ? 's' : ''}`;
    }

    setTimeout(() => {
        document.getElementById('quizResults').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function renderWrongAnswers() {
    const wrongAnswersList = document.getElementById('wrongAnswersList');
    wrongAnswersList.innerHTML = '';

    currentQuestions.forEach((question, index) => {
        const correctIndex = question.answer.charCodeAt(0) - 97;
        const userIndex = userAnswers[index];

        if (userIndex !== correctIndex) {
            const card = document.createElement('div');
            card.className = 'material-card bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-2xl overflow-hidden shadow-material-1';

            const userLetter = userIndex !== undefined ? String.fromCharCode(65 + userIndex) : '‚Äî';
            const correctLetter = String.fromCharCode(65 + correctIndex);

            const userAnswerDisplay = userIndex !== undefined ? question.options[userIndex] : 'Not answered';
            const correctAnswerDisplay = question.options[correctIndex];

            const parsedExplanation = question.explanation ? parseExplanation(question.explanation) : null;

            let stepsHtml = '';
            if (parsedExplanation && parsedExplanation.steps.length > 0) {
                stepsHtml = parsedExplanation.steps.map(step => `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-7 h-7 rounded-full bg-gradient-to-br from-accent to-accent-600 text-white flex items-center justify-center font-bold text-xs shadow-material-1">${step.number}</div>
                        <p class="flex-1 text-sm text-neutral-700 dark:text-neutral-300 leading-relaxed pt-0.5">${sanitizeHTML(step.text)}</p>
                    </div>`).join('');
            }

            let takeawayHtml = '';
            if (parsedExplanation && parsedExplanation.keyTakeaway) {
                takeawayHtml = `
                    <div class="mt-4 p-3 bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-400 rounded-r-lg">
                        <div class="flex items-start space-x-2">
                            <span class="material-icons text-amber-500 text-base flex-shrink-0">tips_and_updates</span>
                            <div>
                                <span class="text-xs text-amber-700 dark:text-amber-400 font-medium uppercase tracking-wide">Key Takeaway</span>
                                <p class="text-amber-800 dark:text-amber-200 text-sm mt-1">${sanitizeHTML(parsedExplanation.keyTakeaway)}</p>
                            </div>
                        </div>
                    </div>`;
            }

            card.innerHTML = `
                <div class="px-5 py-4 bg-red-50 dark:bg-red-900/20 border-b border-red-200 dark:border-red-800">
                    <div class="flex items-start space-x-3">
                        <span class="flex-shrink-0 w-8 h-8 rounded-full bg-error text-white flex items-center justify-center font-bold text-sm">${index + 1}</span>
                        <div class="flex-1">
                            <p class="text-sm text-neutral-800 dark:text-white leading-relaxed">${sanitizeHTML(question.question)}</p>
                        </div>
                    </div>
                </div>
                <div class="p-5 space-y-3">
                    <div class="flex items-start space-x-3 p-3 rounded-xl bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800">
                        <span class="material-icons text-error text-lg flex-shrink-0">close</span>
                        <div class="flex-1">
                            <span class="text-xs text-red-600 dark:text-red-400 font-medium uppercase tracking-wide">Your Answer</span>
                            <p class="text-sm text-red-800 dark:text-red-200 mt-0.5"><strong>${userLetter}.</strong> ${sanitizeHTML(userAnswerDisplay)}</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-3 p-3 rounded-xl bg-green-50 dark:bg-green-900/10 border border-green-200 dark:border-green-800">
                        <span class="material-icons text-success text-lg flex-shrink-0">check_circle</span>
                        <div class="flex-1">
                            <span class="text-xs text-green-600 dark:text-green-400 font-medium uppercase tracking-wide">Correct Answer</span>
                            <p class="text-sm text-green-800 dark:text-green-200 mt-0.5"><strong>${correctLetter}.</strong> ${sanitizeHTML(correctAnswerDisplay)}</p>
                        </div>
                    </div>
                    ${question.explanation ? `
                        <div class="mt-4 p-4 rounded-xl bg-accent-50 dark:bg-accent-900/20 border border-accent-200 dark:border-accent-700">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="material-icons text-accent text-lg">psychology</span>
                                <span class="text-sm font-medium text-accent-700 dark:text-accent-300">Step-by-Step Solution</span>
                            </div>
                            <div class="space-y-3">
                                ${stepsHtml}
                                ${takeawayHtml}
                            </div>
                        </div>
                    ` : ''}
                </div>`;

            wrongAnswersList.appendChild(card);
        }
    });

    document.getElementById('wrongAnswersSection').classList.remove('hidden');

    setTimeout(() => {
        document.getElementById('wrongAnswersSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

// ============================================
// VIEW NAVIGATION
// ============================================
function showSubjectSelection() {
    stopTimer();
    hideAllViews();
    subjectSelection.classList.remove('hidden');
    currentView = 'subjects';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showTopicSelection() {
    stopTimer();
    hideAllViews();
    topicSelection.classList.remove('hidden');
    currentView = 'topics';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showQuizInterface() {
    hideAllViews();
    quizInterface.classList.remove('hidden');
    document.getElementById('quizResults').classList.add('hidden');
    document.querySelector('#quizInterface .material-card').classList.remove('hidden');
    const navigationContainer = document.getElementById('quizNavigation');
    if (navigationContainer) {
        navigationContainer.classList.remove('hidden');
    }
    currentView = 'quiz';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function hideAllViews() {
    subjectSelection.classList.add('hidden');
    topicSelection.classList.add('hidden');
    quizInterface.classList.add('hidden');
}

function showLoading() {
    loadingModal.classList.remove('hidden');
}

function hideLoading() {
    loadingModal.classList.add('hidden');
}

function showError(message) {
    const errorModal = document.createElement('div');
    errorModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
    errorModal.innerHTML = `
        <div class="material-card bg-white dark:bg-neutral-800 p-6 rounded-2xl shadow-material-4 max-w-sm w-full">
            <div class="flex items-center space-x-3 mb-4">
                <span class="material-icons text-error">error</span>
                <h3 class="font-semibold text-error">Error</h3>
            </div>
            <p class="mb-6 text-neutral-800 dark:text-white">${message}</p>
            <button class="material-button w-full px-4 py-3 bg-primary text-white rounded-xl hover:bg-primary-600 font-medium" onclick="this.closest('.fixed').remove()">OK</button>
        </div>`;
    document.body.appendChild(errorModal);
}

// ============================================
// KEYBOARD SHORTCUTS
// ============================================
let isSubmitModalOpen = false;

function handleKeyboardShortcuts(event) {
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
        return;
    }

    const key = event.key.toUpperCase();

    if (isSubmitModalOpen) {
        if (key === 'Y') {
            event.preventDefault();
            confirmSubmitQuiz();
        } else if (key === 'R') {
            event.preventDefault();
            hideSubmitModal();
        }
        return;
    }

    if (currentView !== 'quiz') return;

    const quizResults = document.getElementById('quizResults');
    if (quizResults && !quizResults.classList.contains('hidden')) return;

    switch (key) {
        case 'A':
            event.preventDefault();
            selectOption(0);
            flashOptionFeedback(0);
            break;
        case 'B':
            event.preventDefault();
            selectOption(1);
            flashOptionFeedback(1);
            break;
        case 'C':
            event.preventDefault();
            selectOption(2);
            flashOptionFeedback(2);
            break;
        case 'D':
            event.preventDefault();
            selectOption(3);
            flashOptionFeedback(3);
            break;
        case 'P':
            event.preventDefault();
            if (currentQuestionIndex > 0) {
                previousQuestion();
            }
            break;
        case 'N':
            event.preventDefault();
            if (userAnswers[currentQuestionIndex] !== undefined) {
                if (currentQuestionIndex < currentQuestions.length - 1) {
                    nextQuestion();
                }
            }
            break;
        case 'S':
            event.preventDefault();
            showSubmitModal();
            break;
    }
}

function flashOptionFeedback(optionIndex) {
    const options = document.querySelectorAll('.option-btn');
    if (options[optionIndex]) {
        options[optionIndex].classList.add('ring-2', 'ring-accent', 'ring-offset-2');
        setTimeout(() => {
            options[optionIndex].classList.remove('ring-2', 'ring-accent', 'ring-offset-2');
        }, 200);
    }
}

function showSubmitModal() {
    const answeredCount = userAnswers.filter(a => a !== undefined).length;
    const unansweredCount = currentQuestions.length - answeredCount;
    document.getElementById('submitModalStats').textContent = `You've answered ${answeredCount} of ${currentQuestions.length} questions${unansweredCount > 0 ? ` (${unansweredCount} unanswered)` : ''}`;
    document.getElementById('submitConfirmModal').classList.remove('hidden');
    isSubmitModalOpen = true;
}

function hideSubmitModal() {
    document.getElementById('submitConfirmModal').classList.add('hidden');
    isSubmitModalOpen = false;
}

function confirmSubmitQuiz() {
    hideSubmitModal();
    finishQuiz();
}

function toggleKeyboardHelp() {
    const panel = document.getElementById('keyboardHelpPanel');
    const toggle = document.getElementById('keyboardHelpToggle');
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggle.classList.add('hidden');
    } else {
        panel.classList.add('hidden');
        toggle.classList.remove('hidden');
    }
}

function updateKeyboardHelpVisibility() {
    const toggle = document.getElementById('keyboardHelpToggle');
    const panel = document.getElementById('keyboardHelpPanel');
    if (currentView === 'quiz') {
        toggle.classList.remove('hidden');
        toggle.classList.add('flex');
    } else {
        toggle.classList.add('hidden');
        toggle.classList.remove('flex');
        panel.classList.add('hidden');
    }
}

const originalShowQuizInterface = showQuizInterface;
showQuizInterface = function() {
    originalShowQuizInterface();
    updateKeyboardHelpVisibility();
    try {
        if (!localStorage.getItem('keyboardHintShown')) {
            setTimeout(() => {
                document.getElementById('keyboardHelpPanel').classList.remove('hidden');
                document.getElementById('keyboardHelpToggle').classList.add('hidden');
                localStorage.setItem('keyboardHintShown', 'true');
            }, 1000);
        }
    } catch (e) { }
};

const originalShowSubjectSelection = showSubjectSelection;
showSubjectSelection = function() {
    originalShowSubjectSelection();
    updateKeyboardHelpVisibility();
};

const originalShowTopicSelection = showTopicSelection;
showTopicSelection = function() {
    originalShowTopicSelection();
    updateKeyboardHelpVisibility();
};

// ============================================
// EVENT LISTENERS SETUP
// ============================================
function setupEventListeners() {
    // Payment modal
    document.getElementById('payWithPaystackBtn').addEventListener('click', initiatePayment);
    document.getElementById('closePaymentModal').addEventListener('click', hidePaymentModal);
    document.getElementById('headerPremiumBtn').addEventListener('click', showPaymentModal);

    document.getElementById('paymentModal').addEventListener('click', (e) => {
        if (e.target.id === 'paymentModal') {
            hidePaymentModal();
        }
    });

    // Navigation
    document.getElementById('backToSubjects').addEventListener('click', showSubjectSelection);
    document.getElementById('backToTopics').addEventListener('click', showTopicSelection);
    document.getElementById('backToTopicsFromResults').addEventListener('click', showTopicSelection);

    // Quiz controls
    document.getElementById('prevBtn').addEventListener('click', previousQuestion);
    document.getElementById('nextBtn').addEventListener('click', nextQuestion);
    document.getElementById('explainBtn').addEventListener('click', showExplanation);

    // Results
    document.getElementById('retakeBtn').addEventListener('click', () => {
        stopTimer();
        currentQuestions = shuffleArray([...currentTopic.questions]);
        currentQuestionIndex = 0;
        userAnswers = [];
        quizStartTime = Date.now();
        renderQuestion();
        showQuizInterface();
    });

    // Mode info
    const modeInfoBtn = document.getElementById('modeInfoBtn');
    const modeInfoPanel = document.getElementById('modeInfoPanel');
    const closeModeInfoBtn = document.getElementById('closeModeInfoBtn');

    if (modeInfoBtn && modeInfoPanel) {
        modeInfoBtn.addEventListener('click', () => {
            modeInfoPanel.classList.toggle('hidden');
        });
    }

    if (closeModeInfoBtn && modeInfoPanel) {
        closeModeInfoBtn.addEventListener('click', () => {
            modeInfoPanel.classList.add('hidden');
        });
    }

    // Wrong answers
    document.getElementById('reviewWrongBtn').addEventListener('click', renderWrongAnswers);
    document.getElementById('hideWrongAnswersBtn').addEventListener('click', () => {
        document.getElementById('wrongAnswersSection').classList.add('hidden');
        document.getElementById('quizResults').scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    // Submit modal
    document.getElementById('confirmSubmitBtn').addEventListener('click', confirmSubmitQuiz);
    document.getElementById('cancelSubmitBtn').addEventListener('click', hideSubmitModal);

    // Keyboard help
    document.getElementById('keyboardHelpToggle').addEventListener('click', toggleKeyboardHelp);
    document.getElementById('closeKeyboardHelp').addEventListener('click', () => {
        document.getElementById('keyboardHelpPanel').classList.add('hidden');
        document.getElementById('keyboardHelpToggle').classList.remove('hidden');
    });

    // Global keyboard shortcuts
    document.addEventListener('keydown', handleKeyboardShortcuts);
}

// ============================================
// INITIALIZE APP
// ============================================
init();
</script>
</body>
</html>