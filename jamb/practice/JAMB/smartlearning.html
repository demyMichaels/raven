<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Learning Analytics Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4A49C5',
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-success {
            animation: pulseSuccess 0.5s ease-out;
        }
        @keyframes pulseSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .shake {
            animation: shake 0.5s ease-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 transition-colors duration-200">

    <!-- Main Container -->
    <div class="min-h-screen">

        <!-- Header -->
        <header class="bg-gradient-to-r from-primary to-primary-dark text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <h1 class="text-2xl sm:text-3xl font-bold">üéì Smart Learning Analytics</h1>
                <p class="text-sm sm:text-base mt-1 opacity-90">Data-driven learning for better outcomes</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-2 sm:space-x-4 overflow-x-auto py-3">
                    <button onclick="switchTab('quiz')" id="tab-quiz" class="tab-button px-4 py-2 rounded-lg font-medium whitespace-nowrap text-base">
                        üìù Quiz
                    </button>
                    <button onclick="switchTab('analytics')" id="tab-analytics" class="tab-button px-4 py-2 rounded-lg font-medium whitespace-nowrap text-base">
                        üìä Analytics
                    </button>
                    <button onclick="switchTab('progress')" id="tab-progress" class="tab-button px-4 py-2 rounded-lg font-medium whitespace-nowrap text-base">
                        üìà Progress
                    </button>
                    <button onclick="switchTab('insights')" id="tab-insights" class="tab-button px-4 py-2 rounded-lg font-medium whitespace-nowrap text-base">
                        üí° Insights
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">

            <!-- Quiz Tab -->
            <div id="content-quiz" class="tab-content hidden">

                <!-- Subject Selection -->
                <div id="subject-selection" class="space-y-6">
                    <h2 class="text-2xl font-bold mb-6">Choose a Subject</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="subject-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Topic Selection -->
                <div id="topic-selection" class="hidden space-y-6">
                    <button onclick="backToSubjects()" class="text-primary hover:text-primary-dark font-medium mb-4 text-base">
                        ‚Üê Back to Subjects
                    </button>
                    <h2 class="text-2xl font-bold mb-6" id="topic-title">Choose a Topic</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="topic-grid">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Quiz Interface -->
                <div id="quiz-interface" class="hidden space-y-6">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="backToTopics()" class="text-primary hover:text-primary-dark font-medium text-base">
                            ‚Üê Back to Topics
                        </button>
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            <span id="quiz-timer">00:00</span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                        <div id="quiz-progress" class="bg-primary h-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <!-- Question Counter -->
                    <div class="text-center text-sm text-gray-600 dark:text-gray-400">
                        Question <span id="current-question">1</span> of <span id="total-questions">10</span>
                    </div>

                    <!-- Question Card -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="mb-4">
                            <span id="difficulty-badge" class="px-3 py-1 rounded-full text-sm font-medium"></span>
                        </div>
                        <h3 class="text-xl font-semibold mb-6" id="question-text"></h3>
                        <div class="space-y-3" id="answers-container">
                            <!-- Dynamically populated -->
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between items-center">
                        <button onclick="previousQuestion()" id="prev-btn" class="px-6 py-3 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg font-medium transition text-base disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <button onclick="nextQuestion()" id="next-btn" class="px-6 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium transition text-base">
                            Next
                        </button>
                    </div>
                </div>

                <!-- Results Screen -->
                <div id="quiz-results" class="hidden space-y-6">
                    <div class="text-center">
                        <div class="inline-block p-8 bg-gradient-to-br from-primary to-primary-dark rounded-full mb-6">
                            <span class="text-6xl">üéâ</span>
                        </div>
                        <h2 class="text-3xl font-bold mb-4">Quiz Complete!</h2>
                        <div class="text-6xl font-bold text-primary mb-4" id="final-score">85%</div>
                        <p class="text-lg text-gray-600 dark:text-gray-400 mb-8" id="score-message"></p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-green-100 dark:bg-green-900/30 p-6 rounded-xl text-center">
                            <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="correct-count">8</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2">Correct</div>
                        </div>
                        <div class="bg-red-100 dark:bg-red-900/30 p-6 rounded-xl text-center">
                            <div class="text-3xl font-bold text-red-600 dark:text-red-400" id="incorrect-count">2</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2">Incorrect</div>
                        </div>
                        <div class="bg-blue-100 dark:bg-blue-900/30 p-6 rounded-xl text-center">
                            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="time-spent">12:45</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2">Time Spent</div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="reviewAnswers()" class="px-8 py-3 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg font-medium transition text-base">
                            Review Answers
                        </button>
                        <button onclick="retakeQuiz()" class="px-8 py-3 bg-primary hover:bg-primary-dark text-white rounded-lg font-medium transition text-base">
                            Try Again
                        </button>
                        <button onclick="backToTopics()" class="px-8 py-3 border-2 border-primary text-primary hover:bg-primary hover:text-white rounded-lg font-medium transition text-base">
                            Choose New Topic
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="content-analytics" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">Comprehensive Analytics</h2>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="text-sm opacity-90 mb-2">Total Sessions</div>
                        <div class="text-3xl font-bold" id="total-sessions">0</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="text-sm opacity-90 mb-2">Average Score</div>
                        <div class="text-3xl font-bold" id="avg-score">0%</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="text-sm opacity-90 mb-2">Study Streak</div>
                        <div class="text-3xl font-bold" id="study-streak">0 days</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="text-sm opacity-90 mb-2">Total Time</div>
                        <div class="text-3xl font-bold" id="total-time">0h 0m</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Performance Trend</h3>
                        <canvas id="performance-chart"></canvas>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">Subject Distribution</h3>
                        <canvas id="subject-chart"></canvas>
                    </div>
                </div>

                <!-- Recent Sessions -->
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4">Recent Sessions</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="text-left border-b border-gray-300 dark:border-gray-600">
                                <tr>
                                    <th class="pb-3 text-base">Subject</th>
                                    <th class="pb-3 text-base">Topic</th>
                                    <th class="pb-3 text-base">Score</th>
                                    <th class="pb-3 text-base">Time</th>
                                    <th class="pb-3 text-base">Date</th>
                                </tr>
                            </thead>
                            <tbody id="sessions-table" class="text-base">
                                <!-- Dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Progress Tab -->
            <div id="content-progress" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">Learning Progress</h2>

                <!-- Subject Progress -->
                <div class="space-y-6">
                    <div id="subject-progress-container">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Topic Mastery Breakdown -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4">Topic Mastery Overview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="mastery-overview">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="content-insights" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">Learning Insights & Recommendations</h2>

                <!-- Engagement Score -->
                <div class="bg-gradient-to-r from-primary to-primary-dark text-white p-8 rounded-xl shadow-lg mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-semibold mb-2">Engagement Score</h3>
                            <p class="opacity-90">Based on consistency, performance, and activity</p>
                        </div>
                        <div class="text-6xl font-bold" id="engagement-score">78</div>
                    </div>
                </div>

                <!-- Learning Patterns -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">üìö Learning Preferences</h3>
                        <div class="space-y-3" id="learning-preferences">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold mb-4">‚ö° Performance Insights</h3>
                        <div class="space-y-3" id="performance-insights">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>

                <!-- Knowledge Gaps -->
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6">
                    <h3 class="text-lg font-semibold mb-4">üéØ Identified Knowledge Gaps</h3>
                    <div id="knowledge-gaps" class="space-y-4">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 class="text-lg font-semibold mb-4">üí° Personalized Recommendations</h3>
                    <div id="recommendations" class="space-y-3">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Dark mode initialization
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // ============================================
        // DATA STRUCTURES
        // ============================================

        // Question Bank
        const questionBank = {
            mathematics: {
                algebra: [
                    { id: 'alg_001', question: 'Solve for x: 2x + 5 = 13', answers: ['x = 3', 'x = 4', 'x = 5', 'x = 6'], correct: 1, difficulty: 'easy', tags: ['equations', 'basic'] },
                    { id: 'alg_002', question: 'Factor: x¬≤ + 5x + 6', answers: ['(x+2)(x+3)', '(x+1)(x+6)', '(x+4)(x+2)', '(x+5)(x+1)'], correct: 0, difficulty: 'medium', tags: ['factoring', 'polynomials'] },
                    { id: 'alg_003', question: 'What is the slope of y = 3x - 2?', answers: ['3', '-2', '1/3', '-1/2'], correct: 0, difficulty: 'easy', tags: ['linear', 'slope'] },
                    { id: 'alg_004', question: 'Solve: x¬≤ - 4 = 0', answers: ['x = ¬±2', 'x = 4', 'x = 2', 'x = -2'], correct: 0, difficulty: 'medium', tags: ['quadratic', 'equations'] },
                    { id: 'alg_005', question: 'Simplify: (x¬≥)¬≤', answers: ['x‚Åµ', 'x‚Å∂', 'x‚Åπ', '2x¬≥'], correct: 1, difficulty: 'medium', tags: ['exponents', 'simplification'] },
                    { id: 'alg_006', question: 'Solve for x: 3x - 7 = 2x + 5', answers: ['x = 12', 'x = 10', 'x = 8', 'x = 6'], correct: 0, difficulty: 'easy', tags: ['equations', 'variables'] },
                    { id: 'alg_007', question: 'What is the vertex of y = (x-2)¬≤ + 3?', answers: ['(2, 3)', '(-2, 3)', '(2, -3)', '(-2, -3)'], correct: 0, difficulty: 'hard', tags: ['quadratic', 'vertex'] },
                    { id: 'alg_008', question: 'Solve inequality: 2x + 3 > 7', answers: ['x > 2', 'x > 5', 'x < 2', 'x > 4'], correct: 0, difficulty: 'medium', tags: ['inequalities'] },
                    { id: 'alg_009', question: 'Expand: (x + 3)(x - 3)', answers: ['x¬≤ - 9', 'x¬≤ + 9', 'x¬≤ - 6x + 9', 'x¬≤ + 6x - 9'], correct: 0, difficulty: 'medium', tags: ['expansion', 'polynomials'] },
                    { id: 'alg_010', question: 'Find the y-intercept: y = 4x + 7', answers: ['7', '4', '-7', '1'], correct: 0, difficulty: 'easy', tags: ['linear', 'intercept'] }
                ],
                geometry: [
                    { id: 'geo_001', question: 'What is the area of a circle with radius 3?', answers: ['9œÄ', '6œÄ', '3œÄ', '12œÄ'], correct: 0, difficulty: 'easy', tags: ['circles', 'area'] },
                    { id: 'geo_002', question: 'Sum of angles in a triangle?', answers: ['180¬∞', '360¬∞', '90¬∞', '270¬∞'], correct: 0, difficulty: 'easy', tags: ['triangles', 'angles'] },
                    { id: 'geo_003', question: 'Pythagorean theorem: a¬≤ + b¬≤ = ?', answers: ['c¬≤', 'ab', '2c', 'c'], correct: 0, difficulty: 'easy', tags: ['pythagorean', 'theorem'] },
                    { id: 'geo_004', question: 'Area of rectangle 5√ó8?', answers: ['40', '26', '13', '20'], correct: 0, difficulty: 'easy', tags: ['rectangles', 'area'] },
                    { id: 'geo_005', question: 'Volume of cube with side 4?', answers: ['64', '16', '48', '12'], correct: 0, difficulty: 'medium', tags: ['volume', 'cubes'] },
                    { id: 'geo_006', question: 'Circumference formula?', answers: ['2œÄr', 'œÄr¬≤', 'œÄd', 'Both A and C'], correct: 3, difficulty: 'medium', tags: ['circles', 'formulas'] },
                    { id: 'geo_007', question: 'How many sides does a hexagon have?', answers: ['6', '5', '7', '8'], correct: 0, difficulty: 'easy', tags: ['polygons'] },
                    { id: 'geo_008', question: 'If triangle has sides 3, 4, 5, what type?', answers: ['Right', 'Isosceles', 'Equilateral', 'Obtuse'], correct: 0, difficulty: 'medium', tags: ['triangles', 'types'] },
                    { id: 'geo_009', question: 'Complementary angles sum to?', answers: ['90¬∞', '180¬∞', '360¬∞', '270¬∞'], correct: 0, difficulty: 'easy', tags: ['angles'] },
                    { id: 'geo_010', question: 'Area of triangle: base=6, height=4?', answers: ['12', '24', '10', '20'], correct: 0, difficulty: 'easy', tags: ['triangles', 'area'] }
                ]
            },
            science: {
                physics: [
                    { id: 'phy_001', question: 'What is the SI unit of force?', answers: ['Newton', 'Joule', 'Watt', 'Pascal'], correct: 0, difficulty: 'easy', tags: ['units', 'force'] },
                    { id: 'phy_002', question: 'Speed of light in vacuum?', answers: ['3√ó10‚Å∏ m/s', '3√ó10‚Å∂ m/s', '3√ó10‚Åπ m/s', '3√ó10‚Å∑ m/s'], correct: 0, difficulty: 'medium', tags: ['constants', 'light'] },
                    { id: 'phy_003', question: 'Newton\'s First Law is also called?', answers: ['Law of Inertia', 'F=ma', 'Action-Reaction', 'Gravity Law'], correct: 0, difficulty: 'medium', tags: ['newton', 'laws'] },
                    { id: 'phy_004', question: 'Formula for kinetic energy?', answers: ['¬Ωmv¬≤', 'mgh', 'mv', 'ma'], correct: 0, difficulty: 'medium', tags: ['energy', 'kinetic'] },
                    { id: 'phy_005', question: 'What accelerates falling objects?', answers: ['Gravity', 'Air resistance', 'Momentum', 'Friction'], correct: 0, difficulty: 'easy', tags: ['gravity', 'motion'] },
                    { id: 'phy_006', question: 'Work = Force √ó ?', answers: ['Distance', 'Time', 'Mass', 'Velocity'], correct: 0, difficulty: 'easy', tags: ['work', 'energy'] },
                    { id: 'phy_007', question: 'Unit of power?', answers: ['Watt', 'Joule', 'Newton', 'Ampere'], correct: 0, difficulty: 'easy', tags: ['units', 'power'] },
                    { id: 'phy_008', question: 'Ohm\'s Law: V = ?', answers: ['IR', 'I/R', 'R/I', 'I¬≤R'], correct: 0, difficulty: 'medium', tags: ['electricity', 'ohm'] },
                    { id: 'phy_009', question: 'Frequency √ó Wavelength = ?', answers: ['Speed', 'Energy', 'Amplitude', 'Period'], correct: 0, difficulty: 'medium', tags: ['waves', 'formulas'] },
                    { id: 'phy_010', question: 'What is momentum?', answers: ['Mass √ó Velocity', 'Force √ó Time', 'Mass √ó Acceleration', 'Energy √ó Time'], correct: 0, difficulty: 'medium', tags: ['momentum'] }
                ],
                chemistry: [
                    { id: 'chem_001', question: 'What is H‚ÇÇO?', answers: ['Water', 'Hydrogen', 'Oxygen', 'Peroxide'], correct: 0, difficulty: 'easy', tags: ['compounds', 'basic'] },
                    { id: 'chem_002', question: 'Atomic number of Carbon?', answers: ['6', '12', '8', '14'], correct: 0, difficulty: 'easy', tags: ['elements', 'periodic'] },
                    { id: 'chem_003', question: 'pH of neutral solution?', answers: ['7', '0', '14', '10'], correct: 0, difficulty: 'easy', tags: ['pH', 'solutions'] },
                    { id: 'chem_004', question: 'Noble gases are in group?', answers: ['18', '1', '2', '17'], correct: 0, difficulty: 'medium', tags: ['periodic', 'groups'] },
                    { id: 'chem_005', question: 'NaCl is commonly called?', answers: ['Salt', 'Sugar', 'Baking Soda', 'Vinegar'], correct: 0, difficulty: 'easy', tags: ['compounds', 'common'] },
                    { id: 'chem_006', question: 'Avogadro\'s number?', answers: ['6.02√ó10¬≤¬≥', '3.14√ó10¬≤¬≥', '1.6√ó10¬≤¬≥', '9.8√ó10¬≤¬≥'], correct: 0, difficulty: 'hard', tags: ['constants'] },
                    { id: 'chem_007', question: 'What is a catalyst?', answers: ['Speeds reaction', 'Slows reaction', 'Stops reaction', 'Creates products'], correct: 0, difficulty: 'medium', tags: ['reactions', 'catalysts'] },
                    { id: 'chem_008', question: 'Oxidation is loss of?', answers: ['Electrons', 'Protons', 'Neutrons', 'Atoms'], correct: 0, difficulty: 'medium', tags: ['redox', 'oxidation'] },
                    { id: 'chem_009', question: 'Most abundant gas in air?', answers: ['Nitrogen', 'Oxygen', 'Carbon Dioxide', 'Argon'], correct: 0, difficulty: 'easy', tags: ['atmosphere'] },
                    { id: 'chem_010', question: 'Acid + Base ‚Üí ?', answers: ['Salt + Water', 'Only Salt', 'Only Water', 'Gas'], correct: 0, difficulty: 'medium', tags: ['reactions', 'neutralization'] }
                ]
            }
        };

        // Subject metadata
        const subjects = {
            mathematics: {
                name: 'Mathematics',
                icon: 'üìê',
                color: 'blue',
                topics: {
                    algebra: { name: 'Algebra', description: 'Equations, variables, and functions', difficulty: 'medium' },
                    geometry: { name: 'Geometry', description: 'Shapes, angles, and measurements', difficulty: 'easy' }
                }
            },
            science: {
                name: 'Science',
                icon: 'üî¨',
                color: 'green',
                topics: {
                    physics: { name: 'Physics', description: 'Forces, energy, and motion', difficulty: 'hard' },
                    chemistry: { name: 'Chemistry', description: 'Elements, compounds, and reactions', difficulty: 'medium' }
                }
            }
        };

        // ============================================
        // ANALYTICS DATA STRUCTURE
        // ============================================

        let analyticsData = {
            quizSessions: [],
            topicMastery: {},
            subjectAnalytics: {},
            engagementMetrics: {
                dailyActivity: {},
                sessionPatterns: {
                    averageSessionsPerDay: 0,
                    preferredSessionLength: '15-30min',
                    mostActiveDays: [],
                    studyStreak: 0,
                    longestStreak: 0
                },
                learningPreferences: {
                    preferredQuestionTypes: ['multiple_choice'],
                    preferredDifficulty: 'medium',
                    studyIntensity: 'moderate',
                    reviewFrequency: 'weekly'
                },
                engagementScore: 0,
                consistencyScore: 0,
                improvementMomentum: 'positive'
            },
            learningPatterns: {
                identifiedGaps: [],
                efficiencyMetrics: {
                    questionsPerMinute: 0,
                    accuracyVsSpeed: 'balanced',
                    optimalPace: 45,
                    fatigueThreshold: 25
                },
                behavioralInsights: {
                    learnsBest: 'with_examples',
                    retentionStyle: 'visual',
                    challengePreference: 'gradual_increase',
                    feedbackResponse: 'positive'
                }
            },
            performanceAnalytics: {
                percentileRanking: { subject: 0, topic: 0, overall: 0 },
                improvementRate: { weekly: 0, monthly: 0, overall: 0 },
                skillDevelopment: {
                    problemSolving: 0,
                    conceptualUnderstanding: 0,
                    application: 0,
                    analysis: 0,
                    speed: 0
                }
            }
        };

        // Load analytics from memory (persists during session)
        function loadAnalytics() {
            // Analytics data is already initialized in memory
            // In a production app, this would load from a backend API
        }

        // Save analytics to memory (persists during session)
        function saveAnalytics() {
            // Analytics data is already in memory
            // In a production app, this would save to a backend API
        }

        // ============================================
        // QUIZ STATE
        // ============================================

        let currentState = {
            subject: null,
            topic: null,
            questions: [],
            currentQuestionIndex: 0,
            userAnswers: [],
            startTime: null,
            questionStartTime: null,
            sessionId: null
        };

        // ============================================
        // NAVIGATION
        // ============================================

        function switchTab(tabName) {
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Remove active state from all tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('text-gray-600', 'dark:text-gray-400', 'hover:bg-gray-200', 'dark:hover:bg-gray-800');
            });

            // Show selected content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`content-${tabName}`).classList.add('fade-in');

            // Add active state to clicked tab
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('bg-primary', 'text-white');
            activeBtn.classList.remove('text-gray-600', 'dark:text-gray-400', 'hover:bg-gray-200', 'dark:hover:bg-gray-800');

            // Load data for specific tabs
            if (tabName === 'analytics') {
                renderAnalytics();
            } else if (tabName === 'progress') {
                renderProgress();
            } else if (tabName === 'insights') {
                renderInsights();
            }
        }

        // ============================================
        // QUIZ FUNCTIONS
        // ============================================

        function initializeQuiz() {
            renderSubjects();
            switchTab('quiz');
        }

        function renderSubjects() {
            const grid = document.getElementById('subject-grid');
            grid.innerHTML = '';

            Object.keys(subjects).forEach(subjectKey => {
                const subject = subjects[subjectKey];
                const colorMap = {
                    blue: 'from-blue-500 to-blue-600',
                    green: 'from-green-500 to-green-600',
                    purple: 'from-purple-500 to-purple-600',
                    orange: 'from-orange-500 to-orange-600'
                };

                const card = document.createElement('div');
                card.className = `bg-gradient-to-br ${colorMap[subject.color]} text-white p-6 rounded-xl shadow-lg cursor-pointer transform transition hover:scale-105`;
                card.onclick = () => selectSubject(subjectKey);
                card.innerHTML = `
                    <div class="text-5xl mb-3">${subject.icon}</div>
                    <h3 class="text-xl font-bold mb-2">${subject.name}</h3>
                    <p class="text-sm opacity-90">${Object.keys(subject.topics).length} topics available</p>
                `;
                grid.appendChild(card);
            });
        }

        function selectSubject(subjectKey) {
            currentState.subject = subjectKey;
            renderTopics(subjectKey);

            document.getElementById('subject-selection').classList.add('hidden');
            document.getElementById('topic-selection').classList.remove('hidden');
        }

        function renderTopics(subjectKey) {
            const subject = subjects[subjectKey];
            const grid = document.getElementById('topic-grid');
            const title = document.getElementById('topic-title');

            title.textContent = `${subject.icon} ${subject.name} Topics`;
            grid.innerHTML = '';

            Object.keys(subject.topics).forEach(topicKey => {
                const topic = subject.topics[topicKey];
                const topicId = `${subjectKey}_${topicKey}`;
                const mastery = analyticsData.topicMastery[topicId];

                const difficultyColors = {
                    easy: 'green',
                    medium: 'yellow',
                    hard: 'red'
                };

                const card = document.createElement('div');
                card.className = 'bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg cursor-pointer transform transition hover:scale-105 border-2 border-transparent hover:border-primary';
                card.onclick = () => selectTopic(topicKey);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-lg font-bold">${topic.name}</h3>
                        <span class="px-2 py-1 rounded text-xs font-medium bg-${difficultyColors[topic.difficulty]}-100 dark:bg-${difficultyColors[topic.difficulty]}-900/30 text-${difficultyColors[topic.difficulty]}-700 dark:text-${difficultyColors[topic.difficulty]}-300">
                            ${topic.difficulty}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${topic.description}</p>
                    ${mastery ? `
                        <div class="mt-4">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-600 dark:text-gray-400">Mastery</span>
                                <span class="font-semibold">${mastery.overallScore || 0}%</span>
                            </div>
                            <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-primary rounded-full h-2" style="width: ${mastery.overallScore || 0}%"></div>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                ${mastery.totalAttempts || 0} attempts
                            </div>
                        </div>
                    ` : '<div class="text-sm text-gray-500 dark:text-gray-400 mt-4">Not yet attempted</div>'}
                `;
                grid.appendChild(card);
            });
        }

        function selectTopic(topicKey) {
            currentState.topic = topicKey;
            currentState.questions = [...questionBank[currentState.subject][topicKey]];
            currentState.currentQuestionIndex = 0;
            currentState.userAnswers = new Array(currentState.questions.length).fill(null);
            currentState.startTime = Date.now();
            currentState.sessionId = `session_${Date.now()}`;

            // Shuffle questions
            shuffleArray(currentState.questions);

            document.getElementById('topic-selection').classList.add('hidden');
            document.getElementById('quiz-interface').classList.remove('hidden');

            startQuizTimer();
            renderQuestion();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderQuestion() {
            const question = currentState.questions[currentState.currentQuestionIndex];
            const total = currentState.questions.length;
            const current = currentState.currentQuestionIndex + 1;

            // Update progress
            document.getElementById('quiz-progress').style.width = `${(current / total) * 100}%`;
            document.getElementById('current-question').textContent = current;
            document.getElementById('total-questions').textContent = total;

            // Update difficulty badge
            const badge = document.getElementById('difficulty-badge');
            const difficultyColors = {
                easy: { bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-700 dark:text-green-300' },
                medium: { bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-700 dark:text-yellow-300' },
                hard: { bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-700 dark:text-red-300' }
            };
            const colors = difficultyColors[question.difficulty];
            badge.className = `px-3 py-1 rounded-full text-sm font-medium ${colors.bg} ${colors.text}`;
            badge.textContent = question.difficulty.toUpperCase();

            // Update question
            document.getElementById('question-text').textContent = question.question;

            // Render answers
            const container = document.getElementById('answers-container');
            container.innerHTML = '';

            question.answers.forEach((answer, index) => {
                const selected = currentState.userAnswers[currentState.currentQuestionIndex] === index;
                const button = document.createElement('button');
                button.className = `w-full text-left p-4 rounded-lg border-2 transition text-base ${
                    selected
                        ? 'border-primary bg-primary/10'
                        : 'border-gray-300 dark:border-gray-600 hover:border-primary'
                }`;
                button.onclick = () => selectAnswer(index);
                button.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full border-2 ${
                            selected
                                ? 'border-primary bg-primary'
                                : 'border-gray-400'
                        } mr-3 flex items-center justify-center">
                            ${selected ? '<div class="w-3 h-3 rounded-full bg-white"></div>' : ''}
                        </div>
                        <span>${answer}</span>
                    </div>
                `;
                container.appendChild(button);
            });

            // Update navigation buttons
            document.getElementById('prev-btn').disabled = current === 1;
            document.getElementById('next-btn').textContent = current === total ? 'Finish' : 'Next';

            // Start question timer
            currentState.questionStartTime = Date.now();
        }

        function selectAnswer(answerIndex) {
            const timeSpent = (Date.now() - currentState.questionStartTime) / 1000;
            currentState.userAnswers[currentState.currentQuestionIndex] = {
                answer: answerIndex,
                timeSpent: timeSpent
            };
            renderQuestion();
        }

        function previousQuestion() {
            if (currentState.currentQuestionIndex > 0) {
                currentState.currentQuestionIndex--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (currentState.currentQuestionIndex < currentState.questions.length - 1) {
                currentState.currentQuestionIndex++;
                renderQuestion();
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            const totalTime = (Date.now() - currentState.startTime) / 1000;

            // Calculate results
            let correct = 0;
            let incorrect = 0;
            const questionDetails = [];

            currentState.questions.forEach((q, index) => {
                const userAnswer = currentState.userAnswers[index];
                const isCorrect = userAnswer && userAnswer.answer === q.correct;

                if (isCorrect) correct++;
                else incorrect++;

                questionDetails.push({
                    questionId: q.id,
                    type: 'multiple_choice',
                    difficulty: q.difficulty,
                    timeSpent: userAnswer ? userAnswer.timeSpent : 0,
                    userAnswer: userAnswer ? userAnswer.answer : null,
                    correctAnswer: q.correct,
                    isCorrect: isCorrect,
                    topicTags: q.tags
                });
            });

            const score = Math.round((correct / currentState.questions.length) * 100);

            // Create session record
            const session = {
                sessionId: currentState.sessionId,
                subjectId: currentState.subject,
                topicName: currentState.topic,
                startTime: new Date(currentState.startTime).toISOString(),
                endTime: new Date().toISOString(),
                duration: totalTime,
                totalQuestions: currentState.questions.length,
                questions: questionDetails,
                score: score,
                correctAnswers: correct,
                incorrectAnswers: incorrect,
                accuracyByDifficulty: calculateAccuracyByDifficulty(questionDetails),
                timePerQuestion: totalTime / currentState.questions.length,
                pace: calculatePace(totalTime / currentState.questions.length),
                device: 'web',
                browser: 'unknown'
            };

            // Save session to analytics
            analyticsData.quizSessions.push(session);

            // Update topic mastery
            updateTopicMastery(session);

            // Update subject analytics
            updateSubjectAnalytics(session);

            // Update engagement metrics
            updateEngagementMetrics(session);

            // Update learning patterns
            updateLearningPatterns(session);

            // Save to localStorage
            saveAnalytics();

            // Show results
            displayResults(score, correct, incorrect, totalTime);
        }

        function calculateAccuracyByDifficulty(questions) {
            const byDifficulty = { easy: { correct: 0, total: 0 }, medium: { correct: 0, total: 0 }, hard: { correct: 0, total: 0 } };

            questions.forEach(q => {
                byDifficulty[q.difficulty].total++;
                if (q.isCorrect) byDifficulty[q.difficulty].correct++;
            });

            const result = {};
            Object.keys(byDifficulty).forEach(diff => {
                result[diff] = byDifficulty[diff].total > 0
                    ? byDifficulty[diff].correct / byDifficulty[diff].total
                    : 0;
            });

            return result;
        }

        function calculatePace(avgTime) {
            if (avgTime < 30) return 'fast';
            if (avgTime > 60) return 'slow';
            return 'steady';
        }

        function updateTopicMastery(session) {
            const topicId = `${session.subjectId}_${session.topicName}`;

            if (!analyticsData.topicMastery[topicId]) {
                analyticsData.topicMastery[topicId] = {
                    overallScore: 0,
                    bestScore: 0,
                    worstScore: 100,
                    scoreTrend: 'stable',
                    totalAttempts: 0,
                    completedAttempts: 0,
                    abandonedAttempts: 0,
                    averageAttemptDuration: 0,
                    learningCurve: [],
                    subTopicProficiency: {}
                };
            }

            const mastery = analyticsData.topicMastery[topicId];
            mastery.totalAttempts++;
            mastery.completedAttempts++;
            mastery.bestScore = Math.max(mastery.bestScore, session.score);
            mastery.worstScore = Math.min(mastery.worstScore, session.score);

            // Update learning curve
            mastery.learningCurve.push({
                attempt: mastery.totalAttempts,
                score: session.score,
                date: new Date().toISOString().split('T')[0]
            });

            // Calculate overall score (weighted average favoring recent attempts)
            const recentScores = mastery.learningCurve.slice(-5).map(lc => lc.score);
            mastery.overallScore = Math.round(recentScores.reduce((a, b) => a + b, 0) / recentScores.length);

            // Determine trend
            if (mastery.learningCurve.length >= 3) {
                const recent = mastery.learningCurve.slice(-3);
                const avgRecent = recent.reduce((a, b) => a + b.score, 0) / 3;
                const previous = mastery.learningCurve.slice(-6, -3);
                if (previous.length > 0) {
                    const avgPrevious = previous.reduce((a, b) => a + b.score, 0) / previous.length;
                    if (avgRecent > avgPrevious + 5) mastery.scoreTrend = 'improving';
                    else if (avgRecent < avgPrevious - 5) mastery.scoreTrend = 'declining';
                    else mastery.scoreTrend = 'stable';
                }
            }

            // Update average duration
            mastery.averageAttemptDuration =
                (mastery.averageAttemptDuration * (mastery.totalAttempts - 1) + session.duration) / mastery.totalAttempts;
        }

        function updateSubjectAnalytics(session) {
            if (!analyticsData.subjectAnalytics[session.subjectId]) {
                analyticsData.subjectAnalytics[session.subjectId] = {
                    completion: 0,
                    estimatedMastery: 0,
                    topicBreakdown: { mastered: [], proficient: [], learning: [], notAttempted: [] },
                    performanceByCategory: {},
                    weeklyProgress: []
                };
            }

            const subjectData = analyticsData.subjectAnalytics[session.subjectId];

            // Update performance by category
            if (!subjectData.performanceByCategory[session.topicName]) {
                subjectData.performanceByCategory[session.topicName] = {
                    averageScore: 0,
                    timeSpent: 0,
                    attempts: 0
                };
            }

            const topicPerf = subjectData.performanceByCategory[session.topicName];
            topicPerf.attempts++;
            topicPerf.averageScore =
                (topicPerf.averageScore * (topicPerf.attempts - 1) + session.score) / topicPerf.attempts;
            topicPerf.timeSpent += session.duration;

            // Calculate completion
            const totalTopics = Object.keys(subjects[session.subjectId].topics).length;
            const attemptedTopics = Object.keys(subjectData.performanceByCategory).length;
            subjectData.completion = attemptedTopics / totalTopics;

            // Calculate estimated mastery
            const scores = Object.values(subjectData.performanceByCategory).map(p => p.averageScore);
            subjectData.estimatedMastery = scores.reduce((a, b) => a + b, 0) / scores.length / 100;

            // Update topic breakdown
            Object.keys(analyticsData.topicMastery).forEach(topicId => {
                if (topicId.startsWith(session.subjectId)) {
                    const mastery = analyticsData.topicMastery[topicId];
                    const topicName = topicId.split('_')[1];

                    subjectData.topicBreakdown.mastered = subjectData.topicBreakdown.mastered.filter(t => t !== topicName);
                    subjectData.topicBreakdown.proficient = subjectData.topicBreakdown.proficient.filter(t => t !== topicName);
                    subjectData.topicBreakdown.learning = subjectData.topicBreakdown.learning.filter(t => t !== topicName);

                    if (mastery.overallScore >= 90) subjectData.topicBreakdown.mastered.push(topicName);
                    else if (mastery.overallScore >= 70) subjectData.topicBreakdown.proficient.push(topicName);
                    else subjectData.topicBreakdown.learning.push(topicName);
                }
            });
        }

        function updateEngagementMetrics(session) {
            const today = new Date().toISOString().split('T')[0];

            // Update daily activity
            if (!analyticsData.engagementMetrics.dailyActivity[today]) {
                analyticsData.engagementMetrics.dailyActivity[today] = {
                    sessions: 0,
                    totalTime: 0,
                    subjects: new Set()
                };
            }

            const dailyData = analyticsData.engagementMetrics.dailyActivity[today];
            dailyData.sessions++;
            dailyData.totalTime += session.duration;
            dailyData.subjects.add(session.subjectId);

            // Convert Set to Array for storage
            analyticsData.engagementMetrics.dailyActivity[today].subjects =
                Array.from(dailyData.subjects);

            // Calculate study streak
            const dates = Object.keys(analyticsData.engagementMetrics.dailyActivity).sort();
            let streak = 0;
            let currentDate = new Date();

            for (let i = dates.length - 1; i >= 0; i--) {
                const checkDate = new Date(dates[i]);
                const diffDays = Math.floor((currentDate - checkDate) / (1000 * 60 * 60 * 24));

                if (diffDays === streak) {
                    streak++;
                } else {
                    break;
                }
            }

            analyticsData.engagementMetrics.sessionPatterns.studyStreak = streak;
            analyticsData.engagementMetrics.sessionPatterns.longestStreak =
                Math.max(analyticsData.engagementMetrics.sessionPatterns.longestStreak, streak);

            // Calculate engagement score
            const totalSessions = analyticsData.quizSessions.length;
            const avgScore = analyticsData.quizSessions.reduce((a, b) => a + b.score, 0) / totalSessions;
            const consistencyScore = Math.min(100, streak * 10);

            analyticsData.engagementMetrics.engagementScore = Math.round(
                (avgScore * 0.4) + (consistencyScore * 0.3) + (Math.min(100, totalSessions * 5) * 0.3)
            );
            analyticsData.engagementMetrics.consistencyScore = consistencyScore;
        }

        function updateLearningPatterns(session) {
            // Calculate efficiency metrics
            const totalQuestions = analyticsData.quizSessions.reduce((a, b) => a + b.totalQuestions, 0);
            const totalTime = analyticsData.quizSessions.reduce((a, b) => a + b.duration, 0);

            analyticsData.learningPatterns.efficiencyMetrics.questionsPerMinute =
                (totalQuestions / totalTime) * 60;

            // Identify knowledge gaps
            const weakTopics = [];
            Object.keys(analyticsData.topicMastery).forEach(topicId => {
                const mastery = analyticsData.topicMastery[topicId];
                if (mastery.overallScore < 70 && mastery.totalAttempts >= 2) {
                    const [subjectId, topicName] = topicId.split('_');
                    weakTopics.push({
                        topic: topicName,
                        subject: subjectId,
                        confidence: 'high',
                        evidence: [
                            `Low average score: ${mastery.overallScore}%`,
                            `${mastery.totalAttempts} attempts made`,
                            mastery.scoreTrend === 'declining' ? 'Declining trend' : 'Not improving'
                        ],
                        recommendedActions: [
                            'Review fundamental concepts',
                            'Practice with easier questions first',
                            'Focus on understanding mistakes'
                        ]
                    });
                }
            });

            analyticsData.learningPatterns.identifiedGaps = weakTopics;

            // Update skill development scores
            const allScores = analyticsData.quizSessions.map(s => s.score);
            const recentScores = analyticsData.quizSessions.slice(-10).map(s => s.score);

            if (allScores.length > 0) {
                analyticsData.performanceAnalytics.skillDevelopment.problemSolving =
                    Math.round(recentScores.reduce((a, b) => a + b, 0) / recentScores.length);
                analyticsData.performanceAnalytics.skillDevelopment.conceptualUnderstanding =
                    Math.round((allScores.reduce((a, b) => a + b, 0) / allScores.length) * 1.1);
                analyticsData.performanceAnalytics.skillDevelopment.speed =
                    Math.min(100, Math.round(analyticsData.learningPatterns.efficiencyMetrics.questionsPerMinute * 30));
            }
        }

        function displayResults(score, correct, incorrect, totalTime) {
            document.getElementById('quiz-interface').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');

            const minutes = Math.floor(totalTime / 60);
            const seconds = Math.floor(totalTime % 60);

            document.getElementById('final-score').textContent = `${score}%`;
            document.getElementById('correct-count').textContent = correct;
            document.getElementById('incorrect-count').textContent = incorrect;
            document.getElementById('time-spent').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            let message = '';
            if (score >= 90) message = 'Outstanding! You\'re mastering this topic! üåü';
            else if (score >= 70) message = 'Great job! Keep up the good work! üëè';
            else if (score >= 50) message = 'Good effort! Review and try again! üí™';
            else message = 'Keep practicing! You\'ll improve! üìö';

            document.getElementById('score-message').textContent = message;
        }

        function reviewAnswers() {
            // Reset to first question and show interface
            currentState.currentQuestionIndex = 0;
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-interface').classList.remove('hidden');

            // Disable answer selection (review mode)
            renderQuestionReview();
        }

        function renderQuestionReview() {
            const question = currentState.questions[currentState.currentQuestionIndex];
            const userAnswer = currentState.userAnswers[currentState.currentQuestionIndex];
            const total = currentState.questions.length;
            const current = currentState.currentQuestionIndex + 1;

            document.getElementById('quiz-progress').style.width = `${(current / total) * 100}%`;
            document.getElementById('current-question').textContent = current;
            document.getElementById('total-questions').textContent = total;
            document.getElementById('question-text').textContent = question.question;

            const badge = document.getElementById('difficulty-badge');
            badge.className = `px-3 py-1 rounded-full text-sm font-medium bg-gray-200 dark:bg-gray-700`;
            badge.textContent = `Review Mode`;

            const container = document.getElementById('answers-container');
            container.innerHTML = '';

            question.answers.forEach((answer, index) => {
                const isCorrect = index === question.correct;
                const isUserAnswer = userAnswer && userAnswer.answer === index;

                let className = 'w-full text-left p-4 rounded-lg border-2 transition text-base ';
                if (isCorrect) {
                    className += 'border-green-500 bg-green-100 dark:bg-green-900/30';
                } else if (isUserAnswer) {
                    className += 'border-red-500 bg-red-100 dark:bg-red-900/30';
                } else {
                    className += 'border-gray-300 dark:border-gray-600';
                }

                const div = document.createElement('div');
                div.className = className;
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>${answer}</span>
                        ${isCorrect ? '<span class="text-green-600 dark:text-green-400">‚úì Correct</span>' : ''}
                        ${isUserAnswer && !isCorrect ? '<span class="text-red-600 dark:text-red-400">‚úó Your answer</span>' : ''}
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('prev-btn').disabled = current === 1;
            document.getElementById('next-btn').textContent = current === total ? 'Back to Results' : 'Next';
            document.getElementById('next-btn').onclick = () => {
                if (current === total) {
                    displayResults(
                        Math.round((currentState.questions.filter((q, i) =>
                            currentState.userAnswers[i] && currentState.userAnswers[i].answer === q.correct
                        ).length / currentState.questions.length) * 100),
                        currentState.questions.filter((q, i) =>
                            currentState.userAnswers[i] && currentState.userAnswers[i].answer === q.correct
                        ).length,
                        currentState.questions.length - currentState.questions.filter((q, i) =>
                            currentState.userAnswers[i] && currentState.userAnswers[i].answer === q.correct
                        ).length,
                        (Date.now() - currentState.startTime) / 1000
                    );
                } else {
                    currentState.currentQuestionIndex++;
                    renderQuestionReview();
                }
            };
        }

        function retakeQuiz() {
            selectTopic(currentState.topic);
        }

        function backToTopics() {
            document.getElementById('quiz-interface').classList.add('hidden');
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('topic-selection').classList.remove('hidden');

            // Reset next button
            document.getElementById('next-btn').onclick = nextQuestion;
        }

        function backToSubjects() {
            document.getElementById('topic-selection').classList.add('hidden');
            document.getElementById('subject-selection').classList.remove('hidden');
        }

        // Quiz timer
        let timerInterval;
        function startQuizTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - currentState.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('quiz-timer').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // ============================================
        // ANALYTICS RENDERING
        // ============================================

        function renderAnalytics() {
            const sessions = analyticsData.quizSessions;

            if (sessions.length === 0) {
                document.getElementById('total-sessions').textContent = '0';
                document.getElementById('avg-score').textContent = '0%';
                document.getElementById('study-streak').textContent = '0 days';
                document.getElementById('total-time').textContent = '0h 0m';
                document.getElementById('sessions-table').innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No quiz sessions yet. Start a quiz to see analytics!</td></tr>';
                return;
            }

            // Summary cards
            document.getElementById('total-sessions').textContent = sessions.length;
            const avgScore = Math.round(sessions.reduce((a, b) => a + b.score, 0) / sessions.length);
            document.getElementById('avg-score').textContent = `${avgScore}%`;
            document.getElementById('study-streak').textContent =
                `${analyticsData.engagementMetrics.sessionPatterns.studyStreak} days`;

            const totalSeconds = sessions.reduce((a, b) => a + b.duration, 0);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            document.getElementById('total-time').textContent = `${hours}h ${minutes}m`;

            // Performance chart
            renderPerformanceChart(sessions);

            // Subject chart
            renderSubjectChart(sessions);

            // Sessions table
            renderSessionsTable(sessions);
        }

        function renderPerformanceChart(sessions) {
            const ctx = document.getElementById('performance-chart');
            if (!ctx) return;

            // Destroy existing chart
            if (window.performanceChart) {
                window.performanceChart.destroy();
            }

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            const recentSessions = sessions.slice(-10);
            const labels = recentSessions.map((s, i) => `Quiz ${i + 1}`);
            const data = recentSessions.map(s => s.score);

            window.performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score %',
                        data: data,
                        borderColor: '#5D5CDE',
                        backgroundColor: 'rgba(93, 92, 222, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: textColor }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }

        function renderSubjectChart(sessions) {
            const ctx = document.getElementById('subject-chart');
            if (!ctx) return;

            if (window.subjectChart) {
                window.subjectChart.destroy();
            }

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';

            const subjectCounts = {};
            sessions.forEach(s => {
                subjectCounts[s.subjectId] = (subjectCounts[s.subjectId] || 0) + 1;
            });

            const labels = Object.keys(subjectCounts).map(k => subjects[k].name);
            const data = Object.values(subjectCounts);
            const colors = Object.keys(subjectCounts).map(k => {
                const colorMap = { blue: '#3b82f6', green: '#10b981', purple: '#8b5cf6', orange: '#f59e0b' };
                return colorMap[subjects[k].color];
            });

            window.subjectChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: isDark ? '#181818' : '#FFFFFF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, padding: 15 }
                        }
                    }
                }
            });
        }

        function renderSessionsTable(sessions) {
            const tbody = document.getElementById('sessions-table');
            tbody.innerHTML = '';

            sessions.slice(-10).reverse().forEach(session => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 dark:border-gray-700';

                const date = new Date(session.startTime);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const duration = Math.floor(session.duration / 60);

                row.innerHTML = `
                    <td class="py-3">${subjects[session.subjectId].icon} ${subjects[session.subjectId].name}</td>
                    <td class="py-3">${session.topicName}</td>
                    <td class="py-3">
                        <span class="px-2 py-1 rounded text-sm font-medium ${
                            session.score >= 80 ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' :
                            session.score >= 60 ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300' :
                            'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'
                        }">
                            ${session.score}%
                        </span>
                    </td>
                    <td class="py-3">${duration}m</td>
                    <td class="py-3 text-gray-500 dark:text-gray-400 text-sm">${dateStr} ${timeStr}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // ============================================
        // PROGRESS RENDERING
        // ============================================

        function renderProgress() {
            const container = document.getElementById('subject-progress-container');
            container.innerHTML = '';

            Object.keys(subjects).forEach(subjectKey => {
                const subject = subjects[subjectKey];
                const analytics = analyticsData.subjectAnalytics[subjectKey];

                const card = document.createElement('div');
                card.className = 'bg-gray-50 dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-6';

                if (!analytics) {
                    card.innerHTML = `
                        <div class="flex items-center mb-4">
                            <span class="text-4xl mr-3">${subject.icon}</span>
                            <div>
                                <h3 class="text-xl font-semibold">${subject.name}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Not yet started</p>
                            </div>
                        </div>
                    `;
                } else {
                    const masteryPercent = Math.round(analytics.estimatedMastery * 100);
                    const completionPercent = Math.round(analytics.completion * 100);

                    card.innerHTML = `
                        <div class="flex items-center mb-4">
                            <span class="text-4xl mr-3">${subject.icon}</span>
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold">${subject.name}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    ${completionPercent}% topics explored ‚Ä¢ ${masteryPercent}% mastery
                                </p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600 dark:text-gray-400">Overall Progress</span>
                                <span class="font-semibold">${masteryPercent}%</span>
                            </div>
                            <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                <div class="bg-primary rounded-full h-3 transition-all duration-500" style="width: ${masteryPercent}%"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center text-sm">
                            <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg">
                                <div class="font-bold text-green-700 dark:text-green-300">${analytics.topicBreakdown.mastered.length}</div>
                                <div class="text-gray-600 dark:text-gray-400">Mastered</div>
                            </div>
                            <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-lg">
                                <div class="font-bold text-blue-700 dark:text-blue-300">${analytics.topicBreakdown.proficient.length}</div>
                                <div class="text-gray-600 dark:text-gray-400">Proficient</div>
                            </div>
                            <div class="bg-yellow-100 dark:bg-yellow-900/30 p-3 rounded-lg">
                                <div class="font-bold text-yellow-700 dark:text-yellow-300">${analytics.topicBreakdown.learning.length}</div>
                                <div class="text-gray-600 dark:text-gray-400">Learning</div>
                            </div>
                            <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                                <div class="font-bold text-gray-700 dark:text-gray-300">
                                    ${Object.keys(subject.topics).length - analytics.topicBreakdown.mastered.length -
                                    analytics.topicBreakdown.proficient.length - analytics.topicBreakdown.learning.length}
                                </div>
                                <div class="text-gray-600 dark:text-gray-400">Not Started</div>
                            </div>
                        </div>
                    `;
                }

                container.appendChild(card);
            });

            // Mastery overview
            renderMasteryOverview();
        }

        function renderMasteryOverview() {
            const container = document.getElementById('mastery-overview');
            container.innerHTML = '';

            if (Object.keys(analyticsData.topicMastery).length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-8">Complete some quizzes to see topic mastery data</div>';
                return;
            }

            Object.keys(analyticsData.topicMastery).forEach(topicId => {
                const mastery = analyticsData.topicMastery[topicId];
                const [subjectKey, topicKey] = topicId.split('_');
                const subject = subjects[subjectKey];
                const topic = subject.topics[topicKey];

                const card = document.createElement('div');
                card.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700';

                const trendIcon = {
                    improving: 'üìà',
                    declining: 'üìâ',
                    stable: '‚û°Ô∏è'
                }[mastery.scoreTrend];

                const masteryLevel =
                    mastery.overallScore >= 90 ? { label: 'Mastered', color: 'green' } :
                    mastery.overallScore >= 70 ? { label: 'Proficient', color: 'blue' } :
                    mastery.overallScore >= 50 ? { label: 'Learning', color: 'yellow' } :
                    { label: 'Struggling', color: 'red' };

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold">${subject.icon} ${topic.name}</h4>
                            <p class="text-xs text-gray-600 dark:text-gray-400">${subject.name}</p>
                        </div>
                        <span class="text-xl">${trendIcon}</span>
                    </div>

                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600 dark:text-gray-400">Score</span>
                            <span class="font-semibold">${mastery.overallScore}%</span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-${masteryLevel.color}-500 rounded-full h-2" style="width: ${mastery.overallScore}%"></div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="px-2 py-1 rounded text-xs font-medium bg-${masteryLevel.color}-100 dark:bg-${masteryLevel.color}-900/30 text-${masteryLevel.color}-700 dark:text-${masteryLevel.color}-300">
                            ${masteryLevel.label}
                        </span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${mastery.totalAttempts} attempts</span>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // ============================================
        // INSIGHTS RENDERING
        // ============================================

        function renderInsights() {
            // Engagement score
            const engagementScore = analyticsData.engagementMetrics.engagementScore ||
                (analyticsData.quizSessions.length > 0 ? 50 : 0);
            document.getElementById('engagement-score').textContent = engagementScore;

            // Learning preferences
            renderLearningPreferences();

            // Performance insights
            renderPerformanceInsights();

            // Knowledge gaps
            renderKnowledgeGaps();

            // Recommendations
            renderRecommendations();
        }

        function renderLearningPreferences() {
            const container = document.getElementById('learning-preferences');

            if (analyticsData.quizSessions.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Complete more quizzes to discover your learning preferences</p>';
                return;
            }

            const prefs = analyticsData.engagementMetrics.learningPreferences;
            const avgSessionTime = analyticsData.quizSessions.reduce((a, b) => a + b.duration, 0) /
                analyticsData.quizSessions.length / 60;

            container.innerHTML = `
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Study Intensity</span>
                    <span class="font-medium capitalize">${prefs.studyIntensity}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Avg Session Length</span>
                    <span class="font-medium">${Math.round(avgSessionTime)} minutes</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-200 dark:border-gray-700">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Preferred Difficulty</span>
                    <span class="font-medium capitalize">${prefs.preferredDifficulty}</span>
                </div>
                <div class="flex justify-between py-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Learning Style</span>
                    <span class="font-medium">${analyticsData.learningPatterns.behavioralInsights.learnsBest.replace(/_/g, ' ')}</span>
                </div>
            `;
        }

        function renderPerformanceInsights() {
            const container = document.getElementById('performance-insights');

            if (analyticsData.quizSessions.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Complete more quizzes to see performance insights</p>';
                return;
            }

            const skills = analyticsData.performanceAnalytics.skillDevelopment;
            const efficiency = analyticsData.learningPatterns.efficiencyMetrics;

            container.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600 dark:text-gray-400">Problem Solving</span>
                            <span class="font-semibold">${skills.problemSolving}/100</span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-primary rounded-full h-2" style="width: ${skills.problemSolving}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600 dark:text-gray-400">Speed</span>
                            <span class="font-semibold">${skills.speed}/100</span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-blue-500 rounded-full h-2" style="width: ${skills.speed}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-600 dark:text-gray-400">Understanding</span>
                            <span class="font-semibold">${Math.min(100, skills.conceptualUnderstanding)}/100</span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-green-500 rounded-full h-2" style="width: ${Math.min(100, skills.conceptualUnderstanding)}%"></div>
                        </div>
                    </div>
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700 text-sm">
                        <div class="flex justify-between py-1">
                            <span class="text-gray-600 dark:text-gray-400">Pace</span>
                            <span class="font-medium capitalize">${efficiency.accuracyVsSpeed}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKnowledgeGaps() {
            const container = document.getElementById('knowledge-gaps');
            const gaps = analyticsData.learningPatterns.identifiedGaps;

            if (gaps.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üéØ</div>
                        <p>No significant knowledge gaps identified yet!</p>
                        <p class="text-sm mt-1">Keep practicing to get detailed insights</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            gaps.forEach(gap => {
                const gapCard = document.createElement('div');
                gapCard.className = 'bg-yellow-50 dark:bg-yellow-900/10 border-l-4 border-yellow-500 p-4 rounded';
                gapCard.innerHTML = `
                    <h4 class="font-semibold mb-2 text-yellow-800 dark:text-yellow-300">
                        ${gap.topic.charAt(0).toUpperCase() + gap.topic.slice(1)} (${gap.subject})
                    </h4>
                    <div class="text-sm mb-3">
                        <p class="font-medium mb-1 text-gray-700 dark:text-gray-300">Evidence:</p>
                        <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 space-y-1">
                            ${gap.evidence.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="text-sm">
                        <p class="font-medium mb-1 text-gray-700 dark:text-gray-300">Recommended Actions:</p>
                        <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 space-y-1">
                            ${gap.recommendedActions.map(a => `<li>${a}</li>`).join('')}
                        </ul>
                    </div>
                `;
                container.appendChild(gapCard);
            });
        }

        function renderRecommendations() {
            const container = document.getElementById('recommendations');
            const sessions = analyticsData.quizSessions;

            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Start taking quizzes to get personalized recommendations!</p>';
                return;
            }

            const recommendations = [];

            // Streak recommendation
            const streak = analyticsData.engagementMetrics.sessionPatterns.studyStreak;
            if (streak === 0) {
                recommendations.push({
                    icon: 'üî•',
                    title: 'Start a Study Streak',
                    description: 'Study for 3 consecutive days to build momentum and improve retention'
                });
            } else if (streak >= 7) {
                recommendations.push({
                    icon: '‚≠ê',
                    title: 'Amazing Streak!',
                    description: `You've studied for ${streak} days in a row! Keep it up!`
                });
            }

            // Topic recommendations
            const weakestTopics = Object.keys(analyticsData.topicMastery)
                .map(topicId => ({ topicId, ...analyticsData.topicMastery[topicId] }))
                .filter(t => t.overallScore < 70)
                .sort((a, b) => a.overallScore - b.overallScore)
                .slice(0, 2);

            if (weakestTopics.length > 0) {
                weakestTopics.forEach(topic => {
                    const [subject, topicName] = topic.topicId.split('_');
                    recommendations.push({
                        icon: 'üìö',
                        title: `Focus on ${topicName}`,
                        description: `Current score: ${topic.overallScore}%. Practice more to improve your mastery`
                    });
                });
            }

            // Performance recommendation
            const recentScores = sessions.slice(-5).map(s => s.score);
            const avgRecent = recentScores.reduce((a, b) => a + b, 0) / recentScores.length;

            if (avgRecent >= 85) {
                recommendations.push({
                    icon: 'üöÄ',
                    title: 'Challenge Yourself',
                    description: 'You\'re doing great! Try harder topics or aim for perfect scores'
                });
            } else if (avgRecent < 60) {
                recommendations.push({
                    icon: 'üí™',
                    title: 'Take Your Time',
                    description: 'Focus on understanding concepts rather than speed. Review incorrect answers'
                });
            }

            // Time recommendation
            const avgSessionTime = sessions.reduce((a, b) => a + b.duration, 0) / sessions.length;
            if (avgSessionTime < 300) { // Less than 5 minutes
                recommendations.push({
                    icon: '‚è∞',
                    title: 'Extend Your Sessions',
                    description: 'Longer study sessions can improve focus and retention'
                });
            }

            container.innerHTML = '';
            recommendations.forEach(rec => {
                const div = document.createElement('div');
                div.className = 'flex items-start space-x-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                div.innerHTML = `
                    <div class="text-2xl">${rec.icon}</div>
                    <div>
                        <h4 class="font-semibold">${rec.title}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${rec.description}</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        window.addEventListener('DOMContentLoaded', () => {
            loadAnalytics();
            initializeQuiz();
        });

        // Re-render charts on theme change
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (document.getElementById('content-analytics').classList.contains('hidden') === false) {
                renderAnalytics();
            }
        });
    </script>
</body>
</html>