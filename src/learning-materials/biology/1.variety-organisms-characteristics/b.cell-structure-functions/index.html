<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Quiz Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #5D5CDE;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px #5D5CDE; }
            50% { box-shadow: 0 0 20px #5D5CDE, 0 0 30px #5D5CDE; }
        }
        .correct-answer {
            background: linear-gradient(135deg, #10B981, #059669);
            animation: celebrate 0.6s ease-in-out;
        }
        .wrong-answer {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            animation: shake 0.6s ease-in-out;
        }
        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen transition-colors duration-200">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">🎧 Audio Quiz Master</h1>
            <p class="text-gray-600 dark:text-gray-400">Interactive quiz with natural voice narration</p>
        </div>

        <!-- Voice Settings Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-primary" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                Voice Settings
            </h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label for="voiceSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Narrator Voice
                    </label>
                    <select id="voiceSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="Sarah">Sarah (Female, Warm)</option>
                        <option value="George">George (Male, Professional)</option>
                        <option value="Jessica">Jessica (Female, Clear)</option>
                        <option value="Brian">Brian (Male, Friendly)</option>
                        <option value="Lily">Lily (Female, Youthful)</option>
                        <option value="Will">Will (Male, Energetic)</option>
                        <option value="River">River (Neutral, Calm)</option>
                        <option value="Matilda">Matilda (Female, Elegant)</option>
                    </select>
                </div>
                <div>
                    <label for="speedSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Speech Speed
                    </label>
                    <select id="speedSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="slow">Slow</option>
                        <option value="normal" selected>Normal</option>
                        <option value="fast">Fast</option>
                    </select>
                </div>
            </div>
            <button id="testVoiceBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200 flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                </svg>
                Test Voice
            </button>
        </div>

        <!-- Quiz Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
            <!-- Quiz Header -->
            <div class="bg-gradient-to-r from-primary to-purple-600 p-6 text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">General Knowledge Quiz</h2>
                        <p class="opacity-90">Test your knowledge with audio narration</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm opacity-90">Question</div>
                        <div class="text-2xl font-bold"><span id="currentQuestion">1</span>/<span id="totalQuestions">10</span></div>
                    </div>
                </div>
                <div class="mt-4 bg-white bg-opacity-20 rounded-full h-2">
                    <div id="progressBar" class="bg-white h-2 rounded-full transition-all duration-300" style="width: 10%"></div>
                </div>
            </div>

            <!-- Quiz Content -->
            <div class="p-6">
                <!-- Question Section -->
                <div id="questionSection" class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Question <span id="questionNumber">1</span></h3>
                        <div class="flex gap-2">
                            <button id="readQuestionBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-3 rounded-md transition-colors duration-200 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.369 4.369 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"/>
                                </svg>
                                <span id="readQuestionBtnText">Read Question</span>
                                <div id="readQuestionSpinner" class="loading-spinner hidden"></div>
                            </button>
                            <button id="stopAudioBtn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-3 rounded-md transition-colors duration-200 hidden">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="questionText" class="text-lg text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 border-primary">
                        Loading question...
                    </div>
                </div>

                <!-- Options Section -->
                <div id="optionsSection" class="mb-6">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-3">Choose your answer:</h4>
                    <div id="optionsContainer" class="space-y-3">
                        <!-- Options will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Audio Player (hidden but functional) -->
                <audio id="audioPlayer" class="hidden" controls></audio>

                <!-- Control Buttons -->
                <div id="controlButtons" class="flex flex-wrap gap-3 justify-center">
                    <button id="nextBtn" class="bg-primary hover:bg-primary/90 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium py-3 px-6 rounded-md transition-all duration-200 hidden">
                        Next Question →
                    </button>
                    <button id="restartBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200 hidden">
                        Restart Quiz
                    </button>
                    <button id="finishBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-md transition-colors duration-200 hidden">
                        Finish Quiz
                    </button>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="hidden text-center">
                    <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-6 rounded-lg">
                        <h3 class="text-2xl font-bold mb-2">🎉 Quiz Complete!</h3>
                        <p class="text-xl">Your Score: <span id="finalScore" class="font-bold">0</span>/10</p>
                        <p id="scoreMessage" class="mt-2 opacity-90"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="mt-4 p-3 rounded-md hidden">
            <p id="statusText"></p>
        </div>
    </div>

    <script>
        // Quiz questions database
        const quizQuestions = [
            {
                question: "What is the capital of France?",
                options: ["London", "Berlin", "Paris", "Madrid"],
                correct: 2
            },
            {
                question: "Which planet is known as the Red Planet?",
                options: ["Venus", "Mars", "Jupiter", "Saturn"],
                correct: 1
            },
            {
                question: "What is the largest mammal in the world?",
                options: ["African Elephant", "Blue Whale", "Giraffe", "Hippopotamus"],
                correct: 1
            },
            {
                question: "In what year did World War II end?",
                options: ["1944", "1945", "1946", "1947"],
                correct: 1
            },
            {
                question: "What is the chemical symbol for gold?",
                options: ["Go", "Gd", "Au", "Ag"],
                correct: 2
            },
            {
                question: "Which ocean is the largest?",
                options: ["Atlantic Ocean", "Indian Ocean", "Arctic Ocean", "Pacific Ocean"],
                correct: 3
            },
            {
                question: "Who painted the Mona Lisa?",
                options: ["Vincent van Gogh", "Leonardo da Vinci", "Pablo Picasso", "Michelangelo"],
                correct: 1
            },
            {
                question: "What is the smallest country in the world?",
                options: ["Monaco", "Vatican City", "San Marino", "Liechtenstein"],
                correct: 1
            },
            {
                question: "Which element has the atomic number 1?",
                options: ["Helium", "Hydrogen", "Lithium", "Carbon"],
                correct: 1
            },
            {
                question: "In which continent is the Sahara Desert located?",
                options: ["Asia", "Australia", "Africa", "South America"],
                correct: 2
            }
        ];

        // Speech API Implementation
        class SpeechAPIInterface {
            constructor(config) {
                this.config = config;
            }

            async generateSpeech(text, options = {}) {
                throw new Error('generateSpeech method must be implemented');
            }

            validateConfig() {
                throw new Error('validateConfig method must be implemented');
            }
        }

        class PoeElevenLabsAPI extends SpeechAPIInterface {
            constructor(config = {}) {
                super(config);
                this.handlerName = 'quiz-speech-handler-' + Date.now();
                this.setupHandler();
            }

            validateConfig() {
                return typeof window.Poe !== 'undefined' && window.Poe.sendUserMessage;
            }

            setupHandler() {
                if (typeof window.Poe !== 'undefined') {
                    window.Poe.registerHandler(this.handlerName, (result, context) => {
                        const callback = context.callback;
                        if (callback) {
                            callback(result);
                        }
                    });
                }
            }

            async generateSpeech(text, options = {}) {
                if (!this.validateConfig()) {
                    throw new Error('Poe API not available');
                }

                const voice = options.voice || 'Sarah';
                let prompt = text;

                // Add speech modifications based on speed
                if (options.speed === 'slow') {
                    prompt = `Please speak slowly: ${text}`;
                } else if (options.speed === 'fast') {
                    prompt = `Please speak quickly: ${text}`;
                }

                prompt += ` --voice ${voice}`;

                return new Promise((resolve, reject) => {
                    const callback = (result) => {
                        if (result.status === 'error') {
                            reject(new Error(result.responses[0]?.statusText || 'Speech generation failed'));
                        } else if (result.status === 'complete') {
                            const message = result.responses[0];
                            if (message.attachments && message.attachments.length > 0) {
                                const audioAttachment = message.attachments.find(att => 
                                    att.mimeType.startsWith('audio/') || att.name.includes('.mp3') || att.name.includes('.wav')
                                );
                                if (audioAttachment) {
                                    resolve({ audioUrl: audioAttachment.url, fileName: audioAttachment.name });
                                } else {
                                    reject(new Error('No audio attachment found in response'));
                                }
                            } else {
                                reject(new Error('No audio generated'));
                            }
                        }
                    };

                    window.Poe.sendUserMessage(`@ElevenLabs-v2.5-Turbo ${prompt}`, {
                        handler: this.handlerName,
                        stream: false,
                        openChat: false,
                        handlerContext: { callback }
                    }).catch(error => {
                        reject(new Error(`Failed to send message: ${error.message}`));
                    });
                });
            }
        }

        // Quiz Application Class
        class AudioQuiz {
            constructor() {
                this.speechAPI = new PoeElevenLabsAPI();
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.answered = false;
                this.currentAudio = null;
                
                this.initializeElements();
                this.setupEventListeners();
                this.loadQuestion();
                this.setupDarkMode();
            }

            initializeElements() {
                this.voiceSelect = document.getElementById('voiceSelect');
                this.speedSelect = document.getElementById('speedSelect');
                this.testVoiceBtn = document.getElementById('testVoiceBtn');
                this.questionText = document.getElementById('questionText');
                this.optionsContainer = document.getElementById('optionsContainer');
                this.readQuestionBtn = document.getElementById('readQuestionBtn');
                this.readQuestionBtnText = document.getElementById('readQuestionBtnText');
                this.readQuestionSpinner = document.getElementById('readQuestionSpinner');
                this.stopAudioBtn = document.getElementById('stopAudioBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.restartBtn = document.getElementById('restartBtn');
                this.finishBtn = document.getElementById('finishBtn');
                this.audioPlayer = document.getElementById('audioPlayer');
                this.currentQuestion = document.getElementById('currentQuestion');
                this.totalQuestions = document.getElementById('totalQuestions');
                this.questionNumber = document.getElementById('questionNumber');
                this.progressBar = document.getElementById('progressBar');
                this.resultsSection = document.getElementById('resultsSection');
                this.finalScore = document.getElementById('finalScore');
                this.scoreMessage = document.getElementById('scoreMessage');
                this.statusMessage = document.getElementById('statusMessage');
                this.statusText = document.getElementById('statusText');

                this.totalQuestions.textContent = quizQuestions.length;
            }

            setupEventListeners() {
                this.testVoiceBtn.addEventListener('click', () => this.testVoice());
                this.readQuestionBtn.addEventListener('click', () => this.readCurrentQuestion());
                this.stopAudioBtn.addEventListener('click', () => this.stopAudio());
                this.nextBtn.addEventListener('click', () => this.nextQuestion());
                this.restartBtn.addEventListener('click', () => this.restartQuiz());
                this.finishBtn.addEventListener('click', () => this.finishQuiz());
                
                this.audioPlayer.addEventListener('ended', () => {
                    this.stopAudioBtn.classList.add('hidden');
                    this.readQuestionBtnText.textContent = 'Read Question';
                });
            }

            setupDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }

            async testVoice() {
                const testText = "Hello! This is a test of the selected voice. How does this sound to you?";
                await this.speakText(testText, this.testVoiceBtn);
            }

            async speakText(text, buttonElement = null) {
                try {
                    if (buttonElement) {
                        buttonElement.disabled = true;
                        const spinner = buttonElement.querySelector('.loading-spinner');
                        if (spinner) spinner.classList.remove('hidden');
                    }

                    const voice = this.voiceSelect.value;
                    const speed = this.speedSelect.value;
                    
                    const result = await this.speechAPI.generateSpeech(text, { voice, speed });
                    
                    if (this.currentAudio) {
                        this.currentAudio.pause();
                    }
                    
                    this.audioPlayer.src = result.audioUrl;
                    this.currentAudio = this.audioPlayer;
                    
                    await this.audioPlayer.play();
                    this.stopAudioBtn.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Speech error:', error);
                    this.showStatus(`Speech generation failed: ${error.message}`, 'error');
                } finally {
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        const spinner = buttonElement.querySelector('.loading-spinner');
                        if (spinner) spinner.classList.add('hidden');
                    }
                }
            }

            loadQuestion() {
                const question = quizQuestions[this.currentQuestionIndex];
                this.questionText.textContent = question.question;
                this.questionNumber.textContent = this.currentQuestionIndex + 1;
                this.currentQuestion.textContent = this.currentQuestionIndex + 1;
                
                // Update progress bar
                const progress = ((this.currentQuestionIndex + 1) / quizQuestions.length) * 100;
                this.progressBar.style.width = `${progress}%`;
                
                // Clear previous options
                this.optionsContainer.innerHTML = '';
                
                // Create option buttons
                question.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-4 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 bg-white dark:bg-gray-700 text-gray-900 dark:text-white';
                    button.innerHTML = `
                        <div class="flex items-center">
                            <span class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-medium mr-3">
                                ${String.fromCharCode(65 + index)}
                            </span>
                            <span class="text-base">${option}</span>
                        </div>
                    `;
                    
                    button.addEventListener('click', () => this.selectAnswer(index, button));
                    this.optionsContainer.appendChild(button);
                });
                
                this.answered = false;
                this.nextBtn.classList.add('hidden');
                this.finishBtn.classList.add('hidden');
            }

            async readCurrentQuestion() {
                const question = quizQuestions[this.currentQuestionIndex];
                const optionsText = question.options.map((option, index) => 
                    `Option ${String.fromCharCode(65 + index)}: ${option}`
                ).join('. ');
                
                const fullText = `Question ${this.currentQuestionIndex + 1}: ${question.question}. The options are: ${optionsText}`;
                
                this.readQuestionBtnText.textContent = 'Reading...';
                this.readQuestionSpinner.classList.remove('hidden');
                
                await this.speakText(fullText);
                
                this.readQuestionBtnText.textContent = 'Read Question';
                this.readQuestionSpinner.classList.add('hidden');
            }

            selectAnswer(selectedIndex, buttonElement) {
                if (this.answered) return;
                
                this.answered = true;
                const question = quizQuestions[this.currentQuestionIndex];
                const isCorrect = selectedIndex === question.correct;
                
                if (isCorrect) {
                    this.score++;
                    buttonElement.classList.add('correct-answer');
                    this.showStatus('Correct! Well done! 🎉', 'success');
                } else {
                    buttonElement.classList.add('wrong-answer');
                    // Show correct answer
                    const correctButton = this.optionsContainer.children[question.correct];
                    correctButton.classList.add('correct-answer');
                    this.showStatus(`Incorrect. The correct answer was: ${question.options[question.correct]}`, 'error');
                }
                
                // Disable all option buttons
                Array.from(this.optionsContainer.children).forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed', 'opacity-75');
                });
                
                // Show appropriate next button
                if (this.currentQuestionIndex < quizQuestions.length - 1) {
                    this.nextBtn.classList.remove('hidden');
                } else {
                    this.finishBtn.classList.remove('hidden');
                }
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.loadQuestion();
                this.hideStatus();
            }

            finishQuiz() {
                this.showResults();
            }

            showResults() {
                document.getElementById('questionSection').classList.add('hidden');
                document.getElementById('optionsSection').classList.add('hidden');
                document.getElementById('controlButtons').classList.add('hidden');
                
                this.finalScore.textContent = this.score;
                
                let message = '';
                const percentage = (this.score / quizQuestions.length) * 100;
                
                if (percentage >= 90) {
                    message = 'Outstanding! You\'re a quiz master! 🏆';
                } else if (percentage >= 70) {
                    message = 'Great job! You know your stuff! 👏';
                } else if (percentage >= 50) {
                    message = 'Not bad! Keep learning! 📚';
                } else {
                    message = 'Keep practicing! You\'ll improve! 💪';
                }
                
                this.scoreMessage.textContent = message;
                this.resultsSection.classList.remove('hidden');
                this.restartBtn.classList.remove('hidden');
            }

            restartQuiz() {
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.answered = false;
                
                document.getElementById('questionSection').classList.remove('hidden');
                document.getElementById('optionsSection').classList.remove('hidden');
                document.getElementById('controlButtons').classList.remove('hidden');
                this.resultsSection.classList.add('hidden');
                this.restartBtn.classList.add('hidden');
                
                this.loadQuestion();
                this.hideStatus();
            }

            stopAudio() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                }
                this.stopAudioBtn.classList.add('hidden');
                this.readQuestionBtnText.textContent = 'Read Question';
            }

            showStatus(message, type) {
                this.statusText.textContent = message;
                this.statusMessage.className = `mt-4 p-3 rounded-md ${
                    type === 'success' ? 'bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700' :
                    type === 'error' ? 'bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-700' :
                    'bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border border-blue-300 dark:border-blue-700'
                }`;
                this.statusMessage.classList.remove('hidden');
                
                if (type === 'success') {
                    setTimeout(() => this.hideStatus(), 3000);
                }
            }

            hideStatus() {
                this.statusMessage.classList.add('hidden');
            }
        }

        // Initialize the quiz when the page loads
        let quiz;
        if (typeof window.Poe !== 'undefined') {
            quiz = new AudioQuiz();
        } else {
            // Show a message if Poe API is not available
            setTimeout(() => {
                document.getElementById('statusText').textContent = 'This quiz requires the Poe environment. Please run it in a Poe Canvas app.';
                document.getElementById('statusMessage').className = 'mt-4 p-3 rounded-md bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-700';
                document.getElementById('statusMessage').classList.remove('hidden');
            }, 1000);
        }
    </script>
</body>
</html>
