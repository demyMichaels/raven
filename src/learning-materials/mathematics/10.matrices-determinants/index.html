<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Treasure Hunt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        treasure: '#FFD700',
                    }
                }
            }
        }
        
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-8 max-w-6xl">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-center mb-2 text-primary dark:text-primary">Matrix Treasure Hunt</h1>
        <p class="text-center mb-4 sm:mb-6 text-sm sm:text-base text-gray-600 dark:text-gray-400">Discover the secrets of determinants through adventure!</p>
        
        <div class="game-content flex flex-col lg:flex-row gap-4 lg:gap-6">
            <!-- Left side: Game controls -->
            <div class="w-full lg:w-1/2 bg-white dark:bg-gray-800 p-3 sm:p-4 rounded-lg shadow-md">
                <div class="tabs flex border-b border-gray-300 dark:border-gray-600 mb-4 -mx-1">
                    <button id="tab-learn" class="tab-btn flex-1 px-2 sm:px-4 py-2 font-medium text-primary border-b-2 border-primary text-sm sm:text-base">Learn</button>
                    <button id="tab-play" class="tab-btn flex-1 px-2 sm:px-4 py-2 font-medium text-gray-500 dark:text-gray-400 text-sm sm:text-base">Play</button>
                    <button id="tab-challenge" class="tab-btn flex-1 px-2 sm:px-4 py-2 font-medium text-gray-500 dark:text-gray-400 text-sm sm:text-base">Challenge</button>
                </div>
                
                <div id="learn-content" class="tab-content">
                    <h2 class="text-lg sm:text-xl font-bold mb-3">Treasure Hunt Adventure</h2>
                    <p class="mb-4 text-sm sm:text-base">Imagine you're on a treasure hunt where three treasures are hidden on a map. Each treasure's location is represented by coordinates (x, y) in a matrix:</p>
                    
                    <div class="mb-4 p-3 sm:p-4 bg-gray-100 dark:bg-gray-700 rounded-lg overflow-x-auto">
                        <div class="matrix-display flex flex-col items-center min-w-fit">
                            <div class="flex items-center">
                                <div class="matrix-bracket text-xl sm:text-2xl mr-1 sm:mr-2">[</div>
                                <div class="matrix-content">
                                    <div class="matrix-row flex">
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">x₁</div>
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">y₁</div>
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">1</div>
                                    </div>
                                    <div class="matrix-row flex">
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">x₂</div>
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">y₂</div>
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">1</div>
                                    </div>
                                    <div class="matrix-row flex">
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">x₃</div>
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">y₃</div>
                                        <div class="matrix-cell w-8 sm:w-10 h-8 sm:h-10 flex items-center justify-center text-sm sm:text-base">1</div>
                                    </div>
                                </div>
                                <div class="matrix-bracket text-xl sm:text-2xl ml-1 sm:ml-2">]</div>
                            </div>
                        </div>
                    </div>
                    
                    <p class="mb-4 text-sm sm:text-base">The <span class="font-bold text-primary">determinant</span> of this matrix tells us something important:</p>
                    <ul class="list-disc pl-4 sm:pl-6 mb-4 space-y-2 text-sm sm:text-base">
                        <li>If the determinant is <span class="font-bold">non-zero</span>, the treasures form a triangle with area = |det|/2</li>
                        <li>If the determinant is <span class="font-bold">zero</span>, the treasures are on a straight line (collinear)</li>
                    </ul>
                    
                    <p class="mb-4 text-sm sm:text-base">Use the interactive map on the right to place treasures and see how the determinant changes!</p>
                    
                    <button id="start-game" class="w-full sm:w-auto px-6 py-3 bg-primary hover:bg-opacity-90 text-white rounded-md transition-all text-base font-medium">Start Playing</button>
                </div>
                
                <div id="play-content" class="tab-content hidden">
                    <h2 class="text-lg sm:text-xl font-bold mb-3">Place Your Treasures</h2>
                    <p class="mb-4 text-sm sm:text-base">Click on the map to place 3 treasure markers. Watch how the determinant changes!</p>
                    
                    <div class="matrix-container mb-6">
                        <h3 class="font-medium mb-3 text-sm sm:text-base">Treasure Coordinates Matrix:</h3>
                        <div class="overflow-x-auto">
                            <div class="flex items-center justify-center min-w-fit">
                                <div class="matrix-bracket text-xl sm:text-2xl mr-1 sm:mr-2">[</div>
                                <div>
                                    <div class="flex gap-1 sm:gap-2 mb-1">
                                        <input type="number" id="m00" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="0" disabled>
                                        <input type="number" id="m01" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="0" disabled>
                                        <input type="number" id="m02" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="1" disabled>
                                    </div>
                                    <div class="flex gap-1 sm:gap-2 mb-1">
                                        <input type="number" id="m10" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="0" disabled>
                                        <input type="number" id="m11" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="0" disabled>
                                        <input type="number" id="m12" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="1" disabled>
                                    </div>
                                    <div class="flex gap-1 sm:gap-2">
                                        <input type="number" id="m20" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="0" disabled>
                                        <input type="number" id="m21" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="0" disabled>
                                        <input type="number" id="m22" class="matrix-input w-16 sm:w-20 h-12 sm:h-14 text-center border dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" value="1" disabled>
                                    </div>
                                </div>
                                <div class="matrix-bracket text-xl sm:text-2xl ml-1 sm:ml-2">]</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="determinant-display p-3 sm:p-4 bg-gray-100 dark:bg-gray-700 rounded-lg mb-4">
                        <h3 class="font-medium mb-2 text-sm sm:text-base">Determinant:</h3>
                        <div id="determinant-value" class="text-xl sm:text-2xl font-bold text-center">0</div>
                        <div id="determinant-message" class="text-center mt-2 italic text-sm sm:text-base">Place 3 treasures to calculate</div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="reset-game" class="flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-md transition-all text-base font-medium">Reset Treasures</button>
                        <button id="next-level" class="flex-1 px-4 py-3 bg-primary hover:bg-opacity-90 text-white rounded-md transition-all hidden text-base font-medium">Try a Challenge</button>
                    </div>
                </div>
                
                <div id="challenge-content" class="tab-content hidden">
                    <h2 class="text-lg sm:text-xl font-bold mb-3">Treasure Hunter Challenge</h2>
                    <p class="mb-4 text-sm sm:text-base">Complete these challenges to become a master treasure hunter!</p>
                    
                    <div id="challenge-instructions" class="p-3 sm:p-4 bg-yellow-100 dark:bg-yellow-900 rounded-lg mb-4">
                        <h3 class="font-medium text-sm sm:text-base">Current Challenge:</h3>
                        <p id="challenge-text" class="mt-2 text-sm sm:text-base">Place 3 treasures to form a triangle with an area of exactly 25 square units.</p>
                    </div>
                    
                    <div class="determinant-challenge p-3 sm:p-4 bg-gray-100 dark:bg-gray-700 rounded-lg mb-4">
                        <h3 class="font-medium mb-2 text-sm sm:text-base">Current Determinant:</h3>
                        <div id="challenge-determinant" class="text-xl sm:text-2xl font-bold text-center">0</div>
                        <div id="challenge-area" class="text-center mt-1 text-sm sm:text-base">Area: 0 square units</div>
                        <div id="challenge-status" class="text-center mt-3 font-medium text-sm sm:text-base">Not completed yet</div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="reset-challenge" class="flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-md transition-all text-base font-medium">Reset</button>
                        <button id="next-challenge" class="flex-1 px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-md transition-all hidden text-base font-medium">Next Challenge</button>
                    </div>
                </div>
            </div>
            
            <!-- Right side: Interactive map -->
            <div class="w-full lg:w-1/2 bg-white dark:bg-gray-800 p-3 sm:p-4 rounded-lg shadow-md">
                <h2 class="text-lg sm:text-xl font-bold mb-3 text-center">Treasure Map</h2>
                <div class="treasure-map-container relative w-full aspect-square border-2 border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden shadow-lg">
                    <canvas id="treasureMap" class="w-full h-full bg-gradient-to-br from-amber-50 to-yellow-100 dark:from-amber-900 dark:to-yellow-800 cursor-crosshair touch-manipulation"></canvas>
                    <div class="coordinate-display absolute bottom-1 sm:bottom-2 right-1 sm:right-2 bg-white dark:bg-gray-800 px-2 sm:px-3 py-1 sm:py-2 rounded-md shadow-md text-xs sm:text-sm font-medium" id="coordinates">X: 0, Y: 0</div>
                </div>
                <div class="mt-3 sm:mt-4 text-center text-xs sm:text-sm text-gray-600 dark:text-gray-400">
                    Click/tap to place treasures (max 3)
                </div>
            </div>
        </div>
        
        <div class="mt-6 sm:mt-8 text-center text-xs sm:text-sm text-gray-600 dark:text-gray-400">
            Matrix Treasure Hunt - Learn how to calculate determinants through adventure!
        </div>
    </div>
    
    <script>
        // DOM elements
        const tabLearn = document.getElementById('tab-learn');
        const tabPlay = document.getElementById('tab-play');
        const tabChallenge = document.getElementById('tab-challenge');
        const learnContent = document.getElementById('learn-content');
        const playContent = document.getElementById('play-content');
        const challengeContent = document.getElementById('challenge-content');
        const startGameBtn = document.getElementById('start-game');
        const resetGameBtn = document.getElementById('reset-game');
        const nextLevelBtn = document.getElementById('next-level');
        const treasureMap = document.getElementById('treasureMap');
        const coordinatesDisplay = document.getElementById('coordinates');
        const determinantValue = document.getElementById('determinant-value');
        const determinantMessage = document.getElementById('determinant-message');
        const nextChallengeBtn = document.getElementById('next-challenge');
        const resetChallengeBtn = document.getElementById('reset-challenge');
        const challengeText = document.getElementById('challenge-text');
        const challengeDeterminant = document.getElementById('challenge-determinant');
        const challengeArea = document.getElementById('challenge-area');
        const challengeStatus = document.getElementById('challenge-status');
        
        // Game state
        let treasures = [];
        let currentTab = 'learn';
        let currentChallengeIndex = 0;
        
        // Matrix input elements
        const matrixInputs = [
            [document.getElementById('m00'), document.getElementById('m01'), document.getElementById('m02')],
            [document.getElementById('m10'), document.getElementById('m11'), document.getElementById('m12')],
            [document.getElementById('m20'), document.getElementById('m21'), document.getElementById('m22')]
        ];
        
        // Challenge data
        const challenges = [
            { 
                text: "Place 3 treasures to form a triangle with an area of exactly 25 square units.",
                targetDeterminant: 50,
                tolerance: 2
            },
            { 
                text: "Place 3 treasures in a straight line (collinear points).",
                targetDeterminant: 0,
                tolerance: 0
            },
            { 
                text: "Place 3 treasures to form a triangle with an area of exactly 36 square units.",
                targetDeterminant: 72,
                tolerance: 2
            }
        ];
        
        // Set up the canvas
        const ctx = treasureMap.getContext('2d');
        let mapSize = treasureMap.width = treasureMap.height = treasureMap.offsetWidth;
        
        // Event listeners for tab switching
        tabLearn.addEventListener('click', () => switchTab('learn'));
        tabPlay.addEventListener('click', () => switchTab('play'));
        tabChallenge.addEventListener('click', () => switchTab('challenge'));
        
        // Start game button
        startGameBtn.addEventListener('click', () => switchTab('play'));
        
        // Reset game button
        resetGameBtn.addEventListener('click', resetGame);
        
        // Next level button
        nextLevelBtn.addEventListener('click', () => switchTab('challenge'));
        
        // Challenge buttons
        resetChallengeBtn.addEventListener('click', resetGame);
        nextChallengeBtn.addEventListener('click', nextChallenge);
        
        // Map click/touch events
        treasureMap.addEventListener('click', handleMapInteraction);
        treasureMap.addEventListener('touchend', handleMapInteraction);
        
        // Mouse move and touch move to show coordinates
        treasureMap.addEventListener('mousemove', updateCoordinates);
        treasureMap.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Prevent scrolling
            updateCoordinates(e.touches[0]);
        });
        
        // Window resize
        window.addEventListener('resize', () => {
            mapSize = treasureMap.width = treasureMap.height = treasureMap.offsetWidth;
            drawMap();
        });
        
        // Initialize
        init();
        
        function init() {
            drawMap();
            updateDeterminant();
            updateChallengeDisplay();
        }
        
        function switchTab(tab) {
            // Update active tab
            currentTab = tab;
            
            // Update tab buttons
            tabLearn.classList.remove('text-primary', 'border-primary', 'text-gray-500', 'dark:text-gray-400', 'border-b-2');
            tabPlay.classList.remove('text-primary', 'border-primary', 'text-gray-500', 'dark:text-gray-400', 'border-b-2');
            tabChallenge.classList.remove('text-primary', 'border-primary', 'text-gray-500', 'dark:text-gray-400', 'border-b-2');
            
            tabLearn.classList.add(tab === 'learn' ? 'text-primary' : 'text-gray-500', 'dark:text-gray-400');
            tabPlay.classList.add(tab === 'play' ? 'text-primary' : 'text-gray-500', 'dark:text-gray-400');
            tabChallenge.classList.add(tab === 'challenge' ? 'text-primary' : 'text-gray-500', 'dark:text-gray-400');
            
            if (tab === 'learn') {
                tabLearn.classList.add('border-b-2', 'border-primary');
            } else if (tab === 'play') {
                tabPlay.classList.add('border-b-2', 'border-primary');
            } else if (tab === 'challenge') {
                tabChallenge.classList.add('border-b-2', 'border-primary');
            }
            
            // Show/hide content
            learnContent.classList.toggle('hidden', tab !== 'learn');
            playContent.classList.toggle('hidden', tab !== 'play');
            challengeContent.classList.toggle('hidden', tab !== 'challenge');
            
            // Reset game if needed
            if (tab === 'challenge') {
                resetGame();
                updateChallengeDisplay();
            }
            
            // Redraw map
            drawMap();
        }
        
        function handleMapInteraction(e) {
            e.preventDefault(); // Prevent default touch/click behavior
            
            if (treasures.length >= 3) return;
            
            const rect = treasureMap.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.type === 'touchend') {
                if (e.changedTouches.length > 0) {
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else {
                    return;
                }
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const x = Math.floor((clientX - rect.left) / rect.width * 20) - 10;
            const y = Math.floor(20 - (clientY - rect.top) / rect.height * 20) - 10;
            
            // Add treasure at clicked position with animation
            const newTreasure = { x, y };
            treasures.push(newTreasure);
            
            // Show click animation
            const clickX = (x + 10) / 20 * mapSize;
            const clickY = mapSize - (y + 10) / 20 * mapSize;
            
            // Create ripple effect
            ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
            let radius = 5;
            const maxRadius = 40;
            let expandRipple = setInterval(() => {
                // Redraw the map to clear previous ripple
                drawMap();
                
                // Draw expanding circle
                ctx.beginPath();
                ctx.arc(clickX, clickY, radius, 0, Math.PI * 2);
                ctx.fill();
                
                radius += 3;
                if (radius > maxRadius) {
                    clearInterval(expandRipple);
                    drawMap(); // Final redraw without the ripple
                }
            }, 30);
            
            // Update matrix
            updateMatrix();
            
            // Check if we have 3 treasures
            if (treasures.length === 3) {
                // Show next level button in play mode
                if (currentTab === 'play') {
                    nextLevelBtn.classList.remove('hidden');
                }
                
                // Check challenge in challenge mode
                if (currentTab === 'challenge') {
                    checkChallenge();
                }
            }
        }
        
        function updateCoordinates(e) {
            const rect = treasureMap.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / rect.width * 20) - 10;
            const y = Math.floor(20 - (e.clientY - rect.top) / rect.height * 20) - 10;
            coordinatesDisplay.textContent = `X: ${x}, Y: ${y}`;
        }
        
        function updateMatrix() {
            // Reset matrix inputs (only the first two columns)
            for (let i = 0; i < 3; i++) {
                matrixInputs[i][0].value = 0;
                matrixInputs[i][1].value = 0;
            }
            
            // Update matrix with treasure coordinates
            treasures.forEach((treasure, index) => {
                if (index < 3) {
                    matrixInputs[index][0].value = treasure.x;
                    matrixInputs[index][1].value = treasure.y;
                }
            });
            
            // Calculate determinant
            updateDeterminant();
        }
        
        function updateDeterminant() {
            if (treasures.length < 3) {
                determinantValue.textContent = "0";
                determinantMessage.textContent = `Place ${3 - treasures.length} more treasure${treasures.length === 2 ? '' : 's'} to calculate`;
                challengeDeterminant.textContent = "0";
                challengeArea.textContent = "Area: 0 square units";
                return;
            }
            
            // Build matrix for determinant calculation
            const matrix = [
                [treasures[0].x, treasures[0].y, 1],
                [treasures[1].x, treasures[1].y, 1],
                [treasures[2].x, treasures[2].y, 1]
            ];
            
            // Calculate determinant
            const det = math.det(matrix);
            const roundedDet = Math.round(det * 100) / 100;
            
            // Update display
            determinantValue.textContent = roundedDet;
            challengeDeterminant.textContent = roundedDet;
            challengeArea.textContent = `Area: ${Math.abs(roundedDet) / 2} square units`;
            
            if (roundedDet === 0) {
                determinantMessage.textContent = "The treasures are collinear (on a straight line)!";
            } else {
                determinantMessage.textContent = `The treasures form a triangle with area ${Math.abs(roundedDet) / 2} square units.`;
            }
        }
        
        function drawMap() {
            ctx.clearRect(0, 0, mapSize, mapSize);
            
            // Draw map background with old map texture
            const isDarkMode = document.documentElement.classList.contains('dark');
            
            // Create treasure map background
            const bgGradient = ctx.createLinearGradient(0, 0, mapSize, mapSize);
            if (isDarkMode) {
                bgGradient.addColorStop(0, '#8B4513');  // Dark brown 
                bgGradient.addColorStop(1, '#A0522D');  // Sienna brown
            } else {
                bgGradient.addColorStop(0, '#F5DEB3');  // Wheat
                bgGradient.addColorStop(1, '#DEB887');  // Burlywood
            }
            
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, mapSize, mapSize);
            
            // Add texture to the map (subtle grid pattern)
            ctx.strokeStyle = isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';
            ctx.lineWidth = 0.5;
            
            // Create grid pattern for map texture
            const gridSize = mapSize / 40;
            for (let i = 0; i <= 40; i++) {
                const pos = i * gridSize;
                
                ctx.beginPath();
                ctx.moveTo(pos, 0);
                ctx.lineTo(pos, mapSize);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, pos);
                ctx.lineTo(mapSize, pos);
                ctx.stroke();
            }
            
            // Draw main grid
            ctx.strokeStyle = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.2)';
            ctx.lineWidth = 1;
            
            // Draw grid lines (every 5 units for less clutter)
            for (let i = 0; i <= 20; i += 1) {
                if (i % 5 === 0) {
                    ctx.lineWidth = 0.5;
                } else {
                    ctx.lineWidth = 0.25;
                }
        
                const pos = (i / 20) * mapSize;
                
                // Vertical line
                ctx.beginPath();
                ctx.moveTo(pos, 0);
                ctx.lineTo(pos, mapSize);
                ctx.stroke();
                
                // Horizontal line
                ctx.beginPath();
                ctx.moveTo(0, pos);
                ctx.lineTo(mapSize, pos);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = isDarkMode ? '#E5E7EB' : '#000000';
            ctx.lineWidth = 3;
            
            // X axis
            const yAxisPos = mapSize - mapSize / 20 * 10;
            ctx.beginPath();
            ctx.moveTo(0, yAxisPos);
            ctx.lineTo(mapSize, yAxisPos);
            ctx.stroke();
            
            // Y axis
            const xAxisPos = mapSize / 20 * 10;
            ctx.beginPath();
            ctx.moveTo(xAxisPos, 0);
            ctx.lineTo(xAxisPos, mapSize);
            ctx.stroke();
            
            // Draw arrows at the ends of axes
            // X-axis arrow
            ctx.beginPath();
            ctx.moveTo(mapSize - 15, yAxisPos - 8);
            ctx.lineTo(mapSize, yAxisPos);
            ctx.lineTo(mapSize - 15, yAxisPos + 8);
            ctx.fill();
            
            // Y-axis arrow
            ctx.beginPath();
            ctx.moveTo(xAxisPos - 8, 15);
            ctx.lineTo(xAxisPos, 0);
            ctx.lineTo(xAxisPos + 8, 15);
            ctx.fill();
            
            // Draw axis labels with improved visibility
            ctx.fillStyle = isDarkMode ? '#FFFFFF' : '#000000';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // X-axis label
            ctx.fillText("X", mapSize - 15, yAxisPos - 20);
            
            // Y-axis label
            ctx.fillText("Y", xAxisPos - 20, 15);
            
            // X axis numbers
            for (let i = 0; i <= 20; i += 5) {
                if (i === 10) continue; // Skip 0 at origin
                const xPos = (i / 20) * mapSize;
                const value = i - 10;
                
                // Draw tick mark
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(xPos, yAxisPos - 5);
                ctx.lineTo(xPos, yAxisPos + 5);
                ctx.stroke();
                
                // Draw value with background for better legibility
                const txtWidth = ctx.measureText(value.toString()).width;
                ctx.fillStyle = isDarkMode ? 'rgba(0, 0, 0, 0.6)' : 'rgba(255, 255, 255, 0.8)';
                ctx.fillRect(xPos - txtWidth/2 - 3, yAxisPos + 8, txtWidth + 6, 20);
                
                ctx.fillStyle = isDarkMode ? '#FFFFFF' : '#000000';
                ctx.fillText(value.toString(), xPos, yAxisPos + 18);
            }
            
            // Y axis numbers
            for (let i = 0; i <= 20; i += 5) {
                if (i === 10) continue; // Skip 0 at origin
                const yPos = mapSize - (i / 20) * mapSize;
                const value = i - 10;
                
                // Draw tick mark
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(xAxisPos - 5, yPos);
                ctx.lineTo(xAxisPos + 5, yPos);
                ctx.stroke();
                
                // Draw value with background for better legibility
                const txtWidth = ctx.measureText(value.toString()).width;
                ctx.fillStyle = isDarkMode ? 'rgba(0, 0, 0, 0.6)' : 'rgba(255, 255, 255, 0.8)';
                ctx.fillRect(xAxisPos - 25 - txtWidth/2, yPos - 10, txtWidth + 6, 20);
                
                ctx.fillStyle = isDarkMode ? '#FFFFFF' : '#000000';
                ctx.fillText(value.toString(), xAxisPos - 22, yPos);
            }
            
            // Draw origin (0,0)
            ctx.fillStyle = isDarkMode ? 'rgba(0, 0, 0, 0.6)' : 'rgba(255, 255, 255, 0.8)';
            ctx.fillRect(xAxisPos - 18, yAxisPos + 8, 25, 20);
            
            ctx.fillStyle = isDarkMode ? '#FFFFFF' : '#000000';
            ctx.fillText("0", xAxisPos - 5, yAxisPos + 18);
            
            // Draw connecting lines between treasures
            if (treasures.length >= 2) {
                const points = treasures.map(t => ({
                    x: (t.x + 10) / 20 * mapSize,
                    y: mapSize - (t.y + 10) / 20 * mapSize
                }));
                
                // Draw line between first and second point
                ctx.strokeStyle = '#FF6B6B';
                ctx.lineWidth = 3;
                ctx.setLineDash([]);
                
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                ctx.lineTo(points[1].x, points[1].y);
                ctx.stroke();
                
                // Add distance text
                const dx = treasures[1].x - treasures[0].x;
                const dy = treasures[1].y - treasures[0].y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                const midX = (points[0].x + points[1].x) / 2;
                const midY = (points[0].y + points[1].y) / 2;
                
                ctx.fillStyle = isDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)';
                const distText = distance.toFixed(1);
                const distWidth = ctx.measureText(distText).width;
                ctx.fillRect(midX - distWidth/2 - 5, midY - 10, distWidth + 10, 20);
                
                ctx.fillStyle = '#FF6B6B';
                ctx.fillText(distText, midX, midY);
                
                // If we have 3 points, draw the triangle
                if (treasures.length === 3) {
                    // Draw line from second to third point
                    ctx.beginPath();
                    ctx.moveTo(points[1].x, points[1].y);
                    ctx.lineTo(points[2].x, points[2].y);
                    ctx.stroke();
                    
                    // Draw line from third to first point
                    ctx.beginPath();
                    ctx.moveTo(points[2].x, points[2].y);
                    ctx.lineTo(points[0].x, points[0].y);
                    ctx.stroke();
                    
                    // Fill triangle with semi-transparent color
                    ctx.beginPath();
                    ctx.moveTo(points[0].x, points[0].y);
                    ctx.lineTo(points[1].x, points[1].y);
                    ctx.lineTo(points[2].x, points[2].y);
                    ctx.closePath();
                    
                    // Check if determinant is 0 (collinear)
                    const matrix = [
                        [treasures[0].x, treasures[0].y, 1],
                        [treasures[1].x, treasures[1].y, 1],
                        [treasures[2].x, treasures[2].y, 1]
                    ];
                    const det = math.det(matrix);
                    
                    if (Math.abs(det) < 0.001) {
                        // Collinear points - show a dashed line
                        ctx.setLineDash([5, 5]);
                        ctx.strokeStyle = '#FF0000';
                        ctx.stroke();
                    } else {
                        // Non-collinear - fill with semi-transparent color
                        ctx.fillStyle = 'rgba(93, 92, 222, 0.3)';
                        ctx.fill();
                        
                        // Add area label
                        const area = Math.abs(det) / 2;
                        const centroidX = (points[0].x + points[1].x + points[2].x) / 3;
                        const centroidY = (points[0].y + points[1].y + points[2].y) / 3;
                        
                        ctx.fillStyle = isDarkMode ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.9)';
                        const areaText = `Area: ${area.toFixed(1)}`;
                        const areaWidth = ctx.measureText(areaText).width;
                        ctx.fillRect(centroidX - areaWidth/2 - 5, centroidY - 10, areaWidth + 10, 20);
                        
                        ctx.fillStyle = '#5D5CDE';
                        ctx.fillText(areaText, centroidX, centroidY);
                    }
                }
            }
            
            // Draw treasures (on top of everything else)
            treasures.forEach((treasure, index) => {
                const xPos = (treasure.x + 10) / 20 * mapSize;
                const yPos = mapSize - (treasure.y + 10) / 20 * mapSize;
                
                // Draw highlight glow effect
                const gradient = ctx.createRadialGradient(xPos, yPos, 5, xPos, yPos, 20);
                gradient.addColorStop(0, 'rgba(255, 215, 0, 0.8)');
                gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(xPos, yPos, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw treasure chest icon
                ctx.fillStyle = '#CD7F32'; // Bronze color
                ctx.beginPath();
                ctx.arc(xPos, yPos, 12, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw golden center
                ctx.fillStyle = '#FFD700'; // Gold color
                ctx.beginPath();
                ctx.arc(xPos, yPos, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw dark border
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(xPos, yPos, 12, 0, Math.PI * 2);
                ctx.stroke();
                
                // Draw treasure label with improved visibility
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px sans-serif';
                ctx.fillText(String.fromCharCode(65 + index), xPos, yPos);
                
                // Draw coordinate label
                ctx.fillStyle = isDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.9)';
                const coordText = `(${treasure.x}, ${treasure.y})`;
                const textWidth = ctx.measureText(coordText).width;
                ctx.fillRect(xPos - textWidth/2 - 3, yPos + 20, textWidth + 6, 18);
                
                ctx.fillStyle = isDarkMode ? '#FFFFFF' : '#000000';
                ctx.font = '12px sans-serif';
                ctx.fillText(coordText, xPos, yPos + 29);
            });
        }
        
        
        function resetGame() {
            treasures = [];
            updateMatrix();
            drawMap();
            nextLevelBtn.classList.add('hidden');
            nextChallengeBtn.classList.add('hidden');
        }
        
        function updateChallengeDisplay() {
            const challenge = challenges[currentChallengeIndex];
            challengeText.textContent = challenge.text;
            challengeStatus.textContent = "Not completed yet";
            challengeStatus.classList.remove('text-green-500', 'text-red-500');
        }
        
        function checkChallenge() {
            const det = math.det([
                [treasures[0].x, treasures[0].y, 1],
                [treasures[1].x, treasures[1].y, 1],
                [treasures[2].x, treasures[2].y, 1]
            ]);
            
            const challenge = challenges[currentChallengeIndex];
            const diff = Math.abs(Math.abs(det) - Math.abs(challenge.targetDeterminant));
            
            if (diff <= challenge.tolerance) {
                // Challenge passed
                challengeStatus.textContent = "Challenge completed! 🎉";
                challengeStatus.classList.add('text-green-500');
                challengeStatus.classList.remove('text-red-500');
                nextChallengeBtn.classList.remove('hidden');
            } else {
                // Challenge failed
                challengeStatus.textContent = "Not quite right, try again!";
                challengeStatus.classList.add('text-red-500');
                challengeStatus.classList.remove('text-green-500');
            }
        }
        
        function nextChallenge() {
            currentChallengeIndex = (currentChallengeIndex + 1) % challenges.length;
            resetGame();
            updateChallengeDisplay();
            nextChallengeBtn.classList.add('hidden');
        }
    </script>
</body>
</html>
