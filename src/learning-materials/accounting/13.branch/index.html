<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Accounting Detective</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4A5568',
                    }
                }
            },
            darkMode: 'class',
        }
    </script>
    <style>
        .cell-input {
            border: 1px solid transparent;
            background-color: rgba(93, 92, 222, 0.1);
            transition: all 0.3s;
        }
        .cell-input:focus {
            outline: none;
            border: 1px solid #5D5CDE;
            background-color: rgba(93, 92, 222, 0.2);
        }
        .correct {
            background-color: rgba(72, 187, 120, 0.2);
        }
        .incorrect {
            background-color: rgba(245, 101, 101, 0.2);
        }
        .dark .cell-input {
            background-color: rgba(93, 92, 222, 0.3);
        }
        .dark .cell-input:focus {
            background-color: rgba(93, 92, 222, 0.4);
        }
        .dark .correct {
            background-color: rgba(72, 187, 120, 0.4);
        }
        .dark .incorrect {
            background-color: rgba(245, 101, 101, 0.4);
        }
        table {
            border-collapse: collapse;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- Check dark mode preference -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-primary mb-2">Branch Accounting Detective</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">Solve accounting mysteries and master branch accounting concepts</p>
        </header>

        <div class="flex flex-col md:flex-row gap-6 mb-6">
            <!-- Game controls -->
            <div class="w-full md:w-1/4 bg-gray-100 dark:bg-gray-800 rounded-lg p-4 shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-primary">Control Panel</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Select Challenge:</label>
                    <select id="challenge-selector" class="w-full p-2 rounded bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-base">
                        <option value="missing-values">Find Missing Values</option>
                        <option value="identify-errors">Identify Errors</option>
                        <option value="reconciliation">Head Office & Branch Reconciliation</option>
                        <option value="custom-case">Create Your Own Case</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Difficulty:</label>
                    <div class="flex space-x-2">
                        <button class="difficulty-btn bg-green-500 text-white py-1 px-3 rounded active" data-level="beginner">Beginner</button>
                        <button class="difficulty-btn bg-yellow-500 text-white py-1 px-3 rounded" data-level="intermediate">Intermediate</button>
                        <button class="difficulty-btn bg-red-500 text-white py-1 px-3 rounded" data-level="advanced">Advanced</button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <button id="start-challenge" class="w-full bg-primary hover:bg-opacity-90 text-white font-semibold py-2 px-4 rounded transition">
                        Start Challenge
                    </button>
                </div>
                
                <div class="bg-white dark:bg-gray-700 p-3 rounded-lg">
                    <h3 class="font-semibold mb-2 text-primary">Your Progress</h3>
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm">Challenges Completed:</span>
                        <span id="challenges-completed" class="font-semibold">0/5</span>
                    </div>
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm">Accuracy Rate:</span>
                        <span id="accuracy-rate" class="font-semibold">0%</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Current Streak:</span>
                        <span id="current-streak" class="font-semibold">0</span>
                    </div>
                </div>
            </div>

            <!-- Main content area -->
            <div class="w-full md:w-3/4 bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md">
                <div id="challenge-description" class="mb-6 bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                    <h2 class="text-xl font-semibold mb-2 text-primary">Challenge: Find Missing Values</h2>
                    <p class="mb-2">Welcome to Ekpulu Trading! As the new accounting detective, your task is to find the missing values in the financial statements.</p>
                    <p>Examine the Trading and Profit & Loss Account for Ekpulu Trading. Some values are missing (marked with '?'). Calculate and enter the correct values in each cell to solve the mystery!</p>
                </div>

                <div id="accounting-workspace" class="overflow-x-auto">
                    <table class="min-w-full border-2 border-gray-300 dark:border-gray-600 mb-4">
                        <thead>
                            <tr class="bg-gray-200 dark:bg-gray-700">
                                <th class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-left">Particulars</th>
                                <th colspan="2" class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Head Office</th>
                                <th colspan="2" class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Branch</th>
                                <th colspan="2" class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Combined</th>
                            </tr>
                            <tr class="bg-gray-200 dark:bg-gray-700">
                                <th class="border border-gray-300 dark:border-gray-600 px-3 py-2"></th>
                                <th class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Debit (Dr)</th>
                                <th class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Credit (Cr)</th>
                                <th class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Debit (Dr)</th>
                                <th class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Credit (Cr)</th>
                                <th class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Debit (Dr)</th>
                                <th class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-center">Credit (Cr)</th>
                            </tr>
                        </thead>
                        <tbody id="accounting-table">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="flex flex-wrap gap-3 mt-6">
                    <button id="check-answers" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition">
                        Check Answers
                    </button>
                    <button id="show-hint" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded transition">
                        Show Hint
                    </button>
                    <button id="show-solution" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded transition">
                        Reveal Solution
                    </button>
                    <button id="next-challenge" class="bg-primary hover:bg-opacity-90 text-white font-semibold py-2 px-4 rounded transition hidden">
                        Next Challenge â†’
                    </button>
                </div>
            </div>
        </div>

        <!-- Learning resources and explanation section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-md mb-6">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/2">
                    <h2 class="text-xl font-semibold mb-4 text-primary">Branch Accounting Concepts</h2>
                    <div id="concept-explanation" class="prose dark:prose-invert max-w-none">
                        <h3>What is Branch Accounting?</h3>
                        <p>Branch accounting involves recording and managing financial transactions between a head office and its branches. It's crucial for businesses with multiple locations to:</p>
                        <ul>
                            <li>Track performance of individual branches</li>
                            <li>Manage inventory and goods transfers between locations</li>
                            <li>Consolidate financial statements for the overall business</li>
                            <li>Make informed decisions about resource allocation</li>
                        </ul>
                        
                        <h3>Key Branch Accounting Principles</h3>
                        <p>In the Ekpulu Trading example, note these important concepts:</p>
                        <ol>
                            <li><strong>Goods sent to branch</strong> - Appears as a negative entry for Head Office and positive for Branch</li>
                            <li><strong>Admin charges</strong> - Transferred from branch to head office</li>
                            <li><strong>Branch profit transfer</strong> - Branch profits are ultimately transferred to head office</li>
                            <li><strong>Elimination in combined statements</strong> - Inter-branch transactions are eliminated in the combined figures</li>
                        </ol>
                    </div>
                </div>
                <div class="w-full md:w-1/2">
                    <h2 class="text-xl font-semibold mb-4 text-primary">Visualizing Branch Transactions</h2>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg h-80">
                        <canvas id="transaction-flow-chart"></canvas>
                    </div>
                    <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                        <p>This chart visualizes the flow of goods, services, and funds between the head office and branch. Understanding these flows is key to mastering branch accounting.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decision-making section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-primary">Management Decision Center</h2>
            <p class="mb-4">Apply your branch accounting knowledge to make strategic business decisions for Ekpulu Trading.</p>
            
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/2 bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                    <h3 class="font-semibold mb-3">Branch Performance Analysis</h3>
                    <p class="mb-3">Based on the financial statements, which business unit needs more attention?</p>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="decision1-ho" name="performance" class="mr-2">
                            <label for="decision1-ho">Head Office needs improvement</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="decision1-branch" name="performance" class="mr-2">
                            <label for="decision1-branch">Branch needs improvement</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="decision1-both" name="performance" class="mr-2">
                            <label for="decision1-both">Both are performing adequately</label>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block mb-1 text-sm">Justify your decision:</label>
                        <textarea class="w-full p-2 border rounded bg-white dark:bg-gray-800" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="w-full md:w-1/2 bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                    <h3 class="font-semibold mb-3">Resource Allocation Decision</h3>
                    <p class="mb-3">If Ekpulu Trading has â‚¦5,000 to invest, where should it be allocated?</p>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="decision2-ho" name="investment" class="mr-2">
                            <label for="decision2-ho">Expand Head Office inventory</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="decision2-branch" name="investment" class="mr-2">
                            <label for="decision2-branch">Expand Branch operations</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="decision2-new" name="investment" class="mr-2">
                            <label for="decision2-new">Open a new branch location</label>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block mb-1 text-sm">Justify your decision:</label>
                        <textarea class="w-full p-2 border rounded bg-white dark:bg-gray-800" rows="3"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 flex justify-end">
                <button id="submit-decisions" class="bg-primary hover:bg-opacity-90 text-white font-semibold py-2 px-4 rounded transition">
                    Submit Decisions & Get Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- Hint modal -->
    <div id="hint-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4 text-primary">Hint</h3>
            <div id="hint-content" class="mb-4">
                <p>Remember these key principles:</p>
                <ul class="list-disc ml-5 mb-3">
                    <li>Combined figures are the sum of Head Office and Branch, except for internal transactions</li>
                    <li>Internal transactions (like goods transfers) should be eliminated in the combined column</li>
                    <li>For each section, debits must equal credits</li>
                </ul>
                <p>Look carefully at the "Goods Sent to Branch" row - this appears as a negative in Head Office and positive in Branch, but is eliminated in the combined column.</p>
            </div>
            <div class="flex justify-end">
                <button id="close-hint" class="bg-primary hover:bg-opacity-90 text-white font-semibold py-2 px-4 rounded transition">
                    Got it
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize the accounting data (based on the provided example)
        const accountingData = [
            { id: 'sales', particulars: 'Sales', ho_dr: '', ho_cr: '77,626', branch_dr: '', branch_cr: '27,424', combined_dr: '', combined_cr: '105,050' },
            { id: 'header-cogs', particulars: 'Less: Cost of Goods Sold', ho_dr: '', ho_cr: '', branch_dr: '', branch_cr: '', combined_dr: '', combined_cr: '' },
            { id: 'opening-stock', particulars: 'Opening Stock', ho_dr: '7,142', ho_cr: '', branch_dr: '2,412', branch_cr: '', combined_dr: '9,554', combined_cr: '' },
            { id: 'purchases', particulars: 'Purchases', ho_dr: '74,552', ho_cr: '', branch_dr: '-', branch_cr: '', combined_dr: '74,552', combined_cr: '' },
            { id: 'total1', particulars: 'Total', ho_dr: '81,694', ho_cr: '', branch_dr: '2,412', branch_cr: '', combined_dr: '84,106', combined_cr: '' },
            { id: 'goods-to-branch', particulars: 'Goods Sent to Branch', ho_dr: '(19,974)', ho_cr: '', branch_dr: '19,974', branch_cr: '', combined_dr: '0', combined_cr: '' },
            { id: 'available-for-sale', particulars: 'Goods Available for Sale', ho_dr: '61,720', ho_cr: '', branch_dr: '21,824', branch_cr: '', combined_dr: '84,106', combined_cr: '' },
            { id: 'closing-stock', particulars: 'Closing Stock', ho_dr: '(8,128)', ho_cr: '', branch_dr: '(2,724)', branch_cr: '', combined_dr: '(11,504)', combined_cr: '' },
            { id: 'cost-of-sales', particulars: 'Cost of Sales', ho_dr: '', ho_cr: '(53,502)', branch_dr: '', branch_cr: '(19,100)', combined_dr: '', combined_cr: '(72,602)' },
            { id: 'gross-profit', particulars: 'Gross Profit', ho_dr: '', ho_cr: '24,124', branch_dr: '', branch_cr: '8,324', combined_dr: '', combined_cr: '32,448' },
            { id: 'admin-charges-income', particulars: 'Add: Admin Charges', ho_dr: '', ho_cr: '600', branch_dr: '', branch_cr: '0', combined_dr: '', combined_cr: '0' },
            { id: 'total2', particulars: 'Total', ho_dr: '', ho_cr: '24,724', branch_dr: '', branch_cr: '8,324', combined_dr: '', combined_cr: '32,448' },
            { id: 'header-expenses', particulars: 'Less: Expenses', ho_dr: '', ho_cr: '', branch_dr: '', branch_cr: '', combined_dr: '', combined_cr: '' },
            { id: 'admin-charges-expense', particulars: 'Admin Charges', ho_dr: '-', ho_cr: '', branch_dr: '600', branch_cr: '', combined_dr: '-', combined_cr: '' },
            { id: 'depreciation', particulars: 'Depreciation', ho_dr: '-', ho_cr: '', branch_dr: '640', branch_cr: '', combined_dr: '2520', combined_cr: '' },
            { id: 'salaries', particulars: 'Salaries and Wages', ho_dr: '10,232', ho_cr: '', branch_dr: '3,224', branch_cr: '', combined_dr: '13456', combined_cr: '' },
            { id: 'rent', particulars: 'Rent and Rates', ho_dr: '3,094', ho_cr: '', branch_dr: '1,072', branch_cr: '', combined_dr: '4,166', combined_cr: '' },
            { id: 'general-expenses', particulars: 'General Expenses', ho_dr: '836', ho_cr: '', branch_dr: '148', branch_cr: '', combined_dr: '984', combined_cr: '' },
            { id: 'total-expenses', particulars: 'Total Expenses', ho_dr: '', ho_cr: '(16,042)', branch_dr: '', branch_cr: '(5,684)', combined_dr: '', combined_cr: '(21,126)' },
            { id: 'net-profit', particulars: 'Net Profit', ho_dr: '', ho_cr: '8,682', branch_dr: '', branch_cr: '2,640', combined_dr: '', combined_cr: '11,322' },
            { id: 'profit-transfer', particulars: 'Transfer of Branch Net Profit', ho_dr: '', ho_cr: '2,640', branch_dr: '', branch_cr: '(2,640)', combined_dr: '', combined_cr: '-' },
            { id: 'final-profit', particulars: 'Final Net Profit', ho_dr: '', ho_cr: '11,322', branch_dr: '', branch_cr: '-', combined_dr: '', combined_cr: '11,322' }
        ];

        // Challenge data
        const challenges = {
            'missing-values': {
                title: 'Find Missing Values',
                description: 'Some values are missing from the financial statements (marked with "?"). Calculate and enter the correct values to complete the accounting records.',
                cellsToTest: [
                    { row: 'total-expenses', column: 'ho_dr', expected: '14162' },
                    { row: 'total-expenses', column: 'branch_dr', expected: '5684' },
                    { row: 'depreciation', column: 'ho_dr', expected: '1880' },
                    { row: 'net-profit', column: 'combined_dr', expected: '' }
                ],
                hints: [
                    'Total expenses is the sum of all individual expense items.',
                    'For the Head Office expenses, don\'t forget to include depreciation which is missing.',
                    'The combined net profit will be the sum of Head Office and Branch net profits before the profit transfer.'
                ]
            },
            'identify-errors': {
                title: 'Identify Errors',
                description: 'There are several errors in the accounting statements. Identify and correct these errors to balance the accounts.',
                cellsToTest: [
                    { row: 'admin-charges-income', column: 'combined_cr', expected: '0' },
                    { row: 'goods-to-branch', column: 'combined_dr', expected: '0' },
                    { row: 'closing-stock', column: 'combined_dr', expected: '(10852)' }
                ],
                hints: [
                    'Admin charges are an internal transaction and should be eliminated in the combined figures.',
                    'Goods sent to branch represent an internal transfer and should net to zero in the combined column.',
                    'Check if the closing stock in the combined column matches the sum of Head Office and Branch.'
                ]
            },
            'reconciliation': {
                title: 'Head Office & Branch Reconciliation',
                description: 'The statements for Head Office and Branch need to be reconciled. Ensure all transfers and internal transactions are correctly recorded and eliminated in the consolidated statements.',
                cellsToTest: [
                    { row: 'profit-transfer', column: 'combined_cr', expected: '0' },
                    { row: 'admin-charges-income', column: 'combined_cr', expected: '0' },
                    { row: 'admin-charges-expense', column: 'combined_dr', expected: '0' }
                ],
                hints: [
                    'Branch profit transfer is an internal transaction that should be eliminated in the combined figures.',
                    'Admin charges represent an internal service charge that should be eliminated in the combined statements.',
                    'Check that all internal transactions are properly eliminated when preparing consolidated statements.'
                ]
            }
        };

        // Application state
        let currentChallenge = 'missing-values';
        let currentDifficulty = 'beginner';
        let gameStats = {
            challengesCompleted: 0,
            totalAttempts: 0,
            correctAttempts: 0,
            currentStreak: 0
        };

        // DOM Elements
        const accountingTable = document.getElementById('accounting-table');
        const challengeDescription = document.getElementById('challenge-description');
        const startChallengeBtn = document.getElementById('start-challenge');
        const checkAnswersBtn = document.getElementById('check-answers');
        const showHintBtn = document.getElementById('show-hint');
        const showSolutionBtn = document.getElementById('show-solution');
        const nextChallengeBtn = document.getElementById('next-challenge');
        const hintModal = document.getElementById('hint-modal');
        const closeHintBtn = document.getElementById('close-hint');
        const hintContent = document.getElementById('hint-content');
        const submitDecisionsBtn = document.getElementById('submit-decisions');
        const challengeSelector = document.getElementById('challenge-selector');
        const difficultyBtns = document.querySelectorAll('.difficulty-btn');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Populate the accounting table
            renderAccountingTable();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize the transaction flow chart
            initTransactionFlowChart();
            
            // Setup challenge
            setupChallenge('missing-values', 'beginner');
        });

        // Function to render the accounting table
        function renderAccountingTable() {
            accountingTable.innerHTML = '';
            
            accountingData.forEach(row => {
                const tr = document.createElement('tr');
                tr.classList.add('border-b', 'border-gray-300', 'dark:border-gray-600');
                
                // Particulars column - bold for headers
                const tdParticulars = document.createElement('td');
                tdParticulars.classList.add('border', 'border-gray-300', 'dark:border-gray-600', 'px-3', 'py-2');
                if (row.id.includes('header') || row.particulars.includes('Total') || row.particulars.includes('Profit')) {
                    tdParticulars.classList.add('font-semibold');
                }
                tdParticulars.textContent = row.particulars;
                tr.appendChild(tdParticulars);
                
                // Create all data cells (3 sections with dr/cr pairs)
                const columns = ['ho_dr', 'ho_cr', 'branch_dr', 'branch_cr', 'combined_dr', 'combined_cr'];
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.classList.add('border', 'border-gray-300', 'dark:border-gray-600', 'px-3', 'py-2', 'text-right');
                    
                    // Check if this is a cell that should have an input field
                    if (isEditable(row.id, col)) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.classList.add('cell-input', 'w-24', 'text-right', 'py-1', 'px-2', 'rounded');
                        input.dataset.rowId = row.id;
                        input.dataset.colId = col;
                        input.value = row[col] === '?' ? '' : row[col];
                        td.appendChild(input);
                    } else {
                        td.textContent = row[col];
                    }
                    
                    tr.appendChild(td);
                });
                
                accountingTable.appendChild(tr);
            });
        }

        // Determine if a cell should be editable based on challenge type
        function isEditable(rowId, colId) {
            // For the missing-values challenge
            if (currentChallenge === 'missing-values') {
                // Make specific cells editable for this challenge
                if (
                    (rowId === 'total-expenses' && colId === 'ho_dr') ||
                    (rowId === 'total-expenses' && colId === 'branch_dr') ||
                    (rowId === 'depreciation' && colId === 'ho_dr')
                ) {
                    return true;
                }
            }
            
            // For the identify-errors challenge
            else if (currentChallenge === 'identify-errors') {
                // Make specific cells editable for this challenge
                if (
                    (rowId === 'admin-charges-income' && colId === 'combined_cr') ||
                    (rowId === 'goods-to-branch' && colId === 'combined_dr') ||
                    (rowId === 'closing-stock' && colId === 'combined_dr')
                ) {
                    return true;
                }
            }
            
            // For the reconciliation challenge
            else if (currentChallenge === 'reconciliation') {
                // Make specific cells editable for this challenge
                if (
                    (rowId === 'profit-transfer' && colId === 'combined_cr') ||
                    (rowId === 'admin-charges-income' && colId === 'combined_cr') ||
                    (rowId === 'admin-charges-expense' && colId === 'combined_dr')
                ) {
                    return true;
                }
            }
            
            return false;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Start challenge button
            startChallengeBtn.addEventListener('click', () => {
                const selectedChallenge = challengeSelector.value;
                setupChallenge(selectedChallenge, currentDifficulty);
            });
            
            // Difficulty buttons
            difficultyBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active state
                    difficultyBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDifficulty = btn.dataset.level;
                });
            });
            
            // Check answers button
            checkAnswersBtn.addEventListener('click', checkAnswers);
            
            // Show hint button
            showHintBtn.addEventListener('click', () => {
                hintModal.classList.remove('hidden');
                // Set hint content based on current challenge
                const challengeHints = challenges[currentChallenge].hints;
                let hintsHTML = '<p><strong>Hints:</strong></p><ul class="list-disc ml-5 mb-3">';
                challengeHints.forEach(hint => {
                    hintsHTML += `<li>${hint}</li>`;
                });
                hintsHTML += '</ul>';
                hintContent.innerHTML = hintsHTML;
            });
            
            // Close hint modal
            closeHintBtn.addEventListener('click', () => {
                hintModal.classList.add('hidden');
            });
            
            // Show solution button
            showSolutionBtn.addEventListener('click', showSolution);
            
            // Next challenge button
            nextChallengeBtn.addEventListener('click', () => {
                // Move to the next challenge type
                const challenges = ['missing-values', 'identify-errors', 'reconciliation'];
                const currentIndex = challenges.indexOf(currentChallenge);
                const nextIndex = (currentIndex + 1) % challenges.length;
                setupChallenge(challenges[nextIndex], currentDifficulty);
                nextChallengeBtn.classList.add('hidden');
            });
            
            // Submit decisions button
            submitDecisionsBtn.addEventListener('click', () => {
                alert('Decision analysis functionality will be implemented in the next version.');
            });
        }

        // Initialize the transaction flow chart
        function initTransactionFlowChart() {
            const ctx = document.getElementById('transaction-flow-chart').getContext('2d');
            
            // Transaction data for the chart
            const transactions = [
                { label: 'Goods sent to Branch', value: 19974 },
                { label: 'Admin Charges', value: 600 },
                { label: 'Branch Profit Transfer', value: 2640 }
            ];
            
            const flowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: transactions.map(t => t.label),
                    datasets: [{
                        label: 'Head Office to Branch',
                        data: transactions.map(t => t.value),
                        backgroundColor: 'rgba(93, 92, 222, 0.6)',
                        borderColor: 'rgba(93, 92, 222, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Transaction Type'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Head Office to Branch Transactions',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                label: function(context) {
                                    return `Value: ${context.raw}`;
                                },
                                afterLabel: function(context) {
                                    const label = context.label;
                                    if (label === 'Goods sent to Branch') {
                                        return 'Inventory transfer from HO to Branch';
                                    } else if (label === 'Admin Charges') {
                                        return 'Service charge from Branch to HO';
                                    } else if (label === 'Branch Profit Transfer') {
                                        return 'Profit transferred from Branch to HO';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // Setup a challenge
        function setupChallenge(challengeType, difficulty) {
            currentChallenge = challengeType;
            
            // Update challenge description
            const challenge = challenges[challengeType];
            challengeDescription.innerHTML = `
                <h2 class="text-xl font-semibold mb-2 text-primary">Challenge: ${challenge.title}</h2>
                <p>${challenge.description}</p>
            `;
            
            // Reset and re-render the table with appropriate editable cells
            renderAccountingTable();
            
            // Hide the next challenge button
            nextChallengeBtn.classList.add('hidden');
            
            // Apply difficulty adjustments
            applyDifficulty(difficulty);
        }

        // Apply difficulty settings to the challenge
        function applyDifficulty(difficulty) {
            // Adjust the challenge based on difficulty level
            if (difficulty === 'beginner') {
                // Provide more visual cues and simple cases
                document.querySelectorAll('.cell-input').forEach(input => {
                    input.placeholder = '?';
                });
            } else if (difficulty === 'intermediate') {
                // Remove some visual cues
                document.querySelectorAll('.cell-input').forEach(input => {
                    input.placeholder = '';
                });
            } else if (difficulty === 'advanced') {
                // Add more complexity - e.g., make more cells editable or add distractors
                document.querySelectorAll('.cell-input').forEach(input => {
                    input.placeholder = '';
                });
                // Add additional challenge components for advanced difficulty here
            }
        }

        // Check user answers
        function checkAnswers() {
            let allCorrect = true;
            let correctCount = 0;
            let totalCells = 0;
            
            // Get all input cells
            const inputs = document.querySelectorAll('.cell-input');
            
            // Loop through all editable cells and check against expected values
            inputs.forEach(input => {
                const rowId = input.dataset.rowId;
                const colId = input.dataset.colId;
                const userValue = input.value.trim().replace(/,/g, ''); // Remove commas for comparison
                
                // Find the expected value for this cell
                const cellTest = challenges[currentChallenge].cellsToTest.find(
                    cell => cell.row === rowId && cell.column === colId
                );
                
                if (cellTest) {
                    totalCells++;
                    const expectedValue = cellTest.expected.replace(/,/g, ''); // Remove commas for comparison
                    
                    if (userValue === expectedValue) {
                        input.classList.add('correct');
                        input.classList.remove('incorrect');
                        correctCount++;
                    } else {
                        input.classList.add('incorrect');
                        input.classList.remove('correct');
                        allCorrect = false;
                    }
                }
            });
            
            // Update game stats
            gameStats.totalAttempts++;
            
            if (allCorrect) {
                gameStats.correctAttempts++;
                gameStats.currentStreak++;
                gameStats.challengesCompleted++;
                
                // Show success message
                alert('Excellent work! You have correctly completed this challenge.');
                
                // Show next challenge button
                nextChallengeBtn.classList.remove('hidden');
            } else {
                gameStats.currentStreak = 0;
                
                // Show error message with partial progress
                alert(`You've got ${correctCount} out of ${totalCells} correct. Keep trying!`);
            }
            
            // Update stats display
            updateStatsDisplay();
        }

        // Show solution
        function showSolution() {
            const inputs = document.querySelectorAll('.cell-input');
            
            inputs.forEach(input => {
                const rowId = input.dataset.rowId;
                const colId = input.dataset.colId;
                
                // Find the expected value for this cell
                const cellTest = challenges[currentChallenge].cellsToTest.find(
                    cell => cell.row === rowId && cell.column === colId
                );
                
                if (cellTest) {
                    input.value = cellTest.expected;
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                }
            });
            
            // Reset streak since solution was revealed
            gameStats.currentStreak = 0;
            updateStatsDisplay();
            
            // Show next challenge button
            nextChallengeBtn.classList.remove('hidden');
        }

        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('challenges-completed').textContent = `${gameStats.challengesCompleted}/5`;
            
            const accuracyRate = gameStats.totalAttempts > 0 
                ? Math.round((gameStats.correctAttempts / gameStats.totalAttempts) * 100) 
                : 0;
            document.getElementById('accuracy-rate').textContent = `${accuracyRate}%`;
            
            document.getElementById('current-streak').textContent = gameStats.currentStreak;
        }
    </script>
</body>
</html>