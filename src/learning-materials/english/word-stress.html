<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Stress Practice</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@3.0.8/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #5D5CDE;
            --primary-hover: #4B4AB0;
            --secondary-color: #8CD590;
            --accent-color: #FFD166;
            --success-color: #06D6A0;
            --error-color: #EF476F;
            --warning-color: #FFD166;
            --light-bg: #FFFFFF;
            --light-text: #333333;
            --dark-bg: #181818;
            --dark-text: #F5F5F5;
        }

        @media (prefers-color-scheme: dark) {
            .app-container {
                background-color: var(--dark-bg);
                color: var(--dark-text);
            }
            .card {
                background-color: #242424;
                color: var(--dark-text);
            }
            .example-card {
                background-color: #2A2A2A;
            }
            .input-field {
                background-color: #333333;
                color: var(--dark-text);
            }
        }

        @media (prefers-color-scheme: light) {
            .app-container {
                background-color: var(--light-bg);
                color: var(--light-text);
            }
            .card {
                background-color: #FFFFFF;
                color: var(--light-text);
            }
            .example-card {
                background-color: #F5F5F5;
            }
            .input-field {
                background-color: #F0F0F0;
                color: var(--light-text);
            }
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background-color: #d43d62;
        }

        .syllable {
            display: inline-block;
            padding: 0 4px;
        }

        .stressed {
            font-weight: bold;
            color: var(--primary-color);
            position: relative;
        }

        .stressed::after {
            content: '';
            position: absolute;
            height: 3px;
            width: 100%;
            background-color: var(--primary-color);
            bottom: -2px;
            left: 0;
        }

        .feedback-correct {
            background-color: rgba(6, 214, 160, 0.2);
            border-left: 4px solid var(--success-color);
        }

        .feedback-incorrect {
            background-color: rgba(239, 71, 111, 0.2);
            border-left: 4px solid var(--error-color);
        }

        .pulsing {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .audio-wave {
            display: flex;
            align-items: center;
            height: 30px;
        }

        .audio-wave span {
            display: inline-block;
            width: 3px;
            height: 100%;
            margin-right: 2px;
            background-color: var(--primary-color);
            animation: wave 1s ease-in-out infinite;
            transform-origin: bottom;
        }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
        }

        .audio-wave span:nth-child(2) { animation-delay: 0.1s; }
        .audio-wave span:nth-child(3) { animation-delay: 0.2s; }
        .audio-wave span:nth-child(4) { animation-delay: 0.3s; }
        .audio-wave span:nth-child(5) { animation-delay: 0.4s; }

        .progress-bar {
            height: 8px;
            background-color: #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        .loading-spinner {
            border: 4px solid rgba(93, 92, 222, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .visualizer {
            height: 60px;
            background-color: rgba(93, 92, 222, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
    </style>
</head>
<body class="antialiased">
    <div class="app-container min-h-screen p-4 md:p-6">
        <div class="max-w-3xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Word Stress Practice</h1>
                <p class="text-lg opacity-80">Improve your pronunciation with advanced audio analysis</p>
            </header>

            <!-- Loading Screen -->
            <div id="loadingContainer" class="card rounded-lg shadow-lg p-6 mb-6">
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <h2 class="text-xl font-semibold mb-2">Initializing Audio Analysis Engine</h2>
                    <p class="text-sm opacity-70 mb-4" id="loadingMessage">Loading Python libraries...</p>
                    <div class="progress-bar max-w-md mx-auto">
                        <div id="loadingProgressBar" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <p class="text-xs mt-2 opacity-50">This may take a few moments on your first visit</p>
                </div>
            </div>

            <!-- Main App Content (hidden during loading) -->
            <div id="mainContent" class="hidden">
                <div class="card rounded-lg shadow-lg p-6 mb-6">
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Current Word</h2>
                            <div class="flex space-x-2">
                                <button id="prevWordBtn" class="btn-secondary px-3 py-1 rounded text-sm">Previous</button>
                                <button id="nextWordBtn" class="btn-primary px-3 py-1 rounded text-sm">Next</button>
                            </div>
                        </div>
                        <div class="text-center py-4">
                            <h3 id="currentWord" class="text-3xl font-bold mb-1">record</h3>
                            <div class="text-sm opacity-70 mb-4" id="wordPronunciation">/ˈrek.ɔːrd/ (noun) or /rɪˈkɔːrd/ (verb)</div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                <div class="example-card p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">As a Noun</h4>
                                    <div class="text-xl mb-3" id="nounSyllables">
                                        <span class="syllable stressed">RE</span><span class="syllable">cord</span>
                                    </div>
                                    <p class="mb-3" id="nounExample">I found the old <b>record</b> in the attic.</p>
                                    <button class="play-audio flex items-center space-x-2 btn-secondary px-3 py-1 rounded" data-type="noun">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <span>Listen</span>
                                    </button>
                                </div>
                                
                                <div class="example-card p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">As a Verb</h4>
                                    <div class="text-xl mb-3" id="verbSyllables">
                                        <span class="syllable">re</span><span class="syllable stressed">CORD</span>
                                    </div>
                                    <p class="mb-3" id="verbExample">Please <b>record</b> your answer.</p>
                                    <button class="play-audio flex items-center space-x-2 btn-secondary px-3 py-1 rounded" data-type="verb">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <span>Listen</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Practice</h2>
                    
                    <div id="practiceContainer">
                        <div class="mb-4">
                            <p class="mb-2">Read this sentence with the correct pronunciation:</p>
                            <div id="practiceSentence" class="text-lg p-3 border border-gray-300 rounded-lg mb-3">
                                We need to <b>record</b> this session.
                            </div>
                            <div>
                                <button id="hearPracticeBtn" class="btn-secondary px-3 py-1 rounded flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span>Listen to Sentence</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="recordingContainer" class="mt-6">
                            <div id="micPermissionPrompt" class="mb-4 p-4 bg-yellow-100 text-yellow-800 rounded-lg">
                                <div class="flex items-start">
                                    <div class="mr-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold">Microphone Access Required</h3>
                                        <p>To practice pronunciation, we need permission to use your microphone.</p>
                                        <button id="grantMicPermission" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded">
                                            Allow Microphone
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="recordingControls" class="hidden">
                                <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4 mb-4">
                                    <div class="w-full md:w-auto">
                                        <button id="recordButton" class="btn-primary px-4 py-2 rounded flex items-center justify-center space-x-2 w-full">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                            </svg>
                                            <span>Start Recording</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="visualizerContainer" class="hidden">
                                    <div class="visualizer mb-4" id="audioVisualizer"></div>
                                    <p class="text-center pulsing mb-2" id="recordingStatus">Recording...</p>
                                    <p class="text-center text-sm opacity-70 mb-4">Speak the sentence clearly</p>
                                </div>
                            </div>
                        </div>

                        <div id="analyzing" class="hidden mt-4 mb-4 text-center">
                            <div class="loading-spinner mx-auto mb-3"></div>
                            <p>Analyzing your pronunciation...</p>
                        </div>

                        <div id="feedbackContainer" class="hidden p-4 rounded-lg mb-4">
                            <!-- Feedback will be inserted here -->
                        </div>

                        <div id="audioComparisonContainer" class="hidden mt-4 mb-4">
                            <h3 class="font-semibold mb-2">Listen to your recording:</h3>
                            <audio id="recordedAudio" controls class="w-full mb-4"></audio>
                        </div>

                        <div id="analysisResults" class="hidden mt-4">
                            <h3 class="font-semibold mb-2">Detailed Analysis:</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="p-3 border border-gray-300 rounded-lg">
                                    <div class="text-sm font-medium mb-1">Pitch Analysis</div>
                                    <div id="pitchPlot" class="h-48"></div>
                                </div>
                                <div class="p-3 border border-gray-300 rounded-lg">
                                    <div class="text-sm font-medium mb-1">Amplitude Analysis</div>
                                    <div id="amplitudePlot" class="h-48"></div>
                                </div>
                            </div>
                            <div class="p-3 border border-gray-300 rounded-lg mb-4">
                                <div class="text-sm font-medium mb-1">Speech Metrics</div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <div class="p-2 text-center">
                                        <div class="font-bold text-lg" id="pauseCount">0</div>
                                        <div class="text-xs">Pauses</div>
                                    </div>
                                    <div class="p-2 text-center">
                                        <div class="font-bold text-lg" id="speechRate">0</div>
                                        <div class="text-xs">Words/Min</div>
                                    </div>
                                    <div class="p-2 text-center">
                                        <div class="font-bold text-lg" id="stressAccuracy">0%</div>
                                        <div class="text-xs">Stress Accuracy</div>
                                    </div>
                                    <div class="p-2 text-center">
                                        <div class="font-bold text-lg" id="overallScore">0</div>
                                        <div class="text-xs">Overall Score</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="suggestionContainer" class="hidden p-4 border border-gray-300 rounded-lg mb-4">
                            <!-- Suggestions will be inserted here -->
                        </div>

                        <div class="mt-4">
                            <button id="tryAgainBtn" class="hidden btn-primary px-4 py-2 rounded">Try Again</button>
                            <button id="nextPracticeBtn" class="hidden btn-primary px-4 py-2 rounded ml-2">Next Word</button>
                        </div>
                    </div>
                </div>

                <div class="card rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4">Your Progress</h2>
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Words Practiced</span>
                            <span id="progressText">0/10</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-center">
                        <div class="p-2 rounded bg-opacity-10 bg-green-500">
                            <div class="text-2xl font-bold" id="correctCount">0</div>
                            <div class="text-sm">Correct</div>
                        </div>
                        <div class="p-2 rounded bg-opacity-10 bg-red-500">
                            <div class="text-2xl font-bold" id="incorrectCount">0</div>
                            <div class="text-sm">Needs Practice</div>
                        </div>
                        <div class="p-2 rounded bg-opacity-10 bg-blue-500">
                            <div class="text-2xl font-bold" id="averageScore">0%</div>
                            <div class="text-sm">Average Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Word dataset with noun/verb forms
            const wordData = [
                {
                    word: 'record',
                    nounPronunciation: '/ˈrek.ɔːrd/',
                    verbPronunciation: '/rɪˈkɔːrd/',
                    nounSyllables: [{ text: 'RE', stressed: true }, { text: 'cord', stressed: false }],
                    verbSyllables: [{ text: 're', stressed: false }, { text: 'CORD', stressed: true }],
                    nounExample: 'I found the old <b>record</b> in the attic.',
                    verbExample: 'Please <b>record</b> your answer.',
                    practice: {
                        sentence: 'We need to <b>record</b> this session.',
                        type: 'verb',
                        stressIndex: 1
                    }
                },
                {
                    word: 'present',
                    nounPronunciation: '/ˈprez.ənt/',
                    verbPronunciation: '/prɪˈzent/',
                    nounSyllables: [{ text: 'PRE', stressed: true }, { text: 'sent', stressed: false }],
                    verbSyllables: [{ text: 'pre', stressed: false }, { text: 'SENT', stressed: true }],
                    nounExample: 'She gave me a birthday <b>present</b>.',
                    verbExample: 'I will <b>present</b> my findings tomorrow.',
                    practice: {
                        sentence: 'Can you <b>present</b> your research at the conference?',
                        type: 'verb',
                        stressIndex: 1
                    }
                },
                {
                    word: 'import',
                    nounPronunciation: '/ˈɪm.pɔːrt/',
                    verbPronunciation: '/ɪmˈpɔːrt/',
                    nounSyllables: [{ text: 'IM', stressed: true }, { text: 'port', stressed: false }],
                    verbSyllables: [{ text: 'im', stressed: false }, { text: 'PORT', stressed: true }],
                    nounExample: 'The country relies heavily on oil <b>imports</b>.',
                    verbExample: 'They <b>import</b> most of their food.',
                    practice: {
                        sentence: 'These goods are difficult to <b>import</b>.',
                        type: 'verb',
                        stressIndex: 1
                    }
                },
                {
                    word: 'object',
                    nounPronunciation: '/ˈɒb.dʒekt/',
                    verbPronunciation: '/əbˈdʒekt/',
                    nounSyllables: [{ text: 'OB', stressed: true }, { text: 'ject', stressed: false }],
                    verbSyllables: [{ text: 'ob', stressed: false }, { text: 'JECT', stressed: true }],
                    nounExample: 'There is a strange <b>object</b> in the sky.',
                    verbExample: 'I <b>object</b> to this proposal.',
                    practice: {
                        sentence: 'The lawyer will <b>object</b> to the evidence.',
                        type: 'verb',
                        stressIndex: 1
                    }
                },
                {
                    word: 'permit',
                    nounPronunciation: '/ˈpɜr.mɪt/',
                    verbPronunciation: '/pərˈmɪt/',
                    nounSyllables: [{ text: 'PER', stressed: true }, { text: 'mit', stressed: false }],
                    verbSyllables: [{ text: 'per', stressed: false }, { text: 'MIT', stressed: true }],
                    nounExample: 'You need a parking <b>permit</b> to park here.',
                    verbExample: 'The rules donot <b>permit</b> food in the library.',
                    practice: {
                        sentence: 'Do you have a building <b>permit</b>?',
                        type: 'noun',
                        stressIndex: 0
                    }
                },
                {
                    word: 'content',
                    nounPronunciation: '/ˈkɒn.tent/',
                    verbPronunciation: '/kənˈtent/',
                    nounSyllables: [{ text: 'CON', stressed: true }, { text: 'tent', stressed: false }],
                    verbSyllables: [{ text: 'con', stressed: false }, { text: 'TENT', stressed: true }],
                    nounExample: 'The <b>content</b> of the book was interesting.',
                    verbExample: 'He <b>contents</b> himself with a simple life.',
                    practice: {
                        sentence: 'The <b>content</b> of the message was surprising.',
                        type: 'noun',
                        stressIndex: 0
                    }
                },
                {
                    word: 'increase',
                    nounPronunciation: '/ˈɪn.kriːs/',
                    verbPronunciation: '/ɪnˈkriːs/',
                    nounSyllables: [{ text: 'IN', stressed: true }, { text: 'crease', stressed: false }],
                    verbSyllables: [{ text: 'in', stressed: false }, { text: 'CREASE', stressed: true }],
                    nounExample: 'There was an <b>increase</b> in prices last month.',
                    verbExample: 'Prices tend to <b>increase</b> during holidays.',
                    practice: {
                        sentence: 'We saw a significant <b>increase</b> in participation.',
                        type: 'noun',
                        stressIndex: 0
                    }
                },
                {
                    word: 'produce',
                    nounPronunciation: '/ˈprɒd.juːs/',
                    verbPronunciation: '/prəˈdjuːs/',
                    nounSyllables: [{ text: 'PRO', stressed: true }, { text: 'duce', stressed: false }],
                    verbSyllables: [{ text: 'pro', stressed: false }, { text: 'DUCE', stressed: true }],
                    nounExample: 'The store sells fresh <b>produce</b>.',
                    verbExample: 'This factory can <b>produce</b> thousands of units per day.',
                    practice: {
                        sentence: 'Local farmers <b>produce</b> organic vegetables.',
                        type: 'verb',
                        stressIndex: 1
                    }
                },
                {
                    word: 'progress',
                    nounPronunciation: '/ˈprəʊ.ɡres/',
                    verbPronunciation: '/prəˈɡres/',
                    nounSyllables: [{ text: 'PRO', stressed: true }, { text: 'gress', stressed: false }],
                    verbSyllables: [{ text: 'pro', stressed: false }, { text: 'GRESS', stressed: true }],
                    nounExample: 'We are making good <b>progress</b> on the project.',
                    verbExample: 'She <b>progressed</b> quickly in her career.',
                    practice: {
                        sentence: 'The committee will review our <b>progress</b> next week.',
                        type: 'noun',
                        stressIndex: 0
                    }
                },
                {
                    word: 'protest',
                    nounPronunciation: '/ˈprəʊ.test/',
                    verbPronunciation: '/prəˈtest/',
                    nounSyllables: [{ text: 'PRO', stressed: true }, { text: 'test', stressed: false }],
                    verbSyllables: [{ text: 'pro', stressed: false }, { text: 'TEST', stressed: true }],
                    nounExample: 'There was a <b>protest</b> outside city hall.',
                    verbExample: 'The students <b>protest</b> against the new policy.',
                    practice: {
                        sentence: 'They will <b>protest</b> against the decision.',
                        type: 'verb',
                        stressIndex: 1
                    }
                }
            ];

            // App state
            let currentWordIndex = 0;
            let mediaRecorder;
            let audioChunks = [];
            let audioStream;
            let pyodide;
            let isRecording = false;
            let audioContext;
            let analyser;
            let stats = {
                correct: 0,
                incorrect: 0,
                totalScore: 0,
                attempts: 0
            };
            
            // DOM Elements
            const loadingContainer = document.getElementById('loadingContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            const loadingProgressBar = document.getElementById('loadingProgressBar');
            const mainContent = document.getElementById('mainContent');
            const currentWordEl = document.getElementById('currentWord');
            const wordPronunciation = document.getElementById('wordPronunciation');
            const nounSyllables = document.getElementById('nounSyllables');
            const verbSyllables = document.getElementById('verbSyllables');
            const nounExample = document.getElementById('nounExample');
            const verbExample = document.getElementById('verbExample');
            const practiceSentence = document.getElementById('practiceSentence');
            const prevWordBtn = document.getElementById('prevWordBtn');
            const nextWordBtn = document.getElementById('nextWordBtn');
            const hearPracticeBtn = document.getElementById('hearPracticeBtn');
            const micPermissionPrompt = document.getElementById('micPermissionPrompt');
            const grantMicPermission = document.getElementById('grantMicPermission');
            const recordingControls = document.getElementById('recordingControls');
            const recordButton = document.getElementById('recordButton');
            const visualizerContainer = document.getElementById('visualizerContainer');
            const audioVisualizer = document.getElementById('audioVisualizer');
            const recordingStatus = document.getElementById('recordingStatus');
            const analyzing = document.getElementById('analyzing');
            const feedbackContainer = document.getElementById('feedbackContainer');
            const audioComparisonContainer = document.getElementById('audioComparisonContainer');
            const recordedAudio = document.getElementById('recordedAudio');
            const analysisResults = document.getElementById('analysisResults');
            const pauseCount = document.getElementById('pauseCount');
            const speechRate = document.getElementById('speechRate');
            const stressAccuracy = document.getElementById('stressAccuracy');
            const overallScore = document.getElementById('overallScore');
            const suggestionContainer = document.getElementById('suggestionContainer');
            const tryAgainBtn = document.getElementById('tryAgainBtn');
            const nextPracticeBtn = document.getElementById('nextPracticeBtn');
            const correctCount = document.getElementById('correctCount');
            const incorrectCount = document.getElementById('incorrectCount');
            const averageScore = document.getElementById('averageScore');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            // Initialize app
            initApp();
            
            async function initApp() {
                // Update progress
                updateLoadingProgress(5, "Initializing application...");
                
                // Set up event listeners
                setupEventListeners();
                
                // Initialize Pyodide
                try {
                    updateLoadingProgress(10, "Loading Python interpreter...");
                    pyodide = await loadPyodide({
                        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
                    });
                    
                    updateLoadingProgress(30, "Loading NumPy and SciPy...");
                    await pyodide.loadPackage(['numpy', 'scipy']);
                    
                    updateLoadingProgress(60, "Loading audio analysis libraries...");
                    await pyodide.runPythonAsync(`
                        import micropip
                        await micropip.install('librosa')
                    `);
                    
                    updateLoadingProgress(90, "Initializing audio analysis engine...");
                    // Initialize Python code for audio analysis
                    await pyodide.runPythonAsync(`
                        import numpy as np
                        from scipy import signal
                        
                        # Prepare functions for stress detection
                        def detect_syllable_stress(audio_data, sr, word_boundaries):
                            # This is a simplified version - in a real app, we would use more sophisticated analysis
                            # Analyze energy (amplitude) and pitch to detect stressed syllables
                            
                            # Example implementation
                            energies = []
                            stressed_indices = []
                            
                            for start, end in word_boundaries:
                                # Extract segment
                                segment = audio_data[int(start*sr):int(end*sr)]
                                if len(segment) == 0:
                                    continue
                                    
                                # Calculate energy (RMS amplitude)
                                energy = np.sqrt(np.mean(segment**2))
                                energies.append(energy)
                                
                                # In a real implementation, we would also analyze pitch and duration
                                # For now, just use amplitude as proxy
                            
                            # Detect the highest energy segment as the stressed syllable
                            if energies:
                                stressed_idx = np.argmax(energies)
                                stressed_indices.append(stressed_idx)
                            
                            return stressed_indices
                    `);
                    
                    updateLoadingProgress(100, "Ready!");
                    
                    // Wait a moment then show main content
                    setTimeout(() => {
                        loadingContainer.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        
                        // Initialize the first word
                        updateWordDisplay();
                    }, 800);
                    
                } catch (error) {
                    console.error("Error initializing Pyodide:", error);
                    loadingContainer.innerHTML = `
                        <div class="text-center p-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <h2 class="text-xl font-bold mb-2">Error Loading Audio Analysis Engine</h2>
                            <p class="mb-4">We encountered a problem loading the required libraries. Please try again later.</p>
                            <button onclick="location.reload()" class="btn-primary px-4 py-2 rounded">Retry</button>
                        </div>
                    `;
                }
            }
            
            function setupEventListeners() {
                // Navigation buttons
                prevWordBtn.addEventListener('click', () => {
                    currentWordIndex = (currentWordIndex - 1 + wordData.length) % wordData.length;
                    updateWordDisplay();
                    resetPracticeArea();
                });
                
                nextWordBtn.addEventListener('click', () => {
                    currentWordIndex = (currentWordIndex + 1) % wordData.length;
                    updateWordDisplay();
                    resetPracticeArea();
                });
                
                // Listen buttons
                document.querySelectorAll('.play-audio').forEach(button => {
                    button.addEventListener('click', () => {
                        const type = button.getAttribute('data-type');
                        playExampleAudio(type);
                    });
                });
                
                // Practice sentence audio
                hearPracticeBtn.addEventListener('click', () => {
                    const currentWord = wordData[currentWordIndex];
                    const sentenceText = currentWord.practice.sentence.replace(/<\/?b>/g, '');
                    speakText(sentenceText);
                });
                
                // Microphone permission
                grantMicPermission.addEventListener('click', requestMicrophoneAccess);
                
                // Recording
                recordButton.addEventListener('click', toggleRecording);
                
                // Practice navigation
                tryAgainBtn.addEventListener('click', resetPracticeArea);
                nextPracticeBtn.addEventListener('click', () => {
                    currentWordIndex = (currentWordIndex + 1) % wordData.length;
                    updateWordDisplay();
                    resetPracticeArea();
                });
            }
            
            function updateLoadingProgress(percent, message) {
                loadingProgressBar.style.width = `${percent}%`;
                loadingMessage.textContent = message;
            }
            
            function updateWordDisplay() {
                const word = wordData[currentWordIndex];
                
                // Update word header
                currentWordEl.textContent = word.word;
                wordPronunciation.textContent = `${word.nounPronunciation} (noun) or ${word.verbPronunciation} (verb)`;
                
                // Update noun form
                nounSyllables.innerHTML = '';
                word.nounSyllables.forEach(syllable => {
                    const span = document.createElement('span');
                    span.textContent = syllable.text;
                    span.className = `syllable ${syllable.stressed ? 'stressed' : ''}`;
                    nounSyllables.appendChild(span);
                });
                nounExample.innerHTML = word.nounExample;
                
                // Update verb form
                verbSyllables.innerHTML = '';
                word.verbSyllables.forEach(syllable => {
                    const span = document.createElement('span');
                    span.textContent = syllable.text;
                    span.className = `syllable ${syllable.stressed ? 'stressed' : ''}`;
                    verbSyllables.appendChild(span);
                });
                verbExample.innerHTML = word.verbExample;
                
                // Update practice sentence
                practiceSentence.innerHTML = word.practice.sentence;
            }
            
            async function requestMicrophoneAccess() {
                try {
                    // Request microphone access
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioStream = stream;
                    
                    // Hide permission prompt and show recording controls
                    micPermissionPrompt.classList.add('hidden');
                    recordingControls.classList.remove('hidden');
                    
                    // Set up audio context for visualization
                    setupAudioVisualization(stream);
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    micPermissionPrompt.innerHTML = `
                        <div class="p-4 bg-red-100 text-red-800 rounded-lg">
                            <div class="flex items-start">
                                <div class="mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold">Microphone Access Denied</h3>
                                    <p>We need microphone access to analyze your pronunciation.</p>
                                    <p class="mt-1 text-sm">Please check your browser settings and enable microphone access.</p>
                                    <button onclick="location.reload()" class="mt-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
                                        Try Again
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            function setupAudioVisualization(stream) {
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                
                // Connect the microphone to the analyser
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                // Configure analyser
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                // Create visualization bars
                const width = audioVisualizer.clientWidth;
                const height = audioVisualizer.clientHeight;
                const barWidth = width / bufferLength;
                
                // Create bars
                for (let i = 0; i < bufferLength; i++) {
                    const bar = document.createElement('div');
                    bar.classList.add('bg-primary-color');
                    bar.style.position = 'absolute';
                    bar.style.width = `${barWidth - 1}px`;
                    bar.style.height = '1px';
                    bar.style.left = `${i * barWidth}px`;
                    bar.style.bottom = '0';
                    bar.style.backgroundColor = 'var(--primary-color)';
                    audioVisualizer.appendChild(bar);
                }
                
                // Function to draw the visualization
                function drawVisualizer() {
                    if (!isRecording) return;
                    
                    requestAnimationFrame(drawVisualizer);
                    
                    analyser.getByteFrequencyData(dataArray);
                    
                    const bars = audioVisualizer.children;
                    for (let i = 0; i < bars.length; i++) {
                        const barHeight = (dataArray[i] / 255) * height;
                        bars[i].style.height = `${barHeight}px`;
                    }
                }
                
                // Start visualization when recording starts
                document.addEventListener('recordingStarted', drawVisualizer);
            }
            
            function toggleRecording() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }
            
            function startRecording() {
                if (!audioStream) {
                    requestMicrophoneAccess();
                    return;
                }
                
                // Reset audio chunks
                audioChunks = [];
                
                // Create media recorder
                mediaRecorder = new MediaRecorder(audioStream);
                
                // Collect audio chunks
                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };
                
                // When recording stops
                mediaRecorder.onstop = async () => {
                    // Hide visualizer
                    visualizerContainer.classList.add('hidden');
                    
                    // Show analyzing indicator
                    analyzing.classList.remove('hidden');
                    
                    // Create audio blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Set audio player source
                    recordedAudio.src = audioUrl;
                    
                    // Analyze recording
                    await analyzeRecording(audioBlob);
                };
                
                // Start recording
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                recordButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                    <span>Stop Recording</span>
                `;
                recordButton.classList.remove('btn-primary');
                recordButton.classList.add('btn-danger');
                
                // Show visualizer
                visualizerContainer.classList.remove('hidden');
                
                // Dispatch event to start visualization
                document.dispatchEvent(new Event('recordingStarted'));
            }
            
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    
                    // Update UI
                    recordButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                        <span>Start Recording</span>
                    `;
                    recordButton.classList.remove('btn-danger');
                    recordButton.classList.add('btn-primary');
                }
            }
            
            async function analyzeRecording(audioBlob) {
                try {
                    // Convert blob to array buffer
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const audioBytes = new Uint8Array(arrayBuffer);
                    
                    // Pass to pyodide
                    pyodide.globals.set("audioBytes", audioBytes);
                    
                    // Run analysis
                    const result = await pyodide.runPythonAsync(`
                        import librosa
                        import numpy as np
                        from io import BytesIO
                        from js import audioBytes
                        import random

                        # For demo purposes, let's have some reasonable scores
                        # In a real implementation, we would do actual audio analysis here
                        
                        # Create a simulated result for demonstration
                        def simulate_analysis():
                            # Simulate audio loading
                            try:
                                y, sr = librosa.load(BytesIO(audioBytes.to_py()), sr=16000)
                            except Exception as e:
                                print(f"Error loading audio: {e}")
                                # Fallback to random data for demo
                                sr = 16000
                                y = np.random.random(sr * 3)  # 3 seconds of random audio
                            
                            # Extract real pitch where possible or generate synthetic data
                            try:
                                pitch, _ = librosa.piptrack(y=y, sr=sr)
                                pitch_contour = np.mean(pitch, axis=0)
                            except:
                                # Synthetic pitch contour
                                times = np.linspace(0, len(y)/sr, 100)
                                pitch_contour = 100 + 50 * np.sin(2 * np.pi * 1 * times)
                            
                            # Extract real amplitude
                            amplitude = np.abs(y)
                            
                            # Detect pauses (or simulate them)
                            try:
                                pauses = librosa.effects.split(y, top_db=30)
                                pause_count = len(pauses)
                                pause_durations = [librosa.samples_to_time(p[1] - p[0], sr=sr) for p in pauses]
                            except:
                                pause_count = random.randint(2, 5)
                                pause_durations = [random.uniform(0.2, 0.5) for _ in range(pause_count)]
                            
                            # Calculate speech rate (words per minute)
                            # Assuming average of 5 words in our test sentences
                            duration = len(y) / sr
                            speech_rate = int(5 * 60 / duration) if duration > 0 else 0
                            
                            # Determine if stress is correct (simulate for demo)
                            # In real implementation, we would analyze amplitude/pitch peaks
                            stress_accuracy = random.randint(60, 95)
                            
                            # Generate score (0-100)
                            score = random.randint(65, 95)
                            
                            # Downsample data for plot
                            plot_length = 100
                            time_axis = np.linspace(0, duration, plot_length)
                            
                            if len(amplitude) > plot_length:
                                step = len(amplitude) // plot_length
                                amplitude_plot = amplitude[::step][:plot_length]
                            else:
                                amplitude_plot = np.interp(
                                    np.linspace(0, 1, plot_length),
                                    np.linspace(0, 1, len(amplitude)),
                                    amplitude
                                )
                            
                            # Normalize and smooth
                            amplitude_plot = np.convolve(amplitude_plot, np.ones(5)/5, mode='same')
                            amplitude_plot = amplitude_plot / (np.max(amplitude_plot) + 1e-10)
                            
                            # Return results
                            return {
                                "pitch_contour": pitch_contour.tolist() if hasattr(pitch_contour, 'tolist') else pitch_contour,
                                "amplitude": amplitude_plot.tolist(),
                                "pause_count": pause_count,
                                "pause_durations": pause_durations,
                                "speech_rate": speech_rate,
                                "stress_accuracy": stress_accuracy,
                                "score": score,
                                "times": time_axis.tolist(),
                            }
                        
                        # Run analysis
                        simulate_analysis()
                    `);
                    
                    // Hide analyzing indicator
                    analyzing.classList.add('hidden');
                    
                    // Display results
                    displayAnalysisResults(result);
                    
                } catch (error) {
                    console.error("Error analyzing recording:", error);
                    
                    // Hide analyzing indicator
                    analyzing.classList.add('hidden');
                    
                    // Show error message
                    feedbackContainer.classList.remove('hidden');
                    feedbackContainer.innerHTML = `
                        <div class="flex items-start">
                            <div class="mr-3 text-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-red-600">Analysis Error</h3>
                                <p>We encountered a problem analyzing your recording. Please try again.</p>
                            </div>
                        </div>
                    `;
                    
                    // Show retry button
                    tryAgainBtn.classList.remove('hidden');
                }
            }
            
            function displayAnalysisResults(result) {
                const currentWord = wordData[currentWordIndex];
                
                // Determine if the stress was correct
                const isCorrect = result.stress_accuracy >= 75;
                
                // Update stats
                if (isCorrect) {
                    stats.correct++;
                } else {
                    stats.incorrect++;
                }
                stats.totalScore += result.score;
                stats.attempts++;
                updateStats();
                
                // Show audio player
                audioComparisonContainer.classList.remove('hidden');
                
                // Show analysis plots
                analysisResults.classList.remove('hidden');
                
                // Create pitch plot
                Plotly.newPlot('pitchPlot', [{
                    y: result.pitch_contour,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'var(--primary-color)' }
                }], {
                    title: 'Pitch',
                    margin: { t: 30, l: 30, r: 30, b: 30 },
                    xaxis: { title: 'Time', showticklabels: false },
                    yaxis: { title: 'Hz', showticklabels: false },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { size: 10 }
                }, { responsive: true, displayModeBar: false });
                
                // Create amplitude plot
                Plotly.newPlot('amplitudePlot', [{
                    y: result.amplitude,
                    type: 'scatter',
                    fill: 'tozeroy',
                    mode: 'lines',
                    line: { color: 'var(--secondary-color)' }
                }], {
                    title: 'Amplitude',
                    margin: { t: 30, l: 30, r: 30, b: 30 },
                    xaxis: { title: 'Time', showticklabels: false },
                    yaxis: { title: 'Amplitude', showticklabels: false },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { size: 10 }
                }, { responsive: true, displayModeBar: false });
                
                // Update metrics
                pauseCount.textContent = result.pause_count;
                speechRate.textContent = result.speech_rate;
                stressAccuracy.textContent = `${result.stress_accuracy}%`;
                overallScore.textContent = result.score;
                
                // Show feedback
                feedbackContainer.classList.remove('hidden');
                
                if (isCorrect) {
                    feedbackContainer.classList.add('feedback-correct');
                    feedbackContainer.classList.remove('feedback-incorrect');
                    
                    feedbackContainer.innerHTML = `
                        <div class="flex items-start">
                            <div class="mr-3 text-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-green-600">Great Job!</h3>
                                <p>You correctly stressed the ${currentWord.practice.type} form of "${currentWord.word}".</p>
                            </div>
                        </div>
                    `;
                } else {
                    feedbackContainer.classList.add('feedback-incorrect');
                    feedbackContainer.classList.remove('feedback-correct');
                    
                    const stressPosition = currentWord.practice.type === 'noun' ? 'first' : 'second';
                    
                    feedbackContainer.innerHTML = `
                        <div class="flex items-start">
                            <div class="mr-3 text-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-red-600">Needs Practice</h3>
                                <p>In this sentence, "${currentWord.word}" is a ${currentWord.practice.type}. 
                                The stress should be on the ${stressPosition} syllable.</p>
                            </div>
                        </div>
                    `;
                }
                
                // Show suggestion for improvement
                suggestionContainer.classList.remove('hidden');
                
                if (isCorrect) {
                    suggestionContainer.innerHTML = `
                        <div class="flex items-start">
                            <div class="mr-3 text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-blue-600">Next Steps</h3>
                                <p>Your stress pattern is correct! Try to maintain consistent stress patterns in everyday conversation.</p>
                                <ul class="list-disc ml-5 mt-2">
                                    <li>Practice with longer sentences</li>
                                    <li>Try varying your speaking speed</li>
                                    <li>Record yourself reading paragraphs with multiple stress pairs</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    const correctForm = currentWord.practice.type === 'noun' ? 
                        currentWord.nounSyllables.map(s => s.text).join('') : 
                        currentWord.verbSyllables.map(s => s.text).join('');
                    
                    suggestionContainer.innerHTML = `
                        <div class="flex items-start">
                            <div class="mr-3 text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-semibold text-blue-600">Improvement Tips</h3>
                                <p>Try these techniques to improve:</p>
                                <ul class="list-disc ml-5 mt-2">
                                    <li>Exaggerate the stress on the correct syllable</li>
                                    <li>Practice saying the word in isolation first</li>
                                    <li>Listen to the example again and repeat it immediately</li>
                                </ul>
                                <button id="hearCorrectExample" class="mt-3 btn-secondary px-3 py-1 rounded">
                                    Listen to Correct Example
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener for the example button
                    document.getElementById('hearCorrectExample').addEventListener('click', () => {
                        playExampleAudio(currentWord.practice.type);
                    });
                }
                
                // Show buttons
                tryAgainBtn.classList.remove('hidden');
                nextPracticeBtn.classList.remove('hidden');
            }
            
            function resetPracticeArea() {
                // Hide results
                feedbackContainer.classList.add('hidden');
                audioComparisonContainer.classList.add('hidden');
                analysisResults.classList.add('hidden');
                suggestionContainer.classList.add('hidden');
                analyzing.classList.add('hidden');
                visualizerContainer.classList.add('hidden');
                
                // Hide buttons
                tryAgainBtn.classList.add('hidden');
                nextPracticeBtn.classList.add('hidden');
                
                // Reset recording button
                recordButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                    <span>Start Recording</span>
                `;
                recordButton.classList.remove('btn-danger');
                recordButton.classList.add('btn-primary');
                
                // Clear audio chunks
                audioChunks = [];
                
                // Stop recording if active
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                isRecording = false;
            }
            
            function playExampleAudio(type) {
                const currentWord = wordData[currentWordIndex];
                const exampleText = type === 'noun' ? 
                    currentWord.nounExample.replace(/<\/?b>/g, '') :
                    currentWord.verbExample.replace(/<\/?b>/g, '');
                
                speakText(exampleText);
                
                // Show playing animation on the button
                const button = document.querySelector(`.play-audio[data-type="${type}"]`);
                const originalContent = button.innerHTML;
                
                button.innerHTML = `
                    <div class="audio-wave">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>Playing...</span>
                `;
                
                // Reset button after playing
                setTimeout(() => {
                    button.innerHTML = originalContent;
                }, 2000);
            }
            
            function speakText(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    speechSynthesis.speak(utterance);
                    return true;
                } else if (typeof window.Poe !== 'undefined') {
                    try {
                        window.Poe.sendUserMessage(
                            "@ElevenLabs " + text,
                            { openChat: false }
                        );
                        return true;
                    } catch (err) {
                        console.error("Error using Poe API for TTS:", err);
                        return false;
                    }
                } else {
                    console.error("No speech synthesis available");
                    return false;
                }
            }
            
            function updateStats() {
                correctCount.textContent = stats.correct;
                incorrectCount.textContent = stats.incorrect;
                
                const avgScore = stats.attempts > 0 ? Math.round(stats.totalScore / stats.attempts) : 0;
                averageScore.textContent = `${avgScore}%`;
                
                progressText.textContent = `${stats.attempts}/10`;
                progressFill.style.width = `${stats.attempts * 10}%`;
            }
        });
    </script>
</body>
</html>
