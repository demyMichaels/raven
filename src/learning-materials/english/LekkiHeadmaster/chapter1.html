<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stardom Stories - Book Reader</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400&family=Playfair+Display:wght@600;700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #FDF8F3;
            --bg-secondary: #F5EDE4;
            --bg-paper: #FFFEF9;
            --text-primary: #2C1810;
            --text-secondary: #5C4033;
            --text-muted: #8B7355;
            --accent: #B8860B;
            --accent-light: #DAA520;
            --accent-glow: rgba(184, 134, 11, 0.2);
            --highlight: #FFE4B5;
            --highlight-hover: #FFD700;
            --border: #D4C4B0;
            --shadow: rgba(44, 24, 16, 0.1);
            --shadow-deep: rgba(44, 24, 16, 0.2);
            --note-bg: #FFFACD;
            --success: #228B22;
            --chapter-bg: linear-gradient(135deg, #8B4513 0%, #654321 100%);
        }

        .dark {
            --bg-primary: #1A1412;
            --bg-secondary: #251E1A;
            --bg-paper: #2A2320;
            --text-primary: #F5E6D3;
            --text-secondary: #D4C4B0;
            --text-muted: #9C8B7A;
            --accent: #DAA520;
            --accent-light: #FFD700;
            --accent-glow: rgba(218, 165, 32, 0.3);
            --highlight: #4A3C28;
            --highlight-hover: #5C4A32;
            --border: #3D332A;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-deep: rgba(0, 0, 0, 0.5);
            --note-bg: #3D3520;
            --chapter-bg: linear-gradient(135deg, #3D2A1A 0%, #2A1F15 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.8;
            transition: all 0.3s ease;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--chapter-bg);
            color: #F5E6D3;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px var(--shadow-deep);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .book-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #F5E6D3;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .header-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Main Content Area */
        .main-content {
            display: flex;
            flex: 1;
            position: relative;
        }

        /* Sidebar - Chapter Navigation */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            overflow-y: auto;
            transition: transform 0.3s ease;
            position: fixed;
            left: 0;
            top: 60px;
            bottom: 0;
            z-index: 50;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-title {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
        }

        .chapter-list {
            list-style: none;
        }

        .chapter-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.95rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chapter-item:hover {
            background: var(--accent-glow);
            color: var(--accent);
        }

        .chapter-item.active {
            background: var(--accent);
            color: white;
            font-weight: 600;
        }

        .chapter-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chapter-number {
            width: 28px;
            height: 28px;
            background: var(--bg-paper);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .chapter-item.active .chapter-number {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Book Content */
        .book-wrapper {
            flex: 1;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .book-wrapper.full-width {
            margin-left: 0;
        }

        .reader-container {
            flex: 1;
            padding: 2rem;
            display: flex;
            justify-content: center;
            overflow-y: auto;
        }

        .book-page {
            background: var(--bg-paper);
            max-width: 750px;
            width: 100%;
            padding: 3rem;
            border-radius: 4px;
            box-shadow:
                0 0 0 1px var(--border),
                0 10px 40px var(--shadow),
                inset 0 0 80px rgba(139, 115, 85, 0.03);
            position: relative;
            min-height: 600px;
        }

        .book-page::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to right, var(--border), transparent);
        }

        .chapter-heading {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 0.5rem;
        }

        .chapter-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2rem;
            position: relative;
        }

        .chapter-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background: var(--accent);
            margin-top: 1rem;
        }

        .book-content {
            font-size: 1.15rem;
            text-align: justify;
            hyphens: auto;
        }

        .book-content p {
            margin-bottom: 1.5rem;
            text-indent: 2rem;
        }

        .book-content p:first-of-type {
            text-indent: 0;
        }

        .book-content p:first-of-type::first-letter {
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            float: left;
            line-height: 0.8;
            margin-right: 0.5rem;
            margin-top: 0.1rem;
            color: var(--accent);
        }

        /* Highlighted Keywords */
        .keyword {
            background: linear-gradient(to bottom, transparent 60%, var(--highlight) 60%);
            color: var(--text-primary);
            cursor: help;
            position: relative;
            transition: all 0.2s;
            padding: 0 2px;
        }

        .keyword:hover {
            background: var(--highlight-hover);
            border-radius: 2px;
        }

        .keyword-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: var(--bg-paper);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-style: normal;
            text-indent: 0;
            text-align: left;
            white-space: normal;
            width: 250px;
            box-shadow: 0 4px 20px var(--shadow-deep);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
            pointer-events: none;
        }

        .keyword:hover .keyword-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        .keyword-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--accent);
        }

        .tooltip-word {
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 0.25rem;
            display: block;
        }

        .tooltip-definition {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Page Navigation */
        .page-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .page-btn {
            background: var(--bg-paper);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-indicator {
            font-family: 'Source Sans Pro', sans-serif;
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .page-indicator span {
            color: var(--accent);
            font-weight: 600;
        }

        /* Notes Panel */
        .notes-panel {
            position: fixed;
            right: -400px;
            top: 60px;
            bottom: 0;
            width: 380px;
            background: var(--bg-paper);
            border-left: 1px solid var(--border);
            box-shadow: -5px 0 30px var(--shadow);
            transition: right 0.3s ease;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }

        .notes-panel.open {
            right: 0;
        }

        .notes-header {
            padding: 1.25rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notes-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notes-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }

        .notes-close:hover {
            color: var(--text-primary);
        }

        .notes-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .note-input-area {
            padding: 1rem;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .note-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            resize: vertical;
            background: var(--bg-paper);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }

        .note-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .note-add-btn {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .note-add-btn:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
        }

        .note-card {
            background: var(--note-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            animation: noteSlide 0.3s ease;
        }

        @keyframes noteSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .note-page {
            background: var(--accent);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .note-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .note-delete {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }

        .note-card:hover .note-delete {
            opacity: 1;
        }

        .note-delete:hover {
            color: #C41E3A;
        }

        .empty-notes {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .empty-notes i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* TTS Controls */
        .tts-panel {
            position: fixed;
            bottom: -300px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: var(--bg-paper);
            border: 1px solid var(--border);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -5px 30px var(--shadow);
            transition: bottom 0.3s ease;
            z-index: 200;
        }

        .tts-panel.open {
            bottom: 0;
        }

        .tts-header {
            padding: 1rem 1.25rem;
            background: var(--chapter-bg);
            color: #F5E6D3;
            border-radius: 16px 16px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tts-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tts-close {
            background: none;
            border: none;
            color: #F5E6D3;
            font-size: 1.25rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .tts-close:hover {
            opacity: 1;
        }

        .tts-body {
            padding: 1.25rem;
        }

        .tts-main-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tts-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-paper);
            color: var(--text-primary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tts-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: scale(1.05);
        }

        .tts-btn.play-btn {
            width: 60px;
            height: 60px;
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            font-size: 1.5rem;
        }

        .tts-btn.play-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent-light);
            color: white;
        }

        .tts-btn.playing {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 var(--accent-glow); }
            50% { box-shadow: 0 0 0 15px transparent; }
        }

        .tts-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .tts-setting {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .tts-setting.full-width {
            grid-column: 1 / -1;
        }

        .tts-label {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .tts-value {
            color: var(--accent);
            font-weight: 600;
        }

        .tts-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }

        .tts-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .tts-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .tts-select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-paper);
            color: var(--text-primary);
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .tts-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Status Indicator */
        .tts-status {
            text-align: center;
            padding: 0.5rem;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.85rem;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            margin-top: 1rem;
        }

        .tts-status.speaking {
            color: var(--success);
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        .sidebar-overlay.visible {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .book-wrapper {
                margin-left: 0;
            }

            .notes-panel {
                width: 100%;
                right: -100%;
            }
        }

        @media (max-width: 600px) {
            .header {
                padding: 0.75rem 1rem;
            }

            .book-title {
                font-size: 1.1rem;
            }

            .header-btn span {
                display: none;
            }

            .book-page {
                padding: 1.5rem;
                border-radius: 0;
            }

            .chapter-title {
                font-size: 1.8rem;
            }

            .book-content {
                font-size: 1.05rem;
            }

            .book-content p:first-of-type::first-letter {
                font-size: 3rem;
            }

            .reader-container {
                padding: 1rem;
            }

            .page-nav {
                padding: 1rem;
                gap: 0.75rem;
            }

            .page-btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }

            .tts-panel {
                width: 100%;
                border-radius: 12px 12px 0 0;
            }

            .tts-settings {
                grid-template-columns: 1fr;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .book-loader {
            width: 80px;
            height: 60px;
            position: relative;
        }

        .book-loader::before,
        .book-loader::after {
            content: '';
            position: absolute;
            width: 35px;
            height: 50px;
            background: var(--accent);
            border-radius: 2px;
            transform-origin: bottom center;
        }

        .book-loader::before {
            left: 5px;
            animation: pageLeft 1s ease-in-out infinite;
        }

        .book-loader::after {
            right: 5px;
            animation: pageRight 1s ease-in-out infinite;
        }

        @keyframes pageLeft {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(-30deg); }
        }

        @keyframes pageRight {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(30deg); }
        }

        .loading-text {
            margin-top: 1.5rem;
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            color: var(--text-muted);
            animation: fadeInOut 1.5s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.95rem;
            box-shadow: 0 4px 20px var(--shadow-deep);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 300;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-paper);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px var(--shadow-deep);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .modal-text {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .modal-btn.cancel:hover {
            background: var(--border);
        }

        .modal-btn.confirm {
            background: #C41E3A;
            border: none;
            color: white;
        }

        .modal-btn.confirm:hover {
            background: #A01830;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="book-loader"></div>
        <div class="loading-text">Opening your book...</div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="book-title">
                <i class="fas fa-book-open"></i> Stardom Stories
            </div>
            <div class="header-controls">
                <button class="header-btn" id="menuToggle" title="Chapters">
                    <i class="fas fa-bars"></i>
                    <span>Chapters</span>
                </button>
                <button class="header-btn" id="ttsToggle" title="Read Aloud">
                    <i class="fas fa-headphones"></i>
                    <span>Listen</span>
                </button>
                <button class="header-btn" id="notesToggle" title="Notes">
                    <i class="fas fa-sticky-note"></i>
                    <span>Notes</span>
                </button>
            </div>
        </header>

        <div class="main-content">
            <!-- Sidebar Overlay for Mobile -->
            <div class="sidebar-overlay" id="sidebarOverlay"></div>

            <!-- Sidebar - Chapter Navigation -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-title">Table of Contents</div>
                <ul class="chapter-list" id="chapterList">
                    <!-- Chapters will be populated by JS -->
                </ul>
            </aside>

            <!-- Book Content Wrapper -->
            <div class="book-wrapper" id="bookWrapper">
                <div class="reader-container">
                    <article class="book-page" id="bookPage">
                        <!-- Content populated by JS -->
                    </article>
                </div>

                <!-- Page Navigation -->
                <nav class="page-nav">
                    <button class="page-btn" id="prevPage">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <div class="page-indicator">
                        Page <span id="currentPageNum">1</span> of <span id="totalPages">5</span>
                    </div>
                    <button class="page-btn" id="nextPage">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </nav>
            </div>
        </div>
    </div>

    <!-- Notes Panel -->
    <aside class="notes-panel" id="notesPanel">
        <div class="notes-header">
            <h3 class="notes-title">
                <i class="fas fa-sticky-note"></i> My Notes
            </h3>
            <button class="notes-close" id="notesClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notes-content" id="notesContent">
            <!-- Notes will be populated by JS -->
        </div>
        <div class="note-input-area">
            <textarea class="note-textarea" id="noteInput" placeholder="Write a note about what you're reading..."></textarea>
            <button class="note-add-btn" id="addNoteBtn">
                <i class="fas fa-plus"></i> Add Note
            </button>
        </div>
    </aside>

    <!-- TTS Panel -->
    <div class="tts-panel" id="ttsPanel">
        <div class="tts-header">
            <div class="tts-title">
                <i class="fas fa-volume-up"></i> Read Aloud
            </div>
            <button class="tts-close" id="ttsClose">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="tts-body">
            <div class="tts-main-controls">
                <button class="tts-btn" id="ttsRestart" title="Restart">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="tts-btn play-btn" id="ttsPlayPause" title="Play/Pause">
                    <i class="fas fa-play"></i>
                </button>
                <button class="tts-btn" id="ttsStop" title="Stop">
                    <i class="fas fa-stop"></i>
                </button>
            </div>
            <div class="tts-settings">
                <div class="tts-setting full-width">
                    <label class="tts-label">Voice</label>
                    <select class="tts-select" id="voiceSelect">
                        <option>Loading voices...</option>
                    </select>
                </div>
                <div class="tts-setting">
                    <label class="tts-label">
                        Speed <span class="tts-value" id="rateValue">1.0x</span>
                    </label>
                    <input type="range" class="tts-slider" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
                </div>
                <div class="tts-setting">
                    <label class="tts-label">
                        Pitch <span class="tts-value" id="pitchValue">1.0</span>
                    </label>
                    <input type="range" class="tts-slider" id="pitchSlider" min="0.5" max="2" step="0.1" value="1">
                </div>
            </div>
            <div class="tts-status" id="ttsStatus">Ready to read</div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Modal for confirmations -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h4 class="modal-title" id="modalTitle">Confirm</h4>
            <p class="modal-text" id="modalText">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="modalCancel">Cancel</button>
                <button class="modal-btn confirm" id="modalConfirm">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Book Data
        const bookData = {
            title: "Stardom Stories",
            chapters: [
                { id: 1, title: "Dusk...", available: true },
                { id: 2, title: "Chapter 2", available: false },
                { id: 3, title: "Chapter 3", available: false },
                { id: 4, title: "Chapter 4", available: false },
                { id: 5, title: "Chapter 5", available: false },
                { id: 6, title: "Chapter 6", available: false },
                { id: 7, title: "Chapter 7", available: false },
                { id: 8, title: "Chapter 8", available: false },
                { id: 9, title: "Chapter 9", available: false },
                { id: 10, title: "Chapter 10", available: false },
                { id: 11, title: "Chapter 11", available: false },
                { id: 12, title: "Chapter 12", available: false }
            ],
            pages: {
                1: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p>Something seemed unusual in the way the principal walked to the podium from the back of the assembly. He moved his tall frame rather ponderously. He was not as smart as he used to be. The trademark morning smile was not forthcoming. He took the microphone from Angel, the chapel prefect, and held it, saying nothing. This was in spite of the fact that the morning's pep talk was over, and everyone was excited. All waited for the principal to speak. But the man looked blankly above the students' heads, instead of compellingly into their eyes, the way he used to. He made an attempt to talk; yet words did not come. His head dropped over his broad shoulders as he began to stare at the colourful tiles on the floor.</p>

<p>There was a heavy silence. The principal, again, attempted to speak. Tears! Everyone saw them. Tears trickled out of his eyes. He made yet another attempt to produce words. This time, the microphone dropped on the floor, sending a <span class="keyword">vexatious<span class="keyword-tooltip"><span class="tooltip-word">Vexatious</span><span class="tooltip-definition">Causing annoyance, frustration, or worry; troublesome</span></span></span> clatter out of the twin sound boxes at the assembly. More tears streamed from both eyes, <span class="keyword">conspicuously<span class="keyword-tooltip"><span class="tooltip-word">Conspicuously</span><span class="tooltip-definition">In a clearly visible or obvious manner; attracting attention</span></span></span> rolling down his sunken cheeks. Dozens of perplexed eyes—students' and staff's—fixed on him. There was nowhere to hide from the puzzled looks. Then Mr. Bepo Adewale hid in the only available space. He brought his palms together, like a <span class="keyword">supplicant<span class="keyword-tooltip"><span class="tooltip-word">Supplicant</span><span class="tooltip-definition">A person who humbly begs or pleads for something</span></span></span>, and shielded his face.</p>

<p>The first person who found a voice was the Vice Principal, Mrs. Grace Apeh. "What is the matter, principal?" she asked, moving to his side. Four other members of staff joined her. But the principal said nothing. Instead, he sobbed freely. The school nurse, Mrs. Titi, fetched a handkerchief and offered it to the weeper.</p>

<p>"Please, conclude the assembly and let the students go into their classes immediately," the VP instructed the Chemistry teacher, Mr. Justus Anabel. Mrs. Apeh, the nurse, and Mr. Oyelana, the CRK teacher, started walking the principal back to his office, his face still buried in his palms, sobbing, even more <span class="keyword">agitatedly<span class="keyword-tooltip"><span class="tooltip-word">Agitatedly</span><span class="tooltip-definition">In a troubled, disturbed, or anxious manner</span></span></span>. "Sir, what is the matter?" "Mrs. Titi—or Nurse Titi, as she was fondly called—asked, as they helped Bepo to his chair in the office. "Is anything the matter?" she asked, as they helped Bepo did not utter a word. The tears did not stop flowing either. At 8:05am, more teachers arrived to console the sobbing principal or possibly lend a helping hand. But the VP advised they go to their classes, exempting the guidance counsellor, Mrs. Beke Egbin.</p>`
                },
                2: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p><span class="keyword">Consolations<span class="keyword-tooltip"><span class="tooltip-word">Consolations</span><span class="tooltip-definition">Comfort or words of comfort given to someone in distress</span></span></span> and questions resumed. For over 30 minutes, they petted Bepo. All the while, he sobbed. Occasionally, he would shake his head. He would look at the ceiling and at the faces before him, as though he had just returned from a dreamy wonderland. Then he would plunge further in tears. The VP's phone, meanwhile, had been ringing. Information had already reached some parents. They were anxious to know what had happened to the beloved <span class="keyword">principal<span class="keyword-tooltip"><span class="tooltip-word">Principal</span><span class="tooltip-definition">The head teacher or chief administrator of a school</span></span></span>. One parent learnt he was weeping uncontrollably and rolling on the floor. Another parent heard that he kept muttering, 'Oluwa da mi o! Save me, O God!' At this point, Mrs. Apeh realised the best she could do was to call the Managing Director, Mrs. Ibidun Gloss, popularly called MD, who—but for a function she had to attend that morning—ought to have been in school.</p>

<p>But the morning assembly had not begun on a tearful note. Since the management of Stardom Schools came up with a shrewd <span class="keyword">incentive<span class="keyword-tooltip"><span class="tooltip-word">Incentive</span><span class="tooltip-definition">Something that motivates or encourages someone to do something</span></span></span> of lowering its boarding fees, the headache it used to have, trying to tame lateness, had reduced greatly. From N250,000 per session, the fee climbed down to N165,000. The result was instant: more than 80 per cent of the parents moved their wards to the boarding house, which was a haven of modest comfort enjoyed by elite students. Almost all the students began to turn up at 7:45am for the assembly.</p>

<p>That was far from the case before the policy change. Many of the learners came from different parts of Lagos, where the fear of heavy traffic was the beginning of wisdom. Interestingly, not many parents complained when the school, almost immediately, raised the fee for 'Excursion and Other Items' by N93,000. Some staff gossiped about this, especially Mr. Audu, the Fine Arts teacher, who was a bunch of oily humour. He cleared his throat, pushed a finger into his mouth, drew it out, and pointed skywards: "In matters of economics," he quipped, "I swear, the MD is 'a witch' and wizard rolled into one!" And the auditors laughed at his grammar.</p>

<p>The assembly had commenced early. The A-List school, located in the posh heart of Lekki, as usual began the <span class="keyword">ritual<span class="keyword-tooltip"><span class="tooltip-word">Ritual</span><span class="tooltip-definition">A ceremony or series of acts regularly repeated in a set precise manner</span></span></span> with a short prayer, in the form of a recitation of the second stanza of Nigeria's National Anthem: 'Oh God of creation, direct our noble cause...' Stardom did this on Tuesdays and Thursdays, while normal Christian and Muslim prayers were said on Mondays, Wednesdays and Fridays, alongside the National Anthem (first stanza). On Tuesdays and Thursdays, the assembly adopted the second stanza as prayer. It did not bother to recite the first but simply went straight to the school's anthem.</p>

<p>Angel announced it was time for the pep talk. The principal had introduced this, seven years earlier. It involved the presentation of a speech by a student. It was spontaneous, at times. At other times, topics were given ahead. Today's talk was, however, different: the way it sometimes, happened. Ikenna Egbu, an SS3</p>`
                },
                3: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p>1 student, mounted the <span class="keyword">podium<span class="keyword-tooltip"><span class="tooltip-word">Podium</span><span class="tooltip-definition">A raised platform or stage from which a person gives a speech</span></span></span> to narrate his experience. He was part of a group of Stardom students that had just returned from an excursion to Jos, Plateau State.</p>

<p>"I saw Nigeria in its <span class="keyword">acrobatic<span class="keyword-tooltip"><span class="tooltip-word">Acrobatic</span><span class="tooltip-definition">Involving or requiring spectacular physical movements; here used metaphorically to mean striking or impressive</span></span></span> beauty," he began, awakening cheers and applause. "My fellow students, if you have not been to Jos..." Ikenna paused and browsed their excited faces, as though he wanted to be sure they were really ready for the discoveries he was about to log into. He continued: "You might have been to London, you might have been to New York. But if you have not been to Jos, you MUST be in that brilliantly beautiful city in YOUR lifetime!" Yells and an applause graced the narrative.</p>

<p>"One of the most memorable attributes of Jos is its very lovely weather," Ikenna said. "Although we are in the dry season, Jos welcomed us with very cool arms. So chilly is Jos that I felt like sleeping every second of the two days we spent there. I can also not forget its acrobatic landscape. Not in any negative sense, but with rocks that sit in artistic layers and, at times, in dramatic postures. You could see a rock carrying three other rocks on its head. You could find a small rock confidently backing another, big enough to give birth to it."</p>

<p>Another round of ovation. The narrator paused. He continued: "Dearest Stars of Stardom, some of our hosts said Jos used to be more beautiful than what we saw, and that some violent crises had affected it. Notwithstanding, I can still confidently say it remains the leading tourism city in this country. No wonder, many important white men were said to have lived there during the colonial period."</p>

<p>Ikenna named some of the places the group visited, such as the <span class="keyword">Lamingo<span class="keyword-tooltip"><span class="tooltip-word">Lamingo Dam</span><span class="tooltip-definition">A reservoir in Jos, Plateau State, used for water supply and as a recreational site</span></span></span> Dam, the University of Jos, the Shere Hills, Wase Rocks and the Solomon Lar Amusement Park. "If I have the opportunity in future, I will like to settle down in Jos, instead of japa-ing to Canada or London!" A mixed, yet fun-filled round of clapping and hollering filled everywhere as Ikenna returned and joined his classmates on the line.</p>

<p>The chapel prefect then called for <span class="keyword">decorum<span class="keyword-tooltip"><span class="tooltip-word">Decorum</span><span class="tooltip-definition">Behavior in keeping with good taste and propriety; dignity and correctness</span></span></span> and orderliness, inviting the principal for his address and announcement. Although Ikenna was a science student, he was, equally, a respected poet. His mum, a broadcaster, was an award-winning poet too. Following the young boy's captivating account, many students and staff expected a great comment from the principal, who had been an inspiring pillar at Stardom for 24 years. His impact had been so remarkable that his employers, parents and other stakeholders regarded him as a school builder. He gave the students his all, with an ever-burning passion to see them grow in all <span class="keyword">ramifications<span class="keyword-tooltip"><span class="tooltip-word">Ramifications</span><span class="tooltip-definition">The complex consequences or outgrowths of an action, decision, or event; branches or subdivisions</span></span></span>.</p>

<p>On a day like this, he would be on top of the world. He would regard</p>`
                },
                4: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p>Ikenna's outing as evidence of the good education Stardom offered, and which, he believed, every Nigerian child deserved. The students also expected him to highlight some terms Ikenna might not have <span class="keyword">articulated<span class="keyword-tooltip"><span class="tooltip-word">Articulated</span><span class="tooltip-definition">Expressed clearly and distinctly; spoke with precision</span></span></span> so well. They were eager to hear something special from the tall, light-skinned principal, nicknamed 'the Lekki Headmaster', because of the way he used to imitate characters in the old TV drama, Village Headmaster, when he was Headmaster at Stardom Kiddies. It was his funny way of amusing the pupils. Sometimes, Stardom students called him 'Principo', because he never got tired of saying the pronunciation of 'principal' should not end with 'pa'. It's "PrinciPL," Bepo would emphasize.</p>

<p>But of course, Mr. Bepo, this morning, was not on top of the world: he was under the world ot tears.</p>

<p>At her office on the second floor of the Admin Building, the MD aimlessly removed her glasses and aimlessly dropped them on a tea stool by her right. She never envisaged the frustration fast becoming what, ordinarily, should have been a pleasant morning. She had driven down to school hurriedly, after the VP raised the alarm about the principal's strange behaviour.</p>

<p>Only the previous day, the school had celebrated its over 90 percent success in the last West African Senior School Certificate Examination (WASSCE). The event ought to have held earlier, but it was postponed because the management could not immediately decide on the star prizes it wished to give. The school surprised all members of staff with snacks, bottles of wine, and N20,000 each for all SS3 3 teachers. Those who handled subjects where candidates scored distinctions, however, took home N30,000 each. The only teachers who had questions to answer were Mr. Obong Ukaku and Miss Taye Kareem, in whose subjects—Chemistry and Geography, respectively—two candidates had Ds. But all the teachers escaped real trouble as no candidate scored F9. At Stardom, consider yourself sacked if any of the students you presented for WASSCE or NECO recorded F9. The previous year, not even a cousin of the MD, Mr. Funso Daniels, was spared an abrupt exit.</p>

<p>Following her arrival at about 9:30am, the MD had invited Bepo to her office, asking what the problem was. Thirty-something minutes later, he had yet to state any reason for his <span class="keyword">distraught<span class="keyword-tooltip"><span class="tooltip-word">Distraught</span><span class="tooltip-definition">Deeply upset and agitated; extremely troubled</span></span></span> disposition. Instead, he kept muttering: "Thank you. I will be all right."</p>

<p>"Mr. Bepo, you keep saying you will be alright, but you are not saying what the problem is. You are aware that, given your position in this school and the excellent performance you have always put up, you are central to everything that goes on. You are supposed to be the embodiment of sanity, the balm to troubled nerves. In many cases, those are what you have been. But why would you suddenly turn the source of our anxiety?"</p>`
                },
                5: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p>"Madam, I..." the principal managed to say, then broke down again. The MD became more agitated. She picked one of the three handsets on her table. She made a call, which, three minutes later, produced the Physics teacher, Mr. Ope Wande, who was also a pastor.</p>

<p>"I am here, ma," Wande said as he walked in. He had missed the morning assembly, and besides the gists gathered from colleagues, he was only seeing Bepo for the first time in the day. "Principal, I hope all is well," he asked.</p>

<p>"Not really. And that is why I invited you," the MD said. Wande stooped beside the principal and began to speak to him in a subdued voice. He asked what the real matter was, and assured he would keep secret whatever information Mr. Bepo gave concerning his plight. Just like the MD had done, the pastor-teacher also reminded Bepo of his cardinal position in the school, and the fact that news of the matter had already begun swirling, miles away from the premises.</p>

<p>Wande spoke to the upset principal for close to 10 minutes. Realising he might have been talking to a brick wall, he turned back to the MD and said, "Ma, have we called Mr. Bepo's wife? I think we need to. And urgently too." Mrs. Ibidun Gloss did not object to the advice. She asked the principal for his wife's phone number. This, Mr. Bepo wrote on the back of a card fetched from the breast pocket of his grey suit. The MD studied the card, <span class="keyword">hesitatingly<span class="keyword-tooltip"><span class="tooltip-word">Hesitatingly</span><span class="tooltip-definition">In an uncertain or hesitant manner; with doubt or reluctance</span></span></span>, before dialling. It was an international number.</p>

<p>"Principal's wife now lives in London, ma," Wande affirmed.</p>

<p>"I should know. I wonder if he is not missing her badly," the MD said. The comment was supposed to be a joke. Yet, it elicited no laughter. None of the two lines the MD dialled rang. "Pastor, please, accompany the principal to his office. I think he has to go home, really," she said.</p>

<p>"I understand," Pastor Wande said. "But I think there is a little problem that it might not be a very good idea if he is left to go alone in this <span class="keyword">circumstance<span class="keyword-tooltip"><span class="tooltip-word">Circumstance</span><span class="tooltip-definition">A condition or fact that affects a situation; the existing conditions or state of affairs</span></span></span>."</p>

<p>The MD understood the sentiment in the teacher's fear. But she felt pressed to move the drama away from the school as soon as possible. What would the parents think if they learnt the principal was weeping like a child? The school, an impatient spirit told her, <em>was not a rehabilitation centre but a place for learning and earning money</em>.</p>

<p>"Please, guide him to his office and arrange to take him home," she said, emphatically, adding: "I learnt that the guidance counsellor was with him earlier. Perhaps, he can go with him. He might also visit the clinic ASAP."</p>`
                }
            }
        };

        // Keywords dictionary for future pages
        const keywordDefinitions = {
            'vexatious': 'Causing annoyance, frustration, or worry; troublesome',
            'conspicuously': 'In a clearly visible or obvious manner; attracting attention',
            'supplicant': 'A person who humbly begs or pleads for something',
            'agitatedly': 'In a troubled, disturbed, or anxious manner',
            'consolations': 'Comfort or words of comfort given to someone in distress',
            'principal': 'The head teacher or chief administrator of a school',
            'incentive': 'Something that motivates or encourages someone to do something',
            'ritual': 'A ceremony or series of acts regularly repeated in a set precise manner',
            'podium': 'A raised platform or stage from which a person gives a speech',
            'acrobatic': 'Involving or requiring spectacular physical movements',
            'lamingo': 'A reservoir in Jos, Plateau State, used for water supply',
            'decorum': 'Behavior in keeping with good taste and propriety',
            'ramifications': 'The complex consequences or outgrowths of an action',
            'articulated': 'Expressed clearly and distinctly',
            'distraught': 'Deeply upset and agitated; extremely troubled',
            'hesitatingly': 'In an uncertain or hesitant manner',
            'circumstance': 'A condition or fact that affects a situation'
        };

        // App State
        let currentPage = 1;
        let currentChapter = 1;
        const totalPages = Object.keys(bookData.pages).length;
        let notes = [];
        let speechAPI = null;

        // Speech API using Web Speech API
        class WebSpeechAPI {
            constructor() {
                this.synth = window.speechSynthesis;
                this.voices = [];
                this.currentUtterance = null;
                this.loadVoices();

                if (this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = () => this.loadVoices();
                }
            }

            loadVoices() {
                this.voices = this.synth.getVoices();
                this.populateVoiceSelect();
            }

            populateVoiceSelect() {
                const voiceSelect = document.getElementById('voiceSelect');
                if (!voiceSelect || this.voices.length === 0) return;

                voiceSelect.innerHTML = '';

                const groupedVoices = {};
                this.voices.forEach((voice, index) => {
                    const lang = voice.lang.split('-')[0];
                    if (!groupedVoices[lang]) groupedVoices[lang] = [];
                    groupedVoices[lang].push({ voice, index });
                });

                const englishVoices = groupedVoices['en'] || [];
                englishVoices.forEach(({ voice, index }) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (voice.default) option.selected = true;
                    voiceSelect.appendChild(option);
                });

                Object.keys(groupedVoices).forEach(lang => {
                    if (lang === 'en') return;
                    const langVoices = groupedVoices[lang];
                    if (langVoices.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = `${lang.toUpperCase()} Voices`;
                        langVoices.forEach(({ voice, index }) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            optgroup.appendChild(option);
                        });
                        voiceSelect.appendChild(optgroup);
                    }
                });

                if (this.voices.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'No voices available';
                    voiceSelect.appendChild(option);
                }
            }

            speak(text, options = {}) {
                return new Promise((resolve, reject) => {
                    if (!this.synth) {
                        reject(new Error('Speech synthesis not supported'));
                        return;
                    }

                    this.stop();

                    const utterance = new SpeechSynthesisUtterance(text);

                    const voiceIndex = options.voiceIndex || document.getElementById('voiceSelect').value;
                    if (voiceIndex && this.voices[voiceIndex]) {
                        utterance.voice = this.voices[voiceIndex];
                    }

                    utterance.rate = options.rate || parseFloat(document.getElementById('rateSlider').value);
                    utterance.pitch = options.pitch || parseFloat(document.getElementById('pitchSlider').value);
                    utterance.volume = 1;

                    utterance.onend = () => {
                        this.currentUtterance = null;
                        resolve();
                    };

                    utterance.onerror = (event) => {
                        this.currentUtterance = null;
                        reject(new Error(`Speech synthesis error: ${event.error}`));
                    };

                    this.currentUtterance = utterance;
                    this.synth.speak(utterance);
                });
            }

            stop() {
                if (this.synth && this.synth.speaking) {
                    this.synth.cancel();
                }
                this.currentUtterance = null;
            }

            pause() {
                if (this.synth && this.synth.speaking) {
                    this.synth.pause();
                }
            }

            resume() {
                if (this.synth && this.synth.paused) {
                    this.synth.resume();
                }
            }

            isSpeaking() {
                return this.synth && this.synth.speaking;
            }

            isPaused() {
                return this.synth && this.synth.paused;
            }
        }

        // DOM Elements
        const elements = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            menuToggle: document.getElementById('menuToggle'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebarOverlay'),
            bookWrapper: document.getElementById('bookWrapper'),
            chapterList: document.getElementById('chapterList'),
            bookPage: document.getElementById('bookPage'),
            prevPage: document.getElementById('prevPage'),
            nextPage: document.getElementById('nextPage'),
            currentPageNum: document.getElementById('currentPageNum'),
            totalPages: document.getElementById('totalPages'),
            notesToggle: document.getElementById('notesToggle'),
            notesPanel: document.getElementById('notesPanel'),
            notesClose: document.getElementById('notesClose'),
            notesContent: document.getElementById('notesContent'),
            noteInput: document.getElementById('noteInput'),
            addNoteBtn: document.getElementById('addNoteBtn'),
            ttsToggle: document.getElementById('ttsToggle'),
            ttsPanel: document.getElementById('ttsPanel'),
            ttsClose: document.getElementById('ttsClose'),
            ttsPlayPause: document.getElementById('ttsPlayPause'),
            ttsStop: document.getElementById('ttsStop'),
            ttsRestart: document.getElementById('ttsRestart'),
            ttsStatus: document.getElementById('ttsStatus'),
            rateSlider: document.getElementById('rateSlider'),
            rateValue: document.getElementById('rateValue'),
            pitchSlider: document.getElementById('pitchSlider'),
            pitchValue: document.getElementById('pitchValue'),
            toast: document.getElementById('toast'),
            modalOverlay: document.getElementById('modalOverlay'),
            modalTitle: document.getElementById('modalTitle'),
            modalText: document.getElementById('modalText'),
            modalCancel: document.getElementById('modalCancel'),
            modalConfirm: document.getElementById('modalConfirm')
        };

        // Initialize App
        function init() {
            speechAPI = new WebSpeechAPI();

            elements.totalPages.textContent = totalPages;

            renderChapterList();
            renderPage(currentPage);
            renderNotes();
            setupEventListeners();

            // Hide loading after a short delay
            setTimeout(() => {
                elements.loadingOverlay.classList.add('hidden');
            }, 1000);
        }

        // Render Chapter List
        function renderChapterList() {
            elements.chapterList.innerHTML = '';

            bookData.chapters.forEach(chapter => {
                const li = document.createElement('li');
                li.className = `chapter-item ${chapter.id === currentChapter ? 'active' : ''} ${!chapter.available ? 'locked' : ''}`;
                li.innerHTML = `
                    <span class="chapter-number">${chapter.id}</span>
                    <span>${chapter.title}</span>
                    ${!chapter.available ? '<i class="fas fa-lock" style="margin-left: auto; opacity: 0.5;"></i>' : ''}
                `;

                if (chapter.available) {
                    li.addEventListener('click', () => {
                        navigateToChapter(chapter.id);
                    });
                }

                elements.chapterList.appendChild(li);
            });
        }

        // Navigate to Chapter
        function navigateToChapter(chapterId) {
            // Find first page of this chapter
            for (let pageNum in bookData.pages) {
                if (bookData.pages[pageNum].chapter === chapterId) {
                    currentPage = parseInt(pageNum);
                    currentChapter = chapterId;
                    renderPage(currentPage);
                    renderChapterList();
                    closeSidebar();
                    break;
                }
            }
        }

        // Render Page
        function renderPage(pageNum) {
            const pageData = bookData.pages[pageNum];
            if (!pageData) return;

            elements.bookPage.innerHTML = `
                <div class="chapter-heading">Chapter ${pageData.chapter}</div>
                <h1 class="chapter-title">${pageData.chapterTitle}</h1>
                <div class="book-content">${pageData.content}</div>
            `;

            elements.currentPageNum.textContent = pageNum;
            elements.prevPage.disabled = pageNum === 1;
            elements.nextPage.disabled = pageNum === totalPages;

            // Scroll to top of reader
            document.querySelector('.reader-container').scrollTop = 0;

            // Stop any ongoing speech when changing pages
            if (speechAPI && speechAPI.isSpeaking()) {
                speechAPI.stop();
                updateTTSUI(false);
            }
        }

        // Notes Functions
        function renderNotes() {
            if (notes.length === 0) {
                elements.notesContent.innerHTML = `
                    <div class="empty-notes">
                        <i class="fas fa-book-reader"></i>
                        <p>No notes yet.<br>Start taking notes as you read!</p>
                    </div>
                `;
                return;
            }

            // Sort notes by page number
            const sortedNotes = [...notes].sort((a, b) => a.page - b.page);

            elements.notesContent.innerHTML = sortedNotes.map((note, index) => `
                <div class="note-card" data-index="${notes.indexOf(note)}">
                    <button class="note-delete" title="Delete note">
                        <i class="fas fa-trash"></i>
                    </button>
                    <div class="note-meta">
                        <span class="note-page">Page ${note.page}</span>
                        <span>${note.timestamp}</span>
                    </div>
                    <div class="note-text">${escapeHtml(note.text)}</div>
                </div>
            `).join('');

            // Add delete handlers
            document.querySelectorAll('.note-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const card = e.target.closest('.note-card');
                    const index = parseInt(card.dataset.index);
                    showConfirmModal(
                        'Delete Note',
                        'Are you sure you want to delete this note?',
                        () => {
                            deleteNote(index);
                        }
                    );
                });
            });
        }

        function addNote() {
            const text = elements.noteInput.value.trim();
            if (!text) {
                showToast('Please write something first');
                return;
            }

            const note = {
                text: text,
                page: currentPage,
                chapter: currentChapter,
                timestamp: new Date().toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };

            notes.push(note);
            elements.noteInput.value = '';
            renderNotes();
            showToast('Note added successfully!');
        }

        function deleteNote(index) {
            notes.splice(index, 1);
            renderNotes();
            showToast('Note deleted');
        }

        // TTS Functions
        function getPageText() {
            const content = document.querySelector('.book-content');
            if (!content) return '';
            return content.innerText;
        }

        function updateTTSUI(isPlaying) {
            const icon = elements.ttsPlayPause.querySelector('i');
            if (isPlaying) {
                icon.className = 'fas fa-pause';
                elements.ttsPlayPause.classList.add('playing');
                elements.ttsStatus.textContent = 'Reading aloud...';
                elements.ttsStatus.classList.add('speaking');
            } else {
                icon.className = 'fas fa-play';
                elements.ttsPlayPause.classList.remove('playing');
                elements.ttsStatus.textContent = 'Ready to read';
                elements.ttsStatus.classList.remove('speaking');
            }
        }

        async function togglePlayPause() {
            if (!speechAPI) return;

            if (speechAPI.isSpeaking()) {
                if (speechAPI.isPaused()) {
                    speechAPI.resume();
                    updateTTSUI(true);
                } else {
                    speechAPI.pause();
                    const icon = elements.ttsPlayPause.querySelector('i');
                    icon.className = 'fas fa-play';
                    elements.ttsStatus.textContent = 'Paused';
                }
            } else {
                const text = getPageText();
                if (!text) {
                    showToast('No text to read');
                    return;
                }

                updateTTSUI(true);

                try {
                    await speechAPI.speak(text);
                    updateTTSUI(false);
                } catch (err) {
                    console.error('TTS Error:', err);
                    updateTTSUI(false);
                    showToast('Failed to read text');
                }
            }
        }

        function stopSpeech() {
            if (speechAPI) {
                speechAPI.stop();
                updateTTSUI(false);
            }
        }

        function restartSpeech() {
            stopSpeech();
            setTimeout(() => {
                togglePlayPause();
            }, 100);
        }

        // UI Helpers
        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSidebar() {
            const isOpen = elements.sidebar.classList.contains('open');
            if (isOpen) {
                closeSidebar();
            } else {
                elements.sidebar.classList.add('open');
                elements.sidebarOverlay.classList.add('visible');
            }
        }

        function closeSidebar() {
            elements.sidebar.classList.remove('open');
            elements.sidebarOverlay.classList.remove('visible');
        }

        function toggleNotesPanel() {
            elements.notesPanel.classList.toggle('open');
            if (elements.notesPanel.classList.contains('open')) {
                elements.notesToggle.classList.add('active');
            } else {
                elements.notesToggle.classList.remove('active');
            }
        }

        function toggleTTSPanel() {
            elements.ttsPanel.classList.toggle('open');
            if (elements.ttsPanel.classList.contains('open')) {
                elements.ttsToggle.classList.add('active');
            } else {
                elements.ttsToggle.classList.remove('active');
            }
        }

        // Modal functions
        let modalCallback = null;

        function showConfirmModal(title, text, onConfirm) {
            elements.modalTitle.textContent = title;
            elements.modalText.textContent = text;
            modalCallback = onConfirm;
            elements.modalOverlay.classList.add('visible');
        }

        function hideModal() {
            elements.modalOverlay.classList.remove('visible');
            modalCallback = null;
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            elements.prevPage.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    const pageData = bookData.pages[currentPage];
                    if (pageData && pageData.chapter !== currentChapter) {
                        currentChapter = pageData.chapter;
                        renderChapterList();
                    }
                    renderPage(currentPage);
                }
            });

            elements.nextPage.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    const pageData = bookData.pages[currentPage];
                    if (pageData && pageData.chapter !== currentChapter) {
                        currentChapter = pageData.chapter;
                        renderChapterList();
                    }
                    renderPage(currentPage);
                }
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

                if (e.key === 'ArrowLeft' && currentPage > 1) {
                    elements.prevPage.click();
                } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
                    elements.nextPage.click();
                }
            });

            // Sidebar
            elements.menuToggle.addEventListener('click', toggleSidebar);
            elements.sidebarOverlay.addEventListener('click', closeSidebar);

            // Notes Panel
            elements.notesToggle.addEventListener('click', toggleNotesPanel);
            elements.notesClose.addEventListener('click', toggleNotesPanel);
            elements.addNoteBtn.addEventListener('click', addNote);

            elements.noteInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    addNote();
                }
            });

            // TTS Panel
            elements.ttsToggle.addEventListener('click', toggleTTSPanel);
            elements.ttsClose.addEventListener('click', toggleTTSPanel);
            elements.ttsPlayPause.addEventListener('click', togglePlayPause);
            elements.ttsStop.addEventListener('click', stopSpeech);
            elements.ttsRestart.addEventListener('click', restartSpeech);

            // TTS Settings
            elements.rateSlider.addEventListener('input', (e) => {
                elements.rateValue.textContent = `${e.target.value}x`;
            });

            elements.pitchSlider.addEventListener('input', (e) => {
                elements.pitchValue.textContent = e.target.value;
            });

            // Modal
            elements.modalCancel.addEventListener('click', hideModal);
            elements.modalConfirm.addEventListener('click', () => {
                if (modalCallback) {
                    modalCallback();
                }
                hideModal();
            });
            elements.modalOverlay.addEventListener('click', (e) => {
                if (e.target === elements.modalOverlay) {
                    hideModal();
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

