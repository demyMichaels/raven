<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lekki Headmaster - Book Reader</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: "#0F2C59",
                            50: "#f0f3f8",
                            100: "#d6e1ee",
                            500: "#0F2C59",
                            600: "#0a2549",
                            700: "#081e39",
                        },
                        accent: {
                            DEFAULT: "#009F9D",
                            50: "#e6f7f7",
                            100: "#b3ebea",
                            500: "#009F9D",
                            600: "#008280",
                            700: "#006663",
                        },
                        neutral: {
                            25: "#FEFEFE",
                            50: "#F8F9FA",
                            100: "#F1F3F4",
                            200: "#E8EAED",
                            300: "#DADCE0",
                            400: "#BDC1C6",
                            500: "#9AA0A6",
                            600: "#80868B",
                            700: "#5F6368",
                            800: "#2D3748",
                            900: "#1F2937",
                        },
                        premium: {
                            DEFAULT: "#D2C1A7",
                            50: "#fbf9f6",
                            100: "#f4efe6",
                            500: "#D2C1A7",
                        },
                        success: "#22c55e",
                        warning: "#f59e0b",
                        error: "#ef4444",
                    },
                    fontFamily: {
                        'sans': ['Roboto', 'system-ui', 'sans-serif'],
                        'serif': ['Merriweather', 'Georgia', 'serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', system-ui, sans-serif;
            line-height: 1.6;
        }

        /* Material Design Shadows */
        .shadow-material-1 { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
        .shadow-material-2 { box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23); }
        .shadow-material-3 { box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23); }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes bookOpen {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(-20deg); }
        }

        /* Book Content Styling */
        .book-content {
            font-family: 'Merriweather', Georgia, serif;
            font-size: 1.1rem;
            line-height: 1.9;
            text-align: justify;
            hyphens: auto;
        }

        .book-content p {
            margin-bottom: 1.5rem;
            text-indent: 2rem;
        }

        .book-content p:first-of-type {
            text-indent: 0;
        }

        .book-content p:first-of-type::first-letter {
            font-size: 3.5rem;
            float: left;
            line-height: 0.8;
            margin-right: 0.5rem;
            margin-top: 0.1rem;
            font-weight: 700;
            color: #009F9D;
        }

        .dark .book-content p:first-of-type::first-letter {
            color: #009F9D;
        }

        /* Keyword Tooltips */
        .keyword {
            background: linear-gradient(to bottom, transparent 60%, rgba(0, 159, 157, 0.2) 60%);
            cursor: help;
            position: relative;
            transition: all 0.2s;
            padding: 0 2px;
        }

        .keyword:hover {
            background: rgba(0, 159, 157, 0.3);
            border-radius: 2px;
        }

        .keyword-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: white;
            border: 2px solid #009F9D;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-family: 'Roboto', sans-serif;
            font-style: normal;
            text-indent: 0;
            text-align: left;
            white-space: normal;
            width: 250px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.19);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
            pointer-events: none;
        }

        .dark .keyword-tooltip {
            background: #1F2937;
            border-color: #009F9D;
        }

        .keyword:hover .keyword-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        .keyword-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #009F9D;
        }

        .tooltip-word {
            font-weight: 600;
            color: #009F9D;
            margin-bottom: 0.25rem;
            display: block;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #F1F3F4;
        }

        .dark ::-webkit-scrollbar-track {
            background: #1F2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #BDC1C6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9AA0A6;
        }

        /* TTS Speaking Animation */
        .speaking-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: speakingPulse 1.4s infinite ease-in-out;
        }

        .speaking-dot:nth-child(2) { animation-delay: 0.2s; }
        .speaking-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes speakingPulse {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        /* Note Card Animation */
        @keyframes noteSlide {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .note-card-animate {
            animation: noteSlide 0.3s ease;
        }

        /* Book loader */
        .book-loader {
            width: 60px;
            height: 50px;
            position: relative;
        }

        .book-loader::before,
        .book-loader::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 40px;
            background: #009F9D;
            border-radius: 2px;
            transform-origin: bottom center;
        }

        .book-loader::before {
            left: 5px;
            animation: bookOpen 1s ease-in-out infinite;
        }

        .book-loader::after {
            right: 5px;
            animation: bookOpen 1s ease-in-out infinite reverse;
        }

        /* Slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #E8EAED;
            border-radius: 3px;
            outline: none;
        }

        .dark input[type="range"] {
            background: #374151;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #009F9D;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .book-content {
                font-size: 1rem;
                line-height: 1.8;
            }

            .book-content p:first-of-type::first-letter {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 text-neutral-800 dark:text-neutral-100 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-neutral-50 dark:bg-neutral-900 flex flex-col items-center justify-center z-[1000] transition-opacity duration-500">
        <div class="book-loader"></div>
        <p class="mt-6 text-neutral-600 dark:text-neutral-400 animate-pulse">Opening your book...</p>
    </div>

    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-primary-500 text-white px-4 py-3 flex items-center justify-between shadow-material-2 sticky top-0 z-50">
            <div class="flex items-center gap-2">
                <span class="material-icons">menu_book</span>
                <h1 class="text-lg md:text-xl font-medium tracking-wide">The Lekki Headmaster</h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="menuToggle" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="Chapters">
                    <span class="material-icons">list</span>
                </button>
                <button id="ttsToggle" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="Read Aloud">
                    <span class="material-icons">headphones</span>
                </button>
                <button id="notesToggle" class="p-2 rounded-full hover:bg-white/10 transition-colors" title="Notes">
                    <span class="material-icons">sticky_note_2</span>
                </button>
            </div>
        </header>

        <div class="flex flex-1 relative">
            <!-- Sidebar Overlay -->
            <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

            <!-- Sidebar -->
            <aside id="sidebar" class="fixed left-0 top-[52px] bottom-0 w-72 bg-white dark:bg-neutral-800 border-r border-neutral-200 dark:border-neutral-700 z-50 transform -translate-x-full transition-transform duration-300 overflow-y-auto">
                <div class="p-4">
                    <h2 class="text-xs font-medium uppercase tracking-widest text-neutral-500 dark:text-neutral-400 mb-4 pb-2 border-b-2 border-accent-500">Table of Contents</h2>
                    <ul id="chapterList" class="space-y-1"></ul>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col">
                <div id="readerContainer" class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto">
                    <article id="bookPage" class="max-w-3xl mx-auto bg-white dark:bg-neutral-800 rounded-lg shadow-material-2 p-6 md:p-8 lg:p-10 min-h-[500px] relative fade-in">
                        <!-- Content populated by JS -->
                    </article>
                </div>

                <!-- Page Navigation -->
                <nav id="pageNav" class="flex items-center justify-center gap-4 md:gap-6 px-4 py-4 bg-neutral-100 dark:bg-neutral-800 border-t border-neutral-200 dark:border-neutral-700">
                    <button id="prevPage" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-neutral-700 border border-neutral-300 dark:border-neutral-600 rounded-lg text-sm font-medium text-neutral-700 dark:text-neutral-200 hover:bg-accent-500 hover:text-white hover:border-accent-500 transition-all disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:text-neutral-700 dark:disabled:hover:bg-neutral-700 dark:disabled:hover:text-neutral-200">
                        <span class="material-icons text-lg">chevron_left</span>
                        <span class="hidden sm:inline">Previous</span>
                    </button>
                    <div class="text-sm text-neutral-600 dark:text-neutral-400">
                        Page <span id="currentPageNum" class="font-semibold text-accent-500">1</span> of <span id="totalPages">5</span>
                    </div>
                    <button id="nextPage" class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-neutral-700 border border-neutral-300 dark:border-neutral-600 rounded-lg text-sm font-medium text-neutral-700 dark:text-neutral-200 hover:bg-accent-500 hover:text-white hover:border-accent-500 transition-all disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:text-neutral-700 dark:disabled:hover:bg-neutral-700 dark:disabled:hover:text-neutral-200">
                        <span class="hidden sm:inline">Next</span>
                        <span class="material-icons text-lg">chevron_right</span>
                    </button>
                </nav>
            </main>
        </div>
    </div>

    <!-- Notes Panel -->
    <aside id="notesPanel" class="fixed right-0 top-[52px] bottom-0 w-full sm:w-96 bg-white dark:bg-neutral-800 border-l border-neutral-200 dark:border-neutral-700 z-50 transform translate-x-full transition-transform duration-300 flex flex-col shadow-material-3">
        <div class="flex items-center justify-between p-4 bg-neutral-100 dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-700">
            <h3 class="flex items-center gap-2 text-lg font-medium">
                <span class="material-icons text-accent-500">sticky_note_2</span>
                My Notes
            </h3>
            <button id="notesClose" class="p-2 hover:bg-neutral-200 dark:hover:bg-neutral-700 rounded-full transition-colors">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div id="notesContent" class="flex-1 p-4 overflow-y-auto">
            <!-- Notes populated by JS -->
        </div>
        <div class="p-4 border-t border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-900">
            <textarea id="noteInput" class="w-full min-h-[100px] p-3 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-800 text-neutral-800 dark:text-neutral-100 resize-y focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent text-base" placeholder="Write a note about what you're reading..."></textarea>
            <button id="addNoteBtn" class="w-full mt-3 py-3 bg-accent-500 hover:bg-accent-600 text-white font-medium rounded-lg flex items-center justify-center gap-2 transition-colors">
                <span class="material-icons text-lg">add</span>
                Add Note
            </button>
        </div>
    </aside>

    <!-- TTS Panel -->
    <div id="ttsPanel" class="fixed left-1/2 -translate-x-1/2 bottom-0 w-[95%] max-w-lg bg-white dark:bg-neutral-800 rounded-t-2xl shadow-material-3 z-[100] transform translate-y-full transition-transform duration-300">
        <div class="bg-gradient-to-r from-primary-500 to-accent-500 text-white px-4 py-3 rounded-t-2xl flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="material-icons">volume_up</span>
                <span class="font-medium">Read Aloud</span>
            </div>
            <button id="ttsClose" class="p-1 hover:bg-white/20 rounded-full transition-colors">
                <span class="material-icons">expand_more</span>
            </button>
        </div>
        <div class="p-4">
            <div class="flex justify-center items-center gap-4 mb-6">
                <button id="ttsRestart" class="w-12 h-12 flex items-center justify-center rounded-full border-2 border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-300 hover:border-accent-500 hover:text-accent-500 transition-all" title="Restart">
                    <span class="material-icons">replay</span>
                </button>
                <button id="ttsPlayPause" class="w-16 h-16 flex items-center justify-center rounded-full bg-accent-500 text-white shadow-material-2 hover:bg-accent-600 transition-all" title="Play/Pause">
                    <span class="material-icons text-3xl">play_arrow</span>
                </button>
                <button id="ttsStop" class="w-12 h-12 flex items-center justify-center rounded-full border-2 border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-300 hover:border-accent-500 hover:text-accent-500 transition-all" title="Stop">
                    <span class="material-icons">stop</span>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-neutral-600 dark:text-neutral-400 mb-2">Voice</label>
                    <select id="voiceSelect" class="w-full p-3 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-700 text-neutral-800 dark:text-neutral-100 focus:outline-none focus:ring-2 focus:ring-accent-500 text-base">
                        <option>Loading voices...</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="flex justify-between text-sm text-neutral-600 dark:text-neutral-400 mb-2">
                            <span>Speed</span>
                            <span id="rateValue" class="text-accent-500 font-medium">1.0x</span>
                        </label>
                        <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
                    </div>
                    <div>
                        <label class="flex justify-between text-sm text-neutral-600 dark:text-neutral-400 mb-2">
                            <span>Pitch</span>
                            <span id="pitchValue" class="text-accent-500 font-medium">1.0</span>
                        </label>
                        <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1">
                    </div>
                </div>
            </div>
            <div id="ttsStatus" class="text-center text-sm text-neutral-500 dark:text-neutral-400 mt-4 pt-4 border-t border-neutral-200 dark:border-neutral-700">
                Ready to read
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-neutral-800 dark:bg-neutral-100 text-white dark:text-neutral-800 px-6 py-3 rounded-lg shadow-material-2 opacity-0 translate-y-4 transition-all duration-300 z-[200]"></div>

    <!-- Modal -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[300] opacity-0 invisible transition-all duration-300">
        <div class="bg-white dark:bg-neutral-800 rounded-xl p-6 max-w-sm w-[90%] shadow-material-3 transform scale-95 transition-transform duration-300">
            <h4 id="modalTitle" class="text-lg font-medium mb-2">Confirm</h4>
            <p id="modalText" class="text-neutral-600 dark:text-neutral-400 mb-6">Are you sure?</p>
            <div class="flex gap-3 justify-end">
                <button id="modalCancel" class="px-4 py-2 bg-neutral-200 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 rounded-lg hover:bg-neutral-300 dark:hover:bg-neutral-600 transition-colors">Cancel</button>
                <button id="modalConfirm" class="px-4 py-2 bg-error text-white rounded-lg hover:bg-red-600 transition-colors">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList.toggle('dark', event.matches);
        });

        // Book Data
        const bookData = {
            title: "The Lekki Headmaster",
            chapters: [
                { id: 1, title: "Dusk...", available: true },
                { id: 2, title: "Chapter 2", available: false },
                { id: 3, title: "Chapter 3", available: false },
                { id: 4, title: "Chapter 4", available: false },
                { id: 5, title: "Chapter 5", available: false },
                { id: 6, title: "Chapter 6", available: false },
                { id: 7, title: "Chapter 7", available: false },
                { id: 8, title: "Chapter 8", available: false },
                { id: 9, title: "Chapter 9", available: false },
                { id: 10, title: "Chapter 10", available: false },
                { id: 11, title: "Chapter 11", available: false },
                { id: 12, title: "Chapter 12", available: false }
            ],
            pages: {
                1: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p>Something seemed unusual in the way the principal walked to the podium from the back of the assembly. He moved his tall frame rather ponderously. He was not as smart as he used to be. The trademark morning smile was not forthcoming. He took the microphone from Angel, the chapel prefect, and held it, saying nothing. This was in spite of the fact that the morning's pep talk was over, and everyone was excited. All waited for the principal to speak. But the man looked blankly above the students' heads, instead of compellingly into their eyes, the way he used to. He made an attempt to talk; yet words did not come. His head dropped over his broad shoulders as he began to stare at the colourful tiles on the floor.</p>

<p>There was a heavy silence. The principal, again, attempted to speak. Tears! Everyone saw them. Tears trickled out of his eyes. He made yet another attempt to produce words. This time, the microphone dropped on the floor, sending a <span class="keyword">vexatious<span class="keyword-tooltip"><span class="tooltip-word">Vexatious</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">Causing annoyance, frustration, or worry; troublesome</span></span></span> clatter out of the twin sound boxes at the assembly. More tears streamed from both eyes, <span class="keyword">conspicuously<span class="keyword-tooltip"><span class="tooltip-word">Conspicuously</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">In a clearly visible or obvious manner; attracting attention</span></span></span> rolling down his sunken cheeks. Dozens of perplexed eyes—students' and staff's—fixed on him. There was nowhere to hide from the puzzled looks. Then Mr. Bepo Adewale hid in the only available space. He brought his palms together, like a <span class="keyword">supplicant<span class="keyword-tooltip"><span class="tooltip-word">Supplicant</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">A person who humbly begs or pleads for something</span></span></span>, and shielded his face.</p>

<p>The first person who found a voice was the Vice Principal, Mrs. Grace Apeh. "What is the matter, principal?" she asked, moving to his side. Four other members of staff joined her. But the principal said nothing. Instead, he sobbed freely. The school nurse, Mrs. Titi, fetched a handkerchief and offered it to the weeper.</p>

<p>"Please, conclude the assembly and let the students go into their classes immediately," the VP instructed the Chemistry teacher, Mr. Justus Anabel. Mrs. Apeh, the nurse, and Mr. Oyelana, the CRK teacher, started walking the principal back to his office, his face still buried in his palms, sobbing, even more <span class="keyword">agitatedly<span class="keyword-tooltip"><span class="tooltip-word">Agitatedly</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">In a troubled, disturbed, or anxious manner</span></span></span>. "Sir, what is the matter?" "Mrs. Titi—or Nurse Titi, as she was fondly called—asked, as they helped Bepo to his chair in the office. "Is anything the matter?" she asked, as they helped Bepo did not utter a word. The tears did not stop flowing either. At 8:05am, more teachers arrived to console the sobbing principal or possibly lend a helping hand. But the VP advised they go to their classes, exempting the guidance counsellor, Mrs. Beke Egbin.</p>`
                },
                2: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p><span class="keyword">Consolations<span class="keyword-tooltip"><span class="tooltip-word">Consolations</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">Comfort or words of comfort given to someone in distress</span></span></span> and questions resumed. For over 30 minutes, they petted Bepo. All the while, he sobbed. Occasionally, he would shake his head. He would look at the ceiling and at the faces before him, as though he had just returned from a dreamy wonderland. Then he would plunge further in tears. The VP's phone, meanwhile, had been ringing. Information had already reached some parents. They were anxious to know what had happened to the beloved <span class="keyword">principal<span class="keyword-tooltip"><span class="tooltip-word">Principal</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">The head teacher or chief administrator of a school</span></span></span>. One parent learnt he was weeping uncontrollably and rolling on the floor. Another parent heard that he kept muttering, 'Oluwa da mi o! Save me, O God!' At this point, Mrs. Apeh realised the best she could do was to call the Managing Director, Mrs. Ibidun Gloss, popularly called MD, who—but for a function she had to attend that morning—ought to have been in school.</p>

<p>But the morning assembly had not begun on a tearful note. Since the management of Stardom Schools came up with a shrewd <span class="keyword">incentive<span class="keyword-tooltip"><span class="tooltip-word">Incentive</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">Something that motivates or encourages someone to do something</span></span></span> of lowering its boarding fees, the headache it used to have, trying to tame lateness, had reduced greatly. From N250,000 per session, the fee climbed down to N165,000. The result was instant: more than 80 per cent of the parents moved their wards to the boarding house, which was a haven of modest comfort enjoyed by elite students. Almost all the students began to turn up at 7:45am for the assembly.</p>

<p>That was far from the case before the policy change. Many of the learners came from different parts of Lagos, where the fear of heavy traffic was the beginning of wisdom. Interestingly, not many parents complained when the school, almost immediately, raised the fee for 'Excursion and Other Items' by N93,000. Some staff gossiped about this, especially Mr. Audu, the Fine Arts teacher, who was a bunch of oily humour. He cleared his throat, pushed a finger into his mouth, drew it out, and pointed skywards: "In matters of economics," he quipped, "I swear, the MD is 'a witch' and wizard rolled into one!" And the auditors laughed at his grammar.</p>

<p>The assembly had commenced early. The A-List school, located in the posh heart of Lekki, as usual began the <span class="keyword">ritual<span class="keyword-tooltip"><span class="tooltip-word">Ritual</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">A ceremony or series of acts regularly repeated in a set precise manner</span></span></span> with a short prayer, in the form of a recitation of the second stanza of Nigeria's National Anthem: 'Oh God of creation, direct our noble cause...' Stardom did this on Tuesdays and Thursdays, while normal Christian and Muslim prayers were said on Mondays, Wednesdays and Fridays, alongside the National Anthem (first stanza). On Tuesdays and Thursdays, the assembly adopted the second stanza as prayer. It did not bother to recite the first but simply went straight to the school's anthem.</p>

<p>Angel announced it was time for the pep talk. The principal had introduced this, seven years earlier. It involved the presentation of a speech by a student. It was spontaneous, at times. At other times, topics were given ahead. Today's talk was, however, different: the way it sometimes, happened. Ikenna Egbu, an SS3</p>`
                },
                3: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p>1 student, mounted the <span class="keyword">podium<span class="keyword-tooltip"><span class="tooltip-word">Podium</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">A raised platform or stage from which a person gives a speech</span></span></span> to narrate his experience. He was part of a group of Stardom students that had just returned from an excursion to Jos, Plateau State.</p>

<p>"I saw Nigeria in its <span class="keyword">acrobatic<span class="keyword-tooltip"><span class="tooltip-word">Acrobatic</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">Involving or requiring spectacular physical movements; here used metaphorically to mean striking or impressive</span></span></span> beauty," he began, awakening cheers and applause. "My fellow students, if you have not been to Jos..." Ikenna paused and browsed their excited faces, as though he wanted to be sure they were really ready for the discoveries he was about to log into. He continued: "You might have been to London, you might have been to New York. But if you have not been to Jos, you MUST be in that brilliantly beautiful city in YOUR lifetime!" Yells and an applause graced the narrative.</p>

<p>"One of the most memorable attributes of Jos is its very lovely weather," Ikenna said. "Although we are in the dry season, Jos welcomed us with very cool arms. So chilly is Jos that I felt like sleeping every second of the two days we spent there. I can also not forget its acrobatic landscape. Not in any negative sense, but with rocks that sit in artistic layers and, at times, in dramatic postures. You could see a rock carrying three other rocks on its head. You could find a small rock confidently backing another, big enough to give birth to it."</p>

<p>Another round of ovation. The narrator paused. He continued: "Dearest Stars of Stardom, some of our hosts said Jos used to be more beautiful than what we saw, and that some violent crises had affected it. Notwithstanding, I can still confidently say it remains the leading tourism city in this country. No wonder, many important white men were said to have lived there during the colonial period."</p>

<p>Ikenna named some of the places the group visited, such as the <span class="keyword">Lamingo<span class="keyword-tooltip"><span class="tooltip-word">Lamingo Dam</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">A reservoir in Jos, Plateau State, used for water supply and as a recreational site</span></span></span> Dam, the University of Jos, the Shere Hills, Wase Rocks and the Solomon Lar Amusement Park. "If I have the opportunity in future, I will like to settle down in Jos, instead of japa-ing to Canada or London!" A mixed, yet fun-filled round of clapping and hollering filled everywhere as Ikenna returned and joined his classmates on the line.</p>

<p>The chapel prefect then called for <span class="keyword">decorum<span class="keyword-tooltip"><span class="tooltip-word">Decorum</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">Behavior in keeping with good taste and propriety; dignity and correctness</span></span></span> and orderliness, inviting the principal for his address and announcement. Although Ikenna was a science student, he was, equally, a respected poet. His mum, a broadcaster, was an award-winning poet too. Following the young boy's captivating account, many students and staff expected a great comment from the principal, who had been an inspiring pillar at Stardom for 24 years. His impact had been so remarkable that his employers, parents and other stakeholders regarded him as a school builder. He gave the students his all, with an ever-burning passion to see them grow in all <span class="keyword">ramifications<span class="keyword-tooltip"><span class="tooltip-word">Ramifications</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">The complex consequences or outgrowths of an action, decision, or event; branches or subdivisions</span></span></span>.</p>

<p>On a day like this, he would be on top of the world. He would regard</p>`
                },
                4: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p>Ikenna's outing as evidence of the good education Stardom offered, and which, he believed, every Nigerian child deserved. The students also expected him to highlight some terms Ikenna might not have <span class="keyword">articulated<span class="keyword-tooltip"><span class="tooltip-word">Articulated</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">Expressed clearly and distinctly; spoke with precision</span></span></span> so well. They were eager to hear something special from the tall, light-skinned principal, nicknamed 'the Lekki Headmaster', because of the way he used to imitate characters in the old TV drama, Village Headmaster, when he was Headmaster at Stardom Kiddies. It was his funny way of amusing the pupils. Sometimes, Stardom students called him 'Principo', because he never got tired of saying the pronunciation of 'principal' should not end with 'pa'. It's "PrinciPL," Bepo would emphasize.</p>

<p>But of course, Mr. Bepo, this morning, was not on top of the world: he was under the world ot tears.</p>

<p>At her office on the second floor of the Admin Building, the MD aimlessly removed her glasses and aimlessly dropped them on a tea stool by her right. She never envisaged the frustration fast becoming what, ordinarily, should have been a pleasant morning. She had driven down to school hurriedly, after the VP raised the alarm about the principal's strange behaviour.</p>

<p>Only the previous day, the school had celebrated its over 90 percent success in the last West African Senior School Certificate Examination (WASSCE). The event ought to have held earlier, but it was postponed because the management could not immediately decide on the star prizes it wished to give. The school surprised all members of staff with snacks, bottles of wine, and N20,000 each for all SS3 3 teachers. Those who handled subjects where candidates scored distinctions, however, took home N30,000 each. The only teachers who had questions to answer were Mr. Obong Ukaku and Miss Taye Kareem, in whose subjects—Chemistry and Geography, respectively—two candidates had Ds. But all the teachers escaped real trouble as no candidate scored F9. At Stardom, consider yourself sacked if any of the students you presented for WASSCE or NECO recorded F9. The previous year, not even a cousin of the MD, Mr. Funso Daniels, was spared an abrupt exit.</p>

<p>Following her arrival at about 9:30am, the MD had invited Bepo to her office, asking what the problem was. Thirty-something minutes later, he had yet to state any reason for his <span class="keyword">distraught<span class="keyword-tooltip"><span class="tooltip-word">Distraught</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">Deeply upset and agitated; extremely troubled</span></span></span> disposition. Instead, he kept muttering: "Thank you. I will be all right."</p>

<p>"Mr. Bepo, you keep saying you will be alright, but you are not saying what the problem is. You are aware that, given your position in this school and the excellent performance you have always put up, you are central to everything that goes on. You are supposed to be the embodiment of sanity, the balm to troubled nerves. In many cases, those are what you have been. But why would you suddenly turn the source of our anxiety?"</p>`
                },
                5: {
                    chapter: 1,
                    chapterTitle: "Dusk...",
                    content: `<p>"Madam, I..." the principal managed to say, then broke down again. The MD became more agitated. She picked one of the three handsets on her table. She made a call, which, three minutes later, produced the Physics teacher, Mr. Ope Wande, who was also a pastor.</p>

<p>"I am here, ma," Wande said as he walked in. He had missed the morning assembly, and besides the gists gathered from colleagues, he was only seeing Bepo for the first time in the day. "Principal, I hope all is well," he asked.</p>

<p>"Not really. And that is why I invited you," the MD said. Wande stooped beside the principal and began to speak to him in a subdued voice. He asked what the real matter was, and assured he would keep secret whatever information Mr. Bepo gave concerning his plight. Just like the MD had done, the pastor-teacher also reminded Bepo of his cardinal position in the school, and the fact that news of the matter had already begun swirling, miles away from the premises.</p>

<p>Wande spoke to the upset principal for close to 10 minutes. Realising he might have been talking to a brick wall, he turned back to the MD and said, "Ma, have we called Mr. Bepo's wife? I think we need to. And urgently too." Mrs. Ibidun Gloss did not object to the advice. She asked the principal for his wife's phone number. This, Mr. Bepo wrote on the back of a card fetched from the breast pocket of his grey suit. The MD studied the card, <span class="keyword">hesitatingly<span class="keyword-tooltip"><span class="tooltip-word">Hesitatingly</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">In an uncertain or hesitant manner; with doubt or reluctance</span></span></span>, before dialling. It was an international number.</p>

<p>"Principal's wife now lives in London, ma," Wande affirmed.</p>

<p>"I should know. I wonder if he is not missing her badly," the MD said. The comment was supposed to be a joke. Yet, it elicited no laughter. None of the two lines the MD dialled rang. "Pastor, please, accompany the principal to his office. I think he has to go home, really," she said.</p>

<p>"I understand," Pastor Wande said. "But I think there is a little problem that it might not be a very good idea if he is left to go alone in this <span class="keyword">circumstance<span class="keyword-tooltip"><span class="tooltip-word">Circumstance</span><span class="tooltip-definition text-neutral-600 dark:text-neutral-300">A condition or fact that affects a situation; the existing conditions or state of affairs</span></span></span>."</p>

<p>The MD understood the sentiment in the teacher's fear. But she felt pressed to move the drama away from the school as soon as possible. What would the parents think if they learnt the principal was weeping like a child? The school, an impatient spirit told her, <em>was not a rehabilitation centre but a place for learning and earning money</em>.</p>

<p>"Please, guide him to his office and arrange to take him home," she said, emphatically, adding: "I learnt that the guidance counsellor was with him earlier. Perhaps, he can go with him. He might also visit the clinic ASAP."</p>`
                }
            }
        };

        // App State
        let currentPage = 1;
        let currentChapter = 1;
        const totalPages = Object.keys(bookData.pages).length;
        let notes = [];
        let speechAPI = null;
        const STORAGE_KEY = 'lekki_headmaster_notes';

        // Notes are stored in memory for this session
        function loadNotes() {
            // Notes persist in memory during the session
        }

        function saveNotes() {
            // Notes are kept in memory
        }

        // Speech API using Web Speech API with limited voices
        class WebSpeechAPI {
            constructor() {
                this.synth = window.speechSynthesis;
                this.voices = [];
                this.selectedVoices = [];
                this.currentUtterance = null;
                this.loadVoices();

                if (this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = () => this.loadVoices();
                }
            }

            loadVoices() {
                this.voices = this.synth.getVoices();
                this.selectTwoVoices();
                this.populateVoiceSelect();
            }

            selectTwoVoices() {
                // Filter for English voices
                const englishVoices = this.voices.filter(v => v.lang.startsWith('en'));

                // Try to find one male and one female voice
                let femaleVoice = null;
                let maleVoice = null;

                // Common female voice names
                const femaleNames = ['female', 'woman', 'samantha', 'victoria', 'karen', 'moira', 'tessa', 'fiona', 'veena', 'zira', 'susan', 'hazel', 'kate', 'serena', 'emily', 'siri'];
                // Common male voice names
                const maleNames = ['male', 'man', 'daniel', 'alex', 'tom', 'david', 'james', 'george', 'fred', 'lee', 'oliver', 'aaron', 'arthur'];

                for (const voice of englishVoices) {
                    const nameLower = voice.name.toLowerCase();

                    if (!femaleVoice && femaleNames.some(n => nameLower.includes(n))) {
                        femaleVoice = voice;
                    }
                    if (!maleVoice && maleNames.some(n => nameLower.includes(n))) {
                        maleVoice = voice;
                    }

                    if (femaleVoice && maleVoice) break;
                }

                // Fallback: just pick first two English voices if we couldn't identify gender
                if (!femaleVoice && englishVoices.length > 0) {
                    femaleVoice = englishVoices[0];
                }
                if (!maleVoice && englishVoices.length > 1) {
                    maleVoice = englishVoices[1];
                } else if (!maleVoice && englishVoices.length > 0) {
                    maleVoice = englishVoices[0];
                }

                this.selectedVoices = [];
                if (femaleVoice) this.selectedVoices.push({ voice: femaleVoice, label: 'Female Voice' });
                if (maleVoice && maleVoice !== femaleVoice) this.selectedVoices.push({ voice: maleVoice, label: 'Male Voice' });

                // If we only got one voice, duplicate it
                if (this.selectedVoices.length === 1) {
                    this.selectedVoices[0].label = 'Voice 1';
                }
                if (this.selectedVoices.length === 0 && this.voices.length > 0) {
                    this.selectedVoices.push({ voice: this.voices[0], label: 'Default Voice' });
                }
            }

            populateVoiceSelect() {
                const voiceSelect = document.getElementById('voiceSelect');
                if (!voiceSelect) return;

                voiceSelect.innerHTML = '';

                if (this.selectedVoices.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'No voices available';
                    voiceSelect.appendChild(option);
                    return;
                }

                this.selectedVoices.forEach((item, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${item.label} (${item.voice.name})`;
                    if (index === 0) option.selected = true;
                    voiceSelect.appendChild(option);
                });
            }

            speak(text, options = {}) {
                return new Promise((resolve, reject) => {
                    if (!this.synth) {
                        reject(new Error('Speech synthesis not supported'));
                        return;
                    }

                    this.stop();

                    const utterance = new SpeechSynthesisUtterance(text);

                    const voiceIndex = options.voiceIndex !== undefined ? options.voiceIndex : parseInt(document.getElementById('voiceSelect').value) || 0;
                    if (this.selectedVoices[voiceIndex]) {
                        utterance.voice = this.selectedVoices[voiceIndex].voice;
                    }

                    utterance.rate = options.rate || parseFloat(document.getElementById('rateSlider').value);
                    utterance.pitch = options.pitch || parseFloat(document.getElementById('pitchSlider').value);
                    utterance.volume = 1;

                    utterance.onend = () => {
                        this.currentUtterance = null;
                        resolve();
                    };

                    utterance.onerror = (event) => {
                        this.currentUtterance = null;
                        reject(new Error(`Speech synthesis error: ${event.error}`));
                    };

                    this.currentUtterance = utterance;
                    this.synth.speak(utterance);
                });
            }

            stop() {
                if (this.synth && this.synth.speaking) {
                    this.synth.cancel();
                }
                this.currentUtterance = null;
            }

            pause() {
                if (this.synth && this.synth.speaking) {
                    this.synth.pause();
                }
            }

            resume() {
                if (this.synth && this.synth.paused) {
                    this.synth.resume();
                }
            }

            isSpeaking() {
                return this.synth && this.synth.speaking;
            }

            isPaused() {
                return this.synth && this.synth.paused;
            }
        }

        // DOM Elements
        const elements = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            menuToggle: document.getElementById('menuToggle'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebarOverlay'),
            chapterList: document.getElementById('chapterList'),
            bookPage: document.getElementById('bookPage'),
            prevPage: document.getElementById('prevPage'),
            nextPage: document.getElementById('nextPage'),
            currentPageNum: document.getElementById('currentPageNum'),
            totalPages: document.getElementById('totalPages'),
            notesToggle: document.getElementById('notesToggle'),
            notesPanel: document.getElementById('notesPanel'),
            notesClose: document.getElementById('notesClose'),
            notesContent: document.getElementById('notesContent'),
            noteInput: document.getElementById('noteInput'),
            addNoteBtn: document.getElementById('addNoteBtn'),
            ttsToggle: document.getElementById('ttsToggle'),
            ttsPanel: document.getElementById('ttsPanel'),
            ttsClose: document.getElementById('ttsClose'),
            ttsPlayPause: document.getElementById('ttsPlayPause'),
            ttsStop: document.getElementById('ttsStop'),
            ttsRestart: document.getElementById('ttsRestart'),
            ttsStatus: document.getElementById('ttsStatus'),
            rateSlider: document.getElementById('rateSlider'),
            rateValue: document.getElementById('rateValue'),
            pitchSlider: document.getElementById('pitchSlider'),
            pitchValue: document.getElementById('pitchValue'),
            toast: document.getElementById('toast'),
            modalOverlay: document.getElementById('modalOverlay'),
            modalTitle: document.getElementById('modalTitle'),
            modalText: document.getElementById('modalText'),
            modalCancel: document.getElementById('modalCancel'),
            modalConfirm: document.getElementById('modalConfirm'),
            pageNav: document.getElementById('pageNav')
        };

        // Initialize App
        function init() {
            loadNotes();
            speechAPI = new WebSpeechAPI();

            elements.totalPages.textContent = totalPages;

            renderChapterList();
            renderPage(currentPage);
            renderNotes();
            setupEventListeners();

            // Hide loading after a short delay
            setTimeout(() => {
                elements.loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                }, 500);
            }, 800);
        }

        // Render Chapter List
        function renderChapterList() {
            elements.chapterList.innerHTML = '';

            bookData.chapters.forEach(chapter => {
                const li = document.createElement('li');
                const isActive = chapter.id === currentChapter;
                const isLocked = !chapter.available;

                li.className = `flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-all ${
                    isActive
                        ? 'bg-accent-500 text-white'
                        : isLocked
                            ? 'opacity-50 cursor-not-allowed'
                            : 'hover:bg-accent-50 dark:hover:bg-accent-500/20 text-neutral-700 dark:text-neutral-300'
                }`;

                li.innerHTML = `
                    <span class="w-7 h-7 flex items-center justify-center rounded-full text-xs font-medium ${
                        isActive
                            ? 'bg-white/20 text-white'
                            : 'bg-neutral-200 dark:bg-neutral-700 text-neutral-600 dark:text-neutral-400'
                    }">${chapter.id}</span>
                    <span class="flex-1 text-sm">${chapter.title}</span>
                    ${isLocked ? '<span class="material-icons text-sm opacity-50">lock</span>' : ''}
                `;

                if (chapter.available) {
                    li.addEventListener('click', () => navigateToChapter(chapter.id));
                }

                elements.chapterList.appendChild(li);
            });
        }

        // Navigate to Chapter
        function navigateToChapter(chapterId) {
            for (let pageNum in bookData.pages) {
                if (bookData.pages[pageNum].chapter === chapterId) {
                    currentPage = parseInt(pageNum);
                    currentChapter = chapterId;
                    renderPage(currentPage);
                    renderChapterList();
                    closeSidebar();
                    break;
                }
            }
        }

        // Render Page
        function renderPage(pageNum) {
            const pageData = bookData.pages[pageNum];
            if (!pageData) return;

            elements.bookPage.innerHTML = `
                <div class="text-xs font-medium uppercase tracking-widest text-neutral-500 dark:text-neutral-400 mb-2">Chapter ${pageData.chapter}</div>
                <h1 class="text-2xl md:text-3xl font-bold text-primary-500 dark:text-accent-500 mb-6 pb-4 border-b-2 border-accent-500">${pageData.chapterTitle}</h1>
                <div class="book-content text-neutral-800 dark:text-neutral-200">${pageData.content}</div>
            `;

            elements.currentPageNum.textContent = pageNum;
            elements.prevPage.disabled = pageNum === 1;
            elements.nextPage.disabled = pageNum === totalPages;

            // Scroll to top
            document.getElementById('readerContainer').scrollTop = 0;

            // Stop TTS when changing pages
            if (speechAPI && speechAPI.isSpeaking()) {
                speechAPI.stop();
                updateTTSUI(false);
            }
        }

        // Notes Functions
        function renderNotes() {
            if (notes.length === 0) {
                elements.notesContent.innerHTML = `
                    <div class="text-center py-10 text-neutral-400">
                        <span class="material-icons text-5xl opacity-30 mb-3">auto_stories</span>
                        <p>No notes yet.<br>Start taking notes as you read!</p>
                    </div>
                `;
                return;
            }

            const sortedNotes = [...notes].sort((a, b) => a.page - b.page);

            elements.notesContent.innerHTML = sortedNotes.map((note, idx) => `
                <div class="note-card-animate bg-premium-50 dark:bg-neutral-700 border border-premium-500/30 dark:border-neutral-600 rounded-lg p-4 mb-3 relative group" data-index="${notes.indexOf(note)}">
                    <button class="note-delete absolute top-2 right-2 p-1 text-neutral-400 hover:text-error opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-icons text-lg">delete</span>
                    </button>
                    <div class="flex items-center justify-between mb-2 text-xs text-neutral-500 dark:text-neutral-400">
                        <span class="bg-accent-500 text-white px-2 py-0.5 rounded font-medium">Page ${note.page}</span>
                        <span>${note.timestamp}</span>
                    </div>
                    <div class="text-sm text-neutral-700 dark:text-neutral-300 leading-relaxed">${escapeHtml(note.text)}</div>
                </div>
            `).join('');

            document.querySelectorAll('.note-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const card = e.target.closest('[data-index]');
                    const index = parseInt(card.dataset.index);
                    showConfirmModal('Delete Note', 'Are you sure you want to delete this note?', () => deleteNote(index));
                });
            });
        }

        function addNote() {
            const text = elements.noteInput.value.trim();
            if (!text) {
                showToast('Please write something first');
                return;
            }

            const note = {
                text: text,
                page: currentPage,
                chapter: currentChapter,
                timestamp: new Date().toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };

            notes.push(note);
            saveNotes();
            elements.noteInput.value = '';
            renderNotes();
            showToast('Note added successfully!');
        }

        function deleteNote(index) {
            notes.splice(index, 1);
            saveNotes();
            renderNotes();
            showToast('Note deleted');
        }

        // TTS Functions
        function getPageText() {
            const content = document.querySelector('.book-content');
            if (!content) return '';
            return content.innerText;
        }

        function updateTTSUI(isPlaying) {
            const icon = elements.ttsPlayPause.querySelector('.material-icons');
            if (isPlaying) {
                icon.textContent = 'pause';
                elements.ttsPlayPause.classList.add('animate-pulse');
                elements.ttsStatus.textContent = 'Reading aloud...';
                elements.ttsStatus.classList.add('text-success');
            } else {
                icon.textContent = 'play_arrow';
                elements.ttsPlayPause.classList.remove('animate-pulse');
                elements.ttsStatus.textContent = 'Ready to read';
                elements.ttsStatus.classList.remove('text-success');
            }
        }

        async function togglePlayPause() {
            if (!speechAPI) return;

            if (speechAPI.isSpeaking()) {
                if (speechAPI.isPaused()) {
                    speechAPI.resume();
                    updateTTSUI(true);
                } else {
                    speechAPI.pause();
                    const icon = elements.ttsPlayPause.querySelector('.material-icons');
                    icon.textContent = 'play_arrow';
                    elements.ttsStatus.textContent = 'Paused';
                }
            } else {
                const text = getPageText();
                if (!text) {
                    showToast('No text to read');
                    return;
                }

                updateTTSUI(true);

                try {
                    await speechAPI.speak(text);
                    updateTTSUI(false);
                } catch (err) {
                    console.error('TTS Error:', err);
                    updateTTSUI(false);
                    showToast('Failed to read text');
                }
            }
        }

        function stopSpeech() {
            if (speechAPI) {
                speechAPI.stop();
                updateTTSUI(false);
            }
        }

        function restartSpeech() {
            stopSpeech();
            setTimeout(() => togglePlayPause(), 100);
        }

        // UI Helpers
        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.classList.remove('opacity-0', 'translate-y-4');
            elements.toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                elements.toast.classList.add('opacity-0', 'translate-y-4');
                elements.toast.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSidebar() {
            const isOpen = elements.sidebar.classList.contains('translate-x-0');
            if (isOpen) {
                closeSidebar();
            } else {
                elements.sidebar.classList.remove('-translate-x-full');
                elements.sidebar.classList.add('translate-x-0');
                elements.sidebarOverlay.classList.remove('hidden');
            }
        }

        function closeSidebar() {
            elements.sidebar.classList.add('-translate-x-full');
            elements.sidebar.classList.remove('translate-x-0');
            elements.sidebarOverlay.classList.add('hidden');
        }

        function toggleNotesPanel() {
            const isOpen = !elements.notesPanel.classList.contains('translate-x-full');
            if (isOpen) {
                elements.notesPanel.classList.add('translate-x-full');
                elements.notesToggle.classList.remove('bg-white/20');
            } else {
                elements.notesPanel.classList.remove('translate-x-full');
                elements.notesToggle.classList.add('bg-white/20');
            }
        }

        function toggleTTSPanel() {
            const isOpen = !elements.ttsPanel.classList.contains('translate-y-full');
            if (isOpen) {
                elements.ttsPanel.classList.add('translate-y-full');
                elements.ttsToggle.classList.remove('bg-white/20');
            } else {
                elements.ttsPanel.classList.remove('translate-y-full');
                elements.ttsToggle.classList.add('bg-white/20');
            }
        }

        // Modal functions
        let modalCallback = null;

        function showConfirmModal(title, text, onConfirm) {
            elements.modalTitle.textContent = title;
            elements.modalText.textContent = text;
            modalCallback = onConfirm;
            elements.modalOverlay.classList.remove('opacity-0', 'invisible');
            elements.modalOverlay.classList.add('opacity-100', 'visible');
            elements.modalOverlay.querySelector('.bg-white').classList.remove('scale-95');
            elements.modalOverlay.querySelector('.bg-white').classList.add('scale-100');
        }

        function hideModal() {
            elements.modalOverlay.classList.add('opacity-0', 'invisible');
            elements.modalOverlay.classList.remove('opacity-100', 'visible');
            elements.modalOverlay.querySelector('.bg-white').classList.add('scale-95');
            elements.modalOverlay.querySelector('.bg-white').classList.remove('scale-100');
            modalCallback = null;
        }

        // Event Listeners
        function setupEventListeners() {
            // Navigation
            elements.prevPage.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    const pageData = bookData.pages[currentPage];
                    if (pageData && pageData.chapter !== currentChapter) {
                        currentChapter = pageData.chapter;
                        renderChapterList();
                    }
                    renderPage(currentPage);
                }
            });

            elements.nextPage.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    const pageData = bookData.pages[currentPage];
                    if (pageData && pageData.chapter !== currentChapter) {
                        currentChapter = pageData.chapter;
                        renderChapterList();
                    }
                    renderPage(currentPage);
                }
            });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

                if (e.key === 'ArrowLeft' && currentPage > 1) {
                    elements.prevPage.click();
                } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
                    elements.nextPage.click();
                }
            });

            // Sidebar
            elements.menuToggle.addEventListener('click', toggleSidebar);
            elements.sidebarOverlay.addEventListener('click', closeSidebar);

            // Notes Panel
            elements.notesToggle.addEventListener('click', toggleNotesPanel);
            elements.notesClose.addEventListener('click', toggleNotesPanel);
            elements.addNoteBtn.addEventListener('click', addNote);

            elements.noteInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    addNote();
                }
            });

            // TTS Panel
            elements.ttsToggle.addEventListener('click', toggleTTSPanel);
            elements.ttsClose.addEventListener('click', toggleTTSPanel);
            elements.ttsPlayPause.addEventListener('click', togglePlayPause);
            elements.ttsStop.addEventListener('click', stopSpeech);
            elements.ttsRestart.addEventListener('click', restartSpeech);

            // TTS Settings
            elements.rateSlider.addEventListener('input', (e) => {
                elements.rateValue.textContent = `${e.target.value}x`;
            });

            elements.pitchSlider.addEventListener('input', (e) => {
                elements.pitchValue.textContent = e.target.value;
            });

            // Modal
            elements.modalCancel.addEventListener('click', hideModal);
            elements.modalConfirm.addEventListener('click', () => {
                if (modalCallback) modalCallback();
                hideModal();
            });
            elements.modalOverlay.addEventListener('click', (e) => {
                if (e.target === elements.modalOverlay) hideModal();
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

