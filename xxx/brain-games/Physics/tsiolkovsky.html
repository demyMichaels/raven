<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tsiolkovsky Rocket Equation Simulator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=IBM+Plex+Sans:wght@400;600&display=swap');

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #131829;
            --bg-tertiary: #1a1f3a;
            --accent-1: #00d4ff;
            --accent-2: #ff6b35;
            --accent-3: #4ecdc4;
            --text-primary: #e0e6ed;
            --text-secondary: #8892a6;
            --success: #26de81;
            --warning: #fed330;
            --danger: #fc5c65;
            --grid-line: rgba(0, 212, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1535 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(78, 205, 196, 0.1) 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        h1 {
            font-family: 'Space Mono', monospace;
            font-size: clamp(1.8rem, 4vw, 3rem);
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-family: 'Space Mono', monospace;
            color: var(--text-secondary);
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            letter-spacing: 0.1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 212, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .panel-header {
            font-family: 'Space Mono', monospace;
            font-size: 1.3rem;
            color: var(--accent-1);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }

        .control-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .value-display {
            color: var(--accent-1);
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: var(--bg-tertiary);
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 5px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        select {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Space Mono', monospace;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-1);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .engine-info {
            margin-top: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        button {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .btn-launch {
            background: linear-gradient(135deg, var(--accent-2), #ff8c42);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .btn-launch:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
        }

        .btn-launch:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-reset {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            margin-top: 10px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .btn-reset:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-1);
        }

        .simulation-view {
            position: relative;
            background: linear-gradient(180deg, #000814 0%, #001d3d 50%, #003566 100%);
            border-radius: 15px;
            overflow: hidden;
            height: 600px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .stats-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(10, 14, 39, 0.9);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            border: 1px solid rgba(0, 212, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--accent-1);
            font-weight: 700;
        }

        .equation-panel {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(78, 205, 196, 0.1));
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .equation {
            font-family: 'Space Mono', monospace;
            font-size: 1.3rem;
            text-align: center;
            margin: 15px 0;
            color: var(--accent-3);
        }

        .equation-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .eq-var {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .eq-var-name {
            font-family: 'Space Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .eq-var-value {
            font-family: 'Space Mono', monospace;
            color: var(--accent-1);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .mission-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .mission-card {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mission-card:hover {
            border-color: var(--accent-1);
            transform: translateY(-2px);
        }

        .mission-card.active {
            border-color: var(--accent-3);
            background: rgba(78, 205, 196, 0.1);
        }

        .mission-title {
            font-family: 'Space Mono', monospace;
            color: var(--accent-1);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .mission-target {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .educational-note {
            background: rgba(0, 212, 255, 0.05);
            border-left: 4px solid var(--accent-1);
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
        }

        .status-success {
            background: rgba(38, 222, 129, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .status-failure {
            background: rgba(252, 92, 101, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .status-info {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid var(--accent-1);
            color: var(--accent-1);
        }

        .graph-container {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            height: 300px;
        }

        #velocityGraph {
            width: 100%;
            height: 100%;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-box {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .info-value {
            color: var(--accent-1);
            font-family: 'Space Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .altitude-marker {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .marker-line {
            position: absolute;
            right: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 212, 255, 0.2);
            border-top: 2px dashed rgba(0, 212, 255, 0.4);
        }

        .marker-karman {
            top: 16.67%;
        }

        .marker-leo {
            top: 6%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ TSIOLKOVSKY ROCKET EQUATION</h1>
            <p class="subtitle">Interactive Educational Simulator</p>
        </header>

        <div class="panel">
            <div class="panel-header">üìö The Fundamental Equation of Rocketry</div>
            <div class="equation-panel">
                <div class="equation">
                    Œîv = v<sub>e</sub> √ó ln(m‚ÇÄ/m<sub>f</sub>)
                </div>
                <div class="equation-breakdown">
                    <div class="eq-var">
                        <div class="eq-var-name">Œîv (Delta-V)</div>
                        <div class="eq-var-value" id="deltaVDisplay">0 m/s</div>
                    </div>
                    <div class="eq-var">
                        <div class="eq-var-name">v<sub>e</sub> (Exhaust Velocity)</div>
                        <div class="eq-var-value" id="veDisplay">0 m/s</div>
                    </div>
                    <div class="eq-var">
                        <div class="eq-var-name">m‚ÇÄ (Initial Mass)</div>
                        <div class="eq-var-value" id="m0Display">0 kg</div>
                    </div>
                    <div class="eq-var">
                        <div class="eq-var-name">m<sub>f</sub> (Final Mass)</div>
                        <div class="eq-var-value" id="mfDisplay">0 kg</div>
                    </div>
                    <div class="eq-var">
                        <div class="eq-var-name">Mass Ratio</div>
                        <div class="eq-var-value" id="massRatioDisplay">0</div>
                    </div>
                </div>
                <div class="educational-note">
                    <strong>Key Insight:</strong> The natural logarithm (ln) creates an <strong>exponential relationship</strong>.
                    To double your Œîv, you need to <em>square</em> your mass ratio! For example, if a mass ratio of 2:1
                    gives you 3,000 m/s, you need a ratio of 4:1 (not 4:1) to reach 6,000 m/s.
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">üéØ Select Mission</div>
            <div class="mission-selector">
                <div class="mission-card active" data-mission="suborbital">
                    <div class="mission-title">Suborbital Flight</div>
                    <div class="mission-target">Target: 100 km (K√°rm√°n Line)<br>Œîv needed: ~1,400 m/s</div>
                </div>
                <div class="mission-card" data-mission="leo">
                    <div class="mission-title">Low Earth Orbit</div>
                    <div class="mission-target">Target: 300 km altitude<br>Œîv needed: ~9,400 m/s</div>
                </div>
                <div class="mission-card" data-mission="efficiency">
                    <div class="mission-title">Efficiency Challenge</div>
                    <div class="mission-target">Reach 100 km with<br>minimum fuel mass</div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="panel">
                <div class="panel-header">‚öôÔ∏è Rocket Design</div>

                <div class="control-group">
                    <label>
                        Engine Type
                    </label>
                    <select id="engineSelect">
                        <option value="2000">Solid Rocket (v_e = 2,000 m/s)</option>
                        <option value="3000">Kerosene/LOX (v_e = 3,000 m/s)</option>
                        <option value="3500" selected>Hydrogen/LOX (v_e = 3,500 m/s)</option>
                        <option value="4500">Nuclear Thermal (v_e = 4,500 m/s)</option>
                    </select>
                    <div class="engine-info" id="engineInfo">
                        High-performance chemical rocket. Used in Space Shuttle main engines.
                    </div>
                </div>

                <div class="control-group">
                    <label>
                        Payload + Structure Mass (Dry Mass): <span class="value-display" id="dryMassValue">5,000 kg</span>
                    </label>
                    <input type="range" id="dryMassSlider" min="1000" max="50000" step="1000" value="5000">
                    <div class="educational-note">
                        This is m<sub>f</sub> - the mass remaining after all fuel is burned. Includes payload, tanks, engines.
                    </div>
                </div>

                <div class="control-group">
                    <label>
                        Fuel Mass: <span class="value-display" id="fuelMassValue">15,000 kg</span>
                    </label>
                    <input type="range" id="fuelMassSlider" min="5000" max="200000" step="5000" value="15000">
                    <div class="educational-note">
                        More fuel = higher mass ratio = more Œîv. But diminishing returns due to the logarithm!
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-box">
                        <div class="info-label">Total Mass (m‚ÇÄ)</div>
                        <div class="info-value" id="totalMassInfo">20,000</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Fuel Fraction</div>
                        <div class="info-value" id="fuelFractionInfo">75%</div>
                    </div>
                </div>

                <button class="btn-launch" id="launchBtn">üöÄ Launch Rocket</button>
                <button class="btn-reset" id="resetBtn">Reset Simulation</button>

                <div id="statusMessage"></div>
            </div>

            <div>
                <div class="panel" style="padding: 0; position: relative;">
                    <div class="simulation-view">
                        <canvas id="rocketCanvas"></canvas>
                        <div class="stats-overlay" id="statsOverlay">
                            <div class="stat-row">
                                <span class="stat-label">Altitude:</span>
                                <span class="stat-value" id="altitudeStat">0 km</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Velocity:</span>
                                <span class="stat-value" id="velocityStat">0 m/s</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Fuel Remaining:</span>
                                <span class="stat-value" id="fuelStat">100%</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Current Mass:</span>
                                <span class="stat-value" id="massStat">0 kg</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Acceleration:</span>
                                <span class="stat-value" id="accelStat">0 m/s¬≤</span>
                            </div>
                        </div>
                        <div class="marker-line marker-karman"></div>
                        <div class="altitude-marker" style="top: 16.67%; right: 25px;">
                            <div style="background: rgba(10, 14, 39, 0.9); padding: 8px; border-radius: 5px; border: 1px solid rgba(255, 107, 53, 0.5);">
                                ‚Üê 100 km (K√°rm√°n Line)
                            </div>
                        </div>
                        <div class="marker-line marker-leo"></div>
                        <div class="altitude-marker" style="top: 6%; right: 25px;">
                            <div style="background: rgba(10, 14, 39, 0.9); padding: 8px; border-radius: 5px; border: 1px solid rgba(78, 205, 196, 0.5);">
                                ‚Üê 300 km (Low Earth Orbit)
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">üìä Velocity vs Fuel Burned</div>
                    <div class="graph-container">
                        <canvas id="velocityGraph"></canvas>
                    </div>
                    <div class="educational-note">
                        This graph shows the <strong>logarithmic curve</strong> of the Tsiolkovsky equation in action.
                        Notice how velocity increases rapidly at first, then slows down as fuel depletes.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Rocket simulation state
        const state = {
            dryMass: 5000,
            fuelMass: 15000,
            exhaustVelocity: 3500,
            mission: 'suborbital',
            isSimulating: false,
            time: 0,
            currentVelocity: 0,
            currentAltitude: 0,
            currentFuel: 0,
            currentMass: 0,
            burnRate: 0,
            velocityHistory: [],
            fuelBurnedHistory: []
        };

        const missions = {
            suborbital: { target: 100, deltaV: 1400, name: 'Suborbital' },
            leo: { target: 300, deltaV: 9400, name: 'Low Earth Orbit' },
            efficiency: { target: 100, deltaV: 1400, name: 'Efficiency Challenge', checkEfficiency: true }
        };

        // Engine descriptions
        const engineInfo = {
            2000: 'Basic solid propellant rocket. Simple but lowest performance. Used in boosters.',
            3000: 'Kerosene (RP-1) and Liquid Oxygen. Used in Falcon 9, Soyuz rockets.',
            3500: 'Liquid Hydrogen and Liquid Oxygen. High performance chemical rocket. Used in Space Shuttle.',
            4500: 'Nuclear thermal rocket. Theoretical high-performance engine. Not yet used in spaceflight.'
        };

        // Canvas setup
        const canvas = document.getElementById('rocketCanvas');
        const ctx = canvas.getContext('2d');
        const graphCanvas = document.getElementById('velocityGraph');
        const graphCtx = graphCanvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            graphCanvas.width = graphCanvas.offsetWidth;
            graphCanvas.height = graphCanvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Calculate Tsiolkovsky equation
        function calculateDeltaV() {
            const m0 = state.dryMass + state.fuelMass;
            const mf = state.dryMass;
            const massRatio = m0 / mf;
            const deltaV = state.exhaustVelocity * Math.log(massRatio);
            return { deltaV, massRatio, m0, mf };
        }

        // Update displays
        function updateDisplays() {
            const { deltaV, massRatio, m0, mf } = calculateDeltaV();

            document.getElementById('deltaVDisplay').textContent = Math.round(deltaV).toLocaleString() + ' m/s';
            document.getElementById('veDisplay').textContent = state.exhaustVelocity.toLocaleString() + ' m/s';
            document.getElementById('m0Display').textContent = m0.toLocaleString() + ' kg';
            document.getElementById('mfDisplay').textContent = mf.toLocaleString() + ' kg';
            document.getElementById('massRatioDisplay').textContent = massRatio.toFixed(2) + ':1';

            document.getElementById('dryMassValue').textContent = state.dryMass.toLocaleString() + ' kg';
            document.getElementById('fuelMassValue').textContent = state.fuelMass.toLocaleString() + ' kg';
            document.getElementById('totalMassInfo').textContent = m0.toLocaleString();

            const fuelFraction = (state.fuelMass / m0 * 100);
            document.getElementById('fuelFractionInfo').textContent = fuelFraction.toFixed(1) + '%';
        }

        // Event listeners
        document.getElementById('dryMassSlider').addEventListener('input', (e) => {
            state.dryMass = parseInt(e.target.value);
            updateDisplays();
        });

        document.getElementById('fuelMassSlider').addEventListener('input', (e) => {
            state.fuelMass = parseInt(e.target.value);
            updateDisplays();
        });

        document.getElementById('engineSelect').addEventListener('change', (e) => {
            state.exhaustVelocity = parseInt(e.target.value);
            document.getElementById('engineInfo').textContent = engineInfo[e.target.value];
            updateDisplays();
        });

        // Mission selection
        document.querySelectorAll('.mission-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.mission-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                state.mission = card.dataset.mission;
            });
        });

        // Launch simulation
        document.getElementById('launchBtn').addEventListener('click', () => {
            if (state.isSimulating) return;

            state.isSimulating = true;
            state.time = 0;
            state.currentVelocity = 0;
            state.currentAltitude = 0;
            state.currentFuel = state.fuelMass;
            state.currentMass = state.dryMass + state.fuelMass;
            state.velocityHistory = [];
            state.fuelBurnedHistory = [];

            // Burn rate: burn all fuel over 60 seconds
            state.burnRate = state.fuelMass / 60;

            document.getElementById('launchBtn').disabled = true;
            document.getElementById('statusMessage').innerHTML = '';

            animate();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            state.isSimulating = false;
            state.time = 0;
            state.currentVelocity = 0;
            state.currentAltitude = 0;
            state.currentFuel = 0;
            state.currentMass = state.dryMass;
            state.velocityHistory = [];
            state.fuelBurnedHistory = [];

            document.getElementById('launchBtn').disabled = false;
            document.getElementById('statusMessage').innerHTML = '';

            drawRocket();
            drawGraph();
            updateStats();
        });

        // Animation loop
        function animate() {
            if (!state.isSimulating) return;

            const dt = 1/60; // 60 FPS
            state.time += dt;

            // Burn fuel
            if (state.currentFuel > 0) {
                const fuelBurned = Math.min(state.burnRate * dt, state.currentFuel);
                state.currentFuel -= fuelBurned;
                state.currentMass = state.dryMass + state.currentFuel;

                // Calculate instantaneous velocity using Tsiolkovsky
                const massRatio = (state.dryMass + state.fuelMass) / state.currentMass;
                state.currentVelocity = state.exhaustVelocity * Math.log(massRatio);

                // Record for graph
                const fuelBurnedPercent = ((state.fuelMass - state.currentFuel) / state.fuelMass) * 100;
                state.velocityHistory.push(state.currentVelocity);
                state.fuelBurnedHistory.push(fuelBurnedPercent);
            }

            // Update altitude (simplified - no gravity)
            state.currentAltitude += state.currentVelocity * dt / 1000; // Convert to km

            drawRocket();
            drawGraph();
            updateStats();

            // Check if simulation is complete
            if (state.currentFuel <= 0 && state.time > 1) {
                state.isSimulating = false;
                document.getElementById('launchBtn').disabled = false;
                checkMissionSuccess();
                return;
            }

            requestAnimationFrame(animate);
        }

        // Draw rocket on canvas
        function drawRocket() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw stars
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 50; i++) {
                const x = (i * 73) % canvas.width;
                const y = (i * 131) % canvas.height;
                const size = Math.random() * 2;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }

            // Calculate rocket position (bottom to top)
            const maxAltitude = 500; // km for display
            const rocketY = canvas.height - (state.currentAltitude / maxAltitude) * canvas.height;
            const rocketX = canvas.width / 2;

            // Draw exhaust if burning
            if (state.currentFuel > 0 && state.isSimulating) {
                const exhaustLength = 40 + Math.random() * 20;
                const gradient = ctx.createLinearGradient(rocketX, rocketY + 35, rocketX, rocketY + 35 + exhaustLength);
                gradient.addColorStop(0, 'rgba(255, 200, 100, 0.9)');
                gradient.addColorStop(0.5, 'rgba(255, 100, 50, 0.6)');
                gradient.addColorStop(1, 'rgba(255, 50, 0, 0)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.moveTo(rocketX - 12, rocketY + 35);
                ctx.lineTo(rocketX + 12, rocketY + 35);
                ctx.lineTo(rocketX + 8, rocketY + 35 + exhaustLength);
                ctx.lineTo(rocketX - 8, rocketY + 35 + exhaustLength);
                ctx.closePath();
                ctx.fill();
            }

            // Draw rocket body
            const rocketWidth = 24;
            const rocketHeight = 70;

            // Fuel tank (changes color as fuel depletes)
            const fuelPercent = state.currentFuel / state.fuelMass;
            const fuelGradient = ctx.createLinearGradient(rocketX - rocketWidth/2, rocketY, rocketX + rocketWidth/2, rocketY);
            fuelGradient.addColorStop(0, `rgba(0, 212, 255, ${fuelPercent * 0.8})`);
            fuelGradient.addColorStop(1, `rgba(78, 205, 196, ${fuelPercent * 0.8})`);

            ctx.fillStyle = fuelGradient;
            ctx.fillRect(rocketX - rocketWidth/2, rocketY, rocketWidth, rocketHeight - 20);

            // Dry mass (payload)
            ctx.fillStyle = '#ff6b35';
            ctx.fillRect(rocketX - rocketWidth/2, rocketY - 20, rocketWidth, 20);

            // Nose cone
            ctx.fillStyle = '#ff8c42';
            ctx.beginPath();
            ctx.moveTo(rocketX - rocketWidth/2, rocketY - 20);
            ctx.lineTo(rocketX, rocketY - 40);
            ctx.lineTo(rocketX + rocketWidth/2, rocketY - 20);
            ctx.closePath();
            ctx.fill();

            // Engine nozzle
            ctx.fillStyle = '#1a1f3a';
            ctx.fillRect(rocketX - 14, rocketY + rocketHeight - 20, 28, 15);

            // Fins
            ctx.fillStyle = '#ff6b35';
            ctx.beginPath();
            ctx.moveTo(rocketX - rocketWidth/2, rocketY + rocketHeight - 25);
            ctx.lineTo(rocketX - rocketWidth/2 - 15, rocketY + rocketHeight - 10);
            ctx.lineTo(rocketX - rocketWidth/2, rocketY + rocketHeight - 10);
            ctx.closePath();
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(rocketX + rocketWidth/2, rocketY + rocketHeight - 25);
            ctx.lineTo(rocketX + rocketWidth/2 + 15, rocketY + rocketHeight - 10);
            ctx.lineTo(rocketX + rocketWidth/2, rocketY + rocketHeight - 10);
            ctx.closePath();
            ctx.fill();
        }

        // Draw velocity graph
        function drawGraph() {
            graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);

            if (state.velocityHistory.length < 2) return;

            const padding = 40;
            const graphWidth = graphCanvas.width - padding * 2;
            const graphHeight = graphCanvas.height - padding * 2;

            // Draw axes
            graphCtx.strokeStyle = 'rgba(0, 212, 255, 0.3)';
            graphCtx.lineWidth = 2;
            graphCtx.beginPath();
            graphCtx.moveTo(padding, padding);
            graphCtx.lineTo(padding, graphCanvas.height - padding);
            graphCtx.lineTo(graphCanvas.width - padding, graphCanvas.height - padding);
            graphCtx.stroke();

            // Labels
            graphCtx.fillStyle = '#8892a6';
            graphCtx.font = '12px Space Mono';
            graphCtx.fillText('Fuel Burned (%)', graphCanvas.width / 2 - 40, graphCanvas.height - 10);
            graphCtx.save();
            graphCtx.translate(15, graphCanvas.height / 2 + 50);
            graphCtx.rotate(-Math.PI / 2);
            graphCtx.fillText('Velocity (m/s)', 0, 0);
            graphCtx.restore();

            // Find max velocity for scaling
            const maxVelocity = Math.max(...state.velocityHistory, 1000);

            // Draw grid lines
            graphCtx.strokeStyle = 'rgba(0, 212, 255, 0.1)';
            graphCtx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (graphHeight / 5) * i;
                graphCtx.beginPath();
                graphCtx.moveTo(padding, y);
                graphCtx.lineTo(graphCanvas.width - padding, y);
                graphCtx.stroke();

                const velocityLabel = Math.round(maxVelocity * (1 - i / 5));
                graphCtx.fillStyle = '#8892a6';
                graphCtx.fillText(velocityLabel, 5, y + 4);
            }

            // Draw curve
            graphCtx.strokeStyle = '#00d4ff';
            graphCtx.lineWidth = 3;
            graphCtx.beginPath();

            for (let i = 0; i < state.velocityHistory.length; i++) {
                const x = padding + (state.fuelBurnedHistory[i] / 100) * graphWidth;
                const y = graphCanvas.height - padding - (state.velocityHistory[i] / maxVelocity) * graphHeight;

                if (i === 0) {
                    graphCtx.moveTo(x, y);
                } else {
                    graphCtx.lineTo(x, y);
                }
            }
            graphCtx.stroke();

            // Fill area under curve
            graphCtx.fillStyle = 'rgba(0, 212, 255, 0.1)';
            graphCtx.lineTo(graphCanvas.width - padding, graphCanvas.height - padding);
            graphCtx.lineTo(padding, graphCanvas.height - padding);
            graphCtx.closePath();
            graphCtx.fill();
        }

        // Update stats overlay
        function updateStats() {
            document.getElementById('altitudeStat').textContent = state.currentAltitude.toFixed(1) + ' km';
            document.getElementById('velocityStat').textContent = Math.round(state.currentVelocity).toLocaleString() + ' m/s';
            document.getElementById('fuelStat').textContent = ((state.currentFuel / state.fuelMass) * 100).toFixed(1) + '%';
            document.getElementById('massStat').textContent = Math.round(state.currentMass).toLocaleString() + ' kg';

            // Calculate acceleration (F = thrust / mass, thrust = mass_flow_rate * exhaust_velocity)
            if (state.currentFuel > 0) {
                const thrust = state.burnRate * state.exhaustVelocity;
                const acceleration = thrust / state.currentMass;
                document.getElementById('accelStat').textContent = acceleration.toFixed(2) + ' m/s¬≤';
            } else {
                document.getElementById('accelStat').textContent = '0 m/s¬≤';
            }
        }

        // Check mission success
        function checkMissionSuccess() {
            const mission = missions[state.mission];
            const { deltaV } = calculateDeltaV();
            const statusDiv = document.getElementById('statusMessage');

            if (state.mission === 'efficiency') {
                const fuelFraction = state.fuelMass / (state.dryMass + state.fuelMass);
                if (state.currentAltitude >= mission.target) {
                    statusDiv.className = 'status-message status-success';
                    statusDiv.innerHTML = `
                        <div>üéâ Mission Success!</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            Reached ${state.currentAltitude.toFixed(1)} km with ${(fuelFraction * 100).toFixed(1)}% fuel fraction.<br>
                            Try to improve by reducing fuel mass while still reaching the target!
                        </div>
                    `;
                } else {
                    statusDiv.className = 'status-message status-failure';
                    statusDiv.innerHTML = `
                        <div>‚ùå Mission Failed</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            Only reached ${state.currentAltitude.toFixed(1)} km. Target: ${mission.target} km.<br>
                            Need more Œîv: ${deltaV.toFixed(0)} m/s achieved, ${mission.deltaV} m/s required.
                        </div>
                    `;
                }
            } else {
                if (state.currentAltitude >= mission.target && deltaV >= mission.deltaV) {
                    statusDiv.className = 'status-message status-success';
                    statusDiv.innerHTML = `
                        <div>üéâ Mission Success!</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            Reached ${state.currentAltitude.toFixed(1)} km altitude with ${deltaV.toFixed(0)} m/s Œîv.<br>
                            Mass ratio of ${((state.dryMass + state.fuelMass) / state.dryMass).toFixed(2)}:1 achieved the target!
                        </div>
                    `;
                } else {
                    statusDiv.className = 'status-message status-failure';
                    statusDiv.innerHTML = `
                        <div>‚ùå Mission Failed</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            Only reached ${state.currentAltitude.toFixed(1)} km. Target: ${mission.target} km.<br>
                            Œîv: ${deltaV.toFixed(0)} m/s (needed ${mission.deltaV} m/s).<br>
                            <strong>Try:</strong> Increase fuel mass or choose a more efficient engine!
                        </div>
                    `;
                }
            }
        }

        // Initial draw
        updateDisplays();
        drawRocket();
        drawGraph();
        updateStats();
    </script>
</body>
</html>